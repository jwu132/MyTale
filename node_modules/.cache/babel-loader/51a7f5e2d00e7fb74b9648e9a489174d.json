{"remainingRequest":"/Users/justinwu/Desktop/story_personalization_system/node_modules/babel-loader/lib/index.js!/Users/justinwu/Desktop/story_personalization_system/node_modules/eslint-loader/index.js??ref--13-0!/Users/justinwu/Desktop/story_personalization_system/src/js/extwee_utils/StoryEditor.js","dependencies":[{"path":"/Users/justinwu/Desktop/story_personalization_system/src/js/extwee_utils/StoryEditor.js","mtime":1604692362843},{"path":"/Users/justinwu/Desktop/story_personalization_system/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/justinwu/Desktop/story_personalization_system/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/justinwu/Desktop/story_personalization_system/node_modules/eslint-loader/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:cmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmZpbHRlciIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmZvci1lYWNoIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuaW5jbHVkZXMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5pbmRleC1vZiIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmpvaW4iKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5sYXN0LWluZGV4LW9mIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc2xpY2UiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5mdW5jdGlvbi5uYW1lIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMubWFwIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LnRvLXN0cmluZyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC5leGVjIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLmluY2x1ZGVzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLml0ZXJhdG9yIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnJlcGxhY2UiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuc3BsaXQiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcudHJpbSIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuZm9yLWVhY2giKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLml0ZXJhdG9yIik7Cgp2YXIgX2NsYXNzQ2FsbENoZWNrID0gcmVxdWlyZSgiL1VzZXJzL2p1c3Rpbnd1L0Rlc2t0b3Avc3RvcnlfcGVyc29uYWxpemF0aW9uX3N5c3RlbS9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jbGFzc0NhbGxDaGVjayIpOwoKdmFyIF9jcmVhdGVDbGFzcyA9IHJlcXVpcmUoIi9Vc2Vycy9qdXN0aW53dS9EZXNrdG9wL3N0b3J5X3BlcnNvbmFsaXphdGlvbl9zeXN0ZW0vbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvY3JlYXRlQ2xhc3MiKTsKCnZhciBQYXNzYWdlID0gcmVxdWlyZSgiLi9QYXNzYWdlIik7Cgp2YXIgUGFnZSA9IHJlcXVpcmUoIi4vUGFnZSIpOwoKdmFyIFN0b3J5ID0gcmVxdWlyZSgiLi9TdG9yeSIpOwoKdmFyIFZBUl9UQUcgPSAndmFyaWFibGVzJzsKLypjb25zdCBTV0FUQ0hFUyA9IFsiIzMzNjU4QSIgLCAiIzg2QkJEOCIsICIjMkY0ODU4IiwgIiNGNkFFMkQiLCAiI0YyNjQxOSIsICIjOEFBQTc5IiwgIiNGQTgzMzQiLCAiI0ZGRkQ3NyIsCiAgICAgICAgICAgICAgICAgICAgIiNGRkU4ODIiLCAiIzM4ODY5NyIsICIjMjcxMDMzIiwgIiM1MDUxNEYiLCAiI0Y3OTI1NiIsICIjRkJEMUEyIiwgIiM3RENGQjYiLCAiIzAwQjJDQSIsCiAgICAgICAgICAgICAgICAgICAgIiMxRDRFODkiLCAiIzdFNzhEMiIsICIjRTcxRDM2IiwgIiNBRjQzMTkiLCAiIzc3MjAxNCIsICIjM0YyMjBGIiwgIiMxOTE4MEEiLCAiI0MwRjhEMSJdOyovCgp2YXIgTlVNX1ZBUlMgPSAwOwp2YXIgTlVNX0lNR19WQVJTID0gMDsKdmFyIE5VTV9BVURfVkFSUyA9IDA7Ci8qKgogKiBAY2xhc3MgU3RvcnlFZGl0b3IKICogQG1vZHVsZSBTdG9yeUVkaXRvcgogKi8KCnZhciBTdG9yeUVkaXRvciA9IC8qI19fUFVSRV9fKi9mdW5jdGlvbiAoKSB7CiAgInVzZSBzdHJpY3QiOwoKICAvKioKICAgKiBAZnVuY3Rpb24gU3RvcnlFZGl0b3IKICAgKiBAcGFyYW0ge1N0b3J5fSBzdG9yeSAtIFRoZSBzdG9yeSB0byBnZW5lcmF0ZQogICAqIEBjbGFzcyBTdG9yeUVkaXRvcgogICAqLwogIGZ1bmN0aW9uIFN0b3J5RWRpdG9yKHN0b3J5KSB7CiAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgU3RvcnlFZGl0b3IpOwoKICAgIHRoaXMuYmFzZVN0b3J5ID0gc3Rvcnk7CiAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlcyA9IFtdOwogICAgdGhpcy52YXJpYWJsZXMgPSBuZXcgTWFwKCk7CiAgICB0aGlzLmltYWdlVmFyaWFibGVzID0gbmV3IE1hcCgpOwogICAgdGhpcy5hdWRpb1ZhcmlhYmxlcyA9IG5ldyBNYXAoKTsKICAgIHRoaXMuY3NzID0gIiI7CiAgICB0aGlzLmpzID0gIiI7CiAgICB0aGlzLnJlZ2VuZXJhdGVQYWdlcygpOwogICAgdGhpcy5wYXJzZVZhcmlhYmxlcygpOwogICAgdGhpcy5nZW5lcmF0ZVN0b3J5VGV4dCh0cnVlKTsKICAgIHRoaXMucmVwYXJzZU1lZGlhKCk7CiAgfQogIC8qKiAKICAgKiBHZXQgdGhlIGRlZmF1bHQgdmFsdWUgb2YgYSB0ZXh0IHZhcmlhYmxlCiAgICogCiAgICogQGZ1bmN0aW9uIGV4dHJhY3REZWZhdWx0CiAgICogQHBhcmFtIHtzdHJpbmd9IGxpbmUgLSBMaW5lIHRvIGV4dHJhY3QgZnJvbQogICAqIEByZXR1cm5zIHtTdHJpbmd9CiAgICovCgoKICBfY3JlYXRlQ2xhc3MoU3RvcnlFZGl0b3IsIFt7CiAgICBrZXk6ICJleHRyYWN0RGVmYXVsdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZXh0cmFjdERlZmF1bHQobGluZSkgewogICAgICB2YXIgcG9zMSA9IGxpbmUuaW5kZXhPZigiOyIpOwogICAgICB2YXIgcG9zMiA9IGxpbmUubGFzdEluZGV4T2YoIiYiKTsKICAgICAgcmV0dXJuIGxpbmUuc2xpY2UocG9zMSArIDEsIHBvczIpOwogICAgfQogICAgLyoqCiAgICAgKiBDaGFuZ2VzIHRoZSB2YWx1ZSBvZiB0aGUgdmFyaWFibGUKICAgICAqIAogICAgICogQHBhcmFtIHtTdHJpbmd9IGxpbmUgLSBMaW5lIHRvIHNwbGljZSBpbnRvCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmV3VmFsIC0gVmFsdWUgdG8gc3BsaWNlCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfQogICAgICovCgogIH0sIHsKICAgIGtleTogIndyaXRlVmFyaWFibGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHdyaXRlVmFyaWFibGUobGluZSwgbmV3VmFsKSB7CiAgICAgIHZhciBwb3MxID0gbGluZS5pbmRleE9mKCI7Iik7CiAgICAgIHZhciBwb3MyID0gbGluZS5sYXN0SW5kZXhPZigiJiIpOwogICAgICByZXR1cm4gbGluZS5zbGljZSgwLCBwb3MxICsgMSkgKyBuZXdWYWwgKyBsaW5lLnNsaWNlKHBvczIsIGxpbmUubGVuZ3RoKTsKICAgIH0KICAgIC8qKiAKICAgICAqIEdldCB0aGUgZGVmYXVsdCBuYW1lIG9mIGEgdGV4dCB2YXJpYWJsZQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gZXh0cmFjdFZhcmlhYmxlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbGluZSAtIExpbmUgdG8gZXh0cmFjdCBmcm9tCiAgICAgKiBAcmV0dXJucyB7U3RyaW5nfQogICAgICovCgogIH0sIHsKICAgIGtleTogImV4dHJhY3RWYXJpYWJsZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZXh0cmFjdFZhcmlhYmxlKGxpbmUpIHsKICAgICAgdmFyIHBvcyA9IGxpbmUuaW5kZXhPZigiJCIpOwogICAgICB2YXIgdmFyaWFibGUgPSAiIjsKCiAgICAgIHdoaWxlIChsaW5lLmNoYXJBdChwb3MpICE9ICIgIikgewogICAgICAgIHZhcmlhYmxlICs9IGxpbmUuY2hhckF0KHBvcyk7CiAgICAgICAgcG9zKys7CiAgICAgIH0KCiAgICAgIHJldHVybiB2YXJpYWJsZTsKICAgIH0KICAgIC8qKiAKICAgICAqIE9idGFpbiBhbGwgdGhlIHZhcmlhYmxlcyBmcm9tIGEgc3Rvcnkgb2JqZWN0CiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBwYXJzZVZhcmlhYmxlcwogICAgICogQHJldHVybnMge3ZvaWR9CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAicGFyc2VWYXJpYWJsZXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHBhcnNlVmFyaWFibGVzKCkgewogICAgICAvL0V4dHJhY3QgdGhlIHBhc3NhZ2Ugd2l0aCB2YXJpYWJsZSB0YWcsCiAgICAgIC8vSU1QT1JUQU5UOiBWQVJfVEFHIFNIT1VMRCBOT1QgQkUgVVNFRCBEVVJJTkcgU1RPUlkgQ1JFQVRJT04KICAgICAgLy8gICAgICAgICAgIFRISVMgUEFTU0FHRSBXSUxMIEJFIEFVVE9NQVRJQ0FMTFkgR0VORVJBVEVEIEFORCBBRERFRCAKICAgICAgLy8gICAgICAgICAgIFRPIFRIRSBGSVJTVCBQQVNTQUdFIE9GIFRIRSBTVE9SWS4KICAgICAgdmFyIHZhcmlhYmxlUGFzc2FnZSA9IFtdOwoKICAgICAgaWYgKHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzLmxlbmd0aCA+IDApIHsKICAgICAgICB2YXJpYWJsZVBhc3NhZ2UgPSB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlcy5maWx0ZXIoZnVuY3Rpb24gKHBhc3NhZ2UpIHsKICAgICAgICAgIHZhciByZXN1bHRzID0gcGFzc2FnZS50YWdzLmZpbHRlcihmdW5jdGlvbiAodGFnKSB7CiAgICAgICAgICAgIHJldHVybiB0YWcgPT09IFZBUl9UQUc7CiAgICAgICAgICB9KTsKICAgICAgICAgIHJldHVybiByZXN1bHRzLmxlbmd0aCA+IDA7CiAgICAgICAgfSk7CiAgICAgIH0KCiAgICAgIHRoaXMudmFyaWFibGVzLmNsZWFyKCk7IC8vQ2hlY2tzIGlmIHRoZXJlIGlzIG9ubHkgb25lIHBhc3NhZ2Ugd2l0aCB0aGUgdmFyaWFibGUgdGFnCgogICAgICBpZiAodmFyaWFibGVQYXNzYWdlLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgdmFyIHZhcmlhYmxlVGV4dCA9IHZhcmlhYmxlUGFzc2FnZVswXS50ZXh0OwogICAgICAgIHZhciBsaW5lcyA9IHZhcmlhYmxlVGV4dC5zcGxpdCgiXG4iKTsKICAgICAgICBjb25zb2xlLmxvZyhsaW5lcy5sZW5ndGgpOwoKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IGxpbmVzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZiAobGluZXNbal0uaW5jbHVkZXMoIihzZXQ6IikpIHsKICAgICAgICAgICAgLy9BZGRzIGVhY2ggdmFyaWFibGUgdG8gYSBqcyBNYXAKICAgICAgICAgICAgdmFyIHZhcmlhYmxlID0gdGhpcy5leHRyYWN0VmFyaWFibGUobGluZXNbal0pOwogICAgICAgICAgICB2YXIgZGVmVmFsID0gdGhpcy5leHRyYWN0RGVmYXVsdChsaW5lc1tqXSk7CgogICAgICAgICAgICBpZiAodGhpcy52YXJpYWJsZXMuaGFzKHZhcmlhYmxlKSkgewogICAgICAgICAgICAgIGFsZXJ0KCJEdXBsaWNhdGUgVmFyaWFibGUgXG5cblVwZGF0aW5nIFZhbHVlIHRvOiAiICsgIlwiIiArIGRlZlZhbCArICJcIiIpOwogICAgICAgICAgICB9CgogICAgICAgICAgICB0aGlzLnZhcmlhYmxlcy5zZXQodmFyaWFibGUsIHsKICAgICAgICAgICAgICB2YWx1ZTogZGVmVmFsLAogICAgICAgICAgICAgIGNvbG9yOiAiIiwKICAgICAgICAgICAgICBpZDogTlVNX1ZBUlMrKwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc29sZS5sb2codmFyaWFibGUgKyAiICIgKyBkZWZWYWwpOwogICAgICAgICAgfSBlbHNlIGlmIChsaW5lc1tqXS5pbmNsdWRlcygiKGhpZGRlbjopIikpIHsKICAgICAgICAgICAgdmFyIHZhckRhdGEgPSB0aGlzLmV4dHJhY3RBcnIobGluZXNbal0pOwoKICAgICAgICAgICAgaWYgKHZhckRhdGEudHlwZSA9PSAiaW1hZ2UiKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgayA9IDA7IGsgPCB2YXJEYXRhLmRhdGEubGVuZ3RoOyBrKyspIHsKICAgICAgICAgICAgICAgIHZhciBpbWdTcmMgPSB0aGlzLmV4dHJhY3RTcmModmFyRGF0YS5kYXRhW2tdKTsKICAgICAgICAgICAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuc2V0KHZhckRhdGEuZGF0YVtrXS5zdWJzdHJpbmcoMCwgdmFyRGF0YS5kYXRhW2tdLmluZGV4T2YoInsiKSksIHsKICAgICAgICAgICAgICAgICAgZmlsZTogbnVsbCwKICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IGltZ1NyYy5uYW1lLAogICAgICAgICAgICAgICAgICBwYXRoOiBpbWdTcmMuc3JjLAogICAgICAgICAgICAgICAgICBjb2xvcjogIiIsCiAgICAgICAgICAgICAgICAgIGlkOiBOVU1fSU1HX1ZBUlMrKywKICAgICAgICAgICAgICAgICAgdXBsb2FkZWQ6ICFpbWdTcmMuc3JjLmkuaW5jbHVkZXMoImJsb2IiKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHZhckRhdGEudHlwZSA9PSAiYXVkaW8iKSB7CiAgICAgICAgICAgICAgZm9yICh2YXIgYSA9IDA7IGEgPCB2YXJEYXRhLmRhdGEubGVuZ3RoOyBhKyspIHsKICAgICAgICAgICAgICAgIHZhciBhdWRTcmMgPSB0aGlzLmV4dHJhY3RTcmModmFyRGF0YS5kYXRhW2FdKTsKICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuc2V0KHZhckRhdGEuZGF0YVthXS5zdWJzdHJpbmcoMCwgdmFyRGF0YS5kYXRhW2FdLmluZGV4T2YoInsiKSksIHsKICAgICAgICAgICAgICAgICAgZmlsZTogbnVsbCwKICAgICAgICAgICAgICAgICAgZmlsZU5hbWU6IGltZ1NyYy5uYW1lLAogICAgICAgICAgICAgICAgICBwYXRoOiBhdWRTcmMuc3JjLAogICAgICAgICAgICAgICAgICBjb2xvcjogIiIsCiAgICAgICAgICAgICAgICAgIGlkOiBOVU1fQVVEX1ZBUlMrKywKICAgICAgICAgICAgICAgICAgdXBsb2FkZWQ6ICFhdWRTcmMuc3JjLmkuaW5jbHVkZXMoImJsb2IiKQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsaW5lcyA9IGxpbmVzLmZpbHRlcihmdW5jdGlvbiAobGluZSkgewogICAgICAgICAgcmV0dXJuICFsaW5lLmluY2x1ZGVzKCIoc2V0OiIpICYmICFsaW5lLmluY2x1ZGVzKCIoaGlkZGVuOikiKTsKICAgICAgICB9KTsKCiAgICAgICAgZm9yICh2YXIgbCA9IDA7IGwgPCB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlcy5sZW5ndGg7IGwrKykgewogICAgICAgICAgaWYgKHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2xdLnRhZ3MuaW5jbHVkZXMoVkFSX1RBRykpIHsKICAgICAgICAgICAgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbbF0udGV4dCA9IGxpbmVzLmpvaW4oIlxuIik7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIlBsZWFzZSByZW1vdmUgZXh0cmEgdmFyaWFibGUgcGFzc2FnZSB0YWdzIik7CiAgICAgIH0KCiAgICAgIHRoaXMuZGV0VmFyaWFibGVDb2xvcnMoKTsKICAgICAgdGhpcy5wcmludFZhcmlhYmxlRGF0YSgpOwogICAgfQogICAgLyoqCiAgICAgKiBFeHRyYWN0cyB0aGUgaW1hZ2UgdmFyaWFibGUgZGF0YSBpbiB0aGUgc3RvcnkKICAgICAqIAogICAgICogQGZ1bmN0aW9uIGV4dHJhY3RBcnIKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBsaW5lIAogICAgICovCgogIH0sIHsKICAgIGtleTogImV4dHJhY3RBcnIiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGV4dHJhY3RBcnIobGluZSkgewogICAgICB2YXIgc291cmNlID0gbGluZS5zcGxpdCgiWyIpOwogICAgICB2YXIgY2h1bmsgPSBzb3VyY2VbMV0ucmVwbGFjZSgiXSIsICIiKTsKICAgICAgc291cmNlID0gY2h1bmsuc3BsaXQoIjoiKTsKICAgICAgdmFyIHR5cGUgPSBzb3VyY2VbMF07CiAgICAgIHZhciBhcnIgPSBjaHVuay5yZXBsYWNlKHNvdXJjZVswXSArICI6IiwgIiIpLnNwbGl0KCIsIik7CiAgICAgIGFyciA9IGFyci5maWx0ZXIoZnVuY3Rpb24gKGkpIHsKICAgICAgICByZXR1cm4gaSAhPSAiIjsKICAgICAgfSk7CiAgICAgIGNvbnNvbGUubG9nKGFycik7CiAgICAgIHJldHVybiB7CiAgICAgICAgdHlwZTogdHlwZSwKICAgICAgICBkYXRhOiBhcnIKICAgICAgfTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJleHRyYWN0U3JjIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBleHRyYWN0U3JjKGxpbmUpIHsKICAgICAgdmFyIHNvdXJjZSA9IGxpbmUuc3BsaXQoInsiKTsKICAgICAgdmFyIHNyYyA9ICIiOwogICAgICB2YXIgZmlsZU5hbWUgPSAiIjsKCiAgICAgIGlmIChzb3VyY2UubGVuZ3RoID4gMSkgewogICAgICAgIHNyYyA9IHNvdXJjZVsxXS5zcGxpdCgiICIpWzBdOwogICAgICAgIGZpbGVOYW1lID0gc291cmNlWzFdLnNwbGl0KCIgIilbMV0ucmVwbGFjZSgifSIsICIiKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHsKICAgICAgICBzcmM6IHsKICAgICAgICAgIGk6IHNyYwogICAgICAgIH0sCiAgICAgICAgbmFtZTogZmlsZU5hbWUKICAgICAgfTsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlcyB0aGUgdmFyaWFibGUgY29kZSBpbmplY3Rpb24KICAgICAqIAogICAgICogQGZ1bmN0aW9uIHJlbW92ZVZhcmlhYmxlSW5qZWN0CiAgICAgKiAKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJyZW1vdmVWYXJpYWJsZUluamVjdCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlVmFyaWFibGVJbmplY3QoKSB7CiAgICAgIHZhciB0ZXh0ID0gc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgicHJlUHJvY2Vzc2VkQmFzZVRleHQiKTsKICAgICAgdmFyIHByb2Nlc3MgPSB0ZXh0ICE9ICIiOwoKICAgICAgaWYgKHByb2Nlc3MpIHsKICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzLmxlbmd0aDsgaysrKSB7CiAgICAgICAgICBpZiAodGhpcy5iYXNlU3RvcnkucGFzc2FnZXNba10udGFncy5pbmNsdWRlcyhWQVJfVEFHKSkgewogICAgICAgICAgICB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1trXS50ZXh0ID0gdGV4dDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICBpZiAodGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ubGlua1Bhc3NhZ2UudGFncy5pbmNsdWRlcyhWQVJfVEFHKSkgewogICAgICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5saW5rUGFzc2FnZS50ZXh0ID0gdGV4dDsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8qbGV0IHZhcmlhYmxlUGFzc2FnZSA9IFtdOwogICAgICAgaWYgKHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzLmxlbmd0aCA+IDApIHsKICAgICAgICAgIHZhcmlhYmxlUGFzc2FnZSA9IHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzLmZpbHRlcihmdW5jdGlvbiAocGFzc2FnZSkgewogICAgICAgICAgICAgIGNvbnN0IHJlc3VsdHMgPSBwYXNzYWdlLnRhZ3MuZmlsdGVyKHRhZyA9PiB0YWcgPT09IFZBUl9UQUcpOwogICAgICAgICAgICAgICByZXR1cm4gKHJlc3VsdHMubGVuZ3RoID4gMCk7CiAgICAgICAgICB9KTsKICAgICAgfQogICAgICAgLy9DaGVja3MgaWYgdGhlcmUgaXMgb25seSBvbmUgcGFzc2FnZSB3aXRoIHRoZSB2YXJpYWJsZSB0YWcKICAgICAgIGlmICh2YXJpYWJsZVBhc3NhZ2UubGVuZ3RoID09IDEpIHsKICAgICAgICAgIHZhciB2YXJpYWJsZVRleHQgPSB2YXJpYWJsZVBhc3NhZ2VbMF0udGV4dDsKICAgICAgICAgIHZhciBsaW5lcyA9IHZhcmlhYmxlVGV4dC5zcGxpdCgiXG4iKTsKICAgICAgICAgICBsaW5lcyA9IGxpbmVzLmZpbHRlcihmdW5jdGlvbihsaW5lKSB7CiAgICAgICAgICAgICAgcmV0dXJuICFsaW5lLmluY2x1ZGVzKCIoc2V0OiIpOyAgCiAgICAgICAgICB9KTsKICAgICAgICAgIAogICAgICAgICAgZm9yKHZhciBrID0gMDsgazwgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXMubGVuZ3RoOyBrKyspewogICAgICAgICAgICAgIGlmKHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2tdLnRhZ3MuaW5jbHVkZXMoVkFSX1RBRykpewogICAgICAgICAgICAgICAgICB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1trXS50ZXh0ID0gbGluZXMuam9pbigiXG4iKTsKICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfSBlbHNlIHsKICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiUGxlYXNlIHJlbW92ZSBleHRyYSB2YXJpYWJsZSBwYXNzYWdlIHRhZ3MiKTsKICAgICAgfSovCgogICAgfQogIH0sIHsKICAgIGtleTogImRldFZhcmlhYmxlQ29sb3JzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkZXRWYXJpYWJsZUNvbG9ycygpIHsKICAgICAgdGhpcy5kZXRUZXh0VmFyaWFibGVDb2xvcnMoKTsKICAgICAgdGhpcy5kZXRJbWFnZVZhcmlhYmxlQ29sb3JzKCk7CiAgICAgIHRoaXMuZGV0QXVkaW9WYXJpYWJsZUNvbG9ycygpOwogICAgfQogIH0sIHsKICAgIGtleTogImRldEltYWdlVmFyaWFibGVDb2xvcnMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRldEltYWdlVmFyaWFibGVDb2xvcnMoKSB7CiAgICAgIHZhciBzb3J0ZWRLZXlzID0gW107CiAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIHNvcnRlZEtleXMucHVzaChrZXkpOwogICAgICB9KTsKICAgICAgdmFyIHZhck1hcCA9IHRoaXMuaW1hZ2VWYXJpYWJsZXM7CiAgICAgIHNvcnRlZEtleXMgPSBzb3J0ZWRLZXlzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICB2YXIgaWRBID0gdmFyTWFwLmdldChhKS5pZDsKICAgICAgICB2YXIgaWRCID0gdmFyTWFwLmdldChiKS5pZDsKICAgICAgICByZXR1cm4gaWRBIC0gaWRCOwogICAgICB9KTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydGVkS2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBkYXRhID0gdGhpcy5pbWFnZVZhcmlhYmxlcy5nZXQoc29ydGVkS2V5c1tpXSk7CgogICAgICAgIGlmIChkYXRhLmNvbG9yID09ICIiKSB7CiAgICAgICAgICB2YXIgb1IgPSAyNTU7CiAgICAgICAgICB2YXIgb0cgPSAxNjU7CiAgICAgICAgICB2YXIgb0IgPSAwOwogICAgICAgICAgdmFyIHJhbmRSID0gTWF0aC5yYW5kb20oKSAqIDI1NjsKICAgICAgICAgIHZhciByYW5kRyA9IE1hdGgucmFuZG9tKCkgKiAyNTY7CiAgICAgICAgICB2YXIgcmFuZEIgPSBNYXRoLnJhbmRvbSgpICogMjU2OwogICAgICAgICAgZGF0YS5jb2xvciA9ICJyZ2IoIiArIChvUiArIHJhbmRSKSAvIDIgKyAiLCIgKyAob0cgKyByYW5kRykgLyAyICsgIiwiICsgKG9CICsgcmFuZEIpIC8gMiArICIpIjsKICAgICAgICB9CgogICAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuc2V0KHNvcnRlZEtleXNbaV0sIGRhdGEpOwogICAgICB9CiAgICB9CiAgfSwgewogICAga2V5OiAiZGV0QXVkaW9WYXJpYWJsZUNvbG9ycyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZGV0QXVkaW9WYXJpYWJsZUNvbG9ycygpIHsKICAgICAgdmFyIHNvcnRlZEtleXMgPSBbXTsKICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgc29ydGVkS2V5cy5wdXNoKGtleSk7CiAgICAgIH0pOwogICAgICB2YXIgdmFyTWFwID0gdGhpcy5hdWRpb1ZhcmlhYmxlczsKICAgICAgc29ydGVkS2V5cyA9IHNvcnRlZEtleXMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHZhciBpZEEgPSB2YXJNYXAuZ2V0KGEpLmlkOwogICAgICAgIHZhciBpZEIgPSB2YXJNYXAuZ2V0KGIpLmlkOwogICAgICAgIHJldHVybiBpZEEgLSBpZEI7CiAgICAgIH0pOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0ZWRLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmF1ZGlvVmFyaWFibGVzLmdldChzb3J0ZWRLZXlzW2ldKTsKCiAgICAgICAgaWYgKGRhdGEuY29sb3IgPT0gIiIpIHsKICAgICAgICAgIHZhciBvUiA9IDI1NTsKICAgICAgICAgIHZhciBvRyA9IDE2NTsKICAgICAgICAgIHZhciBvQiA9IDA7CiAgICAgICAgICB2YXIgcmFuZFIgPSBNYXRoLnJhbmRvbSgpICogMjU2OwogICAgICAgICAgdmFyIHJhbmRHID0gTWF0aC5yYW5kb20oKSAqIDI1NjsKICAgICAgICAgIHZhciByYW5kQiA9IE1hdGgucmFuZG9tKCkgKiAyNTY7CiAgICAgICAgICBkYXRhLmNvbG9yID0gInJnYigiICsgKG9SICsgcmFuZFIpIC8gMiArICIsIiArIChvRyArIHJhbmRHKSAvIDIgKyAiLCIgKyAob0IgKyByYW5kQikgLyAyICsgIikiOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcy5zZXQoc29ydGVkS2V5c1tpXSwgZGF0YSk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogRGV0ZXJtaW5lcyB0aGUgc3dhdGNoIG9mIHRoZSB2YXJpYWJsZQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gZGV0VmFyaWFibGVDb2xvcnMKICAgICAqIAogICAgICovCgogIH0sIHsKICAgIGtleTogImRldFRleHRWYXJpYWJsZUNvbG9ycyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZGV0VGV4dFZhcmlhYmxlQ29sb3JzKCkgewogICAgICB2YXIgc29ydGVkS2V5cyA9IFtdOwogICAgICB0aGlzLnZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgc29ydGVkS2V5cy5wdXNoKGtleSk7CiAgICAgIH0pOwogICAgICB2YXIgdmFyTWFwID0gdGhpcy52YXJpYWJsZXM7CiAgICAgIHNvcnRlZEtleXMgPSBzb3J0ZWRLZXlzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICB2YXIgaWRBID0gdmFyTWFwLmdldChhKS5pZDsKICAgICAgICB2YXIgaWRCID0gdmFyTWFwLmdldChiKS5pZDsKICAgICAgICByZXR1cm4gaWRBIC0gaWRCOwogICAgICB9KTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydGVkS2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBkYXRhID0gdGhpcy52YXJpYWJsZXMuZ2V0KHNvcnRlZEtleXNbaV0pOwoKICAgICAgICBpZiAoZGF0YS5jb2xvciA9PSAiIikgewogICAgICAgICAgdmFyIG9SID0gMjU1OwogICAgICAgICAgdmFyIG9HID0gMTY1OwogICAgICAgICAgdmFyIG9CID0gMDsKICAgICAgICAgIHZhciByYW5kUiA9IE1hdGgucmFuZG9tKCkgKiAyNTY7CiAgICAgICAgICB2YXIgcmFuZEcgPSBNYXRoLnJhbmRvbSgpICogMjU2OwogICAgICAgICAgdmFyIHJhbmRCID0gTWF0aC5yYW5kb20oKSAqIDI1NjsKICAgICAgICAgIGRhdGEuY29sb3IgPSAicmdiKCIgKyAob1IgKyByYW5kUikgLyAyICsgIiwiICsgKG9HICsgcmFuZEcpIC8gMiArICIsIiArIChvQiArIHJhbmRCKSAvIDIgKyAiKSI7CiAgICAgICAgfQoKICAgICAgICB0aGlzLnZhcmlhYmxlcy5zZXQoc29ydGVkS2V5c1tpXSwgZGF0YSk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJwcmludFZhcmlhYmxlRGF0YSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcHJpbnRWYXJpYWJsZURhdGEoKSB7CiAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAoZGF0YSwga2V5KSB7CiAgICAgICAgY29uc29sZS5sb2coa2V5ICsgIj09PiIgKyBKU09OLnN0cmluZ2lmeShkYXRhKSk7CiAgICAgIH0pOwogICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKGRhdGEsIGtleSkgewogICAgICAgIGNvbnNvbGUubG9nKGtleSArICI9PT4iICsgSlNPTi5zdHJpbmdpZnkoZGF0YSkpOwogICAgICB9KTsKICAgICAgdGhpcy52YXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAoZGF0YSwga2V5KSB7CiAgICAgICAgY29uc29sZS5sb2coa2V5ICsgIj09PiIgKyBKU09OLnN0cmluZ2lmeShkYXRhKSk7CiAgICAgIH0pOwogICAgfQogICAgLyoqCiAgICAgKiBSZXBhcnNlcyB0aGUgbGlua3MgaW4gdGhlIHBhc3NhZ2UgdGV4dAogICAgICogQGZ1bmN0aW9uIHJlcGFyc2VMaW5rcwogICAgICovCgogIH0sIHsKICAgIGtleTogInJlcGFyc2VMaW5rcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVwYXJzZUxpbmtzKCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ucmVwYXJzZUxpbmtzKCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAicmVwYXJzZU1lZGlhIiwKICAgIHZhbHVlOiBmdW5jdGlvbiByZXBhcnNlTWVkaWEoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5yZXBhcnNlTWVkaWEodGhpcy5pbWFnZVZhcmlhYmxlcywgdGhpcy5hdWRpb1ZhcmlhYmxlcyk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogCiAgICAgKiBAcGFyYW0geyp9IGV2ZW50IAogICAgICovCgogIH0sIHsKICAgIGtleTogImFkZEF1ZGlvVG9QYWdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRBdWRpb1RvUGFnZShldmVudCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLnBhZ2VOYW1lID09IGV2ZW50LnBhZ2VOYW1lKSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5hZGRBdWRpbyhldmVudCk7CiAgICAgIH0KCiAgICAgIHRoaXMucmVwYXJzZU1lZGlhKCk7IC8vdGhpcy5wcmludFZhcmlhYmxlRGF0YSgpOwogICAgfQogICAgLyoqCiAgICAgKiAKICAgICAqIEBwYXJhbSB7Kn0gZXZlbnQgCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAicmVtb3ZlQXVkaW9Gcm9tUGFnZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlQXVkaW9Gcm9tUGFnZShldmVudCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLnBhZ2VOYW1lID09IGV2ZW50LnBhZ2VOYW1lKSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5yZW1vdmVBdWRpbyhldmVudCk7CiAgICAgIH0KCiAgICAgIHRoaXMucmVwYXJzZU1lZGlhKCk7IC8vdGhpcy5wcmludFZhcmlhYmxlRGF0YSgpOwogICAgfQogICAgLyoqCiAgICAgKiAKICAgICAqIEBwYXJhbSB7Kn0gZXZlbnQgCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiYWRkSW1hZ2VUb1BhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGFkZEltYWdlVG9QYWdlKGV2ZW50KSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ucGFnZU5hbWUgPT0gZXZlbnQucGFnZU5hbWUpIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLmFkZEltYWdlKGV2ZW50KTsKICAgICAgfQoKICAgICAgdGhpcy5yZXBhcnNlTWVkaWEoKTsgLy90aGlzLnByaW50VmFyaWFibGVEYXRhKCk7CiAgICB9CiAgICAvKioKICAgICAqIAogICAgICogQHBhcmFtIHsqfSBldmVudCAKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJyZW1vdmVJbWFnZUZyb21QYWdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVJbWFnZUZyb21QYWdlKGV2ZW50KSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ucGFnZU5hbWUgPT0gZXZlbnQucGFnZU5hbWUpIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLnJlbW92ZUltYWdlKGV2ZW50KTsKICAgICAgfQoKICAgICAgdGhpcy5yZXBhcnNlTWVkaWEoKTsgLy90aGlzLnByaW50VmFyaWFibGVEYXRhKCk7CiAgICB9CiAgICAvKioKICAgICAqIFJlZmFjdG9ycyB0aGUgbGluayB0ZXh0IHNvIHRoYXQgaXQgaXMgcHJvcGVybHkgY29uZmlndXJlZAogICAgICogCiAgICAgKiBAZnVuY3Rpb24gcmVwbGFjZUxpbmtzCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJyZXBsYWNlTGlua3MiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlcGxhY2VMaW5rcyhldmVudCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ucmVwbGFjZUxpbmtzKGV2ZW50KTsKCiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlcy5sZW5ndGg7IGorKykgewogICAgICAgICAgaWYgKHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2pdLm5hbWUgPT0gdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ubGlua1Bhc3NhZ2UubmFtZSkgewogICAgICAgICAgICB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tqXS50ZXh0ID0gdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ubGlua1Bhc3NhZ2UudGV4dDsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogUmVmYWN0b3JzIHRoZSBsaW5rIHRleHQgc28gdGhhdCBpdCBpcyBwcm9wZXJseSBjb25maWd1cmVkCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiByZXBsYWNlTGlua3MKICAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IAogICAgICovCgogIH0sIHsKICAgIGtleTogInJlcGxhY2VWYXJpYWJsZXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlcGxhY2VWYXJpYWJsZXMoZXZlbnQpIHsKICAgICAgdmFyIG1lcmdlZE1hcCA9IG5ldyBNYXAoKTsKICAgICAgdGhpcy52YXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIG1lcmdlZE1hcC5zZXQoa2V5LCB2YWx1ZSk7CiAgICAgIH0pOwogICAgICB0aGlzLmltYWdlVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBtZXJnZWRNYXAuc2V0KGtleSwgdmFsdWUpOwogICAgICB9KTsKICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgbWVyZ2VkTWFwLnNldChrZXksIHZhbHVlKTsKICAgICAgfSk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ucmVwbGFjZVZhcmlhYmxlKGV2ZW50LCBtZXJnZWRNYXApOwoKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZiAodGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbal0ubmFtZSA9PSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5saW5rUGFzc2FnZS5uYW1lKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2pdLnRleHQgPSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5saW5rUGFzc2FnZS50ZXh0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICAvKmZvcih2YXIgbSA9IDA7IG0gPCB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlcy5sZW5ndGg7IG0rKyl7CiAgICAgICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbbV0ucmVwbGFjZVZhcmlhYmxlKGV2ZW50LCB0aGlzLmltYWdlVmFyaWFibGVzKTsKICAgICAgICAgICBmb3IodmFyIG4gPSAwOyBuIDwgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXMubGVuZ3RoOyBuKyspewogICAgICAgICAgICAgIGlmKHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW25dLm5hbWUgPT0gdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbbV0ubGlua1Bhc3NhZ2UubmFtZSl7CiAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW25dLnRleHQgPSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1ttXS5saW5rUGFzc2FnZS50ZXh0OwogICAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgfQogICAgICAgZm9yKHZhciBrID0gMDsgayA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaysrKXsKICAgICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1trXS5yZXBsYWNlVmFyaWFibGUoZXZlbnQsIHRoaXMuYXVkaW9WYXJpYWJsZXMpOwogICAgICAgICAgIGZvcih2YXIgbCA9IDA7IGwgPCB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlcy5sZW5ndGg7IGwrKyl7CiAgICAgICAgICAgICAgaWYodGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbbF0ubmFtZSA9PSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1trXS5saW5rUGFzc2FnZS5uYW1lKXsKICAgICAgICAgICAgICAgICAgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbbF0udGV4dCA9IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2tdLmxpbmtQYXNzYWdlLnRleHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9Ki8KICAgICAgLy90aGlzLnByaW50VmFyaWFibGVEYXRhKCk7CgogICAgfQogICAgLyoqCiAgICAgKiBQcm9ncmFtbWF0aWNhbGx5IGFkZHMgYSBsaW5rIHRvIGEgcGFnZQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gYWRkTGluawogICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgLSBkYXRhCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiYWRkTGluayIsCiAgICB2YWx1ZTogZnVuY3Rpb24gYWRkTGluayhldmVudCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLnBhZ2VOYW1lID09IGV2ZW50LnBhZ2VOYW1lKSB7CiAgICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5hZGRMaW5rKGV2ZW50Lm5hbWUpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLnJlcGFyc2VMaW5rcygpOyAvL3RoaXMucHJpbnRWYXJpYWJsZURhdGEoKTsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlcyBhIGxpbmsgZnJvbSBhIHBhZ2UKICAgICAqIAogICAgICogQGZ1bmN0aW9uIHJlbW92ZUxpbmsKICAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IC0gZGF0YQogICAgICovCgogIH0sIHsKICAgIGtleTogInJlbW92ZUxpbmsiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUxpbmsoZXZlbnQpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICh0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5wYWdlTmFtZSA9PSBldmVudC5uYW1lKSB7CiAgICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5yZW1vdmVMaW5rKGV2ZW50LnJlbW92ZUxpbmspOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLnJlcGFyc2VMaW5rcygpOwogICAgfQogICAgLyoqCiAgICAgKiBTZXRzIHRoZSBzdGFydCBwYWdlIGZvciB0aGUgc3RvcnkKICAgICAqIAogICAgICogQGZ1bmN0aW9uIHNldFN0YXJ0UGFnZQogICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgLSBkYXRhCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAic2V0U3RhcnRQYWdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRTdGFydFBhZ2UoZXZlbnQpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICh0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS50YWdzLmluY2x1ZGVzKCJzdGFydCIpKSB7CiAgICAgICAgICB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS50YWdzID0gdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV0udGFncy5maWx0ZXIoZnVuY3Rpb24gKHRhZykgewogICAgICAgICAgICByZXR1cm4gdGFnICE9ICJzdGFydCI7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS50YWdzLmluY2x1ZGVzKFZBUl9UQUcpKSB7CiAgICAgICAgICB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS50YWdzID0gdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV0udGFncy5maWx0ZXIoZnVuY3Rpb24gKHRhZykgewogICAgICAgICAgICByZXR1cm4gdGFnICE9IFZBUl9UQUc7CiAgICAgICAgICB9KTsKICAgICAgICB9CgogICAgICAgIGlmICh0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS5uYW1lID09IGV2ZW50Lm5hbWUpIHsKICAgICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2ldLnRhZ3MucHVzaCgic3RhcnQiKTsKICAgICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2ldLnRhZ3MucHVzaChWQVJfVEFHKTsKICAgICAgICB9CgogICAgICAgIHZhciByZW1UZXh0ID0gdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV0udGV4dDsKICAgICAgICB2YXIgc291cmNlID0gcmVtVGV4dC5zcGxpdCgiXG4iKTsKICAgICAgICBzb3VyY2UgPSBzb3VyY2UuZmlsdGVyKGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgICByZXR1cm4gIWxpbmUuaW5jbHVkZXMoIihzZXQ6Iik7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV0udGV4dCA9IHNvdXJjZS5qb2luKCJcbiIpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIEFkZHMgYSBuZXcgcGFnZSB0byB0aGUgc3RvcnkKICAgICAqIAogICAgICogQGZ1bmN0aW9uIGFkZFBhZ2UKICAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IAogICAgICovCgogIH0sIHsKICAgIGtleTogImFkZFBhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGFkZFBhZ2UoZXZlbnQpIHsKICAgICAgdmFyIHBhZ2VOYW1lID0gZXZlbnQubmFtZTsKICAgICAgdmFyIHByb2Nlc3MgPSB0cnVlOwoKICAgICAgaWYgKHByb2Nlc3MpIHsKICAgICAgICB2YXIgYmFzZVRleHQgPSAiVGhpcyBpcyBhIG5ldyBwYXNzYWdlLiBFZGl0IGl0IHRvIGNyZWF0ZSB5b3VyIG93biBzdG9yeSFcbltbZ28gYmFjay0mZ3Q7IiArIGV2ZW50LnByZXZMaW5rICsgIl1dIjsKICAgICAgICB2YXIgbkxpbmtQYXNzYWdlID0gbmV3IFBhc3NhZ2UocGFnZU5hbWUsIFsic3RvcnkiXSwgewogICAgICAgICAgcG9zaXRpb246ICI1MDAsIDUwMCIsCiAgICAgICAgICBzaXplOiAiMTAwLDEwMCIKICAgICAgICB9LCBiYXNlVGV4dCwgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXMubGVuZ3RoICsgMSk7CiAgICAgICAgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXMucHVzaChuTGlua1Bhc3NhZ2UpOwogICAgICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLnB1c2gobmV3IFBhZ2UobnVsbCwgbkxpbmtQYXNzYWdlLCAiYmFja2dyb3VuZC1jb2xvcjogI2ZmZmZmZjsgY29sb3I6ICMwMDAwMDA7IiwgdGhpcy5iYXNlU3RvcnkuZ2V0U3RvcnlQYXNzYWdlcygpLmxlbmd0aCwgewogICAgICAgICAgc3Rvcnk6IHRoaXMuYmFzZVN0b3J5LAogICAgICAgICAgcGFnZXM6IHRoaXMuYmFzZVN0b3J5LmdldFN0b3J5UGFzc2FnZXMoKS5sZW5ndGgKICAgICAgICB9KSk7CiAgICAgICAgdGhpcy5yZXBhcnNlTGlua3MoKTsKICAgICAgICB0aGlzLnJlcGFyc2VNZWRpYSgpOwogICAgICB9CiAgICB9CiAgICAvKioKICAgICAqIFJlc2V0cyBhbGwgdGhlIHBhZ2VzIGluIHRoZSBzdG9yeQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gcmVnZW5lcmF0ZVBhZ2VzCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAicmVnZW5lcmF0ZVBhZ2VzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiByZWdlbmVyYXRlUGFnZXMoKSB7CiAgICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzID0gW107CiAgICAgIHZhciBsZW5ndGggPSB0aGlzLmJhc2VTdG9yeS5nZXRTdG9yeVBhc3NhZ2VzKCkubGVuZ3RoOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLnB1c2gobmV3IFBhZ2UobnVsbCwgdGhpcy5iYXNlU3RvcnkuZ2V0U3RvcnlQYXNzYWdlcygpW2ldLCAiYmFja2dyb3VuZC1jb2xvcjogI2ZmZmZmZjsgY29sb3I6ICMwMDAwMDA7IiwgaSArIDEsIHsKICAgICAgICAgIHN0b3J5OiB0aGlzLmJhc2VTdG9yeSwKICAgICAgICAgIHBhZ2VzOiBsZW5ndGgKICAgICAgICB9KSk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogU2FmZWx5IGNoYW5nZXMgdGhlIHBhc3NhZ2UgbmFtZQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gY2hhbmdlUGFzc2FnZU5hbWUKICAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IAogICAgICovCgogIH0sIHsKICAgIGtleTogImNoYW5nZVBhc3NhZ2VOYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjaGFuZ2VQYXNzYWdlTmFtZShldmVudCkgewogICAgICBpZiAoZXZlbnQucHJldk5hbWUgIT0gZXZlbnQubmV3TmFtZSkgewogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICh0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS5uYW1lID09IGV2ZW50LnByZXZOYW1lKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2ldLm5hbWUgPSBldmVudC5uZXdOYW1lOwogICAgICAgICAgICBjb25zb2xlLmxvZygiQ2hhbmdlZCBOYW1lIik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZiAodGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbal0ubGlua1Bhc3NhZ2UubmFtZSA9PSBldmVudC5wcmV2TmFtZSkgewogICAgICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tqXS5saW5rUGFzc2FnZS5uYW1lID0gZXZlbnQubmV3TmFtZTsKICAgICAgICAgICAgY29uc29sZS5sb2coIkNoYW5nZWQgTmFtZSIpOwogICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgdGhpcy5yZXBsYWNlTGlua3MoZXZlbnQpOwogICAgICAgIHRoaXMucmVwYXJzZUxpbmtzKCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlcyBhIHBhc3NhZ2UgZnJvbSB0aGUgc3Rvcnk7CiAgICAgKiBAZnVuY3Rpb24gZGVsZXRlUGFzc2FnZQogICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZGVsZXRlUGFzc2FnZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZGVsZXRlUGFzc2FnZShldmVudCkgewogICAgICB2YXIgcGFzc2FnZTsKICAgICAgdmFyIGluZGV4ID0gMDsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV0ubmFtZSA9PSBldmVudC5uYW1lKSB7CiAgICAgICAgICBwYXNzYWdlID0gdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV07CiAgICAgICAgICBpbmRleCA9IGk7CiAgICAgICAgICBjb25zb2xlLmxvZygiUGFzc2FnZToiICsgcGFzc2FnZS5uYW1lKTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgaWYgKHBhc3NhZ2UudGFncy5pbmNsdWRlcyhWQVJfVEFHKSkgewogICAgICAgIGFsZXJ0KCJERUxFVElORyBUSElTIFBBU1NBR0UgV0lMTCBSRVNVTFQgSU4gU1RPUlkgQlJFQUtBR0VcbkFCT1JUSU5HIERFTEVURSIpOwogICAgICB9IGVsc2UgewogICAgICAgIGlmIChwYXNzYWdlLnRhZ3MuaW5jbHVkZXMoJ3N0YXJ0JykpIHsKICAgICAgICAgIGFsZXJ0KCJEZWxldGluZyB0aGlzIHBhc3NhZ2Ugd2lsbCByYW5kb21seSBhc3NpZ24gYSBuZXcgc3RhcnQgcGFzc2FnZSwgc2VsZWN0IGEgc3RhcnQgcGFzc2FnZSBmcm9tIHRoZSBwYXNzYWdlcyBtZW51Iik7CiAgICAgICAgICB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpbmRleCArIDFdLnRhZ3MucHVzaCgic3RhcnQiKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzID0gdGhpcy5iYXNlU3RvcnkucGFzc2FnZXMuZmlsdGVyKGZ1bmN0aW9uIChwYXNzYWdlKSB7CiAgICAgICAgICByZXR1cm4gcGFzc2FnZS5uYW1lICE9IGV2ZW50Lm5hbWU7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMgPSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlcy5maWx0ZXIoZnVuY3Rpb24gKHBhZ2UpIHsKICAgICAgICAgIHJldHVybiBwYWdlLnBhZ2VOYW1lICE9IGV2ZW50Lm5hbWU7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5yZXBsYWNlTGlua3MoewogICAgICAgICAgcHJldk5hbWU6IGV2ZW50Lm5hbWUsCiAgICAgICAgICBuZXdOYW1lOiAiIgogICAgICAgIH0pOwogICAgICAgIHRoaXMucmVwYXJzZUxpbmtzKCk7CiAgICAgIH0KICAgIH0KICAgIC8qKiAKICAgICAqIENoYW5nZSB0aGUgZ2VuZXJhdGVkIHZhbHVlIG9mIGEgdGV4dCB2YXJpYWJsZQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gc2V0VGV4dFZhcmlhYmxlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdmFyaWFibGVOYW1lIC0gVmFyaWFibGUgTmFtZSB0byBjaGFuZ2UKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBuZXdUZXh0IC0gVGV4dCB0byBjaGFuZ2UgdGhlIHZhcmlhYmxlIHRvCiAgICAgKiBAcmV0dXJucyB7dm9pZH0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJzZXRUZXh0VmFyaWFibGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNldFRleHRWYXJpYWJsZSh2YXJpYWJsZU5hbWUsIG5ld1RleHQpIHsKICAgICAgdmFyIGRhdGEgPSB0aGlzLnZhcmlhYmxlcy5nZXQodmFyaWFibGVOYW1lKTsKICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoZGF0YSkpOwogICAgICBkYXRhLnZhbHVlID0gbmV3VGV4dDsKICAgICAgdGhpcy52YXJpYWJsZXMuc2V0KHZhcmlhYmxlTmFtZSwgZGF0YSk7CiAgICB9CiAgICAvKiogCiAgICAgKiBDaGFuZ2UgdGhlIGdlbmVyYXRlZCB2YWx1ZSBvZiBhIHRleHQgdmFyaWFibGUKICAgICAqIAogICAgICogQGZ1bmN0aW9uIHNldFRleHRWYXJpYWJsZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHZhcmlhYmxlTmFtZSAKICAgICAqIEBwYXJhbSB7RXZlbnR9IGRhdGEge30KICAgICAqIEByZXR1cm5zIHt2b2lkfQogICAgICovCgogIH0sIHsKICAgIGtleTogInNldEltYWdlVmFyaWFibGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNldEltYWdlVmFyaWFibGUodmFyaWFibGVOYW1lLCBkYXRhKSB7CiAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuc2V0KHZhcmlhYmxlTmFtZSwgZGF0YSk7CiAgICAgIHRoaXMucmVwYXJzZU1lZGlhKCk7IC8vdGhpcy5wcmludFZhcmlhYmxlRGF0YSgpOwogICAgfQogICAgLyoqIAogICAgICogQ2hhbmdlIHRoZSBnZW5lcmF0ZWQgdmFsdWUgb2YgYSB0ZXh0IHZhcmlhYmxlCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBzZXRUZXh0VmFyaWFibGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSB2YXJpYWJsZU5hbWUgCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBkYXRhIHt9CiAgICAgKiBAcmV0dXJucyB7dm9pZH0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJzZXRBdWRpb1ZhcmlhYmxlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRBdWRpb1ZhcmlhYmxlKHZhcmlhYmxlTmFtZSwgZGF0YSkgewogICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLnNldCh2YXJpYWJsZU5hbWUsIGRhdGEpOwogICAgICB0aGlzLnJlcGFyc2VNZWRpYSgpOyAvL3RoaXMucHJpbnRWYXJpYWJsZURhdGEoKTsKICAgIH0KICAgIC8qKgogICAgICogCiAgICAgKiBAZnVuY3Rpb24gY2hhbmdlVmFyaWFibGVOYW1lCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJjaGFuZ2VUZXh0VmFyaWFibGVOYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjaGFuZ2VUZXh0VmFyaWFibGVOYW1lKGV2ZW50KSB7CiAgICAgIHZhciBwcm9jZXNzID0gdGhpcy5jaGVja0V2ZW50KHsKICAgICAgICBuYW1lOiBldmVudC5uZXdOYW1lCiAgICAgIH0sICJ0ZXh0Iik7CgogICAgICBpZiAocHJvY2VzcykgewogICAgICAgIHRoaXMucmVwbGFjZVZhcmlhYmxlcyhldmVudCk7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLnZhcmlhYmxlcy5nZXQoZXZlbnQucHJldk5hbWUpOwogICAgICAgIHRoaXMudmFyaWFibGVzLmRlbGV0ZShldmVudC5wcmV2TmFtZSk7CiAgICAgICAgdGhpcy52YXJpYWJsZXMuc2V0KGV2ZW50Lm5ld05hbWUsIGRhdGEpOwogICAgICB9CgogICAgICByZXR1cm4gcHJvY2VzczsKICAgIH0KICAgIC8qKgogICAgICogCiAgICAgKiBAZnVuY3Rpb24gY2hhbmdlVmFyaWFibGVOYW1lCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJjaGFuZ2VJbWFnZVZhcmlhYmxlTmFtZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY2hhbmdlSW1hZ2VWYXJpYWJsZU5hbWUoZXZlbnQpIHsKICAgICAgdmFyIHByb2Nlc3MgPSB0aGlzLmNoZWNrRXZlbnQoewogICAgICAgIG5hbWU6IGV2ZW50Lm5ld05hbWUKICAgICAgfSwgIm1lZGlhIik7CiAgICAgIGNvbnNvbGUubG9nKCk7CgogICAgICBpZiAocHJvY2VzcykgewogICAgICAgIHRoaXMucmVwbGFjZVZhcmlhYmxlcyhldmVudCk7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmltYWdlVmFyaWFibGVzLmdldChldmVudC5wcmV2TmFtZSk7CiAgICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5kZWxldGUoZXZlbnQucHJldk5hbWUpOwogICAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuc2V0KGV2ZW50Lm5ld05hbWUsIGRhdGEpOwogICAgICAgIHRoaXMucmVwYXJzZU1lZGlhKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwcm9jZXNzOyAvL3RoaXMucHJpbnRWYXJpYWJsZURhdGEoKTsKICAgIH0KICAgIC8qKgogICAgICogCiAgICAgKiBAZnVuY3Rpb24gY2hhbmdlVmFyaWFibGVOYW1lCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJjaGFuZ2VBdWRpb1ZhcmlhYmxlTmFtZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gY2hhbmdlQXVkaW9WYXJpYWJsZU5hbWUoZXZlbnQpIHsKICAgICAgdmFyIHByb2Nlc3MgPSB0aGlzLmNoZWNrRXZlbnQoewogICAgICAgIG5hbWU6IGV2ZW50Lm5ld05hbWUKICAgICAgfSwgIm1lZGlhIik7CgogICAgICBpZiAocHJvY2VzcykgewogICAgICAgIHRoaXMucmVwbGFjZVZhcmlhYmxlcyhldmVudCk7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmF1ZGlvVmFyaWFibGVzLmdldChldmVudC5wcmV2TmFtZSk7CiAgICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcy5kZWxldGUoZXZlbnQucHJldk5hbWUpOwogICAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuc2V0KGV2ZW50Lm5ld05hbWUsIGRhdGEpOwogICAgICAgIHRoaXMucmVwYXJzZU1lZGlhKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwcm9jZXNzOyAvL3RoaXMucHJpbnRWYXJpYWJsZURhdGEoKTsKICAgIH0KICAgIC8qKgogICAgICogQWRkcyBhIHZhcmlhYmxlIHRvIHRoZSBzdG9yeQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gYWRkVmFyaWFibGUKICAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IAogICAgICovCgogIH0sIHsKICAgIGtleTogImFkZFRleHRWYXJpYWJsZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gYWRkVGV4dFZhcmlhYmxlKGV2ZW50KSB7CiAgICAgIHZhciBwcm9jZXNzID0gdGhpcy5jaGVja0V2ZW50KGV2ZW50LCAidGV4dCIpOwoKICAgICAgaWYgKHByb2Nlc3MpIHsKICAgICAgICB0aGlzLnZhcmlhYmxlcy5zZXQoZXZlbnQubmFtZSwgewogICAgICAgICAgdmFsdWU6IGV2ZW50LnZhbHVlLAogICAgICAgICAgY29sb3I6ICIiLAogICAgICAgICAgaWQ6IE5VTV9WQVJTKysKICAgICAgICB9KTsKICAgICAgICB0aGlzLmRldFZhcmlhYmxlQ29sb3JzKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwcm9jZXNzOwogICAgfQogICAgLyoqCiAgICAgKiBBZGRzIGFuIGltYWdlIHZhcmlhYmxlCiAgICAgKiBAZnVuY3Rpb24gYWRkSW1hZ2VWYXJpYWJsZQogICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQge25hbWU6IHZhck5hbWUsIGZpbGU6IG51bGwsIGZpbGVOYW1lOiAiIiwgcGF0aDogIiIsIGlkOiAiIn0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJhZGRJbWFnZVZhcmlhYmxlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRJbWFnZVZhcmlhYmxlKGV2ZW50KSB7CiAgICAgIHZhciBwcm9jZXNzID0gdGhpcy5jaGVja0V2ZW50KGV2ZW50LCAibWVkaWEiKTsKCiAgICAgIGlmIChwcm9jZXNzKSB7CiAgICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5zZXQoZXZlbnQubmFtZSwgewogICAgICAgICAgZmlsZTogZXZlbnQuZmlsZSwKICAgICAgICAgIGZpbGVOYW1lOiBldmVudC5maWxlTmFtZSwKICAgICAgICAgIHBhdGg6IGV2ZW50LnBhdGgsCiAgICAgICAgICBjb2xvcjogIiIsCiAgICAgICAgICBpZDogTlVNX0lNR19WQVJTKyssCiAgICAgICAgICB1cGxvYWRlZDogZXZlbnQudXBsb2FkZWQKICAgICAgICB9KTsgLy90aGlzLnByaW50VmFyaWFibGVEYXRhKCk7CgogICAgICAgIHRoaXMuZGV0VmFyaWFibGVDb2xvcnMoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHByb2Nlc3M7CiAgICB9CiAgICAvKioKICAgICAqIEFkZHMgYW4gaW1hZ2UgdmFyaWFibGUKICAgICAqIEBmdW5jdGlvbiBhZGRJbWFnZVZhcmlhYmxlCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCB7bmFtZTogdmFyTmFtZSwgZmlsZTogbnVsbCwgZmlsZU5hbWU6ICIiLCBwYXRoOiAiIiwgaWQ6ICIifQogICAgICovCgogIH0sIHsKICAgIGtleTogImFkZEF1ZGlvVmFyaWFibGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGFkZEF1ZGlvVmFyaWFibGUoZXZlbnQpIHsKICAgICAgdmFyIHByb2Nlc3MgPSB0aGlzLmNoZWNrRXZlbnQoZXZlbnQsICJtZWRpYSIpOwoKICAgICAgaWYgKHByb2Nlc3MpIHsKICAgICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLnNldChldmVudC5uYW1lLCB7CiAgICAgICAgICBmaWxlOiBldmVudC5maWxlLAogICAgICAgICAgZmlsZU5hbWU6IGV2ZW50LmZpbGVOYW1lLAogICAgICAgICAgcGF0aDogZXZlbnQucGF0aCwKICAgICAgICAgIGNvbG9yOiAiIiwKICAgICAgICAgIGlkOiBOVU1fQVVEX1ZBUlMrKywKICAgICAgICAgIHVwbG9hZGVkOiBldmVudC51cGxvYWRlZAogICAgICAgIH0pOyAvL3RoaXMucHJpbnRWYXJpYWJsZURhdGEoKTsKCiAgICAgICAgdGhpcy5kZXRWYXJpYWJsZUNvbG9ycygpOwogICAgICB9CgogICAgICByZXR1cm4gcHJvY2VzczsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJjaGVja0V2ZW50IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjaGVja0V2ZW50KGV2ZW50LCB0eXBlKSB7CiAgICAgIHZhciBwcm9jZXNzID0gZmFsc2U7CgogICAgICBpZiAodHlwZSA9PSAidGV4dCIpIHsKICAgICAgICBwcm9jZXNzID0gIXRoaXMudmFyaWFibGVzLmhhcyhldmVudC5uYW1lKTsKICAgICAgfSBlbHNlIGlmICh0eXBlID09ICJtZWRpYSIpIHsKICAgICAgICBwcm9jZXNzID0gISh0aGlzLmltYWdlVmFyaWFibGVzLmhhcyhldmVudC5uYW1lKSB8fCB0aGlzLmF1ZGlvVmFyaWFibGVzLmhhcyhldmVudC5uYW1lKSk7CiAgICAgIH0KCiAgICAgIGlmICghcHJvY2VzcykgewogICAgICAgIGFsZXJ0KGV2ZW50Lm5hbWUgKyAiIGFscmVhZHkgZXhpc3RzISIpOwogICAgICB9CgogICAgICByZXR1cm4gcHJvY2VzczsKICAgIH0KICAgIC8qKgogICAgICogUmVtb3ZlcyBhIHZhcmlhYmxlIGZyb20gdGhlIHN0b3J5CiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBkZWxldGVWYXJpYWJsZQogICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZGVsZXRlVGV4dFZhcmlhYmxlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkZWxldGVUZXh0VmFyaWFibGUoZXZlbnQpIHsKICAgICAgdmFyIGRhdGFBcnIgPSBbXTsKICAgICAgdGhpcy52YXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIGRhdGFBcnIucHVzaCh7CiAgICAgICAgICBuYW1lOiBrZXkKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbal0ucmVtb3ZlS2V5RnJvbVRleHQoZGF0YUFyciwgZXZlbnQubmFtZSk7CiAgICAgIH0KCiAgICAgIHRoaXMudmFyaWFibGVzLmRlbGV0ZShldmVudC5uYW1lKTsKICAgICAgdmFyIHNvcnRlZEtleXMgPSBbXTsKICAgICAgdGhpcy52YXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIHNvcnRlZEtleXMucHVzaChrZXkpOwogICAgICB9KTsKICAgICAgc29ydGVkS2V5cyA9IHNvcnRlZEtleXMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgIGlmIChhID4gYikgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfSBlbHNlIGlmIChhIDwgYikgewogICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0ZWRLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLnZhcmlhYmxlcy5nZXQoc29ydGVkS2V5c1tpXSk7CiAgICAgICAgZGF0YS5pZC0tOwogICAgICAgIHRoaXMudmFyaWFibGVzLnNldChzb3J0ZWRLZXlzW2ldLCBkYXRhKTsKICAgICAgfQoKICAgICAgTlVNX1ZBUlMtLTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJkZWxldGVJbWFnZVZhcmlhYmxlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkZWxldGVJbWFnZVZhcmlhYmxlKGV2ZW50KSB7CiAgICAgIHZhciBkYXRhQXJyID0gW107CiAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIGRhdGFBcnIucHVzaCh7CiAgICAgICAgICBuYW1lOiBrZXkKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIGRhdGFBcnIucHVzaCh7CiAgICAgICAgICBuYW1lOiBrZXkKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbal0ucmVtb3ZlS2V5RnJvbVRleHQoZGF0YUFyciwgZXZlbnQubmFtZSk7CiAgICAgIH0KCiAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuZGVsZXRlKGV2ZW50Lm5hbWUpOwogICAgICB2YXIgc29ydGVkS2V5cyA9IFtdOwogICAgICB0aGlzLmltYWdlVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBzb3J0ZWRLZXlzLnB1c2goa2V5KTsKICAgICAgfSk7CiAgICAgIHNvcnRlZEtleXMgPSBzb3J0ZWRLZXlzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICBpZiAoYSA+IGIpIHsKICAgICAgICAgIHJldHVybiAxOwogICAgICAgIH0gZWxzZSBpZiAoYSA8IGIpIHsKICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydGVkS2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBkYXRhID0gdGhpcy5pbWFnZVZhcmlhYmxlcy5nZXQoc29ydGVkS2V5c1tpXSk7CiAgICAgICAgZGF0YS5pZC0tOwogICAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuc2V0KHNvcnRlZEtleXNbaV0sIGRhdGEpOwogICAgICB9CgogICAgICBOVU1fSU1HX1ZBUlMtLTsKICAgICAgdGhpcy5yZXBhcnNlTWVkaWEoKTsgLy90aGlzLnByaW50VmFyaWFibGVEYXRhKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZGVsZXRlQXVkaW9WYXJpYWJsZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZGVsZXRlQXVkaW9WYXJpYWJsZShldmVudCkgewogICAgICB2YXIgZGF0YUFyciA9IFtdOwogICAgICB0aGlzLmltYWdlVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBkYXRhQXJyLnB1c2goewogICAgICAgICAgbmFtZToga2V5CiAgICAgICAgfSk7CiAgICAgIH0pOwogICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBkYXRhQXJyLnB1c2goewogICAgICAgICAgbmFtZToga2V5CiAgICAgICAgfSk7CiAgICAgIH0pOwoKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlcy5sZW5ndGg7IGorKykgewogICAgICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2pdLnJlbW92ZUtleUZyb21UZXh0KGRhdGFBcnIsIGV2ZW50Lm5hbWUpOwogICAgICB9CgogICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLmRlbGV0ZShldmVudC5uYW1lKTsKICAgICAgdmFyIHNvcnRlZEtleXMgPSBbXTsKICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgc29ydGVkS2V5cy5wdXNoKGtleSk7CiAgICAgIH0pOwogICAgICBzb3J0ZWRLZXlzID0gc29ydGVkS2V5cy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgaWYgKGEgPiBiKSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9IGVsc2UgaWYgKGEgPCBiKSB7CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvcnRlZEtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuYXVkaW9WYXJpYWJsZXMuZ2V0KHNvcnRlZEtleXNbaV0pOwogICAgICAgIGRhdGEuaWQtLTsKICAgICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLnNldChzb3J0ZWRLZXlzW2ldLCBkYXRhKTsKICAgICAgfQoKICAgICAgTlVNX0FVRF9WQVJTLS07CiAgICAgIHRoaXMucmVwYXJzZU1lZGlhKCk7IC8vdGhpcy5wcmludFZhcmlhYmxlRGF0YSgpOwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgdGhlIG5ldyB0ZXh0IGZvciBhIHBhc3NhZ2UgYW5kIHJlcGxhY2UgaXQgaW4gdGhlIHN0b3J5CiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBzZXRQYXNzYWdlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gcGFzc2FnZU5hbWUgLSBOYW1lIG9mIHRoZSBwYXNzYWdlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbmV3VGV4dCAtIE5ldyB0ZXh0IGZvciB0aGUgcGFzc2FnZQogICAgICogQHBhcmFtIHtTdHJpbmd9IGhpZGRlbiAtIFZhbHVlIHRvIHJlZ2VuZXJhdGUgc3RvcnkgdGV4dAogICAgICogQHJldHVybnMge3ZvaWR9CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAic2V0UGFzc2FnZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0UGFzc2FnZShwYXNzYWdlTmFtZSwgbmV3VGV4dCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2ldLm5hbWUgPT0gcGFzc2FnZU5hbWUpIHsKICAgICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2ldLnRleHQgPSBuZXdUZXh0OwogICAgICAgICAgY29uc29sZS5sb2coIlRleHQgQ2hhbmdlZCIpOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5yZXBhcnNlTGlua3MoKTsKICAgICAgdGhpcy5yZXBhcnNlTWVkaWEoKTsKICAgIH0KICAgIC8qKgogICAgICogQ2hhbmdlcyB0aGUgbmFtZSBvZiB0aGUgc3RvcnkKICAgICAqIAogICAgICogQGZ1bmN0aW9uIGNoYW5nZVN0b3J5TmFtZQogICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiY2hhbmdlU3RvcnlOYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjaGFuZ2VTdG9yeU5hbWUoZXZlbnQpIHsKICAgICAgdGhpcy5iYXNlU3RvcnkubmFtZSA9IGV2ZW50Lm5hbWU7CiAgICB9CiAgICAvKiogCiAgICAgKiBHZW5lcmF0ZSB0aGUgc3Rvcnkgd2l0aCB0aGUgcmV2aXNlZCB2YXJpYWJsZXMuCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBnZW5lcmF0ZVZpZXdTdG9yeQogICAgICogQHJldHVybnMge3ZvaWR9CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2VuZXJhdGVWaWV3U3RvcnkiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdlbmVyYXRlVmlld1N0b3J5KG1lZGlhKSB7CiAgICAgIC8vRXh0cmFjdCB0aGUgcGFzc2FnZSB3aXRoIHZhcmlhYmxlIHRhZywKICAgICAgLy9JTVBPUlRBTlQ6IFZBUl9UQUcgU0hPVUxEIE5PVCBCRSBVU0VEIERVUklORyBTVE9SWSBDUkVBVElPTgogICAgICAvLyAgICAgICAgICAgVEhJUyBQQVNTQUdFIFdJTEwgQkUgQVVUT01BVElDQUxMWSBHRU5FUkFURUQgQU5EIEFEREVEIAogICAgICAvLyAgICAgICAgICAgVE8gVEhFIEZJUlNUIFBBU1NBR0UgT0YgVEhFIFNUT1JZLgogICAgICB0aGlzLmNzcyA9ICIiOwogICAgICBjb25zb2xlLmxvZygiR2VuZXJhdGluZyBTdG9yeS4uLiIpOwogICAgICB2YXIgdmlld1N0b3J5ID0gbmV3IFN0b3J5KEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5iYXNlU3RvcnkpKSk7CiAgICAgIGNvbnNvbGUubG9nKHZpZXdTdG9yeS5uYW1lKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdmlld1N0b3J5LnBhc3NhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHBhc3NhZ2VPYmogPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLmxpbmtQYXNzYWdlKSk7CiAgICAgICAgdmlld1N0b3J5LnBhc3NhZ2VzW2ldID0gbmV3IFBhc3NhZ2UocGFzc2FnZU9iai5uYW1lLCBwYXNzYWdlT2JqLnRhZ3MsIHBhc3NhZ2VPYmoubWV0YWRhdGEsIHBhc3NhZ2VPYmoudGV4dCwgcGFzc2FnZU9iai5waWQpOwogICAgICAgIHZpZXdTdG9yeS5wYXNzYWdlc1tpXS50ZXh0ID0gdmlld1N0b3J5LnBhc3NhZ2VzW2ldLnRleHQudHJpbSgpOwoKICAgICAgICBpZiAodmlld1N0b3J5LnBhc3NhZ2VzW2ldLnRhZ3MuaW5jbHVkZXMoVkFSX1RBRykpIHsKICAgICAgICAgIC8vY29uc29sZS5sb2coIlRleHQgQ2hhbmdlZDoiICsgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV0udGV4dCk7CiAgICAgICAgICB2YXIgdGV4dFRvUHVzaCA9IHZpZXdTdG9yeS5wYXNzYWdlc1tpXS50ZXh0OwogICAgICAgICAgdmFyIHNvcnRlZEtleXMgPSBbXTsKICAgICAgICAgIHRoaXMudmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICAgICAgc29ydGVkS2V5cy5wdXNoKGtleSk7CiAgICAgICAgICB9KTsKICAgICAgICAgIHNvcnRlZEtleXMgPSBzb3J0ZWRLZXlzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICAgICAgcmV0dXJuIGEubGVuZ3RoIC0gYi5sZW5ndGg7CiAgICAgICAgICB9KTsKCiAgICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHNvcnRlZEtleXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgICAgLy9jb25zb2xlLmxvZygiS0VZOiAiICsgc29ydGVkS2V5c1tqXSkKICAgICAgICAgICAgLy9jb25zb2xlLmxvZygiS0VZOiAiICsga2V5ICsgIiBWQUxVRTogIiArIHZhbHVlKQogICAgICAgICAgICB2YXIga2V5ID0gc29ydGVkS2V5c1tqXTsKICAgICAgICAgICAgdmFyIHRlbXAgPSB0ZXh0VG9QdXNoLnNwbGl0KGtleSk7CiAgICAgICAgICAgIHZhciBkYXRhID0gdGhpcy52YXJpYWJsZXMuZ2V0KGtleSk7CiAgICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZW1wLmpvaW4oZGF0YS52YWx1ZSk7CiAgICAgICAgICB9CgogICAgICAgICAgdmlld1N0b3J5LnBhc3NhZ2VzW2ldLnRleHQgPSB0ZXh0VG9QdXNoICsgIlxuIiArIHRoaXMuaW5qZWN0VmFyaWFibGVUZXh0KCk7CiAgICAgICAgfQoKICAgICAgICBpZiAobWVkaWEpIHZpZXdTdG9yeS5wYXNzYWdlc1tpXS50ZXh0ID0gdGhpcy5pbmplY3RNZWRpYSh2aWV3U3RvcnkucGFzc2FnZXNbaV0udGV4dCk7CiAgICAgICAgdGhpcy5jc3MgKz0gdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0uaW5qZWN0Q1NTVGV4dCgpICsgJ1xuJzsKICAgICAgfQoKICAgICAgdGhpcy5jc3MgKz0gImJvZHl7IHRleHQtYWxpZ246IGNlbnRlcjt9IjsKICAgICAgcmV0dXJuIHZpZXdTdG9yeTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJpbmplY3RNZWRpYSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gaW5qZWN0TWVkaWEodGV4dFRvUHVzaCkgewogICAgICB2YXIgc29ydGVkS2V5cyA9IFtdOwogICAgICB0aGlzLmltYWdlVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBzb3J0ZWRLZXlzLnB1c2goa2V5KTsKICAgICAgfSk7CiAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIHNvcnRlZEtleXMucHVzaChrZXkpOwogICAgICB9KTsKICAgICAgc29ydGVkS2V5cyA9IHNvcnRlZEtleXMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHJldHVybiBiLmxlbmd0aCAtIGEubGVuZ3RoOwogICAgICB9KTsKCiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc29ydGVkS2V5cy5sZW5ndGg7IGorKykgewogICAgICAgIC8vY29uc29sZS5sb2coIktFWTogIiArIHNvcnRlZEtleXNbal0pCiAgICAgICAgLy9jb25zb2xlLmxvZygiS0VZOiAiICsga2V5ICsgIiBWQUxVRTogIiArIHZhbHVlKQogICAgICAgIHZhciBrZXkgPSBzb3J0ZWRLZXlzW2pdOwogICAgICAgIHZhciB0ZW1wID0gdGV4dFRvUHVzaC5zcGxpdChrZXkpOwogICAgICAgIHZhciBkYXRhID0gbnVsbDsKCiAgICAgICAgaWYgKHRoaXMuaW1hZ2VWYXJpYWJsZXMuaGFzKGtleSkpIHsKICAgICAgICAgIGRhdGEgPSB0aGlzLmltYWdlVmFyaWFibGVzLmdldChrZXkpOwogICAgICAgICAgdGV4dFRvUHVzaCA9IHRlbXAuam9pbigiPGltZyBzdHlsZSA9ICdtYXgtd2lkdGg6IDUwJTsgbWF4LWhlaWdodDo1MCU7JyBzcmMgPSAnIiArIGRhdGEucGF0aC5pICsgIicgYWx0ID0gIiArIGtleS5yZXBsYWNlKCJAIiwgIiIpICsgIi8+Iik7CiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmF1ZGlvVmFyaWFibGVzLmhhcyhrZXkpKSB7CiAgICAgICAgICBkYXRhID0gdGhpcy5hdWRpb1ZhcmlhYmxlcy5nZXQoa2V5KTsKICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZW1wLmpvaW4oIjxhdWRpbyBjb250cm9scz48c291cmNlIHNyYyA9ICciICsgZGF0YS5wYXRoLmkgKyAiJz4gWW91ciBCcm93c2VyIERvZXMgbm90IHN1cHBvcnQgdGhlIGF1ZGlvIGVsZW1lbnQgPC9hdWRpbz4iKTsKICAgICAgICB9IC8vdGV4dFRvUHVzaCA9IHRlbXAuam9pbigiPGltZyBzdHlsZSA9ICdtYXgtd2lkdGg6IDUwJTsgbWF4LWhlaWdodDo1MCU7JyBzcmMgPSAnIiArIGRhdGEucGF0aC5pICsgIicgYWx0ID0gIiArIGtleSArICIvPiIpOwoKICAgICAgICAvKmlmKGRhdGEudXBsb2FkZWQpIHsKICAgICAgICAgICAgCiAgICAgICAgfQogICAgICAgIGlmKCFkYXRhLnVwbG9hZGVkKSB7CiAgICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZW1wLmpvaW4oIjxpbWcgc3R5bGUgPSAnbWF4LXdpZHRoOiA1MCU7IG1heC1oZWlnaHQ6NTAlOycgc3JjID0gJyIgKyBkYXRhLnBhdGggKyAiJyBhbHQgPSAiICsga2V5ICsgIi8+Iik7CiAgICAgICAgfSovCgogICAgICB9CgogICAgICByZXR1cm4gdGV4dFRvUHVzaDsKICAgIH0KICAgIC8qKgogICAgICogR2VuZXJhdGVzIHZhcmlhYmxlIGluc2VydGlvbiB0ZXh0CiAgICAgKiAgCiAgICAgKiBAZnVuY3Rpb24gaW5qZWN0VmFyaWFibGVUZXh0CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiaW5qZWN0VmFyaWFibGVUZXh0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBpbmplY3RWYXJpYWJsZVRleHQoKSB7CiAgICAgIHZhciBpbmplY3QgPSAiIjsKICAgICAgdGhpcy52YXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAoZGF0YSwga2V5KSB7CiAgICAgICAgaW5qZWN0ICs9ICIoc2V0OiAiOwogICAgICAgIGluamVjdCArPSBrZXk7CiAgICAgICAgaW5qZWN0ICs9ICIgdG8gJnF1b3Q7IjsKICAgICAgICBpbmplY3QgKz0gZGF0YS52YWx1ZTsKICAgICAgICBpbmplY3QgKz0gIiZxdW90OylcbiI7CiAgICAgIH0pOwogICAgICBpbmplY3QgKz0gIihoaWRkZW46KVtpbWFnZToiOwogICAgICB0aGlzLmltYWdlVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKGRhdGEsIGtleSkgewogICAgICAgIC8vY29uc29sZS5sb2coa2V5ICsgIjogIiArIEpTT04uc3RyaW5naWZ5KGRhdGEpKTsKICAgICAgICBpbmplY3QgKz0ga2V5ICsgInsiICsgZGF0YS5wYXRoLmkgKyAiICIgKyBkYXRhLmZpbGVOYW1lICsgIn0sIjsKICAgICAgfSk7CiAgICAgIGluamVjdCArPSAiXVxuIjsKICAgICAgaW5qZWN0ICs9ICIoaGlkZGVuOilbYXVkaW86IjsKICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uIChkYXRhLCBrZXkpIHsKICAgICAgICBpbmplY3QgKz0ga2V5ICsgInsiICsgZGF0YS5wYXRoLmkgKyAiICIgKyBkYXRhLmZpbGVOYW1lICsgIn0sIjsKICAgICAgfSk7CiAgICAgIGluamVjdCArPSAiXVxuIjsKICAgICAgcmV0dXJuIGluamVjdDsKICAgIH0KICAgIC8qKgogICAgICogR2V0IGNsb3VkIHNhdmUgc3RvcnkKICAgICAqIAogICAgICogQGZ1bmN0aW9uIGdlbmVyYXRlU2F2ZVN0b3J5CiAgICAgKiBAcmV0dXJucyB7U3Rvcnl9IHN0b3J5IHRvIGJlIHB1c2hlZCB0byBjbG91ZDsKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZW5lcmF0ZVNhdmVTdG9yeSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2VuZXJhdGVTYXZlU3RvcnkoKSB7CiAgICAgIHRoaXMuY3NzID0gIiI7CiAgICAgIHZhciBjbG91ZFN0b3J5ID0gbmV3IFN0b3J5KEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5iYXNlU3RvcnkpKSk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGNsb3VkU3RvcnkucGFzc2FnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgcGFzc2FnZU9iaiA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ubGlua1Bhc3NhZ2UpKTsKICAgICAgICBjbG91ZFN0b3J5LnBhc3NhZ2VzW2ldID0gbmV3IFBhc3NhZ2UocGFzc2FnZU9iai5uYW1lLCBwYXNzYWdlT2JqLnRhZ3MsIHBhc3NhZ2VPYmoubWV0YWRhdGEsIHBhc3NhZ2VPYmoudGV4dCwgcGFzc2FnZU9iai5waWQpOwogICAgICAgIGNsb3VkU3RvcnkucGFzc2FnZXNbaV0udGV4dCA9IGNsb3VkU3RvcnkucGFzc2FnZXNbaV0udGV4dC50cmltKCk7CgogICAgICAgIGlmIChjbG91ZFN0b3J5LnBhc3NhZ2VzW2ldLnRhZ3MuaW5jbHVkZXMoVkFSX1RBRykpIHsKICAgICAgICAgIC8vY29uc29sZS5sb2coIlRleHQgQ2hhbmdlZDoiICsgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV0udGV4dCk7ICAgIAogICAgICAgICAgY2xvdWRTdG9yeS5wYXNzYWdlc1tpXS50ZXh0ID0gY2xvdWRTdG9yeS5wYXNzYWdlc1tpXS50ZXh0ICsgIlxuIiArIHRoaXMuaW5qZWN0VmFyaWFibGVUZXh0KCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNzcyArPSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5pbmplY3RDU1NUZXh0KCkgKyAnXG4nOwogICAgICB9CgogICAgICByZXR1cm4gY2xvdWRTdG9yeTsKICAgIH0KICAgIC8qKiAKICAgICAqIEdlbmVyYXRlIHRoZSBzdG9yeSB3aXRoIHRoZSByZXZpc2VkIHRleHQuCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBnZW5lcmF0ZVN0b3J5VGV4dAogICAgICogQHJldHVybnMge3ZvaWR9CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZ2VuZXJhdGVTdG9yeVRleHQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdlbmVyYXRlU3RvcnlUZXh0KGhpZGRlbiwgaW5WYXJpYWJsZXMsIGluTWVkaWEpIHsKICAgICAgLy90aGlzLmV4cG9ydGVkU3RvcnlUZXh0ID0gW107CiAgICAgIHZhciBzY3JpcHRQYXNzYWdlcyA9IHRoaXMuYmFzZVN0b3J5LmdldFN0b3J5UGFzc2FnZXMoKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc2NyaXB0UGFzc2FnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgdGV4dFRvUHVzaCA9IHNjcmlwdFBhc3NhZ2VzW2ldLnRleHQ7CiAgICAgICAgdGV4dFRvUHVzaCA9IHRoaXMucHJvY2Vzc1RleHRWYXJpYWJsZXModGV4dFRvUHVzaCwgaGlkZGVuLCBpblZhcmlhYmxlcyk7CiAgICAgICAgdGV4dFRvUHVzaCA9IHRoaXMucHJvY2Vzc01lZGlhVmFyaWFibGVzKHRleHRUb1B1c2gsIGhpZGRlbiwgaW5NZWRpYSk7CgogICAgICAgIHdoaWxlICh0ZXh0VG9QdXNoLmluY2x1ZGVzKCJdXSIpIHx8IHRleHRUb1B1c2guaW5jbHVkZXMoIltbIikpIHsKICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZXh0VG9QdXNoLnJlcGxhY2UoJ1tbJywgIjx1PiIpOwogICAgICAgICAgdGV4dFRvUHVzaCA9IHRleHRUb1B1c2gucmVwbGFjZSgnXV0nLCAiPC91PiIpOwogICAgICAgIH0KCiAgICAgICAgd2hpbGUgKHRleHRUb1B1c2guaW5jbHVkZXMoIiZxdW90OyIpIHx8IHRleHRUb1B1c2guaW5jbHVkZXMoIiYjMzk7IikgfHwgdGV4dFRvUHVzaC5pbmNsdWRlcygiJmd0OyIpIHx8IHRleHRUb1B1c2guaW5jbHVkZXMoIiZsdDsiKSkgewogICAgICAgICAgdGV4dFRvUHVzaCA9IHRleHRUb1B1c2gucmVwbGFjZSgiJnF1b3Q7IiwgIlwiIik7CiAgICAgICAgICB0ZXh0VG9QdXNoID0gdGV4dFRvUHVzaC5yZXBsYWNlKCImIzM5OyIsICInIik7CiAgICAgICAgICB0ZXh0VG9QdXNoID0gdGV4dFRvUHVzaC5yZXBsYWNlKCImbHQ7IiwgIjwiKTsKICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZXh0VG9QdXNoLnJlcGxhY2UoIiZndDsiLCAiPiIpOwogICAgICAgIH0gLy90ZXh0VG9QdXNoID0gdGV4dFRvUHVzaC5yZXBsYWNlKC8oXHJcbnxccnxcbil7Mix9L2csICdcbicpOwoKCiAgICAgICAgdmFyIG5QYXNzYWdlID0gbmV3IFBhc3NhZ2Uoc2NyaXB0UGFzc2FnZXNbaV0ubmFtZSwgc2NyaXB0UGFzc2FnZXNbaV0udGFncywgc2NyaXB0UGFzc2FnZXNbaV0ubWV0YWRhdGEsIHRleHRUb1B1c2gsIHNjcmlwdFBhc3NhZ2VzW2ldLnBpZCk7CiAgICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0uZGlzcFBhc3NhZ2UgPSBuUGFzc2FnZTsKICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5wYWdlTmFtZSA9IG5QYXNzYWdlLm5hbWU7CiAgICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0uc3RvcnkgPSB0aGlzLmJhc2VTdG9yeTsKICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5wYWdlcyA9IHRoaXMuYmFzZVN0b3J5LmdldFN0b3J5UGFzc2FnZXMoKS5sZW5ndGg7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJwcm9jZXNzVGV4dFZhcmlhYmxlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcHJvY2Vzc1RleHRWYXJpYWJsZXModGV4dFRvUHVzaCwgaGlkZGVuLCBpblZhcmlhYmxlcykgewogICAgICB2YXIgc29ydGVkS2V5cyA9IFtdOwogICAgICB0aGlzLnZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgc29ydGVkS2V5cy5wdXNoKGtleSk7CiAgICAgIH0pOwogICAgICBzb3J0ZWRLZXlzID0gc29ydGVkS2V5cy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgcmV0dXJuIGIubGVuZ3RoIC0gYS5sZW5ndGg7CiAgICAgIH0pOwoKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBzb3J0ZWRLZXlzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgLy9jb25zb2xlLmxvZygiS0VZOiAiICsgc29ydGVkS2V5c1tqXSkKICAgICAgICAvL2NvbnNvbGUubG9nKCJLRVk6ICIgKyBrZXkgKyAiIFZBTFVFOiAiICsgdmFsdWUpCiAgICAgICAgdmFyIGtleSA9IHNvcnRlZEtleXNbal07CiAgICAgICAgdmFyIHRlbXAgPSB0ZXh0VG9QdXNoLnNwbGl0KGtleSk7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLnZhcmlhYmxlcy5nZXQoa2V5KTsKCiAgICAgICAgaWYgKCFoaWRkZW4pIHsKICAgICAgICAgIGlmIChpblZhcmlhYmxlcykgewogICAgICAgICAgICB0ZXh0VG9QdXNoID0gdGVtcC5qb2luKCI8c3BhbiBzdHlsZSA9ICdjb2xvcjoiICsgZGF0YS5jb2xvciArICI7Jz48c3Ryb25nPigiICsga2V5LnJlcGxhY2UoIiQiLCAiIikgKyAiKTwvc3Ryb25nPjwvc3Bhbj4iICsgZGF0YS52YWx1ZSk7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0ZXh0VG9QdXNoID0gdGVtcC5qb2luKCI8c3Bhbj4oIiArIGtleS5yZXBsYWNlKCIkIiwgIiIpICsgIik8L3NwYW4+IiArIGRhdGEudmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoaW5WYXJpYWJsZXMpIHsKICAgICAgICAgICAgdGV4dFRvUHVzaCA9IHRlbXAuam9pbigiPHNwYW4gc3R5bGUgPSAnY29sb3I6IiArIGRhdGEuY29sb3IgKyAiOyc+PHN0cm9uZz4iICsgZGF0YS52YWx1ZSArICI8L3N0cm9uZz48L3NwYW4+Iik7CiAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0ZXh0VG9QdXNoID0gdGVtcC5qb2luKCI8c3Bhbj4iICsgZGF0YS52YWx1ZSArICI8L3NwYW4+Iik7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CgogICAgICByZXR1cm4gdGV4dFRvUHVzaDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJwcm9jZXNzTWVkaWFWYXJpYWJsZXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHByb2Nlc3NNZWRpYVZhcmlhYmxlcyh0ZXh0VG9QdXNoLCBoaWRkZW4sIGluTWVkaWEpIHsKICAgICAgdmFyIHNvcnRlZEtleXMgPSBbXTsKICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgc29ydGVkS2V5cy5wdXNoKGtleSk7CiAgICAgIH0pOwogICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBzb3J0ZWRLZXlzLnB1c2goa2V5KTsKICAgICAgfSk7CiAgICAgIHNvcnRlZEtleXMgPSBzb3J0ZWRLZXlzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gYi5sZW5ndGggLSBhLmxlbmd0aDsKICAgICAgfSk7CgogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHNvcnRlZEtleXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAvL2NvbnNvbGUubG9nKCJLRVk6ICIgKyBzb3J0ZWRLZXlzW2pdKQogICAgICAgIC8vY29uc29sZS5sb2coIktFWTogIiArIGtleSArICIgVkFMVUU6ICIgKyB2YWx1ZSkKICAgICAgICB2YXIga2V5ID0gc29ydGVkS2V5c1tqXTsKICAgICAgICB2YXIgdGVtcCA9IHRleHRUb1B1c2guc3BsaXQoa2V5KTsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuaW1hZ2VWYXJpYWJsZXMuaGFzKGtleSkgPyB0aGlzLmltYWdlVmFyaWFibGVzLmdldChrZXkpIDogdGhpcy5hdWRpb1ZhcmlhYmxlcy5nZXQoa2V5KTsKICAgICAgICB2YXIgdmFsdWUgPSAiIjsKCiAgICAgICAgaWYgKGRhdGEuZmlsZU5hbWUubGVuZ3RoID4gMzApIHsKICAgICAgICAgIHZhbHVlID0gZGF0YS5maWxlTmFtZS5zdWJzdHIoMCwgMzApICsgIi4uLiI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhbHVlID0gZGF0YS5maWxlTmFtZTsKICAgICAgICB9CgogICAgICAgIGlmICh2YWx1ZSA9PSAiIikgewogICAgICAgICAgdmFsdWUgPSAiTm8gRmlsZSBVcGxvYWRlZCI7CiAgICAgICAgfQoKICAgICAgICBpZiAoIWhpZGRlbikgewogICAgICAgICAgaWYgKGluTWVkaWEpIHsKICAgICAgICAgICAgdGV4dFRvUHVzaCA9IHRlbXAuam9pbigiPHNwYW4gc3R5bGUgPSAnY29sb3I6IiArIGRhdGEuY29sb3IgKyAiOyc+PHN0cm9uZz4oIiArIGtleS5yZXBsYWNlKCJAIiwgIiIpICsgIik8L3N0cm9uZz48L3NwYW4+IiArIHZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZW1wLmpvaW4oIjxzcGFuPigiICsga2V5LnJlcGxhY2UoIkAiLCAiIikgKyAiKTwvc3Bhbj4iICsgdmFsdWUpOwogICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBpZiAoaW5NZWRpYSkgewogICAgICAgICAgICB0ZXh0VG9QdXNoID0gdGVtcC5qb2luKCI8c3BhbiBzdHlsZSA9ICdjb2xvcjoiICsgZGF0YS5jb2xvciArICI7Jz48c3Ryb25nPigiICsgdmFsdWUgKyAiKTwvc3Ryb25nPjwvc3Bhbj4iKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZW1wLmpvaW4oIjxzcGFuPigiICsgdmFsdWUgKyAiKTwvc3Bhbj4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0ZXh0VG9QdXNoOwogICAgfQogIH0sIHsKICAgIGtleTogImdlbmVyYXRlUHVibGlzaFN0b3J5IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZW5lcmF0ZVB1Ymxpc2hTdG9yeSgpIHsKICAgICAgdGhpcy5jc3MgPSAiIjsKICAgICAgdmFyIGNsb3VkU3RvcnkgPSBuZXcgU3RvcnkoSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLmJhc2VTdG9yeSkpKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2xvdWRTdG9yeS5wYXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBwYXNzYWdlT2JqID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5saW5rUGFzc2FnZSkpOwogICAgICAgIGNsb3VkU3RvcnkucGFzc2FnZXNbaV0gPSBuZXcgUGFzc2FnZShwYXNzYWdlT2JqLm5hbWUsIHBhc3NhZ2VPYmoudGFncywgcGFzc2FnZU9iai5tZXRhZGF0YSwgcGFzc2FnZU9iai50ZXh0LCBwYXNzYWdlT2JqLnBpZCk7CiAgICAgICAgY2xvdWRTdG9yeS5wYXNzYWdlc1tpXS50ZXh0ID0gY2xvdWRTdG9yeS5wYXNzYWdlc1tpXS50ZXh0LnRyaW0oKTsKCiAgICAgICAgaWYgKGNsb3VkU3RvcnkucGFzc2FnZXNbaV0udGFncy5pbmNsdWRlcyhWQVJfVEFHKSkgewogICAgICAgICAgLy9jb25zb2xlLmxvZygiVGV4dCBDaGFuZ2VkOiIgKyB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS50ZXh0KTsgICAgCiAgICAgICAgICBjbG91ZFN0b3J5LnBhc3NhZ2VzW2ldLnRleHQgPSBjbG91ZFN0b3J5LnBhc3NhZ2VzW2ldLnRleHQgKyAiXG4iICsgdGhpcy5pbmplY3RQdWJsaXNoVmFyaWFibGVUZXh0KCk7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmNzcyArPSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5pbmplY3RDU1NUZXh0KCkgKyAnXG4nOwogICAgICB9CgogICAgICB0aGlzLmNzcyArPSAiYm9keXsgdGV4dC1hbGlnbjogY2VudGVyO30iOwogICAgICByZXR1cm4gY2xvdWRTdG9yeTsKICAgIH0KICAgIC8qKgogICAgKiBHZW5lcmF0ZXMgdmFyaWFibGUgaW5zZXJ0aW9uIHRleHQKICAgICogIAogICAgKiBAZnVuY3Rpb24gaW5qZWN0VmFyaWFibGVUZXh0CiAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJpbmplY3RQdWJsaXNoVmFyaWFibGVUZXh0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBpbmplY3RQdWJsaXNoVmFyaWFibGVUZXh0KCkgewogICAgICB2YXIgaW5qZWN0ID0gIiI7CiAgICAgIHRoaXMudmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKGRhdGEsIGtleSkgewogICAgICAgIGluamVjdCArPSAiKHNldDogIjsKICAgICAgICBpbmplY3QgKz0ga2V5OwogICAgICAgIGluamVjdCArPSAiIHRvICZxdW90OyI7CiAgICAgICAgaW5qZWN0ICs9ICIoIiArIGtleS5yZXBsYWNlKCIkIiwgIiIpICsgIikiOwogICAgICAgIGluamVjdCArPSAiJnF1b3Q7KVxuIjsKICAgICAgfSk7CiAgICAgIGluamVjdCArPSAiKGhpZGRlbjopW2ltYWdlOiI7CiAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAoZGF0YSwga2V5KSB7CiAgICAgICAgLy9jb25zb2xlLmxvZyhrZXkgKyAiOiAiICsgSlNPTi5zdHJpbmdpZnkoZGF0YSkpOwogICAgICAgIGluamVjdCArPSBrZXkgKyAieyB9LCI7CiAgICAgIH0pOwogICAgICBpbmplY3QgKz0gIl1cbiI7CiAgICAgIGluamVjdCArPSAiKGhpZGRlbjopW2F1ZGlvOiI7CiAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAoZGF0YSwga2V5KSB7CiAgICAgICAgaW5qZWN0ICs9IGtleSArICJ7IH0sIjsKICAgICAgfSk7CiAgICAgIGluamVjdCArPSAiXVxuIjsKICAgICAgcmV0dXJuIGluamVjdDsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJkZXN0cm95IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkZXN0cm95KCkgewogICAgICAvKnRoaXMuaW1hZ2VWYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbihkYXRhKXsKICAgICAgICAgIGlmKGRhdGEucGF0aC5pbmNsdWRlcygiYmxvYiIpKXsKICAgICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKGRhdGEucGF0aCk7CiAgICAgICAgICAgICAgZGF0YS5wYXRoID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICAKICAgICAgfSk7CiAgICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24oZGF0YSl7CiAgICAgICAgICBpZihkYXRhLnBhdGguaW5jbHVkZXMoImJsb2IiKSl7CiAgICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTChkYXRhLnBhdGgpOwogICAgICAgICAgICAgIGRhdGEucGF0aCA9ICIiOwogICAgICAgICAgfQogICAgICAgICAgCiAgICAgIH0pOyovCiAgICB9CiAgfV0pOwoKICByZXR1cm4gU3RvcnlFZGl0b3I7Cn0oKTsKCm1vZHVsZS5leHBvcnRzID0gU3RvcnlFZGl0b3I7"},{"version":3,"sources":["/Users/justinwu/Desktop/story_personalization_system/src/js/extwee_utils/StoryEditor.js"],"names":["Passage","require","Page","Story","VAR_TAG","NUM_VARS","NUM_IMG_VARS","NUM_AUD_VARS","StoryEditor","story","baseStory","exportedStoryPages","variables","Map","imageVariables","audioVariables","css","js","regeneratePages","parseVariables","generateStoryText","reparseMedia","line","pos1","indexOf","pos2","lastIndexOf","slice","newVal","length","pos","variable","charAt","variablePassage","passages","filter","passage","results","tags","tag","clear","variableText","text","lines","split","console","log","j","includes","extractVariable","defVal","extractDefault","has","alert","set","value","color","id","varData","extractArr","type","k","data","imgSrc","extractSrc","substring","file","fileName","name","path","src","uploaded","i","a","audSrc","l","join","Error","detVariableColors","printVariableData","source","chunk","replace","arr","sessionStorage","getItem","process","linkPassage","detTextVariableColors","detImageVariableColors","detAudioVariableColors","sortedKeys","forEach","key","push","varMap","sort","b","idA","get","idB","oR","oG","oB","randR","Math","random","randG","randB","JSON","stringify","reparseLinks","event","pageName","addAudio","removeAudio","addImage","removeImage","replaceLinks","mergedMap","replaceVariable","addLink","removeLink","remText","baseText","prevLink","nLinkPassage","position","size","getStoryPassages","pages","prevName","newName","index","page","variableName","newText","checkEvent","replaceVariables","delete","dataArr","removeKeyFromText","passageName","media","viewStory","parse","passageObj","metadata","pid","trim","textToPush","temp","injectVariableText","injectMedia","injectCSSText","inject","cloudStory","hidden","inVariables","inMedia","scriptPassages","processTextVariables","processMediaVariables","nPassage","dispPassage","substr","injectPublishVariableText","module","exports"],"mappings":"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","sourcesContent":["const Passage = require(\"./Passage\");\nconst Page = require(\"./Page\");\nconst Story = require(\"./Story\");\n\nconst VAR_TAG = 'variables';\n\n/*const SWATCHES = [\"#33658A\" , \"#86BBD8\", \"#2F4858\", \"#F6AE2D\", \"#F26419\", \"#8AAA79\", \"#FA8334\", \"#FFFD77\",\n                    \"#FFE882\", \"#388697\", \"#271033\", \"#50514F\", \"#F79256\", \"#FBD1A2\", \"#7DCFB6\", \"#00B2CA\",\n                    \"#1D4E89\", \"#7E78D2\", \"#E71D36\", \"#AF4319\", \"#772014\", \"#3F220F\", \"#19180A\", \"#C0F8D1\"];*/\n\nvar NUM_VARS = 0;\nvar NUM_IMG_VARS = 0;\nvar NUM_AUD_VARS = 0;\n\n/**\n * @class StoryEditor\n * @module StoryEditor\n */\nclass StoryEditor {\n    /**\n     * @function StoryEditor\n     * @param {Story} story - The story to generate\n     * @class StoryEditor\n     */\n    constructor(story) {\n\n        this.baseStory = story;\n        this.exportedStoryPages = [];\n\n        this.variables = new Map();\n        this.imageVariables = new Map();\n        this.audioVariables = new Map();\n\n        this.css = \"\";\n        this.js = \"\";\n        \n        this.regeneratePages();\n\n        this.parseVariables();\n        this.generateStoryText(true);\n\n        this.reparseMedia();\n    }\n\n    /** \n     * Get the default value of a text variable\n     * \n     * @function extractDefault\n     * @param {string} line - Line to extract from\n     * @returns {String}\n     */\n    extractDefault(line) {\n\n        var pos1 = line.indexOf(\";\");\n        var pos2 = line.lastIndexOf(\"&\");\n\n        return line.slice(pos1 + 1, pos2);\n\n    }\n\n    /**\n     * Changes the value of the variable\n     * \n     * @param {String} line - Line to splice into\n     * @param {String} newVal - Value to splice\n     * @returns {String}\n     */\n    writeVariable(line, newVal) {\n        var pos1 = line.indexOf(\";\");\n        var pos2 = line.lastIndexOf(\"&\");\n\n        return line.slice(0, pos1 + 1) + newVal + line.slice(pos2, line.length);\n\n    }\n\n    /** \n     * Get the default name of a text variable\n     * \n     * @function extractVariable\n     * @param {String} line - Line to extract from\n     * @returns {String}\n     */\n    extractVariable(line) {\n        var pos = line.indexOf(\"$\");\n\n        var variable = \"\";\n\n        while ((line.charAt(pos)) != \" \") {\n            variable += line.charAt(pos);\n            pos++;\n        }\n\n        return variable;\n    }\n\n    /** \n     * Obtain all the variables from a story object\n     * \n     * @function parseVariables\n     * @returns {void}\n     */\n    parseVariables() {\n\n        //Extract the passage with variable tag,\n        //IMPORTANT: VAR_TAG SHOULD NOT BE USED DURING STORY CREATION\n        //           THIS PASSAGE WILL BE AUTOMATICALLY GENERATED AND ADDED \n        //           TO THE FIRST PASSAGE OF THE STORY.\n        let variablePassage = [];\n\n        if (this.baseStory.passages.length > 0) {\n            variablePassage = this.baseStory.passages.filter(function (passage) {\n                const results = passage.tags.filter(tag => tag === VAR_TAG);\n\n                return (results.length > 0);\n            });\n        }\n\n        this.variables.clear();\n        //Checks if there is only one passage with the variable tag\n\n        if (variablePassage.length == 1) {\n            var variableText = variablePassage[0].text;\n            var lines = variableText.split(\"\\n\");\n\n            console.log(lines.length);\n\n            for (var j = 0; j < lines.length; j++) {\n\n                if (lines[j].includes(\"(set:\")) {\n\n                    //Adds each variable to a js Map\n\n                    var variable = this.extractVariable(lines[j]);\n                    var defVal = this.extractDefault(lines[j]);\n                    \n                    if(this.variables.has(variable)){\n                        alert(\"Duplicate Variable \\n\\nUpdating Value to: \" + \"\\\"\" + defVal + \"\\\"\");\n                    }\n\n\n                    this.variables.set(variable, {value: defVal, color: \"\", id: NUM_VARS++});\n                    console.log(variable + \" \" + defVal);\n\n                } else if(lines[j].includes(\"(hidden:)\")){\n                    var varData = this.extractArr(lines[j]); \n\n                    if(varData.type == \"image\"){\n\n                        for(var k = 0; k < varData.data.length; k++){\n                            var imgSrc = this.extractSrc(varData.data[k]);\n\n                            this.imageVariables.set(varData.data[k].substring(0, varData.data[k].indexOf(\"{\")), {file: null, fileName: imgSrc.name, path: imgSrc.src, color: \"\", id: NUM_IMG_VARS++, uploaded: !imgSrc.src.i.includes(\"blob\")});\n                        }\n                    } else if(varData.type == \"audio\"){\n\n                        for(var a = 0; a < varData.data.length; a++){\n                            var audSrc = this.extractSrc(varData.data[a]);\n\n                            this.audioVariables.set(varData.data[a].substring(0, varData.data[a].indexOf(\"{\")), {file: null, fileName: imgSrc.name, path: audSrc.src, color: \"\", id: NUM_AUD_VARS++, uploaded: !audSrc.src.i.includes(\"blob\")});\n                        }\n\n                    }\n\n                }\n\n            }\n\n            lines = lines.filter(function(line) {\n                return !line.includes(\"(set:\") && !line.includes(\"(hidden:)\");  \n            });\n            \n            for(var l = 0; l<  this.baseStory.passages.length; l++){\n                if(this.baseStory.passages[l].tags.includes(VAR_TAG)){\n\n                    this.baseStory.passages[l].text = lines.join(\"\\n\");\n\n                    break;\n                }\n            }\n        } else {\n            throw new Error(\"Please remove extra variable passage tags\");\n        }\n\n        this.detVariableColors();\n        this.printVariableData();\n    }\n\n    /**\n     * Extracts the image variable data in the story\n     * \n     * @function extractArr\n     * @param {String} line \n     */\n    extractArr(line){\n        var source = line.split(\"[\");\n        var chunk = source[1].replace(\"]\", \"\");\n        source = chunk.split(\":\");\n\n        var type = source[0];\n        var arr = chunk.replace(source[0] + \":\", \"\").split(\",\");\n\n        arr = arr.filter(function(i){\n            return i != \"\";\n        })\n\n        console.log(arr);\n\n        return {type: type, data: arr};\n    }\n\n    extractSrc(line){\n        var source = line.split(\"{\");\n\n        var src = \"\";\n        var fileName = \"\";\n\n        if(source.length > 1){\n            src = source[1].split(\" \")[0];\n            fileName = source[1].split(\" \")[1].replace(\"}\", \"\");\n        }\n\n        return {src: {i: src}, name: fileName};\n    }\n\n    /**\n     * Removes the variable code injection\n     * \n     * @function removeVariableInject\n     * \n     */\n    removeVariableInject(){\n\n        var text = sessionStorage.getItem(\"preProcessedBaseText\");\n        var process = text != \"\";\n\n        if(process){\n            for(var k = 0; k< this.baseStory.passages.length; k++){\n                if(this.baseStory.passages[k].tags.includes(VAR_TAG)){\n                \n                    \n                    this.baseStory.passages[k].text = text;\n\n                    break;\n                }\n            }\n\n            for(var i = 0; i< this.exportedStoryPages.length; i++){\n                if(this.exportedStoryPages[i].linkPassage.tags.includes(VAR_TAG)){\n\n                    this.exportedStoryPages[i].linkPassage.text = text;\n                    break;\n                }\n            }\n        }\n\n        /*let variablePassage = [];\n\n        if (this.baseStory.passages.length > 0) {\n            variablePassage = this.baseStory.passages.filter(function (passage) {\n                const results = passage.tags.filter(tag => tag === VAR_TAG);\n\n                return (results.length > 0);\n            });\n        }\n\n        //Checks if there is only one passage with the variable tag\n\n        if (variablePassage.length == 1) {\n            var variableText = variablePassage[0].text;\n            var lines = variableText.split(\"\\n\");\n\n            lines = lines.filter(function(line) {\n                return !line.includes(\"(set:\");  \n            });\n            \n            for(var k = 0; k< this.baseStory.passages.length; k++){\n                if(this.baseStory.passages[k].tags.includes(VAR_TAG)){\n                    this.baseStory.passages[k].text = lines.join(\"\\n\");\n\n                    break;\n                }\n            }\n        } else {\n            throw new Error(\"Please remove extra variable passage tags\");\n        }*/\n    }\n\n    detVariableColors(){\n        this.detTextVariableColors();\n        this.detImageVariableColors();\n        this.detAudioVariableColors();\n    }\n\n    detImageVariableColors(){\n        var sortedKeys = [];\n\n\t\tthis.imageVariables.forEach(\n\t\t\tfunction(value, key){\n\t\t\t\tsortedKeys.push(key);\n\t\t\t}\n        );\n        \n        var varMap = this.imageVariables;\n\n\t\tsortedKeys = sortedKeys.sort(function(a, b){\n            var idA = varMap.get(a).id;\n            var idB = varMap.get(b).id;\n\n            return idA - idB;\n            \n        });\n        \n\n        for(var i = 0; i < sortedKeys.length; i++){\n            var data = this.imageVariables.get(sortedKeys[i]);\n\n\n            if(data.color == \"\"){\n                var oR = 255;\n                var oG = 165;\n                var oB = 0;\n\n                var randR = Math.random() * 256\n                var randG = Math.random() * 256;\n                var randB = Math.random() * 256;\n\n                data.color = \"rgb(\" + ((oR + randR)/2) + \",\" + ((oG + randG)/2) + \",\" + ((oB + randB)/2) + \")\";\n            }\n\n            this.imageVariables.set(sortedKeys[i], data);\n        }\n    }\n\n    detAudioVariableColors(){\n        var sortedKeys = [];\n\n\t\tthis.audioVariables.forEach(\n\t\t\tfunction(value, key){\n\t\t\t\tsortedKeys.push(key);\n\t\t\t}\n        );\n        \n        var varMap = this.audioVariables;\n\n\t\tsortedKeys = sortedKeys.sort(function(a, b){\n            var idA = varMap.get(a).id;\n            var idB = varMap.get(b).id;\n\n            return idA - idB;\n            \n        });\n        \n\n        for(var i = 0; i < sortedKeys.length; i++){\n            var data = this.audioVariables.get(sortedKeys[i]);\n\n\n            if(data.color == \"\"){\n                var oR = 255;\n                var oG = 165;\n                var oB = 0;\n\n                var randR = Math.random() * 256\n                var randG = Math.random() * 256;\n                var randB = Math.random() * 256;\n\n                data.color = \"rgb(\" + ((oR + randR)/2) + \",\" + ((oG + randG)/2) + \",\" + ((oB + randB)/2) + \")\";\n            }\n\n\n\n            this.audioVariables.set(sortedKeys[i], data);\n        }\n    }\n    /**\n     * Determines the swatch of the variable\n     * \n     * @function detVariableColors\n     * \n     */\n    detTextVariableColors(){\n        var sortedKeys = [];\n\n\t\tthis.variables.forEach(\n\t\t\tfunction(value, key){\n\t\t\t\tsortedKeys.push(key);\n\t\t\t}\n        );\n        \n        var varMap = this.variables;\n\n\t\tsortedKeys = sortedKeys.sort(function(a, b){\n            var idA = varMap.get(a).id;\n            var idB = varMap.get(b).id;\n\n            return idA - idB;\n            \n        });\n        \n\n        for(var i = 0; i < sortedKeys.length; i++){\n            var data = this.variables.get(sortedKeys[i]);\n\n\n            if(data.color == \"\"){\n                var oR = 255;\n                var oG = 165;\n                var oB = 0;\n\n                var randR = Math.random() * 256\n                var randG = Math.random() * 256;\n                var randB = Math.random() * 256;\n\n                data.color = \"rgb(\" + ((oR + randR)/2) + \",\" + ((oG + randG)/2) + \",\" + ((oB + randB)/2) + \")\";\n            }\n\n\n\n            this.variables.set(sortedKeys[i], data);\n        }\n\t\t\n    }\n\n    printVariableData(){\n        this.imageVariables.forEach(function(data, key){\n            console.log(key + \"==>\" + JSON.stringify(data));\n        });\n\n        this.audioVariables.forEach(function(data, key){\n            console.log(key + \"==>\" + JSON.stringify(data));\n        });\n\n        this.variables.forEach(function(data, key){\n            console.log(key + \"==>\" + JSON.stringify(data));\n        });\n    }\n\n    /**\n     * Reparses the links in the passage text\n     * @function reparseLinks\n     */\n    reparseLinks(){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n            this.exportedStoryPages[i].reparseLinks();\n        }\n    }\n\n    /**\n     * \n     */\n    reparseMedia(){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n            this.exportedStoryPages[i].reparseMedia(this.imageVariables, this.audioVariables);\n        }\n    }\n\n    /**\n     * \n     * @param {*} event \n     */\n    addAudioToPage(event){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n            if(this.exportedStoryPages[i].pageName == event.pageName)\n                this.exportedStoryPages[i].addAudio(event);\n        }\n        \n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    /**\n     * \n     * @param {*} event \n     */\n    removeAudioFromPage(event){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n            if(this.exportedStoryPages[i].pageName == event.pageName)\n                this.exportedStoryPages[i].removeAudio(event);\n        }\n        \n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    /**\n     * \n     * @param {*} event \n     */\n    addImageToPage(event){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n            if(this.exportedStoryPages[i].pageName == event.pageName)\n                this.exportedStoryPages[i].addImage(event);\n        }\n\n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    /**\n     * \n     * @param {*} event \n     */\n    removeImageFromPage(event){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n            if(this.exportedStoryPages[i].pageName == event.pageName)\n                this.exportedStoryPages[i].removeImage(event);\n        }\n\n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n\n    /**\n     * Refactors the link text so that it is properly configured\n     * \n     * @function replaceLinks\n     * @param {Event} event \n     */\n    replaceLinks(event){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n\n            this.exportedStoryPages[i].replaceLinks(event);\n\n            for(var j = 0; j < this.baseStory.passages.length; j++){\n                if(this.baseStory.passages[j].name == this.exportedStoryPages[i].linkPassage.name){\n                    this.baseStory.passages[j].text = this.exportedStoryPages[i].linkPassage.text;\n                }\n            }\n        }\n    }\n\n    /**\n     * Refactors the link text so that it is properly configured\n     * \n     * @function replaceLinks\n     * @param {Event} event \n     */\n    replaceVariables(event){\n\n        var mergedMap = new Map();\n\n        this.variables.forEach(function(value, key){\n            mergedMap.set(key, value);\n        });\n\n        this.imageVariables.forEach(function(value, key){\n            mergedMap.set(key, value);\n        });\n\n        this.audioVariables.forEach(function(value, key){\n            mergedMap.set(key, value);\n        });\n\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n\n            this.exportedStoryPages[i].replaceVariable(event, mergedMap);\n\n            for(var j = 0; j < this.baseStory.passages.length; j++){\n                if(this.baseStory.passages[j].name == this.exportedStoryPages[i].linkPassage.name){\n                    this.baseStory.passages[j].text = this.exportedStoryPages[i].linkPassage.text;\n                }\n            }\n        }\n\n        /*for(var m = 0; m < this.exportedStoryPages.length; m++){\n\n            this.exportedStoryPages[m].replaceVariable(event, this.imageVariables);\n\n            for(var n = 0; n < this.baseStory.passages.length; n++){\n                if(this.baseStory.passages[n].name == this.exportedStoryPages[m].linkPassage.name){\n                    this.baseStory.passages[n].text = this.exportedStoryPages[m].linkPassage.text;\n                }\n            }\n        }\n\n        for(var k = 0; k < this.exportedStoryPages.length; k++){\n\n            this.exportedStoryPages[k].replaceVariable(event, this.audioVariables);\n\n            for(var l = 0; l < this.baseStory.passages.length; l++){\n                if(this.baseStory.passages[l].name == this.exportedStoryPages[k].linkPassage.name){\n                    this.baseStory.passages[l].text = this.exportedStoryPages[k].linkPassage.text;\n                }\n            }\n        }*/\n\n        //this.printVariableData();\n    }\n\n    /**\n     * Programmatically adds a link to a page\n     * \n     * @function addLink\n     * @param {Event} event - data\n     */\n    addLink(event){\n\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n\n            if(this.exportedStoryPages[i].pageName == event.pageName){\n                this.exportedStoryPages[i].addLink(event.name);\n                break;\n            }\n            \n        }\n\n        this.reparseLinks();\n        //this.printVariableData();\n    }\n\n    /**\n     * Removes a link from a page\n     * \n     * @function removeLink\n     * @param {Event} event - data\n     */\n    removeLink(event){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n\n            if(this.exportedStoryPages[i].pageName == event.name){\n                this.exportedStoryPages[i].removeLink(event.removeLink);\n                break;\n            }\n            \n        }\n\n        this.reparseLinks();\n    }\n\n    /**\n     * Sets the start page for the story\n     * \n     * @function setStartPage\n     * @param {Event} event - data\n     */\n    setStartPage(event){\n\n        for(var i = 0; i < this.baseStory.passages.length; i++){\n            if(this.baseStory.passages[i].tags.includes(\"start\")){\n                this.baseStory.passages[i].tags = this.baseStory.passages[i].tags.filter(function(tag){\n                    return tag != \"start\";\n                });\n            } \n\n            if(this.baseStory.passages[i].tags.includes(VAR_TAG)){\n                this.baseStory.passages[i].tags = this.baseStory.passages[i].tags.filter(function(tag){\n                    return tag != VAR_TAG;\n                });\n            } \n\n            if(this.baseStory.passages[i].name == event.name){\n                this.baseStory.passages[i].tags.push(\"start\");\n                this.baseStory.passages[i].tags.push(VAR_TAG);\n            }\n            \n            \n            var remText = this.baseStory.passages[i].text;\n            var source = remText.split(\"\\n\");\n            \n            source = source.filter(function(line) {\n                return !line.includes(\"(set:\");  \n            });\n            \n            this.baseStory.passages[i].text = source.join(\"\\n\");\n        }\n\n        \n    }\n    \n    /**\n     * Adds a new page to the story\n     * \n     * @function addPage\n     * @param {Event} event \n     */\n    addPage(event){\n        var pageName = event.name;  \n        \n        var process = true;\n\n        if(process){\n            var baseText = \"This is a new passage. Edit it to create your own story!\\n[[go back-&gt;\" + event.prevLink + \"]]\";\n\n            var nLinkPassage = new Passage(pageName, [\"story\"], {position:\"500, 500\", size:\"100,100\"}, baseText, this.baseStory.passages.length + 1);\n            this.baseStory.passages.push(nLinkPassage);\n\n            this.exportedStoryPages.push(new Page(null, nLinkPassage, \"background-color: #ffffff; color: #000000;\", this.baseStory.getStoryPassages().length, {story: this.baseStory, pages: this.baseStory.getStoryPassages().length}));\n\n            this.reparseLinks();\n            this.reparseMedia();\n        }\n    }\n\n    /**\n     * Resets all the pages in the story\n     * \n     * @function regeneratePages\n     */\n    regeneratePages(){\n        this.exportedStoryPages = [];\n        var length = this.baseStory.getStoryPassages().length;\n\n        for(var i = 0; i < length; i++){\n            this.exportedStoryPages.push(new Page(null, this.baseStory.getStoryPassages()[i], \"background-color: #ffffff; color: #000000;\", i + 1, {story: this.baseStory, pages: length}));\n        }\n    }\n\n    /**\n     * Safely changes the passage name\n     * \n     * @function changePassageName\n     * @param {Event} event \n     */\n    changePassageName(event){\n            \n        if(event.prevName != event.newName){\n            for(var i = 0; i < this.baseStory.passages.length; i++){\n                if(this.baseStory.passages[i].name == event.prevName){\n                    this.baseStory.passages[i].name = event.newName;\n                    console.log(\"Changed Name\");\n                }\n            }\n\n            for(var j = 0; j < this.exportedStoryPages.length; j++){\n                if(this.exportedStoryPages[j].linkPassage.name == event.prevName){\n                    this.exportedStoryPages[j].linkPassage.name = event.newName;\n                    console.log(\"Changed Name\");\n                }\n            }\n\n            this.replaceLinks(event);\n            this.reparseLinks();\n        }\n    }\n\n    /**\n     * Removes a passage from the story;\n     * @function deletePassage\n     * @param {Event} event \n     */\n    deletePassage(event){\n\n        var passage;\n        var index = 0;\n\n        for(var i = 0; i< this.baseStory.passages.length; i++){\n            if(this.baseStory.passages[i].name == event.name){\n                passage = this.baseStory.passages[i];\n                index = i;\n\n                console.log(\"Passage:\" + passage.name);\n\n                break;\n            }\n        }\n\n        if(passage.tags.includes(VAR_TAG)){\n            alert(\"DELETING THIS PASSAGE WILL RESULT IN STORY BREAKAGE\\nABORTING DELETE\");\n        } else {\n            \n            if(passage.tags.includes('start')){\n                alert(\"Deleting this passage will randomly assign a new start passage, select a start passage from the passages menu\");\n                this.baseStory.passages[index + 1].tags.push(\"start\");\n            }\n            \n            this.baseStory.passages = this.baseStory.passages.filter(function(passage){\n                return passage.name != event.name;\n            });\n\n            this.exportedStoryPages = this.exportedStoryPages.filter(function(page){\n                return page.pageName != event.name;\n            });\n\n            this.replaceLinks({prevName: event.name, newName: \"\"});\n            this.reparseLinks();\n        }\n\n    }\n\n    /** \n     * Change the generated value of a text variable\n     * \n     * @function setTextVariable\n     * @param {String} variableName - Variable Name to change\n     * @param {String} newText - Text to change the variable to\n     * @returns {void}\n     */\n    setTextVariable(variableName, newText) {\n        var data = this.variables.get(variableName);\n        \n        console.log(JSON.stringify(data));\n\n        data.value = newText;\n\n        this.variables.set(variableName, data);\n    }\n\n\n    /** \n     * Change the generated value of a text variable\n     * \n     * @function setTextVariable\n     * @param {String} variableName \n     * @param {Event} data {}\n     * @returns {void}\n     */\n    setImageVariable(variableName, data){\n        this.imageVariables.set(variableName, data);\n\n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    /** \n     * Change the generated value of a text variable\n     * \n     * @function setTextVariable\n     * @param {String} variableName \n     * @param {Event} data {}\n     * @returns {void}\n     */\n    setAudioVariable(variableName, data){\n        this.audioVariables.set(variableName, data);\n\n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    /**\n     * \n     * @function changeVariableName\n     * @param {Event} event \n     */\n    changeTextVariableName(event){\n        var process = this.checkEvent({name: event.newName}, \"text\");\n\n        if(process){\n            this.replaceVariables(event);\n\n            var data = this.variables.get(event.prevName);\n            this.variables.delete(event.prevName);\n            this.variables.set(event.newName, data);\n        }\n\n        return process;\n\n    }\n\n    /**\n     * \n     * @function changeVariableName\n     * @param {Event} event \n     */\n    changeImageVariableName(event){\n        var process = this.checkEvent({name: event.newName}, \"media\");\n\n        console.log()\n\n        if(process){\n            this.replaceVariables(event);\n\n            var data = this.imageVariables.get(event.prevName);\n            this.imageVariables.delete(event.prevName);\n            this.imageVariables.set(event.newName, data);\n\n            this.reparseMedia();\n        }\n\n        return process;\n            //this.printVariableData();\n    }\n\n    /**\n     * \n     * @function changeVariableName\n     * @param {Event} event \n     */\n    changeAudioVariableName(event){\n\n        var process = this.checkEvent({name: event.newName}, \"media\");\n\n        if(process){\n            this.replaceVariables(event);\n\n            var data = this.audioVariables.get(event.prevName);\n            this.audioVariables.delete(event.prevName);\n            this.audioVariables.set(event.newName, data);\n\n            this.reparseMedia();\n        }\n\n        return process;\n        //this.printVariableData();\n    }\n    \n    /**\n     * Adds a variable to the story\n     * \n     * @function addVariable\n     * @param {Event} event \n     */\n    addTextVariable(event){\n        \n        var process = this.checkEvent(event, \"text\");\n\n        if(process){\n            this.variables.set(event.name, {value: event.value, color: \"\", id: NUM_VARS++});\n\n            this.detVariableColors();\n        }\n\n        return process;\n    }\n\n    /**\n     * Adds an image variable\n     * @function addImageVariable\n     * @param {Event} event {name: varName, file: null, fileName: \"\", path: \"\", id: \"\"}\n     */\n    addImageVariable(event){\n\n        var process = this.checkEvent(event, \"media\");\n        if(process){\n            this.imageVariables.set(event.name, {file: event.file, fileName: event.fileName, path: event.path, color: \"\", id: NUM_IMG_VARS++, uploaded: event.uploaded});\n            //this.printVariableData();\n\n            this.detVariableColors();\n        }\n\n        return process;\n    }\n\n    /**\n     * Adds an image variable\n     * @function addImageVariable\n     * @param {Event} event {name: varName, file: null, fileName: \"\", path: \"\", id: \"\"}\n     */\n    addAudioVariable(event){\n        var process = this.checkEvent(event, \"media\");\n        if(process){\n            this.audioVariables.set(event.name, {file: event.file, fileName: event.fileName, path: event.path, color: \"\", id: NUM_AUD_VARS++, uploaded: event.uploaded});\n            //this.printVariableData();\n\n            this.detVariableColors();\n        }\n\n        return process;\n    }\n\n    checkEvent(event, type){\n\n        var process = false;\n\n        if(type == \"text\"){\n            process = !(this.variables.has(event.name));\n        } else if(type == \"media\"){\n            process = !((this.imageVariables.has(event.name)) || (this.audioVariables.has(event.name)));\n        }\n\n        if(!process){\n            alert(event.name + \" already exists!\");\n        }\n\n        return process;\n    }\n\n    /**\n     * Removes a variable from the story\n     * \n     * @function deleteVariable\n     * @param {Event} event \n     */\n    deleteTextVariable(event){\n\n        var dataArr = [];\n\n        this.variables.forEach(\n            function(value, key){\n                dataArr.push({name: key});\n            }\n        );\n\n        for(var j = 0; j < this.exportedStoryPages.length; j++){\n            this.exportedStoryPages[j].removeKeyFromText(dataArr, event.name);\n        }\n        \n        this.variables.delete(event.name);\n\n        var sortedKeys = [];\n\n\t\tthis.variables.forEach(\n\t\t\tfunction(value, key){\n\t\t\t\tsortedKeys.push(key);\n\t\t\t}\n\t\t);\n\n\t\tsortedKeys = sortedKeys.sort(function(a, b){\n            if(a > b){\n                return 1;\n            } else if(a < b){\n                return -1;\n            } else {\n                return 0;\n            }\n            \n        });\n        \n\n        for(var i = 0; i < sortedKeys.length; i++){\n            var data = this.variables.get(sortedKeys[i]);\n            data.id--;\n            this.variables.set(sortedKeys[i], data);\n        }\n        \n\n        NUM_VARS--;\n\n    }\n\n    deleteImageVariable(event){\n\n        var dataArr = [];\n\n        this.imageVariables.forEach(\n            function(value, key){\n                dataArr.push({name: key});\n            }\n        );\n\n        this.audioVariables.forEach(\n            function(value, key){\n                dataArr.push({name: key});\n            }\n        );\n\n        for(var j = 0; j < this.exportedStoryPages.length; j++){\n            this.exportedStoryPages[j].removeKeyFromText(dataArr, event.name);\n        }\n        \n        this.imageVariables.delete(event.name);\n\n        var sortedKeys = [];\n\n\t\tthis.imageVariables.forEach(\n\t\t\tfunction(value, key){\n\t\t\t\tsortedKeys.push(key);\n\t\t\t}\n\t\t);\n\n\t\tsortedKeys = sortedKeys.sort(function(a, b){\n            if(a > b){\n                return 1;\n            } else if(a < b){\n                return -1;\n            } else {\n                return 0;\n            }\n            \n        });\n        \n\n        for(var i = 0; i < sortedKeys.length; i++){\n            var data = this.imageVariables.get(sortedKeys[i]);\n            data.id--;\n            this.imageVariables.set(sortedKeys[i], data);\n        }\n\n        NUM_IMG_VARS--;\n\n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    deleteAudioVariable(event){\n\n        var dataArr = [];\n\n        this.imageVariables.forEach(\n            function(value, key){\n                dataArr.push({name: key});\n            }\n        );\n\n        this.audioVariables.forEach(\n            function(value, key){\n                dataArr.push({name: key});\n            }\n        );\n\n        for(var j = 0; j < this.exportedStoryPages.length; j++){\n            this.exportedStoryPages[j].removeKeyFromText(dataArr, event.name);\n        }\n\n        this.audioVariables.delete(event.name);\n\n        var sortedKeys = [];\n\n\t\tthis.audioVariables.forEach(\n\t\t\tfunction(value, key){\n\t\t\t\tsortedKeys.push(key);\n\t\t\t}\n\t\t);\n\n\t\tsortedKeys = sortedKeys.sort(function(a, b){\n            if(a > b){\n                return 1;\n            } else if(a < b){\n                return -1;\n            } else {\n                return 0;\n            }\n            \n        });\n        \n\n        for(var i = 0; i < sortedKeys.length; i++){\n            var data = this.audioVariables.get(sortedKeys[i]);\n            data.id--;\n            this.audioVariables.set(sortedKeys[i], data);\n        }\n\n        NUM_AUD_VARS--;\n\n\n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    /**\n     * Get the new text for a passage and replace it in the story\n     * \n     * @function setPassage\n     * @param {String} passageName - Name of the passage\n     * @param {String} newText - New text for the passage\n     * @param {String} hidden - Value to regenerate story text\n     * @returns {void}\n     */\n    setPassage(passageName, newText){\n        for(var i = 0; i < this.baseStory.passages.length; i++){\n            if(this.baseStory.passages[i].name == passageName){\n                this.baseStory.passages[i].text = newText;\n\n                console.log(\"Text Changed\");\n\n            }\n            \n        }\n\n        this.reparseLinks();\n        this.reparseMedia();\n    }\n\n    /**\n     * Changes the name of the story\n     * \n     * @function changeStoryName\n     * @param {Event} event \n     */\n    changeStoryName(event){\n        this.baseStory.name = event.name;\n    }\n\n\n    /** \n     * Generate the story with the revised variables.\n     * \n     * @function generateViewStory\n     * @returns {void}\n     */\n    generateViewStory(media) {\n        //Extract the passage with variable tag,\n        //IMPORTANT: VAR_TAG SHOULD NOT BE USED DURING STORY CREATION\n        //           THIS PASSAGE WILL BE AUTOMATICALLY GENERATED AND ADDED \n        //           TO THE FIRST PASSAGE OF THE STORY.\n\n        this.css = \"\";\n\n        console.log(\"Generating Story...\");\n\n        var viewStory = new Story(JSON.parse(JSON.stringify(this.baseStory)));\n\n        console.log(viewStory.name);\n\n        for(var i = 0; i < viewStory.passages.length; i++){\n            \n            var passageObj = JSON.parse(JSON.stringify(this.exportedStoryPages[i].linkPassage));\n\n            viewStory.passages[i] = new Passage(passageObj.name, passageObj.tags, passageObj.metadata, passageObj.text, passageObj.pid);\n\n            viewStory.passages[i].text = viewStory.passages[i].text.trim();\n\n            if(viewStory.passages[i].tags.includes(VAR_TAG)){\n                \n                //console.log(\"Text Changed:\" + this.baseStory.passages[i].text);\n                var textToPush = viewStory.passages[i].text;\n            \n                var sortedKeys = [];\n\n                this.variables.forEach(\n                    function(value, key){\n                        sortedKeys.push(key);\n                    }\n                );\n\n                sortedKeys = sortedKeys.sort(function(a, b){\n                    return a.length - b.length;\n                });            \n\n                for(var j = 0; j < sortedKeys.length; j++){\n                    \n                    //console.log(\"KEY: \" + sortedKeys[j])\n\n                        //console.log(\"KEY: \" + key + \" VALUE: \" + value)\n                    var key = sortedKeys[j];    \n                    var temp = textToPush.split(key);\n                    var data = this.variables.get(key);\n                    \n                    textToPush = temp.join(data.value);\n                   \n                }\n                \n                \n                viewStory.passages[i].text = textToPush +  \"\\n\"  + this.injectVariableText();\n            } \n\n            if(media)\n                viewStory.passages[i].text = this.injectMedia(viewStory.passages[i].text);\n\n            this.css += this.exportedStoryPages[i].injectCSSText() + '\\n';\n        }\n\n        this.css += \"body{ text-align: center;}\"\n\n        return viewStory;\n\n    }\n\n    injectMedia(textToPush){\n\n        var sortedKeys = [];\n\n        this.imageVariables.forEach(\n            function(value, key){\n                sortedKeys.push(key);\n            }\n        );\n\n        this.audioVariables.forEach(\n            function(value, key){\n                sortedKeys.push(key);\n            }\n        )\n\n        sortedKeys = sortedKeys.sort(function(a, b){\n            return b.length - a.length;\n        });            \n\n        for(var j = 0; j < sortedKeys.length; j++){\n            \n            //console.log(\"KEY: \" + sortedKeys[j])\n\n                //console.log(\"KEY: \" + key + \" VALUE: \" + value)\n            var key = sortedKeys[j];    \n            var temp = textToPush.split(key);\n            \n            var data = null;\n\n            if(this.imageVariables.has(key)){\n                data = this.imageVariables.get(key);\n                \n                textToPush = temp.join(\"<img style = 'max-width: 50%; max-height:50%;' src = '\" + data.path.i + \"' alt = \" + key.replace(\"@\", \"\") + \"/>\");\n\n            } else if(this.audioVariables.has(key)){\n                data = this.audioVariables.get(key);\n\n                textToPush = temp.join(\"<audio controls><source src = '\" + data.path.i + \"'> Your Browser Does not support the audio element </audio>\");\n            }\n\n            //textToPush = temp.join(\"<img style = 'max-width: 50%; max-height:50%;' src = '\" + data.path.i + \"' alt = \" + key + \"/>\");\n            \n            /*if(data.uploaded) {\n                \n            }\n            if(!data.uploaded) {\n                textToPush = temp.join(\"<img style = 'max-width: 50%; max-height:50%;' src = '\" + data.path + \"' alt = \" + key + \"/>\");\n            }*/\n        }\n\n        return textToPush;\n    }\n\n\n    /**\n     * Generates variable insertion text\n     *  \n     * @function injectVariableText\n     */\n    injectVariableText(){\n        var inject = \"\";\n\n        this.variables.forEach(function(data, key){\n            inject += \"(set: \";\n            inject += key;\n            inject += \" to &quot;\";\n            inject += data.value;\n            inject += \"&quot;)\\n\"\n        });\n        \n        inject += \"(hidden:)[image:\"\n\n        this.imageVariables.forEach(function(data, key){\n            //console.log(key + \": \" + JSON.stringify(data));\n\n            inject += key + \"{\" + data.path.i + \" \" + data.fileName + \"},\"\n        });\n\n        inject += \"]\\n\"\n\n        inject += \"(hidden:)[audio:\"\n\n        this.audioVariables.forEach(function(data, key){\n\n            inject += key + \"{\" + data.path.i + \" \" + data.fileName + \"},\"\n\n        });\n\n        inject += \"]\\n\"\n\n        return inject;\n        \n    }\n\n\n    /**\n     * Get cloud save story\n     * \n     * @function generateSaveStory\n     * @returns {Story} story to be pushed to cloud;\n     */\n    generateSaveStory(){\n\n        this.css = \"\";\n\n        var cloudStory = new Story(JSON.parse(JSON.stringify(this.baseStory)));\n\n        for(var i = 0; i < cloudStory.passages.length; i++){\n\n            var passageObj = JSON.parse(JSON.stringify(this.exportedStoryPages[i].linkPassage));\n\n            cloudStory.passages[i] = new Passage(passageObj.name, passageObj.tags, passageObj.metadata, passageObj.text, passageObj.pid);\n\n            cloudStory.passages[i].text = cloudStory.passages[i].text.trim();\n\n            if(cloudStory.passages[i].tags.includes(VAR_TAG)){\n                \n                //console.log(\"Text Changed:\" + this.baseStory.passages[i].text);    \n                cloudStory.passages[i].text = cloudStory.passages[i].text +  \"\\n\"  + this.injectVariableText();\n            } \n            \n            this.css += this.exportedStoryPages[i].injectCSSText() + '\\n';\n        }\n\n        return cloudStory;\n    }\n\n\n    /** \n     * Generate the story with the revised text.\n     * \n     * @function generateStoryText\n     * @returns {void}\n     */\n    generateStoryText(hidden, inVariables, inMedia) {\n\n        //this.exportedStoryText = [];\n\n        let scriptPassages = this.baseStory.getStoryPassages();\n\n        for (var i = 0; i < scriptPassages.length; i++) {\n\n            var textToPush = scriptPassages[i].text;\n\n            textToPush = this.processTextVariables(textToPush, hidden, inVariables);\n            textToPush = this.processMediaVariables(textToPush, hidden, inMedia);\n            \n            while(textToPush.includes(\"]]\") || textToPush.includes(\"[[\")){ \n                textToPush = textToPush.replace('[[', \"<u>\");\n                textToPush = textToPush.replace(']]', \"</u>\");\n            }\n            \n\n            while (textToPush.includes(\"&quot;\") || textToPush.includes(\"&#39;\") || textToPush.includes(\"&gt;\") || textToPush.includes(\"&lt;\")) {\n                textToPush = textToPush.replace(\"&quot;\", \"\\\"\");\n                textToPush = textToPush.replace(\"&#39;\", \"'\");\n                textToPush = textToPush.replace(\"&lt;\", \"<\");\n                textToPush = textToPush.replace(\"&gt;\", \">\");\n            }\n            \n            //textToPush = textToPush.replace(/(\\r\\n|\\r|\\n){2,}/g, '\\n');\n\n            var nPassage = new Passage(scriptPassages[i].name, \n                scriptPassages[i].tags, scriptPassages[i].metadata, textToPush, scriptPassages[i].pid);\n\n            this.exportedStoryPages[i].dispPassage = nPassage;\n            this.exportedStoryPages[i].pageName = nPassage.name;\n            this.exportedStoryPages[i].story = this.baseStory;\n            this.exportedStoryPages[i].pages = this.baseStory.getStoryPassages().length;\n\n        }\n    }\n\n\n    processTextVariables(textToPush, hidden, inVariables){\n        var sortedKeys = [];\n\n        this.variables.forEach(\n            function(value, key){\n                sortedKeys.push(key);\n            }\n        );\n\n        sortedKeys = sortedKeys.sort(function(a, b){\n            return b.length - a.length;\n        });            \n\n        for(var j = 0; j < sortedKeys.length; j++){\n            \n            //console.log(\"KEY: \" + sortedKeys[j])\n\n                //console.log(\"KEY: \" + key + \" VALUE: \" + value)\n            var key = sortedKeys[j];    \n            var temp = textToPush.split(key);\n            var data = this.variables.get(key);\n\n            if(!hidden){\n                if(inVariables){\n                    textToPush = temp.join(\"<span style = 'color:\" + data.color + \";'><strong>(\" + key.replace(\"$\", \"\") + \")</strong></span>\" + data.value);\n                } else {\n                    textToPush = temp.join(\"<span>(\" + key.replace(\"$\", \"\") + \")</span>\" + data.value);\n                }\n            } else {\n                if(inVariables){\n                    textToPush = temp.join(\"<span style = 'color:\" + data.color + \";'><strong>\" + data.value + \"</strong></span>\");\n                } else{\n                    textToPush = temp.join(\"<span>\" + data.value + \"</span>\");   \n                }\n            }\n            \n        }\n\n        return textToPush;\n    }\n\n\n    processMediaVariables(textToPush, hidden, inMedia){\n        \n        var sortedKeys = [];\n\n        this.imageVariables.forEach(\n            function(value, key){\n                sortedKeys.push(key);\n            }\n        );\n\n        this.audioVariables.forEach(\n            function(value, key){\n                sortedKeys.push(key);\n            }\n        );\n\n        sortedKeys = sortedKeys.sort(function(a, b){\n            return b.length - a.length;\n        });            \n\n        for(var j = 0; j < sortedKeys.length; j++){\n            \n            //console.log(\"KEY: \" + sortedKeys[j])\n\n                //console.log(\"KEY: \" + key + \" VALUE: \" + value)\n            var key = sortedKeys[j];    \n            var temp = textToPush.split(key);\n            var data = this.imageVariables.has(key) ? this.imageVariables.get(key) : this.audioVariables.get(key);\n            \n            var value = \"\";\n\n            if(data.fileName.length > 30){\n                value = data.fileName.substr(0, 30) + \"...\";\n            } else {\n                value = data.fileName;\n            }\n\n            if(value == \"\"){\n                value = \"No File Uploaded\";\n            }\n\n            if(!hidden){\n                if(inMedia){\n                    textToPush = temp.join(\"<span style = 'color:\" + data.color + \";'><strong>(\" + key.replace(\"@\", \"\") + \")</strong></span>\" + value);\n                } else {\n                    textToPush = temp.join(\"<span>(\" + key.replace(\"@\", \"\") + \")</span>\" + value);\n                }\n            } else {\n                if(inMedia){\n                    textToPush = temp.join(\"<span style = 'color:\" + data.color + \";'><strong>(\" + value + \")</strong></span>\");\n                } else {\n                    textToPush = temp.join(\"<span>(\" + value + \")</span>\");\n                }\n            }\n            \n        }\n\n        return textToPush;\n    }\n\n    generatePublishStory(){\n        this.css = \"\";\n\n        var cloudStory = new Story(JSON.parse(JSON.stringify(this.baseStory)));\n\n        for(var i = 0; i < cloudStory.passages.length; i++){\n\n            var passageObj = JSON.parse(JSON.stringify(this.exportedStoryPages[i].linkPassage));\n\n            cloudStory.passages[i] = new Passage(passageObj.name, passageObj.tags, passageObj.metadata, passageObj.text, passageObj.pid);\n\n            cloudStory.passages[i].text = cloudStory.passages[i].text.trim();\n\n            if(cloudStory.passages[i].tags.includes(VAR_TAG)){\n                \n                //console.log(\"Text Changed:\" + this.baseStory.passages[i].text);    \n                cloudStory.passages[i].text = cloudStory.passages[i].text +  \"\\n\"  + this.injectPublishVariableText();\n            } \n            \n            this.css += this.exportedStoryPages[i].injectCSSText() + '\\n';\n        }\n\n        this.css += \"body{ text-align: center;}\"\n\n        return cloudStory;\n    }\n\n      /**\n     * Generates variable insertion text\n     *  \n     * @function injectVariableText\n     */\n    injectPublishVariableText(){\n        var inject = \"\";\n\n        this.variables.forEach(function(data, key){\n            inject += \"(set: \";\n            inject += key;\n            inject += \" to &quot;\";\n            inject += \"(\" + key.replace(\"$\", \"\") + \")\";\n            inject += \"&quot;)\\n\"\n        });\n        \n        inject += \"(hidden:)[image:\"\n\n        this.imageVariables.forEach(function(data, key){\n            //console.log(key + \": \" + JSON.stringify(data));\n\n            inject += key + \"{ },\"\n        });\n\n        inject += \"]\\n\"\n\n        inject += \"(hidden:)[audio:\"\n\n        this.audioVariables.forEach(function(data, key){\n\n            inject += key + \"{ },\"\n\n        });\n\n        inject += \"]\\n\"\n\n        return inject;\n        \n    }\n\n\n    destroy(){\n        /*this.imageVariables.forEach(function(data){\n            if(data.path.includes(\"blob\")){\n                URL.revokeObjectURL(data.path);\n                data.path = \"\";\n            }\n            \n        });\n\n        this.audioVariables.forEach(function(data){\n            if(data.path.includes(\"blob\")){\n                URL.revokeObjectURL(data.path);\n                data.path = \"\";\n            }\n            \n        });*/\n    }\n}\n\nmodule.exports = StoryEditor;\n"]}]}