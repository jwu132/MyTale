{"remainingRequest":"/Users/justinwu/Desktop/Gitlab_MyTale/mytale/node_modules/babel-loader/lib/index.js!/Users/justinwu/Desktop/Gitlab_MyTale/mytale/node_modules/eslint-loader/index.js??ref--13-0!/Users/justinwu/Desktop/Gitlab_MyTale/mytale/src/js/extwee_utils/StoryEditor.js","dependencies":[{"path":"/Users/justinwu/Desktop/Gitlab_MyTale/mytale/src/js/extwee_utils/StoryEditor.js","mtime":1604692362843},{"path":"/Users/justinwu/Desktop/Gitlab_MyTale/mytale/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/justinwu/Desktop/Gitlab_MyTale/mytale/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/justinwu/Desktop/Gitlab_MyTale/mytale/node_modules/eslint-loader/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:cmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmZpbHRlciIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmZvci1lYWNoIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuaW5jbHVkZXMiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5pbmRleC1vZiIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLmFycmF5LmpvaW4iKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5hcnJheS5sYXN0LWluZGV4LW9mIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuYXJyYXkuc2xpY2UiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5mdW5jdGlvbi5uYW1lIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMubWFwIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMub2JqZWN0LnRvLXN0cmluZyIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL2VzLnJlZ2V4cC5leGVjIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLmluY2x1ZGVzIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLml0ZXJhdG9yIik7CgpyZXF1aXJlKCJjb3JlLWpzL21vZHVsZXMvZXMuc3RyaW5nLnJlcGxhY2UiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcuc3BsaXQiKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy9lcy5zdHJpbmcudHJpbSIpOwoKcmVxdWlyZSgiY29yZS1qcy9tb2R1bGVzL3dlYi5kb20tY29sbGVjdGlvbnMuZm9yLWVhY2giKTsKCnJlcXVpcmUoImNvcmUtanMvbW9kdWxlcy93ZWIuZG9tLWNvbGxlY3Rpb25zLml0ZXJhdG9yIik7Cgp2YXIgX2NsYXNzQ2FsbENoZWNrID0gcmVxdWlyZSgiL1VzZXJzL2p1c3Rpbnd1L0Rlc2t0b3AvR2l0bGFiX015VGFsZS9teXRhbGUvbm9kZV9tb2R1bGVzL0BiYWJlbC9ydW50aW1lL2hlbHBlcnMvY2xhc3NDYWxsQ2hlY2siKTsKCnZhciBfY3JlYXRlQ2xhc3MgPSByZXF1aXJlKCIvVXNlcnMvanVzdGlud3UvRGVza3RvcC9HaXRsYWJfTXlUYWxlL215dGFsZS9ub2RlX21vZHVsZXMvQGJhYmVsL3J1bnRpbWUvaGVscGVycy9jcmVhdGVDbGFzcyIpOwoKdmFyIFBhc3NhZ2UgPSByZXF1aXJlKCIuL1Bhc3NhZ2UiKTsKCnZhciBQYWdlID0gcmVxdWlyZSgiLi9QYWdlIik7Cgp2YXIgU3RvcnkgPSByZXF1aXJlKCIuL1N0b3J5Iik7Cgp2YXIgVkFSX1RBRyA9ICd2YXJpYWJsZXMnOwovKmNvbnN0IFNXQVRDSEVTID0gWyIjMzM2NThBIiAsICIjODZCQkQ4IiwgIiMyRjQ4NTgiLCAiI0Y2QUUyRCIsICIjRjI2NDE5IiwgIiM4QUFBNzkiLCAiI0ZBODMzNCIsICIjRkZGRDc3IiwKICAgICAgICAgICAgICAgICAgICAiI0ZGRTg4MiIsICIjMzg4Njk3IiwgIiMyNzEwMzMiLCAiIzUwNTE0RiIsICIjRjc5MjU2IiwgIiNGQkQxQTIiLCAiIzdEQ0ZCNiIsICIjMDBCMkNBIiwKICAgICAgICAgICAgICAgICAgICAiIzFENEU4OSIsICIjN0U3OEQyIiwgIiNFNzFEMzYiLCAiI0FGNDMxOSIsICIjNzcyMDE0IiwgIiMzRjIyMEYiLCAiIzE5MTgwQSIsICIjQzBGOEQxIl07Ki8KCnZhciBOVU1fVkFSUyA9IDA7CnZhciBOVU1fSU1HX1ZBUlMgPSAwOwp2YXIgTlVNX0FVRF9WQVJTID0gMDsKLyoqCiAqIEBjbGFzcyBTdG9yeUVkaXRvcgogKiBAbW9kdWxlIFN0b3J5RWRpdG9yCiAqLwoKdmFyIFN0b3J5RWRpdG9yID0gLyojX19QVVJFX18qL2Z1bmN0aW9uICgpIHsKICAidXNlIHN0cmljdCI7CgogIC8qKgogICAqIEBmdW5jdGlvbiBTdG9yeUVkaXRvcgogICAqIEBwYXJhbSB7U3Rvcnl9IHN0b3J5IC0gVGhlIHN0b3J5IHRvIGdlbmVyYXRlCiAgICogQGNsYXNzIFN0b3J5RWRpdG9yCiAgICovCiAgZnVuY3Rpb24gU3RvcnlFZGl0b3Ioc3RvcnkpIHsKICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBTdG9yeUVkaXRvcik7CgogICAgdGhpcy5iYXNlU3RvcnkgPSBzdG9yeTsKICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzID0gW107CiAgICB0aGlzLnZhcmlhYmxlcyA9IG5ldyBNYXAoKTsKICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMgPSBuZXcgTWFwKCk7CiAgICB0aGlzLmF1ZGlvVmFyaWFibGVzID0gbmV3IE1hcCgpOwogICAgdGhpcy5jc3MgPSAiIjsKICAgIHRoaXMuanMgPSAiIjsKICAgIHRoaXMucmVnZW5lcmF0ZVBhZ2VzKCk7CiAgICB0aGlzLnBhcnNlVmFyaWFibGVzKCk7CiAgICB0aGlzLmdlbmVyYXRlU3RvcnlUZXh0KHRydWUpOwogICAgdGhpcy5yZXBhcnNlTWVkaWEoKTsKICB9CiAgLyoqIAogICAqIEdldCB0aGUgZGVmYXVsdCB2YWx1ZSBvZiBhIHRleHQgdmFyaWFibGUKICAgKiAKICAgKiBAZnVuY3Rpb24gZXh0cmFjdERlZmF1bHQKICAgKiBAcGFyYW0ge3N0cmluZ30gbGluZSAtIExpbmUgdG8gZXh0cmFjdCBmcm9tCiAgICogQHJldHVybnMge1N0cmluZ30KICAgKi8KCgogIF9jcmVhdGVDbGFzcyhTdG9yeUVkaXRvciwgW3sKICAgIGtleTogImV4dHJhY3REZWZhdWx0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBleHRyYWN0RGVmYXVsdChsaW5lKSB7CiAgICAgIHZhciBwb3MxID0gbGluZS5pbmRleE9mKCI7Iik7CiAgICAgIHZhciBwb3MyID0gbGluZS5sYXN0SW5kZXhPZigiJiIpOwogICAgICByZXR1cm4gbGluZS5zbGljZShwb3MxICsgMSwgcG9zMik7CiAgICB9CiAgICAvKioKICAgICAqIENoYW5nZXMgdGhlIHZhbHVlIG9mIHRoZSB2YXJpYWJsZQogICAgICogCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gbGluZSAtIExpbmUgdG8gc3BsaWNlIGludG8KICAgICAqIEBwYXJhbSB7U3RyaW5nfSBuZXdWYWwgLSBWYWx1ZSB0byBzcGxpY2UKICAgICAqIEByZXR1cm5zIHtTdHJpbmd9CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAid3JpdGVWYXJpYWJsZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gd3JpdGVWYXJpYWJsZShsaW5lLCBuZXdWYWwpIHsKICAgICAgdmFyIHBvczEgPSBsaW5lLmluZGV4T2YoIjsiKTsKICAgICAgdmFyIHBvczIgPSBsaW5lLmxhc3RJbmRleE9mKCImIik7CiAgICAgIHJldHVybiBsaW5lLnNsaWNlKDAsIHBvczEgKyAxKSArIG5ld1ZhbCArIGxpbmUuc2xpY2UocG9zMiwgbGluZS5sZW5ndGgpOwogICAgfQogICAgLyoqIAogICAgICogR2V0IHRoZSBkZWZhdWx0IG5hbWUgb2YgYSB0ZXh0IHZhcmlhYmxlCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBleHRyYWN0VmFyaWFibGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBsaW5lIC0gTGluZSB0byBleHRyYWN0IGZyb20KICAgICAqIEByZXR1cm5zIHtTdHJpbmd9CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZXh0cmFjdFZhcmlhYmxlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBleHRyYWN0VmFyaWFibGUobGluZSkgewogICAgICB2YXIgcG9zID0gbGluZS5pbmRleE9mKCIkIik7CiAgICAgIHZhciB2YXJpYWJsZSA9ICIiOwoKICAgICAgd2hpbGUgKGxpbmUuY2hhckF0KHBvcykgIT0gIiAiKSB7CiAgICAgICAgdmFyaWFibGUgKz0gbGluZS5jaGFyQXQocG9zKTsKICAgICAgICBwb3MrKzsKICAgICAgfQoKICAgICAgcmV0dXJuIHZhcmlhYmxlOwogICAgfQogICAgLyoqIAogICAgICogT2J0YWluIGFsbCB0aGUgdmFyaWFibGVzIGZyb20gYSBzdG9yeSBvYmplY3QKICAgICAqIAogICAgICogQGZ1bmN0aW9uIHBhcnNlVmFyaWFibGVzCiAgICAgKiBAcmV0dXJucyB7dm9pZH0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJwYXJzZVZhcmlhYmxlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcGFyc2VWYXJpYWJsZXMoKSB7CiAgICAgIC8vRXh0cmFjdCB0aGUgcGFzc2FnZSB3aXRoIHZhcmlhYmxlIHRhZywKICAgICAgLy9JTVBPUlRBTlQ6IFZBUl9UQUcgU0hPVUxEIE5PVCBCRSBVU0VEIERVUklORyBTVE9SWSBDUkVBVElPTgogICAgICAvLyAgICAgICAgICAgVEhJUyBQQVNTQUdFIFdJTEwgQkUgQVVUT01BVElDQUxMWSBHRU5FUkFURUQgQU5EIEFEREVEIAogICAgICAvLyAgICAgICAgICAgVE8gVEhFIEZJUlNUIFBBU1NBR0UgT0YgVEhFIFNUT1JZLgogICAgICB2YXIgdmFyaWFibGVQYXNzYWdlID0gW107CgogICAgICBpZiAodGhpcy5iYXNlU3RvcnkucGFzc2FnZXMubGVuZ3RoID4gMCkgewogICAgICAgIHZhcmlhYmxlUGFzc2FnZSA9IHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzLmZpbHRlcihmdW5jdGlvbiAocGFzc2FnZSkgewogICAgICAgICAgdmFyIHJlc3VsdHMgPSBwYXNzYWdlLnRhZ3MuZmlsdGVyKGZ1bmN0aW9uICh0YWcpIHsKICAgICAgICAgICAgcmV0dXJuIHRhZyA9PT0gVkFSX1RBRzsKICAgICAgICAgIH0pOwogICAgICAgICAgcmV0dXJuIHJlc3VsdHMubGVuZ3RoID4gMDsKICAgICAgICB9KTsKICAgICAgfQoKICAgICAgdGhpcy52YXJpYWJsZXMuY2xlYXIoKTsgLy9DaGVja3MgaWYgdGhlcmUgaXMgb25seSBvbmUgcGFzc2FnZSB3aXRoIHRoZSB2YXJpYWJsZSB0YWcKCiAgICAgIGlmICh2YXJpYWJsZVBhc3NhZ2UubGVuZ3RoID09IDEpIHsKICAgICAgICB2YXIgdmFyaWFibGVUZXh0ID0gdmFyaWFibGVQYXNzYWdlWzBdLnRleHQ7CiAgICAgICAgdmFyIGxpbmVzID0gdmFyaWFibGVUZXh0LnNwbGl0KCJcbiIpOwogICAgICAgIGNvbnNvbGUubG9nKGxpbmVzLmxlbmd0aCk7CgogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgbGluZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmIChsaW5lc1tqXS5pbmNsdWRlcygiKHNldDoiKSkgewogICAgICAgICAgICAvL0FkZHMgZWFjaCB2YXJpYWJsZSB0byBhIGpzIE1hcAogICAgICAgICAgICB2YXIgdmFyaWFibGUgPSB0aGlzLmV4dHJhY3RWYXJpYWJsZShsaW5lc1tqXSk7CiAgICAgICAgICAgIHZhciBkZWZWYWwgPSB0aGlzLmV4dHJhY3REZWZhdWx0KGxpbmVzW2pdKTsKCiAgICAgICAgICAgIGlmICh0aGlzLnZhcmlhYmxlcy5oYXModmFyaWFibGUpKSB7CiAgICAgICAgICAgICAgYWxlcnQoIkR1cGxpY2F0ZSBWYXJpYWJsZSBcblxuVXBkYXRpbmcgVmFsdWUgdG86ICIgKyAiXCIiICsgZGVmVmFsICsgIlwiIik7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHRoaXMudmFyaWFibGVzLnNldCh2YXJpYWJsZSwgewogICAgICAgICAgICAgIHZhbHVlOiBkZWZWYWwsCiAgICAgICAgICAgICAgY29sb3I6ICIiLAogICAgICAgICAgICAgIGlkOiBOVU1fVkFSUysrCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zb2xlLmxvZyh2YXJpYWJsZSArICIgIiArIGRlZlZhbCk7CiAgICAgICAgICB9IGVsc2UgaWYgKGxpbmVzW2pdLmluY2x1ZGVzKCIoaGlkZGVuOikiKSkgewogICAgICAgICAgICB2YXIgdmFyRGF0YSA9IHRoaXMuZXh0cmFjdEFycihsaW5lc1tqXSk7CgogICAgICAgICAgICBpZiAodmFyRGF0YS50eXBlID09ICJpbWFnZSIpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBrID0gMDsgayA8IHZhckRhdGEuZGF0YS5sZW5ndGg7IGsrKykgewogICAgICAgICAgICAgICAgdmFyIGltZ1NyYyA9IHRoaXMuZXh0cmFjdFNyYyh2YXJEYXRhLmRhdGFba10pOwogICAgICAgICAgICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5zZXQodmFyRGF0YS5kYXRhW2tdLnN1YnN0cmluZygwLCB2YXJEYXRhLmRhdGFba10uaW5kZXhPZigieyIpKSwgewogICAgICAgICAgICAgICAgICBmaWxlOiBudWxsLAogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogaW1nU3JjLm5hbWUsCiAgICAgICAgICAgICAgICAgIHBhdGg6IGltZ1NyYy5zcmMsCiAgICAgICAgICAgICAgICAgIGNvbG9yOiAiIiwKICAgICAgICAgICAgICAgICAgaWQ6IE5VTV9JTUdfVkFSUysrLAogICAgICAgICAgICAgICAgICB1cGxvYWRlZDogIWltZ1NyYy5zcmMuaS5pbmNsdWRlcygiYmxvYiIpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAodmFyRGF0YS50eXBlID09ICJhdWRpbyIpIHsKICAgICAgICAgICAgICBmb3IgKHZhciBhID0gMDsgYSA8IHZhckRhdGEuZGF0YS5sZW5ndGg7IGErKykgewogICAgICAgICAgICAgICAgdmFyIGF1ZFNyYyA9IHRoaXMuZXh0cmFjdFNyYyh2YXJEYXRhLmRhdGFbYV0pOwogICAgICAgICAgICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcy5zZXQodmFyRGF0YS5kYXRhW2FdLnN1YnN0cmluZygwLCB2YXJEYXRhLmRhdGFbYV0uaW5kZXhPZigieyIpKSwgewogICAgICAgICAgICAgICAgICBmaWxlOiBudWxsLAogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogaW1nU3JjLm5hbWUsCiAgICAgICAgICAgICAgICAgIHBhdGg6IGF1ZFNyYy5zcmMsCiAgICAgICAgICAgICAgICAgIGNvbG9yOiAiIiwKICAgICAgICAgICAgICAgICAgaWQ6IE5VTV9BVURfVkFSUysrLAogICAgICAgICAgICAgICAgICB1cGxvYWRlZDogIWF1ZFNyYy5zcmMuaS5pbmNsdWRlcygiYmxvYiIpCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGxpbmVzID0gbGluZXMuZmlsdGVyKGZ1bmN0aW9uIChsaW5lKSB7CiAgICAgICAgICByZXR1cm4gIWxpbmUuaW5jbHVkZXMoIihzZXQ6IikgJiYgIWxpbmUuaW5jbHVkZXMoIihoaWRkZW46KSIpOwogICAgICAgIH0pOwoKICAgICAgICBmb3IgKHZhciBsID0gMDsgbCA8IHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzLmxlbmd0aDsgbCsrKSB7CiAgICAgICAgICBpZiAodGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbbF0udGFncy5pbmNsdWRlcyhWQVJfVEFHKSkgewogICAgICAgICAgICB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tsXS50ZXh0ID0gbGluZXMuam9pbigiXG4iKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcigiUGxlYXNlIHJlbW92ZSBleHRyYSB2YXJpYWJsZSBwYXNzYWdlIHRhZ3MiKTsKICAgICAgfQoKICAgICAgdGhpcy5kZXRWYXJpYWJsZUNvbG9ycygpOwogICAgICB0aGlzLnByaW50VmFyaWFibGVEYXRhKCk7CiAgICB9CiAgICAvKioKICAgICAqIEV4dHJhY3RzIHRoZSBpbWFnZSB2YXJpYWJsZSBkYXRhIGluIHRoZSBzdG9yeQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gZXh0cmFjdEFycgogICAgICogQHBhcmFtIHtTdHJpbmd9IGxpbmUgCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZXh0cmFjdEFyciIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZXh0cmFjdEFycihsaW5lKSB7CiAgICAgIHZhciBzb3VyY2UgPSBsaW5lLnNwbGl0KCJbIik7CiAgICAgIHZhciBjaHVuayA9IHNvdXJjZVsxXS5yZXBsYWNlKCJdIiwgIiIpOwogICAgICBzb3VyY2UgPSBjaHVuay5zcGxpdCgiOiIpOwogICAgICB2YXIgdHlwZSA9IHNvdXJjZVswXTsKICAgICAgdmFyIGFyciA9IGNodW5rLnJlcGxhY2Uoc291cmNlWzBdICsgIjoiLCAiIikuc3BsaXQoIiwiKTsKICAgICAgYXJyID0gYXJyLmZpbHRlcihmdW5jdGlvbiAoaSkgewogICAgICAgIHJldHVybiBpICE9ICIiOwogICAgICB9KTsKICAgICAgY29uc29sZS5sb2coYXJyKTsKICAgICAgcmV0dXJuIHsKICAgICAgICB0eXBlOiB0eXBlLAogICAgICAgIGRhdGE6IGFycgogICAgICB9OwogICAgfQogIH0sIHsKICAgIGtleTogImV4dHJhY3RTcmMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGV4dHJhY3RTcmMobGluZSkgewogICAgICB2YXIgc291cmNlID0gbGluZS5zcGxpdCgieyIpOwogICAgICB2YXIgc3JjID0gIiI7CiAgICAgIHZhciBmaWxlTmFtZSA9ICIiOwoKICAgICAgaWYgKHNvdXJjZS5sZW5ndGggPiAxKSB7CiAgICAgICAgc3JjID0gc291cmNlWzFdLnNwbGl0KCIgIilbMF07CiAgICAgICAgZmlsZU5hbWUgPSBzb3VyY2VbMV0uc3BsaXQoIiAiKVsxXS5yZXBsYWNlKCJ9IiwgIiIpOwogICAgICB9CgogICAgICByZXR1cm4gewogICAgICAgIHNyYzogewogICAgICAgICAgaTogc3JjCiAgICAgICAgfSwKICAgICAgICBuYW1lOiBmaWxlTmFtZQogICAgICB9OwogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmVzIHRoZSB2YXJpYWJsZSBjb2RlIGluamVjdGlvbgogICAgICogCiAgICAgKiBAZnVuY3Rpb24gcmVtb3ZlVmFyaWFibGVJbmplY3QKICAgICAqIAogICAgICovCgogIH0sIHsKICAgIGtleTogInJlbW92ZVZhcmlhYmxlSW5qZWN0IiwKICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVWYXJpYWJsZUluamVjdCgpIHsKICAgICAgdmFyIHRleHQgPSBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKCJwcmVQcm9jZXNzZWRCYXNlVGV4dCIpOwogICAgICB2YXIgcHJvY2VzcyA9IHRleHQgIT0gIiI7CgogICAgICBpZiAocHJvY2VzcykgewogICAgICAgIGZvciAodmFyIGsgPSAwOyBrIDwgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXMubGVuZ3RoOyBrKyspIHsKICAgICAgICAgIGlmICh0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1trXS50YWdzLmluY2x1ZGVzKFZBUl9UQUcpKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2tdLnRleHQgPSB0ZXh0OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICAgIGlmICh0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5saW5rUGFzc2FnZS50YWdzLmluY2x1ZGVzKFZBUl9UQUcpKSB7CiAgICAgICAgICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLmxpbmtQYXNzYWdlLnRleHQgPSB0ZXh0OwogICAgICAgICAgICBicmVhazsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KICAgICAgLypsZXQgdmFyaWFibGVQYXNzYWdlID0gW107CiAgICAgICBpZiAodGhpcy5iYXNlU3RvcnkucGFzc2FnZXMubGVuZ3RoID4gMCkgewogICAgICAgICAgdmFyaWFibGVQYXNzYWdlID0gdGhpcy5iYXNlU3RvcnkucGFzc2FnZXMuZmlsdGVyKGZ1bmN0aW9uIChwYXNzYWdlKSB7CiAgICAgICAgICAgICAgY29uc3QgcmVzdWx0cyA9IHBhc3NhZ2UudGFncy5maWx0ZXIodGFnID0+IHRhZyA9PT0gVkFSX1RBRyk7CiAgICAgICAgICAgICAgIHJldHVybiAocmVzdWx0cy5sZW5ndGggPiAwKTsKICAgICAgICAgIH0pOwogICAgICB9CiAgICAgICAvL0NoZWNrcyBpZiB0aGVyZSBpcyBvbmx5IG9uZSBwYXNzYWdlIHdpdGggdGhlIHZhcmlhYmxlIHRhZwogICAgICAgaWYgKHZhcmlhYmxlUGFzc2FnZS5sZW5ndGggPT0gMSkgewogICAgICAgICAgdmFyIHZhcmlhYmxlVGV4dCA9IHZhcmlhYmxlUGFzc2FnZVswXS50ZXh0OwogICAgICAgICAgdmFyIGxpbmVzID0gdmFyaWFibGVUZXh0LnNwbGl0KCJcbiIpOwogICAgICAgICAgIGxpbmVzID0gbGluZXMuZmlsdGVyKGZ1bmN0aW9uKGxpbmUpIHsKICAgICAgICAgICAgICByZXR1cm4gIWxpbmUuaW5jbHVkZXMoIihzZXQ6Iik7ICAKICAgICAgICAgIH0pOwogICAgICAgICAgCiAgICAgICAgICBmb3IodmFyIGsgPSAwOyBrPCB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlcy5sZW5ndGg7IGsrKyl7CiAgICAgICAgICAgICAgaWYodGhpcy5iYXNlU3RvcnkucGFzc2FnZXNba10udGFncy5pbmNsdWRlcyhWQVJfVEFHKSl7CiAgICAgICAgICAgICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2tdLnRleHQgPSBsaW5lcy5qb2luKCJcbiIpOwogICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJQbGVhc2UgcmVtb3ZlIGV4dHJhIHZhcmlhYmxlIHBhc3NhZ2UgdGFncyIpOwogICAgICB9Ki8KCiAgICB9CiAgfSwgewogICAga2V5OiAiZGV0VmFyaWFibGVDb2xvcnMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRldFZhcmlhYmxlQ29sb3JzKCkgewogICAgICB0aGlzLmRldFRleHRWYXJpYWJsZUNvbG9ycygpOwogICAgICB0aGlzLmRldEltYWdlVmFyaWFibGVDb2xvcnMoKTsKICAgICAgdGhpcy5kZXRBdWRpb1ZhcmlhYmxlQ29sb3JzKCk7CiAgICB9CiAgfSwgewogICAga2V5OiAiZGV0SW1hZ2VWYXJpYWJsZUNvbG9ycyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZGV0SW1hZ2VWYXJpYWJsZUNvbG9ycygpIHsKICAgICAgdmFyIHNvcnRlZEtleXMgPSBbXTsKICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgc29ydGVkS2V5cy5wdXNoKGtleSk7CiAgICAgIH0pOwogICAgICB2YXIgdmFyTWFwID0gdGhpcy5pbWFnZVZhcmlhYmxlczsKICAgICAgc29ydGVkS2V5cyA9IHNvcnRlZEtleXMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHZhciBpZEEgPSB2YXJNYXAuZ2V0KGEpLmlkOwogICAgICAgIHZhciBpZEIgPSB2YXJNYXAuZ2V0KGIpLmlkOwogICAgICAgIHJldHVybiBpZEEgLSBpZEI7CiAgICAgIH0pOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0ZWRLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmltYWdlVmFyaWFibGVzLmdldChzb3J0ZWRLZXlzW2ldKTsKCiAgICAgICAgaWYgKGRhdGEuY29sb3IgPT0gIiIpIHsKICAgICAgICAgIHZhciBvUiA9IDI1NTsKICAgICAgICAgIHZhciBvRyA9IDE2NTsKICAgICAgICAgIHZhciBvQiA9IDA7CiAgICAgICAgICB2YXIgcmFuZFIgPSBNYXRoLnJhbmRvbSgpICogMjU2OwogICAgICAgICAgdmFyIHJhbmRHID0gTWF0aC5yYW5kb20oKSAqIDI1NjsKICAgICAgICAgIHZhciByYW5kQiA9IE1hdGgucmFuZG9tKCkgKiAyNTY7CiAgICAgICAgICBkYXRhLmNvbG9yID0gInJnYigiICsgKG9SICsgcmFuZFIpIC8gMiArICIsIiArIChvRyArIHJhbmRHKSAvIDIgKyAiLCIgKyAob0IgKyByYW5kQikgLyAyICsgIikiOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5zZXQoc29ydGVkS2V5c1tpXSwgZGF0YSk7CiAgICAgIH0KICAgIH0KICB9LCB7CiAgICBrZXk6ICJkZXRBdWRpb1ZhcmlhYmxlQ29sb3JzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkZXRBdWRpb1ZhcmlhYmxlQ29sb3JzKCkgewogICAgICB2YXIgc29ydGVkS2V5cyA9IFtdOwogICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBzb3J0ZWRLZXlzLnB1c2goa2V5KTsKICAgICAgfSk7CiAgICAgIHZhciB2YXJNYXAgPSB0aGlzLmF1ZGlvVmFyaWFibGVzOwogICAgICBzb3J0ZWRLZXlzID0gc29ydGVkS2V5cy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgdmFyIGlkQSA9IHZhck1hcC5nZXQoYSkuaWQ7CiAgICAgICAgdmFyIGlkQiA9IHZhck1hcC5nZXQoYikuaWQ7CiAgICAgICAgcmV0dXJuIGlkQSAtIGlkQjsKICAgICAgfSk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvcnRlZEtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuYXVkaW9WYXJpYWJsZXMuZ2V0KHNvcnRlZEtleXNbaV0pOwoKICAgICAgICBpZiAoZGF0YS5jb2xvciA9PSAiIikgewogICAgICAgICAgdmFyIG9SID0gMjU1OwogICAgICAgICAgdmFyIG9HID0gMTY1OwogICAgICAgICAgdmFyIG9CID0gMDsKICAgICAgICAgIHZhciByYW5kUiA9IE1hdGgucmFuZG9tKCkgKiAyNTY7CiAgICAgICAgICB2YXIgcmFuZEcgPSBNYXRoLnJhbmRvbSgpICogMjU2OwogICAgICAgICAgdmFyIHJhbmRCID0gTWF0aC5yYW5kb20oKSAqIDI1NjsKICAgICAgICAgIGRhdGEuY29sb3IgPSAicmdiKCIgKyAob1IgKyByYW5kUikgLyAyICsgIiwiICsgKG9HICsgcmFuZEcpIC8gMiArICIsIiArIChvQiArIHJhbmRCKSAvIDIgKyAiKSI7CiAgICAgICAgfQoKICAgICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLnNldChzb3J0ZWRLZXlzW2ldLCBkYXRhKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBEZXRlcm1pbmVzIHRoZSBzd2F0Y2ggb2YgdGhlIHZhcmlhYmxlCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBkZXRWYXJpYWJsZUNvbG9ycwogICAgICogCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiZGV0VGV4dFZhcmlhYmxlQ29sb3JzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkZXRUZXh0VmFyaWFibGVDb2xvcnMoKSB7CiAgICAgIHZhciBzb3J0ZWRLZXlzID0gW107CiAgICAgIHRoaXMudmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBzb3J0ZWRLZXlzLnB1c2goa2V5KTsKICAgICAgfSk7CiAgICAgIHZhciB2YXJNYXAgPSB0aGlzLnZhcmlhYmxlczsKICAgICAgc29ydGVkS2V5cyA9IHNvcnRlZEtleXMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHZhciBpZEEgPSB2YXJNYXAuZ2V0KGEpLmlkOwogICAgICAgIHZhciBpZEIgPSB2YXJNYXAuZ2V0KGIpLmlkOwogICAgICAgIHJldHVybiBpZEEgLSBpZEI7CiAgICAgIH0pOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0ZWRLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLnZhcmlhYmxlcy5nZXQoc29ydGVkS2V5c1tpXSk7CgogICAgICAgIGlmIChkYXRhLmNvbG9yID09ICIiKSB7CiAgICAgICAgICB2YXIgb1IgPSAyNTU7CiAgICAgICAgICB2YXIgb0cgPSAxNjU7CiAgICAgICAgICB2YXIgb0IgPSAwOwogICAgICAgICAgdmFyIHJhbmRSID0gTWF0aC5yYW5kb20oKSAqIDI1NjsKICAgICAgICAgIHZhciByYW5kRyA9IE1hdGgucmFuZG9tKCkgKiAyNTY7CiAgICAgICAgICB2YXIgcmFuZEIgPSBNYXRoLnJhbmRvbSgpICogMjU2OwogICAgICAgICAgZGF0YS5jb2xvciA9ICJyZ2IoIiArIChvUiArIHJhbmRSKSAvIDIgKyAiLCIgKyAob0cgKyByYW5kRykgLyAyICsgIiwiICsgKG9CICsgcmFuZEIpIC8gMiArICIpIjsKICAgICAgICB9CgogICAgICAgIHRoaXMudmFyaWFibGVzLnNldChzb3J0ZWRLZXlzW2ldLCBkYXRhKTsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogInByaW50VmFyaWFibGVEYXRhIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBwcmludFZhcmlhYmxlRGF0YSgpIHsKICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uIChkYXRhLCBrZXkpIHsKICAgICAgICBjb25zb2xlLmxvZyhrZXkgKyAiPT0+IiArIEpTT04uc3RyaW5naWZ5KGRhdGEpKTsKICAgICAgfSk7CiAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAoZGF0YSwga2V5KSB7CiAgICAgICAgY29uc29sZS5sb2coa2V5ICsgIj09PiIgKyBKU09OLnN0cmluZ2lmeShkYXRhKSk7CiAgICAgIH0pOwogICAgICB0aGlzLnZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uIChkYXRhLCBrZXkpIHsKICAgICAgICBjb25zb2xlLmxvZyhrZXkgKyAiPT0+IiArIEpTT04uc3RyaW5naWZ5KGRhdGEpKTsKICAgICAgfSk7CiAgICB9CiAgICAvKioKICAgICAqIFJlcGFyc2VzIHRoZSBsaW5rcyBpbiB0aGUgcGFzc2FnZSB0ZXh0CiAgICAgKiBAZnVuY3Rpb24gcmVwYXJzZUxpbmtzCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAicmVwYXJzZUxpbmtzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiByZXBhcnNlTGlua3MoKSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5yZXBhcnNlTGlua3MoKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiAKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJyZXBhcnNlTWVkaWEiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlcGFyc2VNZWRpYSgpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLnJlcGFyc2VNZWRpYSh0aGlzLmltYWdlVmFyaWFibGVzLCB0aGlzLmF1ZGlvVmFyaWFibGVzKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiAKICAgICAqIEBwYXJhbSB7Kn0gZXZlbnQgCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiYWRkQXVkaW9Ub1BhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGFkZEF1ZGlvVG9QYWdlKGV2ZW50KSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ucGFnZU5hbWUgPT0gZXZlbnQucGFnZU5hbWUpIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLmFkZEF1ZGlvKGV2ZW50KTsKICAgICAgfQoKICAgICAgdGhpcy5yZXBhcnNlTWVkaWEoKTsgLy90aGlzLnByaW50VmFyaWFibGVEYXRhKCk7CiAgICB9CiAgICAvKioKICAgICAqIAogICAgICogQHBhcmFtIHsqfSBldmVudCAKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJyZW1vdmVBdWRpb0Zyb21QYWdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiByZW1vdmVBdWRpb0Zyb21QYWdlKGV2ZW50KSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ucGFnZU5hbWUgPT0gZXZlbnQucGFnZU5hbWUpIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLnJlbW92ZUF1ZGlvKGV2ZW50KTsKICAgICAgfQoKICAgICAgdGhpcy5yZXBhcnNlTWVkaWEoKTsgLy90aGlzLnByaW50VmFyaWFibGVEYXRhKCk7CiAgICB9CiAgICAvKioKICAgICAqIAogICAgICogQHBhcmFtIHsqfSBldmVudCAKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJhZGRJbWFnZVRvUGFnZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gYWRkSW1hZ2VUb1BhZ2UoZXZlbnQpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICh0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5wYWdlTmFtZSA9PSBldmVudC5wYWdlTmFtZSkgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0uYWRkSW1hZ2UoZXZlbnQpOwogICAgICB9CgogICAgICB0aGlzLnJlcGFyc2VNZWRpYSgpOyAvL3RoaXMucHJpbnRWYXJpYWJsZURhdGEoKTsKICAgIH0KICAgIC8qKgogICAgICogCiAgICAgKiBAcGFyYW0geyp9IGV2ZW50IAogICAgICovCgogIH0sIHsKICAgIGtleTogInJlbW92ZUltYWdlRnJvbVBhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlbW92ZUltYWdlRnJvbVBhZ2UoZXZlbnQpIHsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICh0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5wYWdlTmFtZSA9PSBldmVudC5wYWdlTmFtZSkgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ucmVtb3ZlSW1hZ2UoZXZlbnQpOwogICAgICB9CgogICAgICB0aGlzLnJlcGFyc2VNZWRpYSgpOyAvL3RoaXMucHJpbnRWYXJpYWJsZURhdGEoKTsKICAgIH0KICAgIC8qKgogICAgICogUmVmYWN0b3JzIHRoZSBsaW5rIHRleHQgc28gdGhhdCBpdCBpcyBwcm9wZXJseSBjb25maWd1cmVkCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiByZXBsYWNlTGlua3MKICAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IAogICAgICovCgogIH0sIHsKICAgIGtleTogInJlcGxhY2VMaW5rcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVwbGFjZUxpbmtzKGV2ZW50KSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5yZXBsYWNlTGlua3MoZXZlbnQpOwoKICAgICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgICBpZiAodGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbal0ubmFtZSA9PSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5saW5rUGFzc2FnZS5uYW1lKSB7CiAgICAgICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2pdLnRleHQgPSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5saW5rUGFzc2FnZS50ZXh0OwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZWZhY3RvcnMgdGhlIGxpbmsgdGV4dCBzbyB0aGF0IGl0IGlzIHByb3Blcmx5IGNvbmZpZ3VyZWQKICAgICAqIAogICAgICogQGZ1bmN0aW9uIHJlcGxhY2VMaW5rcwogICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAicmVwbGFjZVZhcmlhYmxlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVwbGFjZVZhcmlhYmxlcyhldmVudCkgewogICAgICB2YXIgbWVyZ2VkTWFwID0gbmV3IE1hcCgpOwogICAgICB0aGlzLnZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgbWVyZ2VkTWFwLnNldChrZXksIHZhbHVlKTsKICAgICAgfSk7CiAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIG1lcmdlZE1hcC5zZXQoa2V5LCB2YWx1ZSk7CiAgICAgIH0pOwogICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBtZXJnZWRNYXAuc2V0KGtleSwgdmFsdWUpOwogICAgICB9KTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5yZXBsYWNlVmFyaWFibGUoZXZlbnQsIG1lcmdlZE1hcCk7CgogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmICh0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tqXS5uYW1lID09IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLmxpbmtQYXNzYWdlLm5hbWUpIHsKICAgICAgICAgICAgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbal0udGV4dCA9IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLmxpbmtQYXNzYWdlLnRleHQ7CiAgICAgICAgICB9CiAgICAgICAgfQogICAgICB9CiAgICAgIC8qZm9yKHZhciBtID0gMDsgbSA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgbSsrKXsKICAgICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1ttXS5yZXBsYWNlVmFyaWFibGUoZXZlbnQsIHRoaXMuaW1hZ2VWYXJpYWJsZXMpOwogICAgICAgICAgIGZvcih2YXIgbiA9IDA7IG4gPCB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlcy5sZW5ndGg7IG4rKyl7CiAgICAgICAgICAgICAgaWYodGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbbl0ubmFtZSA9PSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1ttXS5saW5rUGFzc2FnZS5uYW1lKXsKICAgICAgICAgICAgICAgICAgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbbl0udGV4dCA9IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW21dLmxpbmtQYXNzYWdlLnRleHQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICB9CiAgICAgICBmb3IodmFyIGsgPSAwOyBrIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBrKyspewogICAgICAgICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2tdLnJlcGxhY2VWYXJpYWJsZShldmVudCwgdGhpcy5hdWRpb1ZhcmlhYmxlcyk7CiAgICAgICAgICAgZm9yKHZhciBsID0gMDsgbCA8IHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzLmxlbmd0aDsgbCsrKXsKICAgICAgICAgICAgICBpZih0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tsXS5uYW1lID09IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2tdLmxpbmtQYXNzYWdlLm5hbWUpewogICAgICAgICAgICAgICAgICB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tsXS50ZXh0ID0gdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNba10ubGlua1Bhc3NhZ2UudGV4dDsKICAgICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgIH0qLwogICAgICAvL3RoaXMucHJpbnRWYXJpYWJsZURhdGEoKTsKCiAgICB9CiAgICAvKioKICAgICAqIFByb2dyYW1tYXRpY2FsbHkgYWRkcyBhIGxpbmsgdG8gYSBwYWdlCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBhZGRMaW5rCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAtIGRhdGEKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJhZGRMaW5rIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRMaW5rKGV2ZW50KSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ucGFnZU5hbWUgPT0gZXZlbnQucGFnZU5hbWUpIHsKICAgICAgICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLmFkZExpbmsoZXZlbnQubmFtZSk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMucmVwYXJzZUxpbmtzKCk7IC8vdGhpcy5wcmludFZhcmlhYmxlRGF0YSgpOwogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmVzIGEgbGluayBmcm9tIGEgcGFnZQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gcmVtb3ZlTGluawogICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgLSBkYXRhCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAicmVtb3ZlTGluayIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcmVtb3ZlTGluayhldmVudCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLnBhZ2VOYW1lID09IGV2ZW50Lm5hbWUpIHsKICAgICAgICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLnJlbW92ZUxpbmsoZXZlbnQucmVtb3ZlTGluayk7CiAgICAgICAgICBicmVhazsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIHRoaXMucmVwYXJzZUxpbmtzKCk7CiAgICB9CiAgICAvKioKICAgICAqIFNldHMgdGhlIHN0YXJ0IHBhZ2UgZm9yIHRoZSBzdG9yeQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gc2V0U3RhcnRQYWdlCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAtIGRhdGEKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJzZXRTdGFydFBhZ2UiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNldFN0YXJ0UGFnZShldmVudCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2ldLnRhZ3MuaW5jbHVkZXMoInN0YXJ0IikpIHsKICAgICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2ldLnRhZ3MgPSB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS50YWdzLmZpbHRlcihmdW5jdGlvbiAodGFnKSB7CiAgICAgICAgICAgIHJldHVybiB0YWcgIT0gInN0YXJ0IjsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2ldLnRhZ3MuaW5jbHVkZXMoVkFSX1RBRykpIHsKICAgICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2ldLnRhZ3MgPSB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS50YWdzLmZpbHRlcihmdW5jdGlvbiAodGFnKSB7CiAgICAgICAgICAgIHJldHVybiB0YWcgIT0gVkFSX1RBRzsKICAgICAgICAgIH0pOwogICAgICAgIH0KCiAgICAgICAgaWYgKHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2ldLm5hbWUgPT0gZXZlbnQubmFtZSkgewogICAgICAgICAgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV0udGFncy5wdXNoKCJzdGFydCIpOwogICAgICAgICAgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV0udGFncy5wdXNoKFZBUl9UQUcpOwogICAgICAgIH0KCiAgICAgICAgdmFyIHJlbVRleHQgPSB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS50ZXh0OwogICAgICAgIHZhciBzb3VyY2UgPSByZW1UZXh0LnNwbGl0KCJcbiIpOwogICAgICAgIHNvdXJjZSA9IHNvdXJjZS5maWx0ZXIoZnVuY3Rpb24gKGxpbmUpIHsKICAgICAgICAgIHJldHVybiAhbGluZS5pbmNsdWRlcygiKHNldDoiKTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS50ZXh0ID0gc291cmNlLmpvaW4oIlxuIik7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogQWRkcyBhIG5ldyBwYWdlIHRvIHRoZSBzdG9yeQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gYWRkUGFnZQogICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiYWRkUGFnZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gYWRkUGFnZShldmVudCkgewogICAgICB2YXIgcGFnZU5hbWUgPSBldmVudC5uYW1lOwogICAgICB2YXIgcHJvY2VzcyA9IHRydWU7CgogICAgICBpZiAocHJvY2VzcykgewogICAgICAgIHZhciBiYXNlVGV4dCA9ICJUaGlzIGlzIGEgbmV3IHBhc3NhZ2UuIEVkaXQgaXQgdG8gY3JlYXRlIHlvdXIgb3duIHN0b3J5IVxuW1tnbyBiYWNrLSZndDsiICsgZXZlbnQucHJldkxpbmsgKyAiXV0iOwogICAgICAgIHZhciBuTGlua1Bhc3NhZ2UgPSBuZXcgUGFzc2FnZShwYWdlTmFtZSwgWyJzdG9yeSJdLCB7CiAgICAgICAgICBwb3NpdGlvbjogIjUwMCwgNTAwIiwKICAgICAgICAgIHNpemU6ICIxMDAsMTAwIgogICAgICAgIH0sIGJhc2VUZXh0LCB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlcy5sZW5ndGggKyAxKTsKICAgICAgICB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlcy5wdXNoKG5MaW5rUGFzc2FnZSk7CiAgICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMucHVzaChuZXcgUGFnZShudWxsLCBuTGlua1Bhc3NhZ2UsICJiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmZmZmOyBjb2xvcjogIzAwMDAwMDsiLCB0aGlzLmJhc2VTdG9yeS5nZXRTdG9yeVBhc3NhZ2VzKCkubGVuZ3RoLCB7CiAgICAgICAgICBzdG9yeTogdGhpcy5iYXNlU3RvcnksCiAgICAgICAgICBwYWdlczogdGhpcy5iYXNlU3RvcnkuZ2V0U3RvcnlQYXNzYWdlcygpLmxlbmd0aAogICAgICAgIH0pKTsKICAgICAgICB0aGlzLnJlcGFyc2VMaW5rcygpOwogICAgICAgIHRoaXMucmVwYXJzZU1lZGlhKCk7CiAgICAgIH0KICAgIH0KICAgIC8qKgogICAgICogUmVzZXRzIGFsbCB0aGUgcGFnZXMgaW4gdGhlIHN0b3J5CiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiByZWdlbmVyYXRlUGFnZXMKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJyZWdlbmVyYXRlUGFnZXMiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHJlZ2VuZXJhdGVQYWdlcygpIHsKICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMgPSBbXTsKICAgICAgdmFyIGxlbmd0aCA9IHRoaXMuYmFzZVN0b3J5LmdldFN0b3J5UGFzc2FnZXMoKS5sZW5ndGg7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7CiAgICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMucHVzaChuZXcgUGFnZShudWxsLCB0aGlzLmJhc2VTdG9yeS5nZXRTdG9yeVBhc3NhZ2VzKClbaV0sICJiYWNrZ3JvdW5kLWNvbG9yOiAjZmZmZmZmOyBjb2xvcjogIzAwMDAwMDsiLCBpICsgMSwgewogICAgICAgICAgc3Rvcnk6IHRoaXMuYmFzZVN0b3J5LAogICAgICAgICAgcGFnZXM6IGxlbmd0aAogICAgICAgIH0pKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBTYWZlbHkgY2hhbmdlcyB0aGUgcGFzc2FnZSBuYW1lCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBjaGFuZ2VQYXNzYWdlTmFtZQogICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiY2hhbmdlUGFzc2FnZU5hbWUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNoYW5nZVBhc3NhZ2VOYW1lKGV2ZW50KSB7CiAgICAgIGlmIChldmVudC5wcmV2TmFtZSAhPSBldmVudC5uZXdOYW1lKSB7CiAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgICAgaWYgKHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2ldLm5hbWUgPT0gZXZlbnQucHJldk5hbWUpIHsKICAgICAgICAgICAgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV0ubmFtZSA9IGV2ZW50Lm5ld05hbWU7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJDaGFuZ2VkIE5hbWUiKTsKICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmICh0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tqXS5saW5rUGFzc2FnZS5uYW1lID09IGV2ZW50LnByZXZOYW1lKSB7CiAgICAgICAgICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2pdLmxpbmtQYXNzYWdlLm5hbWUgPSBldmVudC5uZXdOYW1lOwogICAgICAgICAgICBjb25zb2xlLmxvZygiQ2hhbmdlZCBOYW1lIik7CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0aGlzLnJlcGxhY2VMaW5rcyhldmVudCk7CiAgICAgICAgdGhpcy5yZXBhcnNlTGlua3MoKTsKICAgICAgfQogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmVzIGEgcGFzc2FnZSBmcm9tIHRoZSBzdG9yeTsKICAgICAqIEBmdW5jdGlvbiBkZWxldGVQYXNzYWdlCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJkZWxldGVQYXNzYWdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkZWxldGVQYXNzYWdlKGV2ZW50KSB7CiAgICAgIHZhciBwYXNzYWdlOwogICAgICB2YXIgaW5kZXggPSAwOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIGlmICh0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS5uYW1lID09IGV2ZW50Lm5hbWUpIHsKICAgICAgICAgIHBhc3NhZ2UgPSB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXTsKICAgICAgICAgIGluZGV4ID0gaTsKICAgICAgICAgIGNvbnNvbGUubG9nKCJQYXNzYWdlOiIgKyBwYXNzYWdlLm5hbWUpOwogICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgICB9CgogICAgICBpZiAocGFzc2FnZS50YWdzLmluY2x1ZGVzKFZBUl9UQUcpKSB7CiAgICAgICAgYWxlcnQoIkRFTEVUSU5HIFRISVMgUEFTU0FHRSBXSUxMIFJFU1VMVCBJTiBTVE9SWSBCUkVBS0FHRVxuQUJPUlRJTkcgREVMRVRFIik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHBhc3NhZ2UudGFncy5pbmNsdWRlcygnc3RhcnQnKSkgewogICAgICAgICAgYWxlcnQoIkRlbGV0aW5nIHRoaXMgcGFzc2FnZSB3aWxsIHJhbmRvbWx5IGFzc2lnbiBhIG5ldyBzdGFydCBwYXNzYWdlLCBzZWxlY3QgYSBzdGFydCBwYXNzYWdlIGZyb20gdGhlIHBhc3NhZ2VzIG1lbnUiKTsKICAgICAgICAgIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2luZGV4ICsgMV0udGFncy5wdXNoKCJzdGFydCIpOwogICAgICAgIH0KCiAgICAgICAgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXMgPSB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlcy5maWx0ZXIoZnVuY3Rpb24gKHBhc3NhZ2UpIHsKICAgICAgICAgIHJldHVybiBwYXNzYWdlLm5hbWUgIT0gZXZlbnQubmFtZTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlcyA9IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmZpbHRlcihmdW5jdGlvbiAocGFnZSkgewogICAgICAgICAgcmV0dXJuIHBhZ2UucGFnZU5hbWUgIT0gZXZlbnQubmFtZTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLnJlcGxhY2VMaW5rcyh7CiAgICAgICAgICBwcmV2TmFtZTogZXZlbnQubmFtZSwKICAgICAgICAgIG5ld05hbWU6ICIiCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5yZXBhcnNlTGlua3MoKTsKICAgICAgfQogICAgfQogICAgLyoqIAogICAgICogQ2hhbmdlIHRoZSBnZW5lcmF0ZWQgdmFsdWUgb2YgYSB0ZXh0IHZhcmlhYmxlCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBzZXRUZXh0VmFyaWFibGUKICAgICAqIEBwYXJhbSB7U3RyaW5nfSB2YXJpYWJsZU5hbWUgLSBWYXJpYWJsZSBOYW1lIHRvIGNoYW5nZQogICAgICogQHBhcmFtIHtTdHJpbmd9IG5ld1RleHQgLSBUZXh0IHRvIGNoYW5nZSB0aGUgdmFyaWFibGUgdG8KICAgICAqIEByZXR1cm5zIHt2b2lkfQogICAgICovCgogIH0sIHsKICAgIGtleTogInNldFRleHRWYXJpYWJsZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0VGV4dFZhcmlhYmxlKHZhcmlhYmxlTmFtZSwgbmV3VGV4dCkgewogICAgICB2YXIgZGF0YSA9IHRoaXMudmFyaWFibGVzLmdldCh2YXJpYWJsZU5hbWUpOwogICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShkYXRhKSk7CiAgICAgIGRhdGEudmFsdWUgPSBuZXdUZXh0OwogICAgICB0aGlzLnZhcmlhYmxlcy5zZXQodmFyaWFibGVOYW1lLCBkYXRhKTsKICAgIH0KICAgIC8qKiAKICAgICAqIENoYW5nZSB0aGUgZ2VuZXJhdGVkIHZhbHVlIG9mIGEgdGV4dCB2YXJpYWJsZQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gc2V0VGV4dFZhcmlhYmxlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gdmFyaWFibGVOYW1lIAogICAgICogQHBhcmFtIHtFdmVudH0gZGF0YSB7fQogICAgICogQHJldHVybnMge3ZvaWR9CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAic2V0SW1hZ2VWYXJpYWJsZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gc2V0SW1hZ2VWYXJpYWJsZSh2YXJpYWJsZU5hbWUsIGRhdGEpIHsKICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5zZXQodmFyaWFibGVOYW1lLCBkYXRhKTsKICAgICAgdGhpcy5yZXBhcnNlTWVkaWEoKTsgLy90aGlzLnByaW50VmFyaWFibGVEYXRhKCk7CiAgICB9CiAgICAvKiogCiAgICAgKiBDaGFuZ2UgdGhlIGdlbmVyYXRlZCB2YWx1ZSBvZiBhIHRleHQgdmFyaWFibGUKICAgICAqIAogICAgICogQGZ1bmN0aW9uIHNldFRleHRWYXJpYWJsZQogICAgICogQHBhcmFtIHtTdHJpbmd9IHZhcmlhYmxlTmFtZSAKICAgICAqIEBwYXJhbSB7RXZlbnR9IGRhdGEge30KICAgICAqIEByZXR1cm5zIHt2b2lkfQogICAgICovCgogIH0sIHsKICAgIGtleTogInNldEF1ZGlvVmFyaWFibGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIHNldEF1ZGlvVmFyaWFibGUodmFyaWFibGVOYW1lLCBkYXRhKSB7CiAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuc2V0KHZhcmlhYmxlTmFtZSwgZGF0YSk7CiAgICAgIHRoaXMucmVwYXJzZU1lZGlhKCk7IC8vdGhpcy5wcmludFZhcmlhYmxlRGF0YSgpOwogICAgfQogICAgLyoqCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBjaGFuZ2VWYXJpYWJsZU5hbWUKICAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IAogICAgICovCgogIH0sIHsKICAgIGtleTogImNoYW5nZVRleHRWYXJpYWJsZU5hbWUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNoYW5nZVRleHRWYXJpYWJsZU5hbWUoZXZlbnQpIHsKICAgICAgdmFyIHByb2Nlc3MgPSB0aGlzLmNoZWNrRXZlbnQoewogICAgICAgIG5hbWU6IGV2ZW50Lm5ld05hbWUKICAgICAgfSwgInRleHQiKTsKCiAgICAgIGlmIChwcm9jZXNzKSB7CiAgICAgICAgdGhpcy5yZXBsYWNlVmFyaWFibGVzKGV2ZW50KTsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMudmFyaWFibGVzLmdldChldmVudC5wcmV2TmFtZSk7CiAgICAgICAgdGhpcy52YXJpYWJsZXMuZGVsZXRlKGV2ZW50LnByZXZOYW1lKTsKICAgICAgICB0aGlzLnZhcmlhYmxlcy5zZXQoZXZlbnQubmV3TmFtZSwgZGF0YSk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwcm9jZXNzOwogICAgfQogICAgLyoqCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBjaGFuZ2VWYXJpYWJsZU5hbWUKICAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IAogICAgICovCgogIH0sIHsKICAgIGtleTogImNoYW5nZUltYWdlVmFyaWFibGVOYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjaGFuZ2VJbWFnZVZhcmlhYmxlTmFtZShldmVudCkgewogICAgICB2YXIgcHJvY2VzcyA9IHRoaXMuY2hlY2tFdmVudCh7CiAgICAgICAgbmFtZTogZXZlbnQubmV3TmFtZQogICAgICB9LCAibWVkaWEiKTsKICAgICAgY29uc29sZS5sb2coKTsKCiAgICAgIGlmIChwcm9jZXNzKSB7CiAgICAgICAgdGhpcy5yZXBsYWNlVmFyaWFibGVzKGV2ZW50KTsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuaW1hZ2VWYXJpYWJsZXMuZ2V0KGV2ZW50LnByZXZOYW1lKTsKICAgICAgICB0aGlzLmltYWdlVmFyaWFibGVzLmRlbGV0ZShldmVudC5wcmV2TmFtZSk7CiAgICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5zZXQoZXZlbnQubmV3TmFtZSwgZGF0YSk7CiAgICAgICAgdGhpcy5yZXBhcnNlTWVkaWEoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHByb2Nlc3M7IC8vdGhpcy5wcmludFZhcmlhYmxlRGF0YSgpOwogICAgfQogICAgLyoqCiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBjaGFuZ2VWYXJpYWJsZU5hbWUKICAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IAogICAgICovCgogIH0sIHsKICAgIGtleTogImNoYW5nZUF1ZGlvVmFyaWFibGVOYW1lIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBjaGFuZ2VBdWRpb1ZhcmlhYmxlTmFtZShldmVudCkgewogICAgICB2YXIgcHJvY2VzcyA9IHRoaXMuY2hlY2tFdmVudCh7CiAgICAgICAgbmFtZTogZXZlbnQubmV3TmFtZQogICAgICB9LCAibWVkaWEiKTsKCiAgICAgIGlmIChwcm9jZXNzKSB7CiAgICAgICAgdGhpcy5yZXBsYWNlVmFyaWFibGVzKGV2ZW50KTsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMuYXVkaW9WYXJpYWJsZXMuZ2V0KGV2ZW50LnByZXZOYW1lKTsKICAgICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLmRlbGV0ZShldmVudC5wcmV2TmFtZSk7CiAgICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcy5zZXQoZXZlbnQubmV3TmFtZSwgZGF0YSk7CiAgICAgICAgdGhpcy5yZXBhcnNlTWVkaWEoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHByb2Nlc3M7IC8vdGhpcy5wcmludFZhcmlhYmxlRGF0YSgpOwogICAgfQogICAgLyoqCiAgICAgKiBBZGRzIGEgdmFyaWFibGUgdG8gdGhlIHN0b3J5CiAgICAgKiAKICAgICAqIEBmdW5jdGlvbiBhZGRWYXJpYWJsZQogICAgICogQHBhcmFtIHtFdmVudH0gZXZlbnQgCiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiYWRkVGV4dFZhcmlhYmxlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBhZGRUZXh0VmFyaWFibGUoZXZlbnQpIHsKICAgICAgdmFyIHByb2Nlc3MgPSB0aGlzLmNoZWNrRXZlbnQoZXZlbnQsICJ0ZXh0Iik7CgogICAgICBpZiAocHJvY2VzcykgewogICAgICAgIHRoaXMudmFyaWFibGVzLnNldChldmVudC5uYW1lLCB7CiAgICAgICAgICB2YWx1ZTogZXZlbnQudmFsdWUsCiAgICAgICAgICBjb2xvcjogIiIsCiAgICAgICAgICBpZDogTlVNX1ZBUlMrKwogICAgICAgIH0pOwogICAgICAgIHRoaXMuZGV0VmFyaWFibGVDb2xvcnMoKTsKICAgICAgfQoKICAgICAgcmV0dXJuIHByb2Nlc3M7CiAgICB9CiAgICAvKioKICAgICAqIEFkZHMgYW4gaW1hZ2UgdmFyaWFibGUKICAgICAqIEBmdW5jdGlvbiBhZGRJbWFnZVZhcmlhYmxlCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCB7bmFtZTogdmFyTmFtZSwgZmlsZTogbnVsbCwgZmlsZU5hbWU6ICIiLCBwYXRoOiAiIiwgaWQ6ICIifQogICAgICovCgogIH0sIHsKICAgIGtleTogImFkZEltYWdlVmFyaWFibGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGFkZEltYWdlVmFyaWFibGUoZXZlbnQpIHsKICAgICAgdmFyIHByb2Nlc3MgPSB0aGlzLmNoZWNrRXZlbnQoZXZlbnQsICJtZWRpYSIpOwoKICAgICAgaWYgKHByb2Nlc3MpIHsKICAgICAgICB0aGlzLmltYWdlVmFyaWFibGVzLnNldChldmVudC5uYW1lLCB7CiAgICAgICAgICBmaWxlOiBldmVudC5maWxlLAogICAgICAgICAgZmlsZU5hbWU6IGV2ZW50LmZpbGVOYW1lLAogICAgICAgICAgcGF0aDogZXZlbnQucGF0aCwKICAgICAgICAgIGNvbG9yOiAiIiwKICAgICAgICAgIGlkOiBOVU1fSU1HX1ZBUlMrKywKICAgICAgICAgIHVwbG9hZGVkOiBldmVudC51cGxvYWRlZAogICAgICAgIH0pOyAvL3RoaXMucHJpbnRWYXJpYWJsZURhdGEoKTsKCiAgICAgICAgdGhpcy5kZXRWYXJpYWJsZUNvbG9ycygpOwogICAgICB9CgogICAgICByZXR1cm4gcHJvY2VzczsKICAgIH0KICAgIC8qKgogICAgICogQWRkcyBhbiBpbWFnZSB2YXJpYWJsZQogICAgICogQGZ1bmN0aW9uIGFkZEltYWdlVmFyaWFibGUKICAgICAqIEBwYXJhbSB7RXZlbnR9IGV2ZW50IHtuYW1lOiB2YXJOYW1lLCBmaWxlOiBudWxsLCBmaWxlTmFtZTogIiIsIHBhdGg6ICIiLCBpZDogIiJ9CiAgICAgKi8KCiAgfSwgewogICAga2V5OiAiYWRkQXVkaW9WYXJpYWJsZSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gYWRkQXVkaW9WYXJpYWJsZShldmVudCkgewogICAgICB2YXIgcHJvY2VzcyA9IHRoaXMuY2hlY2tFdmVudChldmVudCwgIm1lZGlhIik7CgogICAgICBpZiAocHJvY2VzcykgewogICAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuc2V0KGV2ZW50Lm5hbWUsIHsKICAgICAgICAgIGZpbGU6IGV2ZW50LmZpbGUsCiAgICAgICAgICBmaWxlTmFtZTogZXZlbnQuZmlsZU5hbWUsCiAgICAgICAgICBwYXRoOiBldmVudC5wYXRoLAogICAgICAgICAgY29sb3I6ICIiLAogICAgICAgICAgaWQ6IE5VTV9BVURfVkFSUysrLAogICAgICAgICAgdXBsb2FkZWQ6IGV2ZW50LnVwbG9hZGVkCiAgICAgICAgfSk7IC8vdGhpcy5wcmludFZhcmlhYmxlRGF0YSgpOwoKICAgICAgICB0aGlzLmRldFZhcmlhYmxlQ29sb3JzKCk7CiAgICAgIH0KCiAgICAgIHJldHVybiBwcm9jZXNzOwogICAgfQogIH0sIHsKICAgIGtleTogImNoZWNrRXZlbnQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNoZWNrRXZlbnQoZXZlbnQsIHR5cGUpIHsKICAgICAgdmFyIHByb2Nlc3MgPSBmYWxzZTsKCiAgICAgIGlmICh0eXBlID09ICJ0ZXh0IikgewogICAgICAgIHByb2Nlc3MgPSAhdGhpcy52YXJpYWJsZXMuaGFzKGV2ZW50Lm5hbWUpOwogICAgICB9IGVsc2UgaWYgKHR5cGUgPT0gIm1lZGlhIikgewogICAgICAgIHByb2Nlc3MgPSAhKHRoaXMuaW1hZ2VWYXJpYWJsZXMuaGFzKGV2ZW50Lm5hbWUpIHx8IHRoaXMuYXVkaW9WYXJpYWJsZXMuaGFzKGV2ZW50Lm5hbWUpKTsKICAgICAgfQoKICAgICAgaWYgKCFwcm9jZXNzKSB7CiAgICAgICAgYWxlcnQoZXZlbnQubmFtZSArICIgYWxyZWFkeSBleGlzdHMhIik7CiAgICAgIH0KCiAgICAgIHJldHVybiBwcm9jZXNzOwogICAgfQogICAgLyoqCiAgICAgKiBSZW1vdmVzIGEgdmFyaWFibGUgZnJvbSB0aGUgc3RvcnkKICAgICAqIAogICAgICogQGZ1bmN0aW9uIGRlbGV0ZVZhcmlhYmxlCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJkZWxldGVUZXh0VmFyaWFibGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRlbGV0ZVRleHRWYXJpYWJsZShldmVudCkgewogICAgICB2YXIgZGF0YUFyciA9IFtdOwogICAgICB0aGlzLnZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgZGF0YUFyci5wdXNoKHsKICAgICAgICAgIG5hbWU6IGtleQogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tqXS5yZW1vdmVLZXlGcm9tVGV4dChkYXRhQXJyLCBldmVudC5uYW1lKTsKICAgICAgfQoKICAgICAgdGhpcy52YXJpYWJsZXMuZGVsZXRlKGV2ZW50Lm5hbWUpOwogICAgICB2YXIgc29ydGVkS2V5cyA9IFtdOwogICAgICB0aGlzLnZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgc29ydGVkS2V5cy5wdXNoKGtleSk7CiAgICAgIH0pOwogICAgICBzb3J0ZWRLZXlzID0gc29ydGVkS2V5cy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgaWYgKGEgPiBiKSB7CiAgICAgICAgICByZXR1cm4gMTsKICAgICAgICB9IGVsc2UgaWYgKGEgPCBiKSB7CiAgICAgICAgICByZXR1cm4gLTE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHJldHVybiAwOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHNvcnRlZEtleXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMudmFyaWFibGVzLmdldChzb3J0ZWRLZXlzW2ldKTsKICAgICAgICBkYXRhLmlkLS07CiAgICAgICAgdGhpcy52YXJpYWJsZXMuc2V0KHNvcnRlZEtleXNbaV0sIGRhdGEpOwogICAgICB9CgogICAgICBOVU1fVkFSUy0tOwogICAgfQogIH0sIHsKICAgIGtleTogImRlbGV0ZUltYWdlVmFyaWFibGUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRlbGV0ZUltYWdlVmFyaWFibGUoZXZlbnQpIHsKICAgICAgdmFyIGRhdGFBcnIgPSBbXTsKICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgZGF0YUFyci5wdXNoKHsKICAgICAgICAgIG5hbWU6IGtleQogICAgICAgIH0pOwogICAgICB9KTsKICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgZGF0YUFyci5wdXNoKHsKICAgICAgICAgIG5hbWU6IGtleQogICAgICAgIH0pOwogICAgICB9KTsKCiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXMubGVuZ3RoOyBqKyspIHsKICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tqXS5yZW1vdmVLZXlGcm9tVGV4dChkYXRhQXJyLCBldmVudC5uYW1lKTsKICAgICAgfQoKICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5kZWxldGUoZXZlbnQubmFtZSk7CiAgICAgIHZhciBzb3J0ZWRLZXlzID0gW107CiAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIHNvcnRlZEtleXMucHVzaChrZXkpOwogICAgICB9KTsKICAgICAgc29ydGVkS2V5cyA9IHNvcnRlZEtleXMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgIGlmIChhID4gYikgewogICAgICAgICAgcmV0dXJuIDE7CiAgICAgICAgfSBlbHNlIGlmIChhIDwgYikgewogICAgICAgICAgcmV0dXJuIC0xOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICByZXR1cm4gMDsKICAgICAgICB9CiAgICAgIH0pOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzb3J0ZWRLZXlzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGRhdGEgPSB0aGlzLmltYWdlVmFyaWFibGVzLmdldChzb3J0ZWRLZXlzW2ldKTsKICAgICAgICBkYXRhLmlkLS07CiAgICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5zZXQoc29ydGVkS2V5c1tpXSwgZGF0YSk7CiAgICAgIH0KCiAgICAgIE5VTV9JTUdfVkFSUy0tOwogICAgICB0aGlzLnJlcGFyc2VNZWRpYSgpOyAvL3RoaXMucHJpbnRWYXJpYWJsZURhdGEoKTsKICAgIH0KICB9LCB7CiAgICBrZXk6ICJkZWxldGVBdWRpb1ZhcmlhYmxlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBkZWxldGVBdWRpb1ZhcmlhYmxlKGV2ZW50KSB7CiAgICAgIHZhciBkYXRhQXJyID0gW107CiAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIGRhdGFBcnIucHVzaCh7CiAgICAgICAgICBuYW1lOiBrZXkKICAgICAgICB9KTsKICAgICAgfSk7CiAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIGRhdGFBcnIucHVzaCh7CiAgICAgICAgICBuYW1lOiBrZXkKICAgICAgICB9KTsKICAgICAgfSk7CgogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgdGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbal0ucmVtb3ZlS2V5RnJvbVRleHQoZGF0YUFyciwgZXZlbnQubmFtZSk7CiAgICAgIH0KCiAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuZGVsZXRlKGV2ZW50Lm5hbWUpOwogICAgICB2YXIgc29ydGVkS2V5cyA9IFtdOwogICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBzb3J0ZWRLZXlzLnB1c2goa2V5KTsKICAgICAgfSk7CiAgICAgIHNvcnRlZEtleXMgPSBzb3J0ZWRLZXlzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICBpZiAoYSA+IGIpIHsKICAgICAgICAgIHJldHVybiAxOwogICAgICAgIH0gZWxzZSBpZiAoYSA8IGIpIHsKICAgICAgICAgIHJldHVybiAtMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgcmV0dXJuIDA7CiAgICAgICAgfQogICAgICB9KTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgc29ydGVkS2V5cy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBkYXRhID0gdGhpcy5hdWRpb1ZhcmlhYmxlcy5nZXQoc29ydGVkS2V5c1tpXSk7CiAgICAgICAgZGF0YS5pZC0tOwogICAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuc2V0KHNvcnRlZEtleXNbaV0sIGRhdGEpOwogICAgICB9CgogICAgICBOVU1fQVVEX1ZBUlMtLTsKICAgICAgdGhpcy5yZXBhcnNlTWVkaWEoKTsgLy90aGlzLnByaW50VmFyaWFibGVEYXRhKCk7CiAgICB9CiAgICAvKioKICAgICAqIEdldCB0aGUgbmV3IHRleHQgZm9yIGEgcGFzc2FnZSBhbmQgcmVwbGFjZSBpdCBpbiB0aGUgc3RvcnkKICAgICAqIAogICAgICogQGZ1bmN0aW9uIHNldFBhc3NhZ2UKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBwYXNzYWdlTmFtZSAtIE5hbWUgb2YgdGhlIHBhc3NhZ2UKICAgICAqIEBwYXJhbSB7U3RyaW5nfSBuZXdUZXh0IC0gTmV3IHRleHQgZm9yIHRoZSBwYXNzYWdlCiAgICAgKiBAcGFyYW0ge1N0cmluZ30gaGlkZGVuIC0gVmFsdWUgdG8gcmVnZW5lcmF0ZSBzdG9yeSB0ZXh0CiAgICAgKiBAcmV0dXJucyB7dm9pZH0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJzZXRQYXNzYWdlIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBzZXRQYXNzYWdlKHBhc3NhZ2VOYW1lLCBuZXdUZXh0KSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV0ubmFtZSA9PSBwYXNzYWdlTmFtZSkgewogICAgICAgICAgdGhpcy5iYXNlU3RvcnkucGFzc2FnZXNbaV0udGV4dCA9IG5ld1RleHQ7CiAgICAgICAgICBjb25zb2xlLmxvZygiVGV4dCBDaGFuZ2VkIik7CiAgICAgICAgfQogICAgICB9CgogICAgICB0aGlzLnJlcGFyc2VMaW5rcygpOwogICAgICB0aGlzLnJlcGFyc2VNZWRpYSgpOwogICAgfQogICAgLyoqCiAgICAgKiBDaGFuZ2VzIHRoZSBuYW1lIG9mIHRoZSBzdG9yeQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gY2hhbmdlU3RvcnlOYW1lCiAgICAgKiBAcGFyYW0ge0V2ZW50fSBldmVudCAKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJjaGFuZ2VTdG9yeU5hbWUiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGNoYW5nZVN0b3J5TmFtZShldmVudCkgewogICAgICB0aGlzLmJhc2VTdG9yeS5uYW1lID0gZXZlbnQubmFtZTsKICAgIH0KICAgIC8qKiAKICAgICAqIEdlbmVyYXRlIHRoZSBzdG9yeSB3aXRoIHRoZSByZXZpc2VkIHZhcmlhYmxlcy4KICAgICAqIAogICAgICogQGZ1bmN0aW9uIGdlbmVyYXRlVmlld1N0b3J5CiAgICAgKiBAcmV0dXJucyB7dm9pZH0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZW5lcmF0ZVZpZXdTdG9yeSIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2VuZXJhdGVWaWV3U3RvcnkobWVkaWEpIHsKICAgICAgLy9FeHRyYWN0IHRoZSBwYXNzYWdlIHdpdGggdmFyaWFibGUgdGFnLAogICAgICAvL0lNUE9SVEFOVDogVkFSX1RBRyBTSE9VTEQgTk9UIEJFIFVTRUQgRFVSSU5HIFNUT1JZIENSRUFUSU9OCiAgICAgIC8vICAgICAgICAgICBUSElTIFBBU1NBR0UgV0lMTCBCRSBBVVRPTUFUSUNBTExZIEdFTkVSQVRFRCBBTkQgQURERUQgCiAgICAgIC8vICAgICAgICAgICBUTyBUSEUgRklSU1QgUEFTU0FHRSBPRiBUSEUgU1RPUlkuCiAgICAgIHRoaXMuY3NzID0gIiI7CiAgICAgIGNvbnNvbGUubG9nKCJHZW5lcmF0aW5nIFN0b3J5Li4uIik7CiAgICAgIHZhciB2aWV3U3RvcnkgPSBuZXcgU3RvcnkoSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLmJhc2VTdG9yeSkpKTsKICAgICAgY29uc29sZS5sb2codmlld1N0b3J5Lm5hbWUpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB2aWV3U3RvcnkucGFzc2FnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgcGFzc2FnZU9iaiA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGhpcy5leHBvcnRlZFN0b3J5UGFnZXNbaV0ubGlua1Bhc3NhZ2UpKTsKICAgICAgICB2aWV3U3RvcnkucGFzc2FnZXNbaV0gPSBuZXcgUGFzc2FnZShwYXNzYWdlT2JqLm5hbWUsIHBhc3NhZ2VPYmoudGFncywgcGFzc2FnZU9iai5tZXRhZGF0YSwgcGFzc2FnZU9iai50ZXh0LCBwYXNzYWdlT2JqLnBpZCk7CiAgICAgICAgdmlld1N0b3J5LnBhc3NhZ2VzW2ldLnRleHQgPSB2aWV3U3RvcnkucGFzc2FnZXNbaV0udGV4dC50cmltKCk7CgogICAgICAgIGlmICh2aWV3U3RvcnkucGFzc2FnZXNbaV0udGFncy5pbmNsdWRlcyhWQVJfVEFHKSkgewogICAgICAgICAgLy9jb25zb2xlLmxvZygiVGV4dCBDaGFuZ2VkOiIgKyB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS50ZXh0KTsKICAgICAgICAgIHZhciB0ZXh0VG9QdXNoID0gdmlld1N0b3J5LnBhc3NhZ2VzW2ldLnRleHQ7CiAgICAgICAgICB2YXIgc29ydGVkS2V5cyA9IFtdOwogICAgICAgICAgdGhpcy52YXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgICAgICBzb3J0ZWRLZXlzLnB1c2goa2V5KTsKICAgICAgICAgIH0pOwogICAgICAgICAgc29ydGVkS2V5cyA9IHNvcnRlZEtleXMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgICAgICByZXR1cm4gYS5sZW5ndGggLSBiLmxlbmd0aDsKICAgICAgICAgIH0pOwoKICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc29ydGVkS2V5cy5sZW5ndGg7IGorKykgewogICAgICAgICAgICAvL2NvbnNvbGUubG9nKCJLRVk6ICIgKyBzb3J0ZWRLZXlzW2pdKQogICAgICAgICAgICAvL2NvbnNvbGUubG9nKCJLRVk6ICIgKyBrZXkgKyAiIFZBTFVFOiAiICsgdmFsdWUpCiAgICAgICAgICAgIHZhciBrZXkgPSBzb3J0ZWRLZXlzW2pdOwogICAgICAgICAgICB2YXIgdGVtcCA9IHRleHRUb1B1c2guc3BsaXQoa2V5KTsKICAgICAgICAgICAgdmFyIGRhdGEgPSB0aGlzLnZhcmlhYmxlcy5nZXQoa2V5KTsKICAgICAgICAgICAgdGV4dFRvUHVzaCA9IHRlbXAuam9pbihkYXRhLnZhbHVlKTsKICAgICAgICAgIH0KCiAgICAgICAgICB2aWV3U3RvcnkucGFzc2FnZXNbaV0udGV4dCA9IHRleHRUb1B1c2ggKyAiXG4iICsgdGhpcy5pbmplY3RWYXJpYWJsZVRleHQoKTsKICAgICAgICB9CgogICAgICAgIGlmIChtZWRpYSkgdmlld1N0b3J5LnBhc3NhZ2VzW2ldLnRleHQgPSB0aGlzLmluamVjdE1lZGlhKHZpZXdTdG9yeS5wYXNzYWdlc1tpXS50ZXh0KTsKICAgICAgICB0aGlzLmNzcyArPSB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5pbmplY3RDU1NUZXh0KCkgKyAnXG4nOwogICAgICB9CgogICAgICB0aGlzLmNzcyArPSAiYm9keXsgdGV4dC1hbGlnbjogY2VudGVyO30iOwogICAgICByZXR1cm4gdmlld1N0b3J5OwogICAgfQogIH0sIHsKICAgIGtleTogImluamVjdE1lZGlhIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBpbmplY3RNZWRpYSh0ZXh0VG9QdXNoKSB7CiAgICAgIHZhciBzb3J0ZWRLZXlzID0gW107CiAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIHNvcnRlZEtleXMucHVzaChrZXkpOwogICAgICB9KTsKICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uICh2YWx1ZSwga2V5KSB7CiAgICAgICAgc29ydGVkS2V5cy5wdXNoKGtleSk7CiAgICAgIH0pOwogICAgICBzb3J0ZWRLZXlzID0gc29ydGVkS2V5cy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7CiAgICAgICAgcmV0dXJuIGIubGVuZ3RoIC0gYS5sZW5ndGg7CiAgICAgIH0pOwoKICAgICAgZm9yICh2YXIgaiA9IDA7IGogPCBzb3J0ZWRLZXlzLmxlbmd0aDsgaisrKSB7CiAgICAgICAgLy9jb25zb2xlLmxvZygiS0VZOiAiICsgc29ydGVkS2V5c1tqXSkKICAgICAgICAvL2NvbnNvbGUubG9nKCJLRVk6ICIgKyBrZXkgKyAiIFZBTFVFOiAiICsgdmFsdWUpCiAgICAgICAgdmFyIGtleSA9IHNvcnRlZEtleXNbal07CiAgICAgICAgdmFyIHRlbXAgPSB0ZXh0VG9QdXNoLnNwbGl0KGtleSk7CiAgICAgICAgdmFyIGRhdGEgPSBudWxsOwoKICAgICAgICBpZiAodGhpcy5pbWFnZVZhcmlhYmxlcy5oYXMoa2V5KSkgewogICAgICAgICAgZGF0YSA9IHRoaXMuaW1hZ2VWYXJpYWJsZXMuZ2V0KGtleSk7CiAgICAgICAgICB0ZXh0VG9QdXNoID0gdGVtcC5qb2luKCI8aW1nIHN0eWxlID0gJ21heC13aWR0aDogNTAlOyBtYXgtaGVpZ2h0OjUwJTsnIHNyYyA9ICciICsgZGF0YS5wYXRoLmkgKyAiJyBhbHQgPSAiICsga2V5LnJlcGxhY2UoIkAiLCAiIikgKyAiLz4iKTsKICAgICAgICB9IGVsc2UgaWYgKHRoaXMuYXVkaW9WYXJpYWJsZXMuaGFzKGtleSkpIHsKICAgICAgICAgIGRhdGEgPSB0aGlzLmF1ZGlvVmFyaWFibGVzLmdldChrZXkpOwogICAgICAgICAgdGV4dFRvUHVzaCA9IHRlbXAuam9pbigiPGF1ZGlvIGNvbnRyb2xzPjxzb3VyY2Ugc3JjID0gJyIgKyBkYXRhLnBhdGguaSArICInPiBZb3VyIEJyb3dzZXIgRG9lcyBub3Qgc3VwcG9ydCB0aGUgYXVkaW8gZWxlbWVudCA8L2F1ZGlvPiIpOwogICAgICAgIH0gLy90ZXh0VG9QdXNoID0gdGVtcC5qb2luKCI8aW1nIHN0eWxlID0gJ21heC13aWR0aDogNTAlOyBtYXgtaGVpZ2h0OjUwJTsnIHNyYyA9ICciICsgZGF0YS5wYXRoLmkgKyAiJyBhbHQgPSAiICsga2V5ICsgIi8+Iik7CgogICAgICAgIC8qaWYoZGF0YS51cGxvYWRlZCkgewogICAgICAgICAgICAKICAgICAgICB9CiAgICAgICAgaWYoIWRhdGEudXBsb2FkZWQpIHsKICAgICAgICAgICAgdGV4dFRvUHVzaCA9IHRlbXAuam9pbigiPGltZyBzdHlsZSA9ICdtYXgtd2lkdGg6IDUwJTsgbWF4LWhlaWdodDo1MCU7JyBzcmMgPSAnIiArIGRhdGEucGF0aCArICInIGFsdCA9ICIgKyBrZXkgKyAiLz4iKTsKICAgICAgICB9Ki8KCiAgICAgIH0KCiAgICAgIHJldHVybiB0ZXh0VG9QdXNoOwogICAgfQogICAgLyoqCiAgICAgKiBHZW5lcmF0ZXMgdmFyaWFibGUgaW5zZXJ0aW9uIHRleHQKICAgICAqICAKICAgICAqIEBmdW5jdGlvbiBpbmplY3RWYXJpYWJsZVRleHQKICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJpbmplY3RWYXJpYWJsZVRleHQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGluamVjdFZhcmlhYmxlVGV4dCgpIHsKICAgICAgdmFyIGluamVjdCA9ICIiOwogICAgICB0aGlzLnZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uIChkYXRhLCBrZXkpIHsKICAgICAgICBpbmplY3QgKz0gIihzZXQ6ICI7CiAgICAgICAgaW5qZWN0ICs9IGtleTsKICAgICAgICBpbmplY3QgKz0gIiB0byAmcXVvdDsiOwogICAgICAgIGluamVjdCArPSBkYXRhLnZhbHVlOwogICAgICAgIGluamVjdCArPSAiJnF1b3Q7KVxuIjsKICAgICAgfSk7CiAgICAgIGluamVjdCArPSAiKGhpZGRlbjopW2ltYWdlOiI7CiAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAoZGF0YSwga2V5KSB7CiAgICAgICAgLy9jb25zb2xlLmxvZyhrZXkgKyAiOiAiICsgSlNPTi5zdHJpbmdpZnkoZGF0YSkpOwogICAgICAgIGluamVjdCArPSBrZXkgKyAieyIgKyBkYXRhLnBhdGguaSArICIgIiArIGRhdGEuZmlsZU5hbWUgKyAifSwiOwogICAgICB9KTsKICAgICAgaW5qZWN0ICs9ICJdXG4iOwogICAgICBpbmplY3QgKz0gIihoaWRkZW46KVthdWRpbzoiOwogICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKGRhdGEsIGtleSkgewogICAgICAgIGluamVjdCArPSBrZXkgKyAieyIgKyBkYXRhLnBhdGguaSArICIgIiArIGRhdGEuZmlsZU5hbWUgKyAifSwiOwogICAgICB9KTsKICAgICAgaW5qZWN0ICs9ICJdXG4iOwogICAgICByZXR1cm4gaW5qZWN0OwogICAgfQogICAgLyoqCiAgICAgKiBHZXQgY2xvdWQgc2F2ZSBzdG9yeQogICAgICogCiAgICAgKiBAZnVuY3Rpb24gZ2VuZXJhdGVTYXZlU3RvcnkKICAgICAqIEByZXR1cm5zIHtTdG9yeX0gc3RvcnkgdG8gYmUgcHVzaGVkIHRvIGNsb3VkOwogICAgICovCgogIH0sIHsKICAgIGtleTogImdlbmVyYXRlU2F2ZVN0b3J5IiwKICAgIHZhbHVlOiBmdW5jdGlvbiBnZW5lcmF0ZVNhdmVTdG9yeSgpIHsKICAgICAgdGhpcy5jc3MgPSAiIjsKICAgICAgdmFyIGNsb3VkU3RvcnkgPSBuZXcgU3RvcnkoSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLmJhc2VTdG9yeSkpKTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2xvdWRTdG9yeS5wYXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciBwYXNzYWdlT2JqID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeSh0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5saW5rUGFzc2FnZSkpOwogICAgICAgIGNsb3VkU3RvcnkucGFzc2FnZXNbaV0gPSBuZXcgUGFzc2FnZShwYXNzYWdlT2JqLm5hbWUsIHBhc3NhZ2VPYmoudGFncywgcGFzc2FnZU9iai5tZXRhZGF0YSwgcGFzc2FnZU9iai50ZXh0LCBwYXNzYWdlT2JqLnBpZCk7CiAgICAgICAgY2xvdWRTdG9yeS5wYXNzYWdlc1tpXS50ZXh0ID0gY2xvdWRTdG9yeS5wYXNzYWdlc1tpXS50ZXh0LnRyaW0oKTsKCiAgICAgICAgaWYgKGNsb3VkU3RvcnkucGFzc2FnZXNbaV0udGFncy5pbmNsdWRlcyhWQVJfVEFHKSkgewogICAgICAgICAgLy9jb25zb2xlLmxvZygiVGV4dCBDaGFuZ2VkOiIgKyB0aGlzLmJhc2VTdG9yeS5wYXNzYWdlc1tpXS50ZXh0KTsgICAgCiAgICAgICAgICBjbG91ZFN0b3J5LnBhc3NhZ2VzW2ldLnRleHQgPSBjbG91ZFN0b3J5LnBhc3NhZ2VzW2ldLnRleHQgKyAiXG4iICsgdGhpcy5pbmplY3RWYXJpYWJsZVRleHQoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY3NzICs9IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLmluamVjdENTU1RleHQoKSArICdcbic7CiAgICAgIH0KCiAgICAgIHJldHVybiBjbG91ZFN0b3J5OwogICAgfQogICAgLyoqIAogICAgICogR2VuZXJhdGUgdGhlIHN0b3J5IHdpdGggdGhlIHJldmlzZWQgdGV4dC4KICAgICAqIAogICAgICogQGZ1bmN0aW9uIGdlbmVyYXRlU3RvcnlUZXh0CiAgICAgKiBAcmV0dXJucyB7dm9pZH0KICAgICAqLwoKICB9LCB7CiAgICBrZXk6ICJnZW5lcmF0ZVN0b3J5VGV4dCIsCiAgICB2YWx1ZTogZnVuY3Rpb24gZ2VuZXJhdGVTdG9yeVRleHQoaGlkZGVuLCBpblZhcmlhYmxlcywgaW5NZWRpYSkgewogICAgICAvL3RoaXMuZXhwb3J0ZWRTdG9yeVRleHQgPSBbXTsKICAgICAgdmFyIHNjcmlwdFBhc3NhZ2VzID0gdGhpcy5iYXNlU3RvcnkuZ2V0U3RvcnlQYXNzYWdlcygpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBzY3JpcHRQYXNzYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHZhciB0ZXh0VG9QdXNoID0gc2NyaXB0UGFzc2FnZXNbaV0udGV4dDsKICAgICAgICB0ZXh0VG9QdXNoID0gdGhpcy5wcm9jZXNzVGV4dFZhcmlhYmxlcyh0ZXh0VG9QdXNoLCBoaWRkZW4sIGluVmFyaWFibGVzKTsKICAgICAgICB0ZXh0VG9QdXNoID0gdGhpcy5wcm9jZXNzTWVkaWFWYXJpYWJsZXModGV4dFRvUHVzaCwgaGlkZGVuLCBpbk1lZGlhKTsKCiAgICAgICAgd2hpbGUgKHRleHRUb1B1c2guaW5jbHVkZXMoIl1dIikgfHwgdGV4dFRvUHVzaC5pbmNsdWRlcygiW1siKSkgewogICAgICAgICAgdGV4dFRvUHVzaCA9IHRleHRUb1B1c2gucmVwbGFjZSgnW1snLCAiPHU+Iik7CiAgICAgICAgICB0ZXh0VG9QdXNoID0gdGV4dFRvUHVzaC5yZXBsYWNlKCddXScsICI8L3U+Iik7CiAgICAgICAgfQoKICAgICAgICB3aGlsZSAodGV4dFRvUHVzaC5pbmNsdWRlcygiJnF1b3Q7IikgfHwgdGV4dFRvUHVzaC5pbmNsdWRlcygiJiMzOTsiKSB8fCB0ZXh0VG9QdXNoLmluY2x1ZGVzKCImZ3Q7IikgfHwgdGV4dFRvUHVzaC5pbmNsdWRlcygiJmx0OyIpKSB7CiAgICAgICAgICB0ZXh0VG9QdXNoID0gdGV4dFRvUHVzaC5yZXBsYWNlKCImcXVvdDsiLCAiXCIiKTsKICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZXh0VG9QdXNoLnJlcGxhY2UoIiYjMzk7IiwgIiciKTsKICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZXh0VG9QdXNoLnJlcGxhY2UoIiZsdDsiLCAiPCIpOwogICAgICAgICAgdGV4dFRvUHVzaCA9IHRleHRUb1B1c2gucmVwbGFjZSgiJmd0OyIsICI+Iik7CiAgICAgICAgfSAvL3RleHRUb1B1c2ggPSB0ZXh0VG9QdXNoLnJlcGxhY2UoLyhcclxufFxyfFxuKXsyLH0vZywgJ1xuJyk7CgoKICAgICAgICB2YXIgblBhc3NhZ2UgPSBuZXcgUGFzc2FnZShzY3JpcHRQYXNzYWdlc1tpXS5uYW1lLCBzY3JpcHRQYXNzYWdlc1tpXS50YWdzLCBzY3JpcHRQYXNzYWdlc1tpXS5tZXRhZGF0YSwgdGV4dFRvUHVzaCwgc2NyaXB0UGFzc2FnZXNbaV0ucGlkKTsKICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5kaXNwUGFzc2FnZSA9IG5QYXNzYWdlOwogICAgICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLnBhZ2VOYW1lID0gblBhc3NhZ2UubmFtZTsKICAgICAgICB0aGlzLmV4cG9ydGVkU3RvcnlQYWdlc1tpXS5zdG9yeSA9IHRoaXMuYmFzZVN0b3J5OwogICAgICAgIHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLnBhZ2VzID0gdGhpcy5iYXNlU3RvcnkuZ2V0U3RvcnlQYXNzYWdlcygpLmxlbmd0aDsKICAgICAgfQogICAgfQogIH0sIHsKICAgIGtleTogInByb2Nlc3NUZXh0VmFyaWFibGVzIiwKICAgIHZhbHVlOiBmdW5jdGlvbiBwcm9jZXNzVGV4dFZhcmlhYmxlcyh0ZXh0VG9QdXNoLCBoaWRkZW4sIGluVmFyaWFibGVzKSB7CiAgICAgIHZhciBzb3J0ZWRLZXlzID0gW107CiAgICAgIHRoaXMudmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBzb3J0ZWRLZXlzLnB1c2goa2V5KTsKICAgICAgfSk7CiAgICAgIHNvcnRlZEtleXMgPSBzb3J0ZWRLZXlzLnNvcnQoZnVuY3Rpb24gKGEsIGIpIHsKICAgICAgICByZXR1cm4gYi5sZW5ndGggLSBhLmxlbmd0aDsKICAgICAgfSk7CgogICAgICBmb3IgKHZhciBqID0gMDsgaiA8IHNvcnRlZEtleXMubGVuZ3RoOyBqKyspIHsKICAgICAgICAvL2NvbnNvbGUubG9nKCJLRVk6ICIgKyBzb3J0ZWRLZXlzW2pdKQogICAgICAgIC8vY29uc29sZS5sb2coIktFWTogIiArIGtleSArICIgVkFMVUU6ICIgKyB2YWx1ZSkKICAgICAgICB2YXIga2V5ID0gc29ydGVkS2V5c1tqXTsKICAgICAgICB2YXIgdGVtcCA9IHRleHRUb1B1c2guc3BsaXQoa2V5KTsKICAgICAgICB2YXIgZGF0YSA9IHRoaXMudmFyaWFibGVzLmdldChrZXkpOwoKICAgICAgICBpZiAoIWhpZGRlbikgewogICAgICAgICAgaWYgKGluVmFyaWFibGVzKSB7CiAgICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZW1wLmpvaW4oIjxzcGFuIHN0eWxlID0gJ2NvbG9yOiIgKyBkYXRhLmNvbG9yICsgIjsnPjxzdHJvbmc+KCIgKyBrZXkucmVwbGFjZSgiJCIsICIiKSArICIpPC9zdHJvbmc+PC9zcGFuPiIgKyBkYXRhLnZhbHVlKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZW1wLmpvaW4oIjxzcGFuPigiICsga2V5LnJlcGxhY2UoIiQiLCAiIikgKyAiKTwvc3Bhbj4iICsgZGF0YS52YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpblZhcmlhYmxlcykgewogICAgICAgICAgICB0ZXh0VG9QdXNoID0gdGVtcC5qb2luKCI8c3BhbiBzdHlsZSA9ICdjb2xvcjoiICsgZGF0YS5jb2xvciArICI7Jz48c3Ryb25nPiIgKyBkYXRhLnZhbHVlICsgIjwvc3Ryb25nPjwvc3Bhbj4iKTsKICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZW1wLmpvaW4oIjxzcGFuPiIgKyBkYXRhLnZhbHVlICsgIjwvc3Bhbj4iKTsKICAgICAgICAgIH0KICAgICAgICB9CiAgICAgIH0KCiAgICAgIHJldHVybiB0ZXh0VG9QdXNoOwogICAgfQogIH0sIHsKICAgIGtleTogInByb2Nlc3NNZWRpYVZhcmlhYmxlcyIsCiAgICB2YWx1ZTogZnVuY3Rpb24gcHJvY2Vzc01lZGlhVmFyaWFibGVzKHRleHRUb1B1c2gsIGhpZGRlbiwgaW5NZWRpYSkgewogICAgICB2YXIgc29ydGVkS2V5cyA9IFtdOwogICAgICB0aGlzLmltYWdlVmFyaWFibGVzLmZvckVhY2goZnVuY3Rpb24gKHZhbHVlLCBrZXkpIHsKICAgICAgICBzb3J0ZWRLZXlzLnB1c2goa2V5KTsKICAgICAgfSk7CiAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAodmFsdWUsIGtleSkgewogICAgICAgIHNvcnRlZEtleXMucHVzaChrZXkpOwogICAgICB9KTsKICAgICAgc29ydGVkS2V5cyA9IHNvcnRlZEtleXMuc29ydChmdW5jdGlvbiAoYSwgYikgewogICAgICAgIHJldHVybiBiLmxlbmd0aCAtIGEubGVuZ3RoOwogICAgICB9KTsKCiAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgc29ydGVkS2V5cy5sZW5ndGg7IGorKykgewogICAgICAgIC8vY29uc29sZS5sb2coIktFWTogIiArIHNvcnRlZEtleXNbal0pCiAgICAgICAgLy9jb25zb2xlLmxvZygiS0VZOiAiICsga2V5ICsgIiBWQUxVRTogIiArIHZhbHVlKQogICAgICAgIHZhciBrZXkgPSBzb3J0ZWRLZXlzW2pdOwogICAgICAgIHZhciB0ZW1wID0gdGV4dFRvUHVzaC5zcGxpdChrZXkpOwogICAgICAgIHZhciBkYXRhID0gdGhpcy5pbWFnZVZhcmlhYmxlcy5oYXMoa2V5KSA/IHRoaXMuaW1hZ2VWYXJpYWJsZXMuZ2V0KGtleSkgOiB0aGlzLmF1ZGlvVmFyaWFibGVzLmdldChrZXkpOwogICAgICAgIHZhciB2YWx1ZSA9ICIiOwoKICAgICAgICBpZiAoZGF0YS5maWxlTmFtZS5sZW5ndGggPiAzMCkgewogICAgICAgICAgdmFsdWUgPSBkYXRhLmZpbGVOYW1lLnN1YnN0cigwLCAzMCkgKyAiLi4uIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFsdWUgPSBkYXRhLmZpbGVOYW1lOwogICAgICAgIH0KCiAgICAgICAgaWYgKHZhbHVlID09ICIiKSB7CiAgICAgICAgICB2YWx1ZSA9ICJObyBGaWxlIFVwbG9hZGVkIjsKICAgICAgICB9CgogICAgICAgIGlmICghaGlkZGVuKSB7CiAgICAgICAgICBpZiAoaW5NZWRpYSkgewogICAgICAgICAgICB0ZXh0VG9QdXNoID0gdGVtcC5qb2luKCI8c3BhbiBzdHlsZSA9ICdjb2xvcjoiICsgZGF0YS5jb2xvciArICI7Jz48c3Ryb25nPigiICsga2V5LnJlcGxhY2UoIkAiLCAiIikgKyAiKTwvc3Ryb25nPjwvc3Bhbj4iICsgdmFsdWUpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGV4dFRvUHVzaCA9IHRlbXAuam9pbigiPHNwYW4+KCIgKyBrZXkucmVwbGFjZSgiQCIsICIiKSArICIpPC9zcGFuPiIgKyB2YWx1ZSk7CiAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGlmIChpbk1lZGlhKSB7CiAgICAgICAgICAgIHRleHRUb1B1c2ggPSB0ZW1wLmpvaW4oIjxzcGFuIHN0eWxlID0gJ2NvbG9yOiIgKyBkYXRhLmNvbG9yICsgIjsnPjxzdHJvbmc+KCIgKyB2YWx1ZSArICIpPC9zdHJvbmc+PC9zcGFuPiIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGV4dFRvUHVzaCA9IHRlbXAuam9pbigiPHNwYW4+KCIgKyB2YWx1ZSArICIpPC9zcGFuPiIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQoKICAgICAgcmV0dXJuIHRleHRUb1B1c2g7CiAgICB9CiAgfSwgewogICAga2V5OiAiZ2VuZXJhdGVQdWJsaXNoU3RvcnkiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGdlbmVyYXRlUHVibGlzaFN0b3J5KCkgewogICAgICB0aGlzLmNzcyA9ICIiOwogICAgICB2YXIgY2xvdWRTdG9yeSA9IG5ldyBTdG9yeShKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMuYmFzZVN0b3J5KSkpOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjbG91ZFN0b3J5LnBhc3NhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIHBhc3NhZ2VPYmogPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLmxpbmtQYXNzYWdlKSk7CiAgICAgICAgY2xvdWRTdG9yeS5wYXNzYWdlc1tpXSA9IG5ldyBQYXNzYWdlKHBhc3NhZ2VPYmoubmFtZSwgcGFzc2FnZU9iai50YWdzLCBwYXNzYWdlT2JqLm1ldGFkYXRhLCBwYXNzYWdlT2JqLnRleHQsIHBhc3NhZ2VPYmoucGlkKTsKICAgICAgICBjbG91ZFN0b3J5LnBhc3NhZ2VzW2ldLnRleHQgPSBjbG91ZFN0b3J5LnBhc3NhZ2VzW2ldLnRleHQudHJpbSgpOwoKICAgICAgICBpZiAoY2xvdWRTdG9yeS5wYXNzYWdlc1tpXS50YWdzLmluY2x1ZGVzKFZBUl9UQUcpKSB7CiAgICAgICAgICAvL2NvbnNvbGUubG9nKCJUZXh0IENoYW5nZWQ6IiArIHRoaXMuYmFzZVN0b3J5LnBhc3NhZ2VzW2ldLnRleHQpOyAgICAKICAgICAgICAgIGNsb3VkU3RvcnkucGFzc2FnZXNbaV0udGV4dCA9IGNsb3VkU3RvcnkucGFzc2FnZXNbaV0udGV4dCArICJcbiIgKyB0aGlzLmluamVjdFB1Ymxpc2hWYXJpYWJsZVRleHQoKTsKICAgICAgICB9CgogICAgICAgIHRoaXMuY3NzICs9IHRoaXMuZXhwb3J0ZWRTdG9yeVBhZ2VzW2ldLmluamVjdENTU1RleHQoKSArICdcbic7CiAgICAgIH0KCiAgICAgIHRoaXMuY3NzICs9ICJib2R5eyB0ZXh0LWFsaWduOiBjZW50ZXI7fSI7CiAgICAgIHJldHVybiBjbG91ZFN0b3J5OwogICAgfQogICAgLyoqCiAgICAqIEdlbmVyYXRlcyB2YXJpYWJsZSBpbnNlcnRpb24gdGV4dAogICAgKiAgCiAgICAqIEBmdW5jdGlvbiBpbmplY3RWYXJpYWJsZVRleHQKICAgICovCgogIH0sIHsKICAgIGtleTogImluamVjdFB1Ymxpc2hWYXJpYWJsZVRleHQiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGluamVjdFB1Ymxpc2hWYXJpYWJsZVRleHQoKSB7CiAgICAgIHZhciBpbmplY3QgPSAiIjsKICAgICAgdGhpcy52YXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbiAoZGF0YSwga2V5KSB7CiAgICAgICAgaW5qZWN0ICs9ICIoc2V0OiAiOwogICAgICAgIGluamVjdCArPSBrZXk7CiAgICAgICAgaW5qZWN0ICs9ICIgdG8gJnF1b3Q7IjsKICAgICAgICBpbmplY3QgKz0gIigiICsga2V5LnJlcGxhY2UoIiQiLCAiIikgKyAiKSI7CiAgICAgICAgaW5qZWN0ICs9ICImcXVvdDspXG4iOwogICAgICB9KTsKICAgICAgaW5qZWN0ICs9ICIoaGlkZGVuOilbaW1hZ2U6IjsKICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uIChkYXRhLCBrZXkpIHsKICAgICAgICAvL2NvbnNvbGUubG9nKGtleSArICI6ICIgKyBKU09OLnN0cmluZ2lmeShkYXRhKSk7CiAgICAgICAgaW5qZWN0ICs9IGtleSArICJ7IH0sIjsKICAgICAgfSk7CiAgICAgIGluamVjdCArPSAiXVxuIjsKICAgICAgaW5qZWN0ICs9ICIoaGlkZGVuOilbYXVkaW86IjsKICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uIChkYXRhLCBrZXkpIHsKICAgICAgICBpbmplY3QgKz0ga2V5ICsgInsgfSwiOwogICAgICB9KTsKICAgICAgaW5qZWN0ICs9ICJdXG4iOwogICAgICByZXR1cm4gaW5qZWN0OwogICAgfQogIH0sIHsKICAgIGtleTogImRlc3Ryb3kiLAogICAgdmFsdWU6IGZ1bmN0aW9uIGRlc3Ryb3koKSB7CiAgICAgIC8qdGhpcy5pbWFnZVZhcmlhYmxlcy5mb3JFYWNoKGZ1bmN0aW9uKGRhdGEpewogICAgICAgICAgaWYoZGF0YS5wYXRoLmluY2x1ZGVzKCJibG9iIikpewogICAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwoZGF0YS5wYXRoKTsKICAgICAgICAgICAgICBkYXRhLnBhdGggPSAiIjsKICAgICAgICAgIH0KICAgICAgICAgIAogICAgICB9KTsKICAgICAgIHRoaXMuYXVkaW9WYXJpYWJsZXMuZm9yRWFjaChmdW5jdGlvbihkYXRhKXsKICAgICAgICAgIGlmKGRhdGEucGF0aC5pbmNsdWRlcygiYmxvYiIpKXsKICAgICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKGRhdGEucGF0aCk7CiAgICAgICAgICAgICAgZGF0YS5wYXRoID0gIiI7CiAgICAgICAgICB9CiAgICAgICAgICAKICAgICAgfSk7Ki8KICAgIH0KICB9XSk7CgogIHJldHVybiBTdG9yeUVkaXRvcjsKfSgpOwoKbW9kdWxlLmV4cG9ydHMgPSBTdG9yeUVkaXRvcjs="},{"version":3,"sources":["/Users/justinwu/Desktop/Gitlab_MyTale/mytale/src/js/extwee_utils/StoryEditor.js"],"names":["Passage","require","Page","Story","VAR_TAG","NUM_VARS","NUM_IMG_VARS","NUM_AUD_VARS","StoryEditor","story","baseStory","exportedStoryPages","variables","Map","imageVariables","audioVariables","css","js","regeneratePages","parseVariables","generateStoryText","reparseMedia","line","pos1","indexOf","pos2","lastIndexOf","slice","newVal","length","pos","variable","charAt","variablePassage","passages","filter","passage","results","tags","tag","clear","variableText","text","lines","split","console","log","j","includes","extractVariable","defVal","extractDefault","has","alert","set","value","color","id","varData","extractArr","type","k","data","imgSrc","extractSrc","substring","file","fileName","name","path","src","uploaded","i","a","audSrc","l","join","Error","detVariableColors","printVariableData","source","chunk","replace","arr","sessionStorage","getItem","process","linkPassage","detTextVariableColors","detImageVariableColors","detAudioVariableColors","sortedKeys","forEach","key","push","varMap","sort","b","idA","get","idB","oR","oG","oB","randR","Math","random","randG","randB","JSON","stringify","reparseLinks","event","pageName","addAudio","removeAudio","addImage","removeImage","replaceLinks","mergedMap","replaceVariable","addLink","removeLink","remText","baseText","prevLink","nLinkPassage","position","size","getStoryPassages","pages","prevName","newName","index","page","variableName","newText","checkEvent","replaceVariables","delete","dataArr","removeKeyFromText","passageName","media","viewStory","parse","passageObj","metadata","pid","trim","textToPush","temp","injectVariableText","injectMedia","injectCSSText","inject","cloudStory","hidden","inVariables","inMedia","scriptPassages","processTextVariables","processMediaVariables","nPassage","dispPassage","substr","injectPublishVariableText","module","exports"],"mappings":"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","sourcesContent":["const Passage = require(\"./Passage\");\nconst Page = require(\"./Page\");\nconst Story = require(\"./Story\");\n\nconst VAR_TAG = 'variables';\n\n/*const SWATCHES = [\"#33658A\" , \"#86BBD8\", \"#2F4858\", \"#F6AE2D\", \"#F26419\", \"#8AAA79\", \"#FA8334\", \"#FFFD77\",\n                    \"#FFE882\", \"#388697\", \"#271033\", \"#50514F\", \"#F79256\", \"#FBD1A2\", \"#7DCFB6\", \"#00B2CA\",\n                    \"#1D4E89\", \"#7E78D2\", \"#E71D36\", \"#AF4319\", \"#772014\", \"#3F220F\", \"#19180A\", \"#C0F8D1\"];*/\n\nvar NUM_VARS = 0;\nvar NUM_IMG_VARS = 0;\nvar NUM_AUD_VARS = 0;\n\n/**\n * @class StoryEditor\n * @module StoryEditor\n */\nclass StoryEditor {\n    /**\n     * @function StoryEditor\n     * @param {Story} story - The story to generate\n     * @class StoryEditor\n     */\n    constructor(story) {\n\n        this.baseStory = story;\n        this.exportedStoryPages = [];\n\n        this.variables = new Map();\n        this.imageVariables = new Map();\n        this.audioVariables = new Map();\n\n        this.css = \"\";\n        this.js = \"\";\n        \n        this.regeneratePages();\n\n        this.parseVariables();\n        this.generateStoryText(true);\n\n        this.reparseMedia();\n    }\n\n    /** \n     * Get the default value of a text variable\n     * \n     * @function extractDefault\n     * @param {string} line - Line to extract from\n     * @returns {String}\n     */\n    extractDefault(line) {\n\n        var pos1 = line.indexOf(\";\");\n        var pos2 = line.lastIndexOf(\"&\");\n\n        return line.slice(pos1 + 1, pos2);\n\n    }\n\n    /**\n     * Changes the value of the variable\n     * \n     * @param {String} line - Line to splice into\n     * @param {String} newVal - Value to splice\n     * @returns {String}\n     */\n    writeVariable(line, newVal) {\n        var pos1 = line.indexOf(\";\");\n        var pos2 = line.lastIndexOf(\"&\");\n\n        return line.slice(0, pos1 + 1) + newVal + line.slice(pos2, line.length);\n\n    }\n\n    /** \n     * Get the default name of a text variable\n     * \n     * @function extractVariable\n     * @param {String} line - Line to extract from\n     * @returns {String}\n     */\n    extractVariable(line) {\n        var pos = line.indexOf(\"$\");\n\n        var variable = \"\";\n\n        while ((line.charAt(pos)) != \" \") {\n            variable += line.charAt(pos);\n            pos++;\n        }\n\n        return variable;\n    }\n\n    /** \n     * Obtain all the variables from a story object\n     * \n     * @function parseVariables\n     * @returns {void}\n     */\n    parseVariables() {\n\n        //Extract the passage with variable tag,\n        //IMPORTANT: VAR_TAG SHOULD NOT BE USED DURING STORY CREATION\n        //           THIS PASSAGE WILL BE AUTOMATICALLY GENERATED AND ADDED \n        //           TO THE FIRST PASSAGE OF THE STORY.\n        let variablePassage = [];\n\n        if (this.baseStory.passages.length > 0) {\n            variablePassage = this.baseStory.passages.filter(function (passage) {\n                const results = passage.tags.filter(tag => tag === VAR_TAG);\n\n                return (results.length > 0);\n            });\n        }\n\n        this.variables.clear();\n        //Checks if there is only one passage with the variable tag\n\n        if (variablePassage.length == 1) {\n            var variableText = variablePassage[0].text;\n            var lines = variableText.split(\"\\n\");\n\n            console.log(lines.length);\n\n            for (var j = 0; j < lines.length; j++) {\n\n                if (lines[j].includes(\"(set:\")) {\n\n                    //Adds each variable to a js Map\n\n                    var variable = this.extractVariable(lines[j]);\n                    var defVal = this.extractDefault(lines[j]);\n                    \n                    if(this.variables.has(variable)){\n                        alert(\"Duplicate Variable \\n\\nUpdating Value to: \" + \"\\\"\" + defVal + \"\\\"\");\n                    }\n\n\n                    this.variables.set(variable, {value: defVal, color: \"\", id: NUM_VARS++});\n                    console.log(variable + \" \" + defVal);\n\n                } else if(lines[j].includes(\"(hidden:)\")){\n                    var varData = this.extractArr(lines[j]); \n\n                    if(varData.type == \"image\"){\n\n                        for(var k = 0; k < varData.data.length; k++){\n                            var imgSrc = this.extractSrc(varData.data[k]);\n\n                            this.imageVariables.set(varData.data[k].substring(0, varData.data[k].indexOf(\"{\")), {file: null, fileName: imgSrc.name, path: imgSrc.src, color: \"\", id: NUM_IMG_VARS++, uploaded: !imgSrc.src.i.includes(\"blob\")});\n                        }\n                    } else if(varData.type == \"audio\"){\n\n                        for(var a = 0; a < varData.data.length; a++){\n                            var audSrc = this.extractSrc(varData.data[a]);\n\n                            this.audioVariables.set(varData.data[a].substring(0, varData.data[a].indexOf(\"{\")), {file: null, fileName: imgSrc.name, path: audSrc.src, color: \"\", id: NUM_AUD_VARS++, uploaded: !audSrc.src.i.includes(\"blob\")});\n                        }\n\n                    }\n\n                }\n\n            }\n\n            lines = lines.filter(function(line) {\n                return !line.includes(\"(set:\") && !line.includes(\"(hidden:)\");  \n            });\n            \n            for(var l = 0; l<  this.baseStory.passages.length; l++){\n                if(this.baseStory.passages[l].tags.includes(VAR_TAG)){\n\n                    this.baseStory.passages[l].text = lines.join(\"\\n\");\n\n                    break;\n                }\n            }\n        } else {\n            throw new Error(\"Please remove extra variable passage tags\");\n        }\n\n        this.detVariableColors();\n        this.printVariableData();\n    }\n\n    /**\n     * Extracts the image variable data in the story\n     * \n     * @function extractArr\n     * @param {String} line \n     */\n    extractArr(line){\n        var source = line.split(\"[\");\n        var chunk = source[1].replace(\"]\", \"\");\n        source = chunk.split(\":\");\n\n        var type = source[0];\n        var arr = chunk.replace(source[0] + \":\", \"\").split(\",\");\n\n        arr = arr.filter(function(i){\n            return i != \"\";\n        })\n\n        console.log(arr);\n\n        return {type: type, data: arr};\n    }\n\n    extractSrc(line){\n        var source = line.split(\"{\");\n\n        var src = \"\";\n        var fileName = \"\";\n\n        if(source.length > 1){\n            src = source[1].split(\" \")[0];\n            fileName = source[1].split(\" \")[1].replace(\"}\", \"\");\n        }\n\n        return {src: {i: src}, name: fileName};\n    }\n\n    /**\n     * Removes the variable code injection\n     * \n     * @function removeVariableInject\n     * \n     */\n    removeVariableInject(){\n\n        var text = sessionStorage.getItem(\"preProcessedBaseText\");\n        var process = text != \"\";\n\n        if(process){\n            for(var k = 0; k< this.baseStory.passages.length; k++){\n                if(this.baseStory.passages[k].tags.includes(VAR_TAG)){\n                \n                    \n                    this.baseStory.passages[k].text = text;\n\n                    break;\n                }\n            }\n\n            for(var i = 0; i< this.exportedStoryPages.length; i++){\n                if(this.exportedStoryPages[i].linkPassage.tags.includes(VAR_TAG)){\n\n                    this.exportedStoryPages[i].linkPassage.text = text;\n                    break;\n                }\n            }\n        }\n\n        /*let variablePassage = [];\n\n        if (this.baseStory.passages.length > 0) {\n            variablePassage = this.baseStory.passages.filter(function (passage) {\n                const results = passage.tags.filter(tag => tag === VAR_TAG);\n\n                return (results.length > 0);\n            });\n        }\n\n        //Checks if there is only one passage with the variable tag\n\n        if (variablePassage.length == 1) {\n            var variableText = variablePassage[0].text;\n            var lines = variableText.split(\"\\n\");\n\n            lines = lines.filter(function(line) {\n                return !line.includes(\"(set:\");  \n            });\n            \n            for(var k = 0; k< this.baseStory.passages.length; k++){\n                if(this.baseStory.passages[k].tags.includes(VAR_TAG)){\n                    this.baseStory.passages[k].text = lines.join(\"\\n\");\n\n                    break;\n                }\n            }\n        } else {\n            throw new Error(\"Please remove extra variable passage tags\");\n        }*/\n    }\n\n    detVariableColors(){\n        this.detTextVariableColors();\n        this.detImageVariableColors();\n        this.detAudioVariableColors();\n    }\n\n    detImageVariableColors(){\n        var sortedKeys = [];\n\n\t\tthis.imageVariables.forEach(\n\t\t\tfunction(value, key){\n\t\t\t\tsortedKeys.push(key);\n\t\t\t}\n        );\n        \n        var varMap = this.imageVariables;\n\n\t\tsortedKeys = sortedKeys.sort(function(a, b){\n            var idA = varMap.get(a).id;\n            var idB = varMap.get(b).id;\n\n            return idA - idB;\n            \n        });\n        \n\n        for(var i = 0; i < sortedKeys.length; i++){\n            var data = this.imageVariables.get(sortedKeys[i]);\n\n\n            if(data.color == \"\"){\n                var oR = 255;\n                var oG = 165;\n                var oB = 0;\n\n                var randR = Math.random() * 256\n                var randG = Math.random() * 256;\n                var randB = Math.random() * 256;\n\n                data.color = \"rgb(\" + ((oR + randR)/2) + \",\" + ((oG + randG)/2) + \",\" + ((oB + randB)/2) + \")\";\n            }\n\n            this.imageVariables.set(sortedKeys[i], data);\n        }\n    }\n\n    detAudioVariableColors(){\n        var sortedKeys = [];\n\n\t\tthis.audioVariables.forEach(\n\t\t\tfunction(value, key){\n\t\t\t\tsortedKeys.push(key);\n\t\t\t}\n        );\n        \n        var varMap = this.audioVariables;\n\n\t\tsortedKeys = sortedKeys.sort(function(a, b){\n            var idA = varMap.get(a).id;\n            var idB = varMap.get(b).id;\n\n            return idA - idB;\n            \n        });\n        \n\n        for(var i = 0; i < sortedKeys.length; i++){\n            var data = this.audioVariables.get(sortedKeys[i]);\n\n\n            if(data.color == \"\"){\n                var oR = 255;\n                var oG = 165;\n                var oB = 0;\n\n                var randR = Math.random() * 256\n                var randG = Math.random() * 256;\n                var randB = Math.random() * 256;\n\n                data.color = \"rgb(\" + ((oR + randR)/2) + \",\" + ((oG + randG)/2) + \",\" + ((oB + randB)/2) + \")\";\n            }\n\n\n\n            this.audioVariables.set(sortedKeys[i], data);\n        }\n    }\n    /**\n     * Determines the swatch of the variable\n     * \n     * @function detVariableColors\n     * \n     */\n    detTextVariableColors(){\n        var sortedKeys = [];\n\n\t\tthis.variables.forEach(\n\t\t\tfunction(value, key){\n\t\t\t\tsortedKeys.push(key);\n\t\t\t}\n        );\n        \n        var varMap = this.variables;\n\n\t\tsortedKeys = sortedKeys.sort(function(a, b){\n            var idA = varMap.get(a).id;\n            var idB = varMap.get(b).id;\n\n            return idA - idB;\n            \n        });\n        \n\n        for(var i = 0; i < sortedKeys.length; i++){\n            var data = this.variables.get(sortedKeys[i]);\n\n\n            if(data.color == \"\"){\n                var oR = 255;\n                var oG = 165;\n                var oB = 0;\n\n                var randR = Math.random() * 256\n                var randG = Math.random() * 256;\n                var randB = Math.random() * 256;\n\n                data.color = \"rgb(\" + ((oR + randR)/2) + \",\" + ((oG + randG)/2) + \",\" + ((oB + randB)/2) + \")\";\n            }\n\n\n\n            this.variables.set(sortedKeys[i], data);\n        }\n\t\t\n    }\n\n    printVariableData(){\n        this.imageVariables.forEach(function(data, key){\n            console.log(key + \"==>\" + JSON.stringify(data));\n        });\n\n        this.audioVariables.forEach(function(data, key){\n            console.log(key + \"==>\" + JSON.stringify(data));\n        });\n\n        this.variables.forEach(function(data, key){\n            console.log(key + \"==>\" + JSON.stringify(data));\n        });\n    }\n\n    /**\n     * Reparses the links in the passage text\n     * @function reparseLinks\n     */\n    reparseLinks(){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n            this.exportedStoryPages[i].reparseLinks();\n        }\n    }\n\n    /**\n     * \n     */\n    reparseMedia(){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n            this.exportedStoryPages[i].reparseMedia(this.imageVariables, this.audioVariables);\n        }\n    }\n\n    /**\n     * \n     * @param {*} event \n     */\n    addAudioToPage(event){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n            if(this.exportedStoryPages[i].pageName == event.pageName)\n                this.exportedStoryPages[i].addAudio(event);\n        }\n        \n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    /**\n     * \n     * @param {*} event \n     */\n    removeAudioFromPage(event){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n            if(this.exportedStoryPages[i].pageName == event.pageName)\n                this.exportedStoryPages[i].removeAudio(event);\n        }\n        \n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    /**\n     * \n     * @param {*} event \n     */\n    addImageToPage(event){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n            if(this.exportedStoryPages[i].pageName == event.pageName)\n                this.exportedStoryPages[i].addImage(event);\n        }\n\n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    /**\n     * \n     * @param {*} event \n     */\n    removeImageFromPage(event){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n            if(this.exportedStoryPages[i].pageName == event.pageName)\n                this.exportedStoryPages[i].removeImage(event);\n        }\n\n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n\n    /**\n     * Refactors the link text so that it is properly configured\n     * \n     * @function replaceLinks\n     * @param {Event} event \n     */\n    replaceLinks(event){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n\n            this.exportedStoryPages[i].replaceLinks(event);\n\n            for(var j = 0; j < this.baseStory.passages.length; j++){\n                if(this.baseStory.passages[j].name == this.exportedStoryPages[i].linkPassage.name){\n                    this.baseStory.passages[j].text = this.exportedStoryPages[i].linkPassage.text;\n                }\n            }\n        }\n    }\n\n    /**\n     * Refactors the link text so that it is properly configured\n     * \n     * @function replaceLinks\n     * @param {Event} event \n     */\n    replaceVariables(event){\n\n        var mergedMap = new Map();\n\n        this.variables.forEach(function(value, key){\n            mergedMap.set(key, value);\n        });\n\n        this.imageVariables.forEach(function(value, key){\n            mergedMap.set(key, value);\n        });\n\n        this.audioVariables.forEach(function(value, key){\n            mergedMap.set(key, value);\n        });\n\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n\n            this.exportedStoryPages[i].replaceVariable(event, mergedMap);\n\n            for(var j = 0; j < this.baseStory.passages.length; j++){\n                if(this.baseStory.passages[j].name == this.exportedStoryPages[i].linkPassage.name){\n                    this.baseStory.passages[j].text = this.exportedStoryPages[i].linkPassage.text;\n                }\n            }\n        }\n\n        /*for(var m = 0; m < this.exportedStoryPages.length; m++){\n\n            this.exportedStoryPages[m].replaceVariable(event, this.imageVariables);\n\n            for(var n = 0; n < this.baseStory.passages.length; n++){\n                if(this.baseStory.passages[n].name == this.exportedStoryPages[m].linkPassage.name){\n                    this.baseStory.passages[n].text = this.exportedStoryPages[m].linkPassage.text;\n                }\n            }\n        }\n\n        for(var k = 0; k < this.exportedStoryPages.length; k++){\n\n            this.exportedStoryPages[k].replaceVariable(event, this.audioVariables);\n\n            for(var l = 0; l < this.baseStory.passages.length; l++){\n                if(this.baseStory.passages[l].name == this.exportedStoryPages[k].linkPassage.name){\n                    this.baseStory.passages[l].text = this.exportedStoryPages[k].linkPassage.text;\n                }\n            }\n        }*/\n\n        //this.printVariableData();\n    }\n\n    /**\n     * Programmatically adds a link to a page\n     * \n     * @function addLink\n     * @param {Event} event - data\n     */\n    addLink(event){\n\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n\n            if(this.exportedStoryPages[i].pageName == event.pageName){\n                this.exportedStoryPages[i].addLink(event.name);\n                break;\n            }\n            \n        }\n\n        this.reparseLinks();\n        //this.printVariableData();\n    }\n\n    /**\n     * Removes a link from a page\n     * \n     * @function removeLink\n     * @param {Event} event - data\n     */\n    removeLink(event){\n        for(var i = 0; i < this.exportedStoryPages.length; i++){\n\n            if(this.exportedStoryPages[i].pageName == event.name){\n                this.exportedStoryPages[i].removeLink(event.removeLink);\n                break;\n            }\n            \n        }\n\n        this.reparseLinks();\n    }\n\n    /**\n     * Sets the start page for the story\n     * \n     * @function setStartPage\n     * @param {Event} event - data\n     */\n    setStartPage(event){\n\n        for(var i = 0; i < this.baseStory.passages.length; i++){\n            if(this.baseStory.passages[i].tags.includes(\"start\")){\n                this.baseStory.passages[i].tags = this.baseStory.passages[i].tags.filter(function(tag){\n                    return tag != \"start\";\n                });\n            } \n\n            if(this.baseStory.passages[i].tags.includes(VAR_TAG)){\n                this.baseStory.passages[i].tags = this.baseStory.passages[i].tags.filter(function(tag){\n                    return tag != VAR_TAG;\n                });\n            } \n\n            if(this.baseStory.passages[i].name == event.name){\n                this.baseStory.passages[i].tags.push(\"start\");\n                this.baseStory.passages[i].tags.push(VAR_TAG);\n            }\n            \n            \n            var remText = this.baseStory.passages[i].text;\n            var source = remText.split(\"\\n\");\n            \n            source = source.filter(function(line) {\n                return !line.includes(\"(set:\");  \n            });\n            \n            this.baseStory.passages[i].text = source.join(\"\\n\");\n        }\n\n        \n    }\n    \n    /**\n     * Adds a new page to the story\n     * \n     * @function addPage\n     * @param {Event} event \n     */\n    addPage(event){\n        var pageName = event.name;  \n        \n        var process = true;\n\n        if(process){\n            var baseText = \"This is a new passage. Edit it to create your own story!\\n[[go back-&gt;\" + event.prevLink + \"]]\";\n\n            var nLinkPassage = new Passage(pageName, [\"story\"], {position:\"500, 500\", size:\"100,100\"}, baseText, this.baseStory.passages.length + 1);\n            this.baseStory.passages.push(nLinkPassage);\n\n            this.exportedStoryPages.push(new Page(null, nLinkPassage, \"background-color: #ffffff; color: #000000;\", this.baseStory.getStoryPassages().length, {story: this.baseStory, pages: this.baseStory.getStoryPassages().length}));\n\n            this.reparseLinks();\n            this.reparseMedia();\n        }\n    }\n\n    /**\n     * Resets all the pages in the story\n     * \n     * @function regeneratePages\n     */\n    regeneratePages(){\n        this.exportedStoryPages = [];\n        var length = this.baseStory.getStoryPassages().length;\n\n        for(var i = 0; i < length; i++){\n            this.exportedStoryPages.push(new Page(null, this.baseStory.getStoryPassages()[i], \"background-color: #ffffff; color: #000000;\", i + 1, {story: this.baseStory, pages: length}));\n        }\n    }\n\n    /**\n     * Safely changes the passage name\n     * \n     * @function changePassageName\n     * @param {Event} event \n     */\n    changePassageName(event){\n            \n        if(event.prevName != event.newName){\n            for(var i = 0; i < this.baseStory.passages.length; i++){\n                if(this.baseStory.passages[i].name == event.prevName){\n                    this.baseStory.passages[i].name = event.newName;\n                    console.log(\"Changed Name\");\n                }\n            }\n\n            for(var j = 0; j < this.exportedStoryPages.length; j++){\n                if(this.exportedStoryPages[j].linkPassage.name == event.prevName){\n                    this.exportedStoryPages[j].linkPassage.name = event.newName;\n                    console.log(\"Changed Name\");\n                }\n            }\n\n            this.replaceLinks(event);\n            this.reparseLinks();\n        }\n    }\n\n    /**\n     * Removes a passage from the story;\n     * @function deletePassage\n     * @param {Event} event \n     */\n    deletePassage(event){\n\n        var passage;\n        var index = 0;\n\n        for(var i = 0; i< this.baseStory.passages.length; i++){\n            if(this.baseStory.passages[i].name == event.name){\n                passage = this.baseStory.passages[i];\n                index = i;\n\n                console.log(\"Passage:\" + passage.name);\n\n                break;\n            }\n        }\n\n        if(passage.tags.includes(VAR_TAG)){\n            alert(\"DELETING THIS PASSAGE WILL RESULT IN STORY BREAKAGE\\nABORTING DELETE\");\n        } else {\n            \n            if(passage.tags.includes('start')){\n                alert(\"Deleting this passage will randomly assign a new start passage, select a start passage from the passages menu\");\n                this.baseStory.passages[index + 1].tags.push(\"start\");\n            }\n            \n            this.baseStory.passages = this.baseStory.passages.filter(function(passage){\n                return passage.name != event.name;\n            });\n\n            this.exportedStoryPages = this.exportedStoryPages.filter(function(page){\n                return page.pageName != event.name;\n            });\n\n            this.replaceLinks({prevName: event.name, newName: \"\"});\n            this.reparseLinks();\n        }\n\n    }\n\n    /** \n     * Change the generated value of a text variable\n     * \n     * @function setTextVariable\n     * @param {String} variableName - Variable Name to change\n     * @param {String} newText - Text to change the variable to\n     * @returns {void}\n     */\n    setTextVariable(variableName, newText) {\n        var data = this.variables.get(variableName);\n        \n        console.log(JSON.stringify(data));\n\n        data.value = newText;\n\n        this.variables.set(variableName, data);\n    }\n\n\n    /** \n     * Change the generated value of a text variable\n     * \n     * @function setTextVariable\n     * @param {String} variableName \n     * @param {Event} data {}\n     * @returns {void}\n     */\n    setImageVariable(variableName, data){\n        this.imageVariables.set(variableName, data);\n\n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    /** \n     * Change the generated value of a text variable\n     * \n     * @function setTextVariable\n     * @param {String} variableName \n     * @param {Event} data {}\n     * @returns {void}\n     */\n    setAudioVariable(variableName, data){\n        this.audioVariables.set(variableName, data);\n\n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    /**\n     * \n     * @function changeVariableName\n     * @param {Event} event \n     */\n    changeTextVariableName(event){\n        var process = this.checkEvent({name: event.newName}, \"text\");\n\n        if(process){\n            this.replaceVariables(event);\n\n            var data = this.variables.get(event.prevName);\n            this.variables.delete(event.prevName);\n            this.variables.set(event.newName, data);\n        }\n\n        return process;\n\n    }\n\n    /**\n     * \n     * @function changeVariableName\n     * @param {Event} event \n     */\n    changeImageVariableName(event){\n        var process = this.checkEvent({name: event.newName}, \"media\");\n\n        console.log()\n\n        if(process){\n            this.replaceVariables(event);\n\n            var data = this.imageVariables.get(event.prevName);\n            this.imageVariables.delete(event.prevName);\n            this.imageVariables.set(event.newName, data);\n\n            this.reparseMedia();\n        }\n\n        return process;\n            //this.printVariableData();\n    }\n\n    /**\n     * \n     * @function changeVariableName\n     * @param {Event} event \n     */\n    changeAudioVariableName(event){\n\n        var process = this.checkEvent({name: event.newName}, \"media\");\n\n        if(process){\n            this.replaceVariables(event);\n\n            var data = this.audioVariables.get(event.prevName);\n            this.audioVariables.delete(event.prevName);\n            this.audioVariables.set(event.newName, data);\n\n            this.reparseMedia();\n        }\n\n        return process;\n        //this.printVariableData();\n    }\n    \n    /**\n     * Adds a variable to the story\n     * \n     * @function addVariable\n     * @param {Event} event \n     */\n    addTextVariable(event){\n        \n        var process = this.checkEvent(event, \"text\");\n\n        if(process){\n            this.variables.set(event.name, {value: event.value, color: \"\", id: NUM_VARS++});\n\n            this.detVariableColors();\n        }\n\n        return process;\n    }\n\n    /**\n     * Adds an image variable\n     * @function addImageVariable\n     * @param {Event} event {name: varName, file: null, fileName: \"\", path: \"\", id: \"\"}\n     */\n    addImageVariable(event){\n\n        var process = this.checkEvent(event, \"media\");\n        if(process){\n            this.imageVariables.set(event.name, {file: event.file, fileName: event.fileName, path: event.path, color: \"\", id: NUM_IMG_VARS++, uploaded: event.uploaded});\n            //this.printVariableData();\n\n            this.detVariableColors();\n        }\n\n        return process;\n    }\n\n    /**\n     * Adds an image variable\n     * @function addImageVariable\n     * @param {Event} event {name: varName, file: null, fileName: \"\", path: \"\", id: \"\"}\n     */\n    addAudioVariable(event){\n        var process = this.checkEvent(event, \"media\");\n        if(process){\n            this.audioVariables.set(event.name, {file: event.file, fileName: event.fileName, path: event.path, color: \"\", id: NUM_AUD_VARS++, uploaded: event.uploaded});\n            //this.printVariableData();\n\n            this.detVariableColors();\n        }\n\n        return process;\n    }\n\n    checkEvent(event, type){\n\n        var process = false;\n\n        if(type == \"text\"){\n            process = !(this.variables.has(event.name));\n        } else if(type == \"media\"){\n            process = !((this.imageVariables.has(event.name)) || (this.audioVariables.has(event.name)));\n        }\n\n        if(!process){\n            alert(event.name + \" already exists!\");\n        }\n\n        return process;\n    }\n\n    /**\n     * Removes a variable from the story\n     * \n     * @function deleteVariable\n     * @param {Event} event \n     */\n    deleteTextVariable(event){\n\n        var dataArr = [];\n\n        this.variables.forEach(\n            function(value, key){\n                dataArr.push({name: key});\n            }\n        );\n\n        for(var j = 0; j < this.exportedStoryPages.length; j++){\n            this.exportedStoryPages[j].removeKeyFromText(dataArr, event.name);\n        }\n        \n        this.variables.delete(event.name);\n\n        var sortedKeys = [];\n\n\t\tthis.variables.forEach(\n\t\t\tfunction(value, key){\n\t\t\t\tsortedKeys.push(key);\n\t\t\t}\n\t\t);\n\n\t\tsortedKeys = sortedKeys.sort(function(a, b){\n            if(a > b){\n                return 1;\n            } else if(a < b){\n                return -1;\n            } else {\n                return 0;\n            }\n            \n        });\n        \n\n        for(var i = 0; i < sortedKeys.length; i++){\n            var data = this.variables.get(sortedKeys[i]);\n            data.id--;\n            this.variables.set(sortedKeys[i], data);\n        }\n        \n\n        NUM_VARS--;\n\n    }\n\n    deleteImageVariable(event){\n\n        var dataArr = [];\n\n        this.imageVariables.forEach(\n            function(value, key){\n                dataArr.push({name: key});\n            }\n        );\n\n        this.audioVariables.forEach(\n            function(value, key){\n                dataArr.push({name: key});\n            }\n        );\n\n        for(var j = 0; j < this.exportedStoryPages.length; j++){\n            this.exportedStoryPages[j].removeKeyFromText(dataArr, event.name);\n        }\n        \n        this.imageVariables.delete(event.name);\n\n        var sortedKeys = [];\n\n\t\tthis.imageVariables.forEach(\n\t\t\tfunction(value, key){\n\t\t\t\tsortedKeys.push(key);\n\t\t\t}\n\t\t);\n\n\t\tsortedKeys = sortedKeys.sort(function(a, b){\n            if(a > b){\n                return 1;\n            } else if(a < b){\n                return -1;\n            } else {\n                return 0;\n            }\n            \n        });\n        \n\n        for(var i = 0; i < sortedKeys.length; i++){\n            var data = this.imageVariables.get(sortedKeys[i]);\n            data.id--;\n            this.imageVariables.set(sortedKeys[i], data);\n        }\n\n        NUM_IMG_VARS--;\n\n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    deleteAudioVariable(event){\n\n        var dataArr = [];\n\n        this.imageVariables.forEach(\n            function(value, key){\n                dataArr.push({name: key});\n            }\n        );\n\n        this.audioVariables.forEach(\n            function(value, key){\n                dataArr.push({name: key});\n            }\n        );\n\n        for(var j = 0; j < this.exportedStoryPages.length; j++){\n            this.exportedStoryPages[j].removeKeyFromText(dataArr, event.name);\n        }\n\n        this.audioVariables.delete(event.name);\n\n        var sortedKeys = [];\n\n\t\tthis.audioVariables.forEach(\n\t\t\tfunction(value, key){\n\t\t\t\tsortedKeys.push(key);\n\t\t\t}\n\t\t);\n\n\t\tsortedKeys = sortedKeys.sort(function(a, b){\n            if(a > b){\n                return 1;\n            } else if(a < b){\n                return -1;\n            } else {\n                return 0;\n            }\n            \n        });\n        \n\n        for(var i = 0; i < sortedKeys.length; i++){\n            var data = this.audioVariables.get(sortedKeys[i]);\n            data.id--;\n            this.audioVariables.set(sortedKeys[i], data);\n        }\n\n        NUM_AUD_VARS--;\n\n\n        this.reparseMedia();\n        //this.printVariableData();\n    }\n\n    /**\n     * Get the new text for a passage and replace it in the story\n     * \n     * @function setPassage\n     * @param {String} passageName - Name of the passage\n     * @param {String} newText - New text for the passage\n     * @param {String} hidden - Value to regenerate story text\n     * @returns {void}\n     */\n    setPassage(passageName, newText){\n        for(var i = 0; i < this.baseStory.passages.length; i++){\n            if(this.baseStory.passages[i].name == passageName){\n                this.baseStory.passages[i].text = newText;\n\n                console.log(\"Text Changed\");\n\n            }\n            \n        }\n\n        this.reparseLinks();\n        this.reparseMedia();\n    }\n\n    /**\n     * Changes the name of the story\n     * \n     * @function changeStoryName\n     * @param {Event} event \n     */\n    changeStoryName(event){\n        this.baseStory.name = event.name;\n    }\n\n\n    /** \n     * Generate the story with the revised variables.\n     * \n     * @function generateViewStory\n     * @returns {void}\n     */\n    generateViewStory(media) {\n        //Extract the passage with variable tag,\n        //IMPORTANT: VAR_TAG SHOULD NOT BE USED DURING STORY CREATION\n        //           THIS PASSAGE WILL BE AUTOMATICALLY GENERATED AND ADDED \n        //           TO THE FIRST PASSAGE OF THE STORY.\n\n        this.css = \"\";\n\n        console.log(\"Generating Story...\");\n\n        var viewStory = new Story(JSON.parse(JSON.stringify(this.baseStory)));\n\n        console.log(viewStory.name);\n\n        for(var i = 0; i < viewStory.passages.length; i++){\n            \n            var passageObj = JSON.parse(JSON.stringify(this.exportedStoryPages[i].linkPassage));\n\n            viewStory.passages[i] = new Passage(passageObj.name, passageObj.tags, passageObj.metadata, passageObj.text, passageObj.pid);\n\n            viewStory.passages[i].text = viewStory.passages[i].text.trim();\n\n            if(viewStory.passages[i].tags.includes(VAR_TAG)){\n                \n                //console.log(\"Text Changed:\" + this.baseStory.passages[i].text);\n                var textToPush = viewStory.passages[i].text;\n            \n                var sortedKeys = [];\n\n                this.variables.forEach(\n                    function(value, key){\n                        sortedKeys.push(key);\n                    }\n                );\n\n                sortedKeys = sortedKeys.sort(function(a, b){\n                    return a.length - b.length;\n                });            \n\n                for(var j = 0; j < sortedKeys.length; j++){\n                    \n                    //console.log(\"KEY: \" + sortedKeys[j])\n\n                        //console.log(\"KEY: \" + key + \" VALUE: \" + value)\n                    var key = sortedKeys[j];    \n                    var temp = textToPush.split(key);\n                    var data = this.variables.get(key);\n                    \n                    textToPush = temp.join(data.value);\n                   \n                }\n                \n                \n                viewStory.passages[i].text = textToPush +  \"\\n\"  + this.injectVariableText();\n            } \n\n            if(media)\n                viewStory.passages[i].text = this.injectMedia(viewStory.passages[i].text);\n\n            this.css += this.exportedStoryPages[i].injectCSSText() + '\\n';\n        }\n\n        this.css += \"body{ text-align: center;}\"\n\n        return viewStory;\n\n    }\n\n    injectMedia(textToPush){\n\n        var sortedKeys = [];\n\n        this.imageVariables.forEach(\n            function(value, key){\n                sortedKeys.push(key);\n            }\n        );\n\n        this.audioVariables.forEach(\n            function(value, key){\n                sortedKeys.push(key);\n            }\n        )\n\n        sortedKeys = sortedKeys.sort(function(a, b){\n            return b.length - a.length;\n        });            \n\n        for(var j = 0; j < sortedKeys.length; j++){\n            \n            //console.log(\"KEY: \" + sortedKeys[j])\n\n                //console.log(\"KEY: \" + key + \" VALUE: \" + value)\n            var key = sortedKeys[j];    \n            var temp = textToPush.split(key);\n            \n            var data = null;\n\n            if(this.imageVariables.has(key)){\n                data = this.imageVariables.get(key);\n                \n                textToPush = temp.join(\"<img style = 'max-width: 50%; max-height:50%;' src = '\" + data.path.i + \"' alt = \" + key.replace(\"@\", \"\") + \"/>\");\n\n            } else if(this.audioVariables.has(key)){\n                data = this.audioVariables.get(key);\n\n                textToPush = temp.join(\"<audio controls><source src = '\" + data.path.i + \"'> Your Browser Does not support the audio element </audio>\");\n            }\n\n            //textToPush = temp.join(\"<img style = 'max-width: 50%; max-height:50%;' src = '\" + data.path.i + \"' alt = \" + key + \"/>\");\n            \n            /*if(data.uploaded) {\n                \n            }\n            if(!data.uploaded) {\n                textToPush = temp.join(\"<img style = 'max-width: 50%; max-height:50%;' src = '\" + data.path + \"' alt = \" + key + \"/>\");\n            }*/\n        }\n\n        return textToPush;\n    }\n\n\n    /**\n     * Generates variable insertion text\n     *  \n     * @function injectVariableText\n     */\n    injectVariableText(){\n        var inject = \"\";\n\n        this.variables.forEach(function(data, key){\n            inject += \"(set: \";\n            inject += key;\n            inject += \" to &quot;\";\n            inject += data.value;\n            inject += \"&quot;)\\n\"\n        });\n        \n        inject += \"(hidden:)[image:\"\n\n        this.imageVariables.forEach(function(data, key){\n            //console.log(key + \": \" + JSON.stringify(data));\n\n            inject += key + \"{\" + data.path.i + \" \" + data.fileName + \"},\"\n        });\n\n        inject += \"]\\n\"\n\n        inject += \"(hidden:)[audio:\"\n\n        this.audioVariables.forEach(function(data, key){\n\n            inject += key + \"{\" + data.path.i + \" \" + data.fileName + \"},\"\n\n        });\n\n        inject += \"]\\n\"\n\n        return inject;\n        \n    }\n\n\n    /**\n     * Get cloud save story\n     * \n     * @function generateSaveStory\n     * @returns {Story} story to be pushed to cloud;\n     */\n    generateSaveStory(){\n\n        this.css = \"\";\n\n        var cloudStory = new Story(JSON.parse(JSON.stringify(this.baseStory)));\n\n        for(var i = 0; i < cloudStory.passages.length; i++){\n\n            var passageObj = JSON.parse(JSON.stringify(this.exportedStoryPages[i].linkPassage));\n\n            cloudStory.passages[i] = new Passage(passageObj.name, passageObj.tags, passageObj.metadata, passageObj.text, passageObj.pid);\n\n            cloudStory.passages[i].text = cloudStory.passages[i].text.trim();\n\n            if(cloudStory.passages[i].tags.includes(VAR_TAG)){\n                \n                //console.log(\"Text Changed:\" + this.baseStory.passages[i].text);    \n                cloudStory.passages[i].text = cloudStory.passages[i].text +  \"\\n\"  + this.injectVariableText();\n            } \n            \n            this.css += this.exportedStoryPages[i].injectCSSText() + '\\n';\n        }\n\n        return cloudStory;\n    }\n\n\n    /** \n     * Generate the story with the revised text.\n     * \n     * @function generateStoryText\n     * @returns {void}\n     */\n    generateStoryText(hidden, inVariables, inMedia) {\n\n        //this.exportedStoryText = [];\n\n        let scriptPassages = this.baseStory.getStoryPassages();\n\n        for (var i = 0; i < scriptPassages.length; i++) {\n\n            var textToPush = scriptPassages[i].text;\n\n            textToPush = this.processTextVariables(textToPush, hidden, inVariables);\n            textToPush = this.processMediaVariables(textToPush, hidden, inMedia);\n            \n            while(textToPush.includes(\"]]\") || textToPush.includes(\"[[\")){ \n                textToPush = textToPush.replace('[[', \"<u>\");\n                textToPush = textToPush.replace(']]', \"</u>\");\n            }\n            \n\n            while (textToPush.includes(\"&quot;\") || textToPush.includes(\"&#39;\") || textToPush.includes(\"&gt;\") || textToPush.includes(\"&lt;\")) {\n                textToPush = textToPush.replace(\"&quot;\", \"\\\"\");\n                textToPush = textToPush.replace(\"&#39;\", \"'\");\n                textToPush = textToPush.replace(\"&lt;\", \"<\");\n                textToPush = textToPush.replace(\"&gt;\", \">\");\n            }\n            \n            //textToPush = textToPush.replace(/(\\r\\n|\\r|\\n){2,}/g, '\\n');\n\n            var nPassage = new Passage(scriptPassages[i].name, \n                scriptPassages[i].tags, scriptPassages[i].metadata, textToPush, scriptPassages[i].pid);\n\n            this.exportedStoryPages[i].dispPassage = nPassage;\n            this.exportedStoryPages[i].pageName = nPassage.name;\n            this.exportedStoryPages[i].story = this.baseStory;\n            this.exportedStoryPages[i].pages = this.baseStory.getStoryPassages().length;\n\n        }\n    }\n\n\n    processTextVariables(textToPush, hidden, inVariables){\n        var sortedKeys = [];\n\n        this.variables.forEach(\n            function(value, key){\n                sortedKeys.push(key);\n            }\n        );\n\n        sortedKeys = sortedKeys.sort(function(a, b){\n            return b.length - a.length;\n        });            \n\n        for(var j = 0; j < sortedKeys.length; j++){\n            \n            //console.log(\"KEY: \" + sortedKeys[j])\n\n                //console.log(\"KEY: \" + key + \" VALUE: \" + value)\n            var key = sortedKeys[j];    \n            var temp = textToPush.split(key);\n            var data = this.variables.get(key);\n\n            if(!hidden){\n                if(inVariables){\n                    textToPush = temp.join(\"<span style = 'color:\" + data.color + \";'><strong>(\" + key.replace(\"$\", \"\") + \")</strong></span>\" + data.value);\n                } else {\n                    textToPush = temp.join(\"<span>(\" + key.replace(\"$\", \"\") + \")</span>\" + data.value);\n                }\n            } else {\n                if(inVariables){\n                    textToPush = temp.join(\"<span style = 'color:\" + data.color + \";'><strong>\" + data.value + \"</strong></span>\");\n                } else{\n                    textToPush = temp.join(\"<span>\" + data.value + \"</span>\");   \n                }\n            }\n            \n        }\n\n        return textToPush;\n    }\n\n\n    processMediaVariables(textToPush, hidden, inMedia){\n        \n        var sortedKeys = [];\n\n        this.imageVariables.forEach(\n            function(value, key){\n                sortedKeys.push(key);\n            }\n        );\n\n        this.audioVariables.forEach(\n            function(value, key){\n                sortedKeys.push(key);\n            }\n        );\n\n        sortedKeys = sortedKeys.sort(function(a, b){\n            return b.length - a.length;\n        });            \n\n        for(var j = 0; j < sortedKeys.length; j++){\n            \n            //console.log(\"KEY: \" + sortedKeys[j])\n\n                //console.log(\"KEY: \" + key + \" VALUE: \" + value)\n            var key = sortedKeys[j];    \n            var temp = textToPush.split(key);\n            var data = this.imageVariables.has(key) ? this.imageVariables.get(key) : this.audioVariables.get(key);\n            \n            var value = \"\";\n\n            if(data.fileName.length > 30){\n                value = data.fileName.substr(0, 30) + \"...\";\n            } else {\n                value = data.fileName;\n            }\n\n            if(value == \"\"){\n                value = \"No File Uploaded\";\n            }\n\n            if(!hidden){\n                if(inMedia){\n                    textToPush = temp.join(\"<span style = 'color:\" + data.color + \";'><strong>(\" + key.replace(\"@\", \"\") + \")</strong></span>\" + value);\n                } else {\n                    textToPush = temp.join(\"<span>(\" + key.replace(\"@\", \"\") + \")</span>\" + value);\n                }\n            } else {\n                if(inMedia){\n                    textToPush = temp.join(\"<span style = 'color:\" + data.color + \";'><strong>(\" + value + \")</strong></span>\");\n                } else {\n                    textToPush = temp.join(\"<span>(\" + value + \")</span>\");\n                }\n            }\n            \n        }\n\n        return textToPush;\n    }\n\n    generatePublishStory(){\n        this.css = \"\";\n\n        var cloudStory = new Story(JSON.parse(JSON.stringify(this.baseStory)));\n\n        for(var i = 0; i < cloudStory.passages.length; i++){\n\n            var passageObj = JSON.parse(JSON.stringify(this.exportedStoryPages[i].linkPassage));\n\n            cloudStory.passages[i] = new Passage(passageObj.name, passageObj.tags, passageObj.metadata, passageObj.text, passageObj.pid);\n\n            cloudStory.passages[i].text = cloudStory.passages[i].text.trim();\n\n            if(cloudStory.passages[i].tags.includes(VAR_TAG)){\n                \n                //console.log(\"Text Changed:\" + this.baseStory.passages[i].text);    \n                cloudStory.passages[i].text = cloudStory.passages[i].text +  \"\\n\"  + this.injectPublishVariableText();\n            } \n            \n            this.css += this.exportedStoryPages[i].injectCSSText() + '\\n';\n        }\n\n        this.css += \"body{ text-align: center;}\"\n\n        return cloudStory;\n    }\n\n      /**\n     * Generates variable insertion text\n     *  \n     * @function injectVariableText\n     */\n    injectPublishVariableText(){\n        var inject = \"\";\n\n        this.variables.forEach(function(data, key){\n            inject += \"(set: \";\n            inject += key;\n            inject += \" to &quot;\";\n            inject += \"(\" + key.replace(\"$\", \"\") + \")\";\n            inject += \"&quot;)\\n\"\n        });\n        \n        inject += \"(hidden:)[image:\"\n\n        this.imageVariables.forEach(function(data, key){\n            //console.log(key + \": \" + JSON.stringify(data));\n\n            inject += key + \"{ },\"\n        });\n\n        inject += \"]\\n\"\n\n        inject += \"(hidden:)[audio:\"\n\n        this.audioVariables.forEach(function(data, key){\n\n            inject += key + \"{ },\"\n\n        });\n\n        inject += \"]\\n\"\n\n        return inject;\n        \n    }\n\n\n    destroy(){\n        /*this.imageVariables.forEach(function(data){\n            if(data.path.includes(\"blob\")){\n                URL.revokeObjectURL(data.path);\n                data.path = \"\";\n            }\n            \n        });\n\n        this.audioVariables.forEach(function(data){\n            if(data.path.includes(\"blob\")){\n                URL.revokeObjectURL(data.path);\n                data.path = \"\";\n            }\n            \n        });*/\n    }\n}\n\nmodule.exports = StoryEditor;\n"]}]}