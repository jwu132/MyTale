{"remainingRequest":"/Users/justinwu/Desktop/story_personalization_system/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/justinwu/Desktop/story_personalization_system/src/components/editor/Editor.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/justinwu/Desktop/story_personalization_system/src/components/editor/Editor.vue","mtime":1604699326243},{"path":"/Users/justinwu/Desktop/story_personalization_system/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/justinwu/Desktop/story_personalization_system/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/justinwu/Desktop/story_personalization_system/node_modules/vuetify-loader/lib/loader.js","mtime":1574476662000},{"path":"/Users/justinwu/Desktop/story_personalization_system/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/justinwu/Desktop/story_personalization_system/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:Ly8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KLy8KCmltcG9ydCBTaWRlYmFyX1ZhcmlhYmxlcyBmcm9tICIuL3Rvb2xzL3ZhcmlhYmxlcy9TaWRlYmFyX1ZhcmlhYmxlcy52dWUiOwppbXBvcnQgU2lkZWJhcl9NZWRpYSBmcm9tICIuL3Rvb2xzL21lZGlhL1NpZGViYXJfTWVkaWEudnVlIjsKaW1wb3J0IFNpZGViYXJfVGhlbWVzIGZyb20gIi4vdG9vbHMvdGhlbWVzL1NpZGViYXJfVGhlbWVzLnZ1ZSI7CmltcG9ydCBTaWRlYmFyX1Bhc3NhZ2UgZnJvbSAiLi90b29scy9wYXNzYWdlL1NpZGViYXJfUGFzc2FnZS52dWUiOwppbXBvcnQgR2xvYmFsX1N0b3J5X09wdGlvbnMgZnJvbSAiLi90b29scy9vcHRpb25zL0dsb2JhbF9TdG9yeV9PcHRpb25zLnZ1ZSI7CmltcG9ydCBQYWdlX0xheW91dCBmcm9tICIuL1BhZ2VfTGF5b3V0LnZ1ZSI7CgppbXBvcnQgRmlsZUNvbnZlcnRlciBmcm9tICJAL2pzL2V4dHdlZV91dGlscy9GaWxlQ29udmVydGVyLmpzIjsKaW1wb3J0IFN0b3J5RWRpdG9yIGZyb20gIkAvanMvZXh0d2VlX3V0aWxzL1N0b3J5RWRpdG9yLmpzIjsKaW1wb3J0IGZpcmViYXNlIGZyb20gImZpcmViYXNlIjsKaW1wb3J0IHsgZGIgfSBmcm9tICJAL2ZpcmViYXNlQ29uZmlnIjsKaW1wb3J0IHN0b3J5TWl4aW4gZnJvbSAiLi4vLi4vbWl4aW5zL3N0b3J5TWl4aW4iOwppbXBvcnQgdHdlZUNvbnZlcnRlciBmcm9tICIuLi8uLi9taXhpbnMvdHdlZUNvbnZlcnRlck1peGluIjsKaW1wb3J0IEF4aW9zIGZyb20gImF4aW9zIjsKaW1wb3J0IEZpbGVTYXZlciBmcm9tICJicm93c2VyLWZpbGVzYXZlciI7CmltcG9ydCBkZWJvdW5jZSBmcm9tICJkZWJvdW5jZSI7Cgp2YXIgSlNaaXAgPSByZXF1aXJlKCJqc3ppcCIpOwoKZXhwb3J0IGRlZmF1bHQgewogIG5hbWU6ICJlZGl0b3IiLAoKICBkYXRhKCkgewogICAgcmV0dXJuIHsKICAgICAgaXNMb2dnZWRJbjogZmFsc2UsCgogICAgICAvLy8vLwogICAgICB1c2VyUmVmOiBudWxsLAogICAgICBzdG9yeVJlZjogbnVsbCwKICAgICAgYmFzZVBhdGg6ICIiLAogICAgICB0b3RhbEZpbGVTaXplOiAwLAogICAgICBtYXhTdG9yYWdlU2l6ZTogMTUsCiAgICAgIHN0YXR1czogIiIsCiAgICAgIC8vLy8vCgogICAgICBzdG9yeU5hbWU6ICIiLAogICAgICBzdG9yeVBhZ2VzOiBBcnJheSwKICAgICAgc3RvcnlWYXJpYWJsZXM6IE1hcCwKICAgICAgaW1hZ2VWYXJpYWJsZXM6IE1hcCwKICAgICAgYXVkaW9WYXJpYWJsZXM6IE1hcCwKCiAgICAgIGN1cnJlbnRQYWdlOiAxLAogICAgICBwYWdlc1Zpc2l0ZWQ6IFtdLAoKICAgICAgdG9vbHNXaWR0aDogIjMwJSIsCgogICAgICBwYWdlV2lkdGg6ICI3MCUiLAogICAgICBjb250ZW50SGVpZ2h0OiAiNzR2aCIsCiAgICAgIG1pbkhlaWdodDogIjUwMHB4IiwKICAgICAgaGlkZUl0ZW06IGZhbHNlLAogICAgICB0b29sQnV0dG9uOiAibWRpLW1pbnVzIiwKICAgICAgZnVsbEJ1dHRvbjogIm1kaS1mdWxsc2NyZWVuIiwKICAgICAgaW5GdWxsTW9kZTogZmFsc2UsCgogICAgICB0aGVtZVZpZXc6IGZhbHNlLAoKICAgICAgaGFuZGxlczogewogICAgICAgIHN0b3J5RWRpdG9yOiBTdG9yeUVkaXRvciwKICAgICAgICBmaWxlQ29udmVydGVyOiBGaWxlQ29udmVydGVyCiAgICAgIH0sCgogICAgICByZW5kZXJIaW50czogewogICAgICAgIHJlbmRlcktleTogMSwKICAgICAgICB2YXJpYWJsZVJlbmRlcktleTogMSwKICAgICAgICB0aGVtZXNSZW5kZXJLZXk6IDEsCiAgICAgICAgcGFzc2FnZVJlbmRlcktleTogMSwKICAgICAgICBnc29SZW5kZXJLZXk6IDEsCiAgICAgICAgbWVkaWFSZW5kZXJLZXk6IDEsCiAgICAgICAgaGlkZGVuOiB0cnVlLAogICAgICAgIGluVmFyaWFibGVFZGl0b3I6IHRydWUsCiAgICAgICAgaW5NZWRpYUVkaXRvcjogZmFsc2UKICAgICAgfSwKCiAgICAgIGhpOiAiSGVsbG8iLAogICAgICBleHBvcnRGaWxlOiAiIgogICAgfTsKICB9LAoKICBjcmVhdGVkOiBmdW5jdGlvbigpIHsKICAgIC8vLy8vCiAgICBpZiAoZmlyZWJhc2UuYXV0aCgpLmN1cnJlbnRVc2VyKSB7CiAgICAgIHRoaXMuaXNMb2dnZWRJbiA9IHRydWU7CiAgICB9CiAgICBpZiAodGhpcy5pc0xvZ2dlZEluKSB7CiAgICAgIHZhciBzdG9yYWdlUmVmID0gZmlyZWJhc2Uuc3RvcmFnZSgpLnJlZigpOwogICAgICB2YXIgdXNlcklEID0gZmlyZWJhc2UuYXV0aCgpLmN1cnJlbnRVc2VyLmVtYWlsOwogICAgICB0aGlzLnVzZXJSZWYgPSBzdG9yYWdlUmVmLmNoaWxkKHVzZXJJRCk7CiAgICB9CiAgICAvLy8vLwoKICAgIGlmICh0aGlzLiRzdG9yZS5zdGF0ZS5zdG9yeUxvY2F0aW9uICE9ICIiKSB7CiAgICAgIEF4aW9zLmdldCh0aGlzLiRzdG9yZS5zdGF0ZS5zdG9yeUxvY2F0aW9uKS50aGVuKHJlc3BvbnNlID0+IHsKICAgICAgICBpZiAocmVzcG9uc2UuZGF0YSAhPSBudWxsKSB7CiAgICAgICAgICB0aGlzLmxvYWRDb250ZW50cyhyZXNwb25zZS5kYXRhKTsKICAgICAgICAgIGlmICgKICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgiT0dzdG9yeVBhc3NhZ2VzIikgPT09ICIiIHx8CiAgICAgICAgICAgIHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oIk9Hc3RvcnlQYXNzYWdlcyIpID09PSBudWxsCiAgICAgICAgICApIHsKICAgICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgKICAgICAgICAgICAgICAiT0dzdG9yeVBhc3NhZ2VzIiwKICAgICAgICAgICAgICBKU09OLnN0cmluZ2lmeSh0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuZXhwb3J0ZWRTdG9yeVBhZ2VzKQogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgiY3JlYXRlVGVtcGxhdGUiLCAieWVzIik7CiAgICAgICAgICBjb25zb2xlLmxvZygiUmVhZCBTdWNjZXNzIik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCJSZWFkIEZhaWwiKTsKICAgICAgICB9CiAgICAgIH0pOwogICAgfSBlbHNlIGlmICh0aGlzLiRzdG9yZS5zdGF0ZS5zdG9yeUNvbnRlbnQgIT0gIiIpIHsKICAgICAgY29uc29sZS5sb2coc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgic3RvcnlDb250ZW50IikpOwogICAgICB0aGlzLmxvYWRDb250ZW50cyh0aGlzLiRzdG9yZS5zdGF0ZS5zdG9yeUNvbnRlbnQpOwogICAgICBpZiAoc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgiT0dzdG9yeVBhc3NhZ2VzIikgPT09ICIiKSB7CiAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgKICAgICAgICAgICJPR3N0b3J5UGFzc2FnZXMiLAogICAgICAgICAgSlNPTi5zdHJpbmdpZnkodGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmV4cG9ydGVkU3RvcnlQYWdlcykKICAgICAgICApOwogICAgICB9CiAgICAgIC8vdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnJlbW92ZVZhcmlhYmxlSW5qZWN0KCk7CiAgICAgIHRoaXMucmVnZW5lcmF0ZVN0b3J5VGV4dCh7IGRpc3A6IHRydWUgfSk7CiAgICB9CgogICAgaWYgKHRoaXMuaXNMb2dnZWRJbikgewogICAgICBpZiAodGhpcy5zdG9yeU5hbWUgPT0gIiIpIHsKICAgICAgICB0aGlzLnN0b3J5TmFtZSA9ICJTdG9yeSBUZW1wbGF0ZSI7CiAgICAgIH0KICAgICAgdGhpcy5zdG9yeVJlZiA9IHRoaXMudXNlclJlZi5jaGlsZCh0aGlzLnN0b3J5TmFtZSk7CiAgICAgIHRoaXMuYmFzZVBhdGggPSB0aGlzLmlzTG9nZ2VkSW4uZW1haWwgKyAiLyIgKyB0aGlzLnN0b3J5TmFtZSArICIvIjsKICAgIH0KCiAgICAvLy8vLwogICAgaWYgKHRoaXMuaXNMb2dnZWRJbikgewogICAgICB0aGlzLnN0b3J5UmVmLmxpc3RBbGwoKS50aGVuKAogICAgICAgIGZ1bmN0aW9uKHJlc3VsdCkgewogICAgICAgICAgcmVzdWx0Lml0ZW1zLmZvckVhY2goCiAgICAgICAgICAgIGZ1bmN0aW9uKG1lZGlhUmVmKSB7CiAgICAgICAgICAgICAgdmFyIGtleSA9CiAgICAgICAgICAgICAgICAiQCIgKyBtZWRpYVJlZi5uYW1lLnN1YnN0cmluZygwLCBtZWRpYVJlZi5uYW1lLmluZGV4T2YoIj0iKSk7CgogICAgICAgICAgICAgIGlmICh0aGlzLmltYWdlVmFyaWFibGVzLmhhcyhrZXkpKSB7CiAgICAgICAgICAgICAgICB2YXIgY3VyclZhbHVlID0gdGhpcy5pbWFnZVZhcmlhYmxlcy5nZXQoa2V5KTsKICAgICAgICAgICAgICAgIHZhciB2YWx1ZSA9IHsKICAgICAgICAgICAgICAgICAgZmlsZTogY3VyclZhbHVlLmZpbGUsCiAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBtZWRpYVJlZi5uYW1lLnN1YnN0cmluZygKICAgICAgICAgICAgICAgICAgICBtZWRpYVJlZi5uYW1lLmluZGV4T2YoIj0iKSArIDEKICAgICAgICAgICAgICAgICAgKSwKICAgICAgICAgICAgICAgICAgcGF0aDogbWVkaWFSZWYuZ2V0RG93bmxvYWRVUkwoKSwKICAgICAgICAgICAgICAgICAgaWQ6IGN1cnJWYWx1ZS5pZCwKICAgICAgICAgICAgICAgICAgY29sb3I6IGN1cnJWYWx1ZS5jb2xvciwKICAgICAgICAgICAgICAgICAgdXBsb2FkZWQ6IHRydWUKICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3Iuc2V0SW1hZ2VWYXJpYWJsZShrZXksIHZhbHVlKTsKICAgICAgICAgICAgICAgIHRoaXMudG90YWxGaWxlU2l6ZSArPSBjdXJyVmFsdWUuZmlsZS5zaXplIC8gMTAyNCAvIDEwMjQ7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGlmICh0aGlzLmF1ZGlvVmFyaWFibGVzLmhhcyhrZXkpKSB7CiAgICAgICAgICAgICAgICBjdXJyVmFsdWUgPSB0aGlzLmF1ZGlvVmFyaWFibGVzLmdldChrZXkpOwogICAgICAgICAgICAgICAgdmFsdWUgPSB7CiAgICAgICAgICAgICAgICAgIGZpbGU6IGN1cnJWYWx1ZS5maWxlLAogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogbWVkaWFSZWYubmFtZS5zdWJzdHJpbmcoCiAgICAgICAgICAgICAgICAgICAgbWVkaWFSZWYubmFtZS5pbmRleE9mKCI9IikgKyAxCiAgICAgICAgICAgICAgICAgICksCiAgICAgICAgICAgICAgICAgIHBhdGg6IG1lZGlhUmVmLmdldERvd25sb2FkVVJMKCksCiAgICAgICAgICAgICAgICAgIGlkOiBjdXJyVmFsdWUuaWQsCiAgICAgICAgICAgICAgICAgIGNvbG9yOiBjdXJyVmFsdWUuY29sb3IsCiAgICAgICAgICAgICAgICAgIHVwbG9hZGVkOiB0cnVlCiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnNldEF1ZGlvVmFyaWFibGUoa2V5LCB2YWx1ZSk7CiAgICAgICAgICAgICAgICB0aGlzLnRvdGFsRmlsZVNpemUgKz0gY3VyclZhbHVlLmZpbGUuc2l6ZSAvIDEwMjQgLyAxMDI0OwogICAgICAgICAgICAgIH0KICAgICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmltYWdlVmFyaWFibGVzKTsKICAgICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmF1ZGlvVmFyaWFibGVzKTsKICAgICAgICAgICAgfS5iaW5kKHRoaXMpCiAgICAgICAgICApOwogICAgICAgIH0uYmluZCh0aGlzKQogICAgICApOwogICAgfQogICAgLy8vLy8KICB9LAoKICBjb21wb25lbnRzOiB7CiAgICAidmFyLXNpZGViYXIiOiBTaWRlYmFyX1ZhcmlhYmxlcywKICAgICJtZWRpYS1zaWRlYmFyIjogU2lkZWJhcl9NZWRpYSwKICAgICJ0aGVtZXMtc2lkZWJhciI6IFNpZGViYXJfVGhlbWVzLAogICAgInBhc3NhZ2Utc2lkZWJhciI6IFNpZGViYXJfUGFzc2FnZSwKICAgICJwYWdlLWxheW91dCI6IFBhZ2VfTGF5b3V0LAogICAgZ3NvOiBHbG9iYWxfU3RvcnlfT3B0aW9ucwogIH0sCgogIHdhdGNoOiB7CiAgICBzdGF0dXM6IGRlYm91bmNlKGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5zdGF0dXMuaW5jbHVkZXMoInN1Y2Nlc3MiKSkgewogICAgICAgIHRoaXMuc3RhdHVzID0gIiI7CiAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKICAgICAgfQogICAgfSwgMzAwMCkKICB9LAoKICBtZXRob2RzOiB7CiAgICBsb2FkVHdlZTogZnVuY3Rpb24oZmlsZXMpIHsKICAgICAgY29uc29sZS5sb2coZmlsZXMpOwoKICAgICAgY29uc3QgZmlsZSA9IGZpbGVzWzBdOwoKICAgICAgdmFyIGlzSFRNTCA9IGZpbGUubmFtZS5pbmNsdWRlcygiLmh0bWwiKTsKCiAgICAgIHRoaXMuc3RvcnlWYXJpYWJsZXMgPSBudWxsOwogICAgICB0aGlzLnN0b3J5TGlua1Bhc3NhZ2VzID0gbnVsbDsKICAgICAgdGhpcy5zdG9yeURpc3BQYXNzYWdlcyA9IG51bGw7CgogICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IgPSBudWxsOwogICAgICB0aGlzLmhhbmRsZXMuZmlsZUNvbnZlcnRlciA9IG51bGw7CgogICAgICBjb25zdCB0ZW1wRmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7CgogICAgICB0ZW1wRmlsZVJlYWRlci5vbmxvYWQgPSAoKSA9PiB7CiAgICAgICAgLy8gYWxlcnQodGVtcEZpbGVSZWFkZXIucmVzdWx0KTsKCiAgICAgICAgdGhpcy5oYW5kbGVzLmZpbGVDb252ZXJ0ZXIgPSBuZXcgRmlsZUNvbnZlcnRlcigKICAgICAgICAgIHRlbXBGaWxlUmVhZGVyLnJlc3VsdCwKICAgICAgICAgIGlzSFRNTAogICAgICAgICk7CiAgICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yID0gbmV3IFN0b3J5RWRpdG9yKAogICAgICAgICAgdGhpcy5oYW5kbGVzLmZpbGVDb252ZXJ0ZXIuc3RvcnkKICAgICAgICApOwogICAgICAgIHRoaXMuc3RvcnlWYXJpYWJsZXMgPSB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IudmFyaWFibGVzOwogICAgICAgIHRoaXMuaW1hZ2VWYXJpYWJsZXMgPSB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuaW1hZ2VWYXJpYWJsZXM7CiAgICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcyA9IHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5hdWRpb1ZhcmlhYmxlczsKICAgICAgICB0aGlzLnN0b3J5UGFnZXMgPSB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuZXhwb3J0ZWRTdG9yeVBhZ2VzOwogICAgICAgIHRoaXMuc3RvcnlOYW1lID0gdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmJhc2VTdG9yeS5uYW1lOwoKICAgICAgICB0aGlzLmdvVG9TdGFydCgpOwoKICAgICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICAgIHRoaXMucmVuZGVySGludHMudmFyaWFibGVSZW5kZXJLZXkrKzsKICAgICAgICB0aGlzLnJlbmRlckhpbnRzLnBhc3NhZ2VSZW5kZXJLZXkrKzsKICAgICAgICB0aGlzLnJlbmRlckhpbnRzLmdzb1JlbmRlcktleSsrOwoKICAgICAgICB0aGlzLnJlbmRlckhpbnRzLmhpZGRlbiA9IHRydWU7CiAgICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CgogICAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oInN0b3J5Q29udGVudCIsIHRlbXBGaWxlUmVhZGVyLnJlc3VsdCk7CiAgICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgic3RvcnlMb2NhdGlvbiIsICIiKTsKCiAgICAgICAgdGhpcy5yZWdlbmVyYXRlU3RvcnlUZXh0KHsgZGlzcDogdGhpcy5yZW5kZXJIaW50cy5oaWRkZW4gfSk7CiAgICAgIH07CiAgICAgIHRlbXBGaWxlUmVhZGVyLnJlYWRBc1RleHQoZmlsZSk7CiAgICB9LAoKICAgIGxvYWRDb250ZW50czogZnVuY3Rpb24oY29udGVudHMpIHsKICAgICAgdGhpcy5zdG9yeVZhcmlhYmxlcyA9IG51bGw7CiAgICAgIHRoaXMuc3RvcnlMaW5rUGFzc2FnZXMgPSBudWxsOwogICAgICB0aGlzLnN0b3J5RGlzcFBhc3NhZ2VzID0gbnVsbDsKCiAgICAgIHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvciA9IG51bGw7CiAgICAgIHRoaXMuaGFuZGxlcy5maWxlQ29udmVydGVyID0gbnVsbDsKCiAgICAgIHRoaXMuaGFuZGxlcy5maWxlQ29udmVydGVyID0gbmV3IEZpbGVDb252ZXJ0ZXIoY29udGVudHMsIGZhbHNlKTsKICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yID0gbmV3IFN0b3J5RWRpdG9yKAogICAgICAgIHRoaXMuaGFuZGxlcy5maWxlQ29udmVydGVyLnN0b3J5CiAgICAgICk7CiAgICAgIHRoaXMuc3RvcnlWYXJpYWJsZXMgPSB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IudmFyaWFibGVzOwogICAgICB0aGlzLmltYWdlVmFyaWFibGVzID0gdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmltYWdlVmFyaWFibGVzOwogICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzID0gdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmF1ZGlvVmFyaWFibGVzOwogICAgICB0aGlzLnN0b3J5UGFnZXMgPSB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuZXhwb3J0ZWRTdG9yeVBhZ2VzOwogICAgICB0aGlzLnN0b3J5TmFtZSA9IHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5iYXNlU3RvcnkubmFtZTsKCiAgICAgIHRoaXMuZ29Ub1N0YXJ0KCk7CgogICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICB0aGlzLnJlbmRlckhpbnRzLnZhcmlhYmxlUmVuZGVyS2V5Kys7CiAgICAgIHRoaXMucmVuZGVySGludHMucGFzc2FnZVJlbmRlcktleSsrOwogICAgICB0aGlzLnJlbmRlckhpbnRzLmdzb1JlbmRlcktleSsrOwoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5oaWRkZW4gPSB0cnVlOwogICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKCiAgICAgIHRoaXMucmVnZW5lcmF0ZVN0b3J5VGV4dCh7IGRpc3A6IHRoaXMucmVuZGVySGludHMuaGlkZGVuIH0pOwogICAgfSwKCiAgICBsb2FkU3RvcnlUZW1wbGF0ZTogZnVuY3Rpb24oKSB7CiAgICAgIGNvbnNvbGUubG9nKCJzdG9yeSB0ZW1wbGF0ZSIpOwoKICAgICAgQXhpb3MuZ2V0KCIvc3Rvcmllcy9TdG9yeSBUZW1wbGF0ZS50d2VlIikudGhlbihyZXNwb25zZSA9PiB7CiAgICAgICAgaWYgKHJlc3BvbnNlLmRhdGEgIT0gbnVsbCkgewogICAgICAgICAgdGhpcy5sb2FkQ29udGVudHMocmVzcG9uc2UuZGF0YSk7CiAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKAogICAgICAgICAgICAiT0dzdG9yeVBhc3NhZ2VzIiwKICAgICAgICAgICAgSlNPTi5zdHJpbmdpZnkodGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmV4cG9ydGVkU3RvcnlQYWdlcykKICAgICAgICAgICk7CiAgICAgICAgICBzZXNzaW9uU3RvcmFnZS5zZXRJdGVtKCJjcmVhdGVUZW1wbGF0ZSIsICJ5ZXMiKTsKICAgICAgICAgIGNvbnNvbGUubG9nKCJSZWFkIFN1Y2Nlc3MiKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgY29uc29sZS5sb2coIlJlYWQgRmFpbCIpOwogICAgICAgIH0KICAgICAgfSk7CgogICAgICB0aGlzLnJlZ2VuZXJhdGVTdG9yeVRleHQoeyBkaXNwOiB0aGlzLnJlbmRlckhpbnRzLmhpZGRlbiB9KTsKICAgIH0sCgogICAgcmVwbGFjZUltYWdlOiBmdW5jdGlvbihldmVudCkgewogICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3Iuc2V0SW1hZ2VWYXJpYWJsZShldmVudC5uYW1lLCBldmVudC5kYXRhKTsKCiAgICAgIHRoaXMud3JpdGVUb1N0b3JhZ2UoKTsKCiAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5Kys7CiAgICAgIHRoaXMucmVuZGVySGludHMubWVkaWFSZW5kZXJLZXkrKzsKICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CgogICAgICAvLy8vLwogICAgICB2YXIgaW1nRGF0YSA9IHRoaXMuaW1hZ2VWYXJpYWJsZXMuZ2V0KGV2ZW50Lm5hbWUpOwogICAgICBpZiAodGhpcy5pc0xvZ2dlZEluKSB7CiAgICAgICAgdmFyIHJlbW92ZVJlZiA9IHRoaXMuc3RvcnlSZWYuY2hpbGQoCiAgICAgICAgICBldmVudC5uYW1lLnJlcGxhY2UoIkAiLCAiIikgKyAiPSIgKyBldmVudC5vbGREYXRhLmZpbGVOYW1lCiAgICAgICAgKTsKICAgICAgICByZW1vdmVSZWYuZGVsZXRlKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgIHRoaXMuc3RhdHVzID0KICAgICAgICAgICAgIlVwbG9hZGluZyAiICsgZXZlbnQuZGF0YS5maWxlTmFtZSArICIuLi4gcGxlYXNlIGJlIHBhdGllbnQgOikiOwogICAgICAgIH0pOwogICAgICAgIHRoaXMudG90YWxGaWxlU2l6ZSAtPSBldmVudC5vbGREYXRhLmZpbGUuc2l6ZSAvIDEwMjQgLyAxMDI0OwogICAgICAgIHRoaXMudG90YWxGaWxlU2l6ZSArPSBldmVudC5kYXRhLmZpbGUuc2l6ZSAvIDEwMjQgLyAxMDI0OwoKICAgICAgICBpZiAodGhpcy50b3RhbEZpbGVTaXplID4gdGhpcy5tYXhTdG9yYWdlU2l6ZSkgewogICAgICAgICAgdGhpcy50b3RhbEZpbGVTaXplIC09IGV2ZW50LmRhdGEuZmlsZS5zaXplIC8gMTAyNCAvIDEwMjQ7CiAgICAgICAgICB0aGlzLnRvdGFsRmlsZVNpemUgKz0gZXZlbnQub2xkRGF0YS5maWxlLnNpemUgLyAxMDI0IC8gMTAyNDsKICAgICAgICAgIHRoaXMuc3RhdHVzID0KICAgICAgICAgICAgIlNvcnJ5ISBJdCBsb29rcyBsaWtlIHlvdSd2ZSBydW4gb3V0IG9mIHN0b3JhZ2Ugc3BhY2UuIFRyeSB1cGxvYWRpbmcgYSBzbWFsbGVyIGZpbGUhIjsKCiAgICAgICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3Iuc2V0SW1hZ2VWYXJpYWJsZShldmVudC5uYW1lLCBldmVudC5vbGREYXRhKTsKICAgICAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5Kys7CiAgICAgICAgICB0aGlzLnJlbmRlckhpbnRzLm1lZGlhUmVuZGVyS2V5Kys7CiAgICAgICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgdmFyIG5ld1JlZiA9IHRoaXMuc3RvcnlSZWYuY2hpbGQoCiAgICAgICAgICAgIGV2ZW50Lm5hbWUucmVwbGFjZSgiQCIsICIiKSArICI9IiArIGV2ZW50LmRhdGEuZmlsZU5hbWUKICAgICAgICAgICk7CiAgICAgICAgICBuZXdSZWYucHV0KGV2ZW50LmRhdGEuZmlsZSkudGhlbigKICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgdGhpcy5zdGF0dXMgPQogICAgICAgICAgICAgICAgIlVwbG9hZCBmb3IgIiArIGV2ZW50LmRhdGEuZmlsZU5hbWUgKyAiIHN1Y2Nlc3NmdWwhIjsKICAgICAgICAgICAgICB2YXIgb2JqID0gewogICAgICAgICAgICAgICAgZmlsZTogZXZlbnQuZGF0YS5maWxlLAogICAgICAgICAgICAgICAgZmlsZU5hbWU6IGV2ZW50LmRhdGEuZmlsZU5hbWUsCiAgICAgICAgICAgICAgICBwYXRoOiBuZXdSZWYuZ2V0RG93bmxvYWRVUkwoKSwKICAgICAgICAgICAgICAgIGNvbG9yOiBpbWdEYXRhLmNvbG9yLAogICAgICAgICAgICAgICAgaWQ6IGltZ0RhdGEuaWQsCiAgICAgICAgICAgICAgICB1cGxvYWRlZDogdHJ1ZQogICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnNldEltYWdlVmFyaWFibGUoZXZlbnQubmFtZSwgb2JqKTsKCiAgICAgICAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgICAgICAgICB0aGlzLnJlbmRlckhpbnRzLm1lZGlhUmVuZGVyS2V5Kys7CiAgICAgICAgICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CgogICAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMuaW1hZ2VWYXJpYWJsZXMpOwogICAgICAgICAgICB9LmJpbmQodGhpcykKICAgICAgICAgICk7CiAgICAgICAgfQogICAgICB9CiAgICAgIC8vLy8vCiAgICB9LAoKICAgIHJlcGxhY2VBdWRpbzogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnNldEF1ZGlvVmFyaWFibGUoZXZlbnQubmFtZSwgZXZlbnQuZGF0YSk7CgogICAgICB0aGlzLndyaXRlVG9TdG9yYWdlKCk7CgogICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICB0aGlzLnJlbmRlckhpbnRzLm1lZGlhUmVuZGVyS2V5Kys7CiAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwoKICAgICAgLy8vLy8KICAgICAgdmFyIGF1ZERhdGEgPSB0aGlzLmF1ZGlvVmFyaWFibGVzLmdldChldmVudC5uYW1lKTsKICAgICAgaWYgKHRoaXMuaXNMb2dnZWRJbikgewogICAgICAgIHZhciByZW1vdmVSZWYgPSB0aGlzLnN0b3J5UmVmLmNoaWxkKAogICAgICAgICAgZXZlbnQubmFtZS5yZXBsYWNlKCJAIiwgIiIpICsgIj0iICsgZXZlbnQub2xkRGF0YS5maWxlTmFtZQogICAgICAgICk7CiAgICAgICAgcmVtb3ZlUmVmLmRlbGV0ZSgpLnRoZW4oZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aGlzLnN0YXR1cyA9CiAgICAgICAgICAgICJVcGxvYWRpbmcgIiArIGV2ZW50LmRhdGEuZmlsZU5hbWUgKyAiLi4uIHBsZWFzZSBiZSBwYXRpZW50IDopIjsKICAgICAgICB9KTsKICAgICAgICB0aGlzLnRvdGFsRmlsZVNpemUgLT0gZXZlbnQub2xkRGF0YS5maWxlLnNpemUgLyAxMDI0IC8gMTAyNDsKICAgICAgICB0aGlzLnRvdGFsRmlsZVNpemUgKz0gZXZlbnQuZGF0YS5maWxlLnNpemUgLyAxMDI0IC8gMTAyNDsKCiAgICAgICAgaWYgKHRoaXMudG90YWxGaWxlU2l6ZSA+IHRoaXMubWF4U3RvcmFnZVNpemUpIHsKICAgICAgICAgIHRoaXMudG90YWxGaWxlU2l6ZSAtPSBldmVudC5kYXRhLmZpbGUuc2l6ZSAvIDEwMjQgLyAxMDI0OwogICAgICAgICAgdGhpcy50b3RhbEZpbGVTaXplICs9IGV2ZW50Lm9sZERhdGEuZmlsZS5zaXplIC8gMTAyNCAvIDEwMjQ7CiAgICAgICAgICB0aGlzLnN0YXR1cyA9CiAgICAgICAgICAgICJTb3JyeSEgSXQgbG9va3MgbGlrZSB5b3UndmUgcnVuIG91dCBvZiBzdG9yYWdlIHNwYWNlLiBUcnkgdXBsb2FkaW5nIGEgc21hbGxlciBmaWxlISI7CgogICAgICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnNldEF1ZGlvVmFyaWFibGUoZXZlbnQubmFtZSwgZXZlbnQub2xkRGF0YSk7CiAgICAgICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5tZWRpYVJlbmRlcktleSsrOwogICAgICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgIHZhciBuZXdSZWYgPSB0aGlzLnN0b3J5UmVmLmNoaWxkKAogICAgICAgICAgICBldmVudC5uYW1lLnJlcGxhY2UoIkAiLCAiIikgKyAiPSIgKyBldmVudC5kYXRhLmZpbGVOYW1lCiAgICAgICAgICApOwogICAgICAgICAgbmV3UmVmLnB1dChldmVudC5kYXRhLmZpbGUpLnRoZW4oCiAgICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICAgIHRoaXMuc3RhdHVzID0KICAgICAgICAgICAgICAgICJVcGxvYWQgZm9yICIgKwogICAgICAgICAgICAgICAgZXZlbnQuZGF0YS5maWxlTmFtZSArCiAgICAgICAgICAgICAgICAiIHN1Y2Nlc3NmdWwuLi4gdGhhbmtzIGZvciB3YWl0aW5nISI7CiAgICAgICAgICAgICAgdmFyIG9iaiA9IHsKICAgICAgICAgICAgICAgIGZpbGU6IGV2ZW50LmRhdGEuZmlsZSwKICAgICAgICAgICAgICAgIGZpbGVOYW1lOiBldmVudC5kYXRhLmZpbGVOYW1lLAogICAgICAgICAgICAgICAgcGF0aDogbmV3UmVmLmdldERvd25sb2FkVVJMKCksCiAgICAgICAgICAgICAgICBjb2xvcjogYXVkRGF0YS5jb2xvciwKICAgICAgICAgICAgICAgIGlkOiBhdWREYXRhLmlkLAogICAgICAgICAgICAgICAgdXBsb2FkZWQ6IHRydWUKICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgIHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5zZXRBdWRpb1ZhcmlhYmxlKGV2ZW50Lm5hbWUsIG9iaik7CgogICAgICAgICAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5Kys7CiAgICAgICAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5tZWRpYVJlbmRlcktleSsrOwogICAgICAgICAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwoKICAgICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmF1ZGlvVmFyaWFibGVzKTsKICAgICAgICAgICAgfS5iaW5kKHRoaXMpCiAgICAgICAgICApOwogICAgICAgIH0KICAgICAgfQogICAgICAvLy8vLwogICAgfSwKCiAgICByZXBsYWNlSW1hZ2VOYW1lOiBmdW5jdGlvbihldmVudCkgewogICAgICB2YXIgcHJvY2VzcyA9IHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5jaGFuZ2VJbWFnZVZhcmlhYmxlTmFtZShldmVudCk7CgogICAgICB0aGlzLndyaXRlVG9TdG9yYWdlKCk7CgogICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICB0aGlzLnJlbmRlckhpbnRzLm1lZGlhUmVuZGVyS2V5Kys7CiAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwoKICAgICAgLy8vLy8KICAgICAgdmFyIGZpbGVOYW1lID0gZXZlbnQuZmlsZU5hbWU7CiAgICAgIGlmICh0aGlzLmlzTG9nZ2VkSW4gJiYgcHJvY2VzcykgewogICAgICAgIHZhciByZW1vdmVSZWYgPSB0aGlzLnN0b3J5UmVmLmNoaWxkKAogICAgICAgICAgZXZlbnQucHJldk5hbWUucmVwbGFjZSgiQCIsICIiKSArICI9IiArIGZpbGVOYW1lCiAgICAgICAgKTsKICAgICAgICByZW1vdmVSZWYuZGVsZXRlKCk7CiAgICAgICAgdmFyIGltZ0RhdGEgPSB0aGlzLmltYWdlVmFyaWFibGVzLmdldChldmVudC5uZXdOYW1lKTsKICAgICAgICB2YXIgbmV3UmVmID0gdGhpcy5zdG9yeVJlZi5jaGlsZCgKICAgICAgICAgIGV2ZW50Lm5ld05hbWUucmVwbGFjZSgiQCIsICIiKSArICI9IiArIGZpbGVOYW1lCiAgICAgICAgKTsKICAgICAgICBuZXdSZWYucHV0KGltZ0RhdGEuZmlsZSkudGhlbigKICAgICAgICAgIGZ1bmN0aW9uKCkgewogICAgICAgICAgICB0aGlzLnN0YXR1cyA9ICJZb3VyIGNoYW5nZXMgd2VyZSBzYXZlZCBzdWNjZXNzZnVsbHkhIjsKCiAgICAgICAgICAgIGlmIChpbWdEYXRhLnBhdGguaS5pbmNsdWRlcygiYmxvYiIpKSB7CiAgICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTChpbWdEYXRhLnBhdGguaSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHZhciBvYmogPSB7CiAgICAgICAgICAgICAgZmlsZTogaW1nRGF0YS5maWxlLAogICAgICAgICAgICAgIGZpbGVOYW1lOiBmaWxlTmFtZSwKICAgICAgICAgICAgICBwYXRoOiBuZXdSZWYuZ2V0RG93bmxvYWRVUkwoKSwKICAgICAgICAgICAgICBjb2xvcjogaW1nRGF0YS5jb2xvciwKICAgICAgICAgICAgICBpZDogaW1nRGF0YS5pZCwKICAgICAgICAgICAgICB1cGxvYWRlZDogdHJ1ZQogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3Iuc2V0SW1hZ2VWYXJpYWJsZShldmVudC5uZXdOYW1lLCBvYmopOwoKICAgICAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5tZWRpYVJlbmRlcktleSsrOwogICAgICAgICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKCiAgICAgICAgICAgIC8vY29uc29sZS5sb2codGhpcy5pbWFnZVZhcmlhYmxlcyk7CiAgICAgICAgICB9LmJpbmQodGhpcykKICAgICAgICApOwogICAgICB9CiAgICAgIC8vLy8vCiAgICB9LAoKICAgIHJlcGxhY2VBdWRpb05hbWU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHZhciBwcm9jZXNzID0gdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmNoYW5nZUF1ZGlvVmFyaWFibGVOYW1lKGV2ZW50KTsKCiAgICAgIHRoaXMud3JpdGVUb1N0b3JhZ2UoKTsKCiAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5Kys7CiAgICAgIHRoaXMucmVuZGVySGludHMubWVkaWFSZW5kZXJLZXkrKzsKICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CgogICAgICAvLy8vLwogICAgICB2YXIgZmlsZU5hbWUgPSBldmVudC5maWxlTmFtZTsKICAgICAgaWYgKHRoaXMuaXNMb2dnZWRJbiAmJiBwcm9jZXNzKSB7CiAgICAgICAgdmFyIHJlbW92ZVJlZiA9IHRoaXMuc3RvcnlSZWYuY2hpbGQoCiAgICAgICAgICBldmVudC5wcmV2TmFtZS5yZXBsYWNlKCJAIiwgIiIpICsgIj0iICsgZmlsZU5hbWUKICAgICAgICApOwogICAgICAgIHJlbW92ZVJlZi5kZWxldGUoKTsKICAgICAgICB2YXIgYXVkRGF0YSA9IHRoaXMuYXVkaW9WYXJpYWJsZXMuZ2V0KGV2ZW50Lm5ld05hbWUpOwogICAgICAgIHZhciBuZXdSZWYgPSB0aGlzLnN0b3J5UmVmLmNoaWxkKAogICAgICAgICAgZXZlbnQubmV3TmFtZS5yZXBsYWNlKCJAIiwgIiIpICsgIj0iICsgZmlsZU5hbWUKICAgICAgICApOwogICAgICAgIG5ld1JlZi5wdXQoYXVkRGF0YS5maWxlKS50aGVuKAogICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0gIllvdXIgY2hhbmdlcyB3ZXJlIHNhdmVkIHN1Y2Nlc3NmdWxseSEiOwoKICAgICAgICAgICAgaWYgKGF1ZERhdGEucGF0aC5pLmluY2x1ZGVzKCJibG9iIikpIHsKICAgICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKGF1ZERhdGEucGF0aC5pKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdmFyIG9iaiA9IHsKICAgICAgICAgICAgICBmaWxlOiBhdWREYXRhLmZpbGUsCiAgICAgICAgICAgICAgZmlsZU5hbWU6IGZpbGVOYW1lLAogICAgICAgICAgICAgIHBhdGg6IG5ld1JlZi5nZXREb3dubG9hZFVSTCgpLAogICAgICAgICAgICAgIGNvbG9yOiBhdWREYXRhLmNvbG9yLAogICAgICAgICAgICAgIGlkOiBhdWREYXRhLmlkLAogICAgICAgICAgICAgIHVwbG9hZGVkOiB0cnVlCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5zZXRBdWRpb1ZhcmlhYmxlKGV2ZW50Lm5ld05hbWUsIG9iaik7CgogICAgICAgICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICAgICAgICB0aGlzLnJlbmRlckhpbnRzLm1lZGlhUmVuZGVyS2V5Kys7CiAgICAgICAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwoKICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy5hdWRpb1ZhcmlhYmxlcyk7CiAgICAgICAgICB9LmJpbmQodGhpcykKICAgICAgICApOwogICAgICB9CiAgICAgIC8vLy8vCiAgICB9LAoKICAgIGFkZEltYWdlVmFyaWFibGU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnQubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuYWRkSW1hZ2VWYXJpYWJsZShldmVudFtpXSk7CiAgICAgIH0KICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnJlcGFyc2VNZWRpYSgpOwoKICAgICAgdGhpcy53cml0ZVRvU3RvcmFnZSgpOwoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5yZW5kZXJIaW50cy5tZWRpYVJlbmRlcktleSsrOwogICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKCiAgICAgIC8vLy8vCiAgICAgIGlmICh0aGlzLmlzTG9nZ2VkSW4pIHsKICAgICAgICB0aGlzLmltYWdlVmFyaWFibGVzLmZvckVhY2goCiAgICAgICAgICBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0KICAgICAgICAgICAgICAiVXBsb2FkaW5nICIgKyB2YWx1ZS5maWxlTmFtZSArICIuLi4gcGxlYXNlIGJlIHBhdGllbnQgOikiOwogICAgICAgICAgICBjb25zb2xlLmxvZygiVXBsb2FkZWQ6IiArIHZhbHVlLnVwbG9hZGVkKTsKCiAgICAgICAgICAgIGlmICh2YWx1ZS51cGxvYWRlZCA9PSBmYWxzZSkgewogICAgICAgICAgICAgIHZhciBjdXJySW1hZ2VSZWYgPSB0aGlzLnN0b3J5UmVmLmNoaWxkKAogICAgICAgICAgICAgICAga2V5LnJlcGxhY2UoIkAiLCAiIikgKyAiPSIgKyB2YWx1ZS5maWxlTmFtZQogICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgdmFyIGZpbGUgPSB2YWx1ZS5maWxlOwogICAgICAgICAgICAgIHRoaXMudG90YWxGaWxlU2l6ZSArPSBmaWxlLnNpemUgLyAxMDI0IC8gMTAyNDsKICAgICAgICAgICAgICBpZiAodGhpcy50b3RhbEZpbGVTaXplID4gdGhpcy5tYXhTdG9yYWdlU2l6ZSkgewogICAgICAgICAgICAgICAgdGhpcy50b3RhbEZpbGVTaXplIC09IGZpbGUuc2l6ZSAvIDEwMjQgLyAxMDI0OwogICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMgPQogICAgICAgICAgICAgICAgICAiU29ycnkhIEl0IGxvb2tzIGxpa2UgeW91J3ZlIHJ1biBvdXQgb2Ygc3RvcmFnZSBzcGFjZS4gVHJ5IHVwbG9hZGluZyBzbWFsbGVyIGZpbGVzISI7CiAgICAgICAgICAgICAgICAvL3RoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5kZWxldGVJbWFnZVZhcmlhYmxlKGtleSk7CiAgICAgICAgICAgICAgICB0aGlzLnJlbW92ZUltYWdlVmFyaWFibGUoewogICAgICAgICAgICAgICAgICBuYW1lOiBrZXksCiAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiB2YWx1ZS5maWxlTmFtZSwKICAgICAgICAgICAgICAgICAgZmlsZTogdmFsdWUuZmlsZQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGN1cnJJbWFnZVJlZi5wdXQoZmlsZSkudGhlbigKICAgICAgICAgICAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5zdGF0dXMgPQogICAgICAgICAgICAgICAgICAgICAgIlVwbG9hZCBmb3IgIiArCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5maWxlTmFtZSArCiAgICAgICAgICAgICAgICAgICAgICAiIHN1Y2Nlc3NmdWwuLi4gdGhhbmtzIGZvciB3YWl0aW5nISI7CgogICAgICAgICAgICAgICAgICAgIGlmICh2YWx1ZS5wYXRoLmkuaW5jbHVkZXMoImJsb2IiKSkgewogICAgICAgICAgICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTCh2YWx1ZS5wYXRoLmkpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgdmFyIG9iaiA9IHsKICAgICAgICAgICAgICAgICAgICAgIGZpbGU6IHZhbHVlLmZpbGUsCiAgICAgICAgICAgICAgICAgICAgICBmaWxlTmFtZTogdmFsdWUuZmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgICAgICBwYXRoOiBjdXJySW1hZ2VSZWYuZ2V0RG93bmxvYWRVUkwoKSwKICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiB2YWx1ZS5jb2xvciwKICAgICAgICAgICAgICAgICAgICAgIGlkOiB2YWx1ZS5pZCwKICAgICAgICAgICAgICAgICAgICAgIHVwbG9hZGVkOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3Iuc2V0SW1hZ2VWYXJpYWJsZShrZXksIG9iaik7CiAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmxvZyh0aGlzLmltYWdlVmFyaWFibGVzKTsKICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUubG9nKHRoaXMudG90YWxGaWxlU2l6ZSk7CgogICAgICAgICAgICAgICAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5Kys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5tZWRpYVJlbmRlcktleSsrOwogICAgICAgICAgICAgICAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwogICAgICAgICAgICAgICAgICB9LmJpbmQodGhpcykKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICB9LmJpbmQodGhpcykKICAgICAgICApOwogICAgICB9CiAgICAgIC8vLy8vCiAgICB9LAoKICAgIGFkZEF1ZGlvVmFyaWFibGU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZXZlbnQubGVuZ3RoOyBpKyspIHsKICAgICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuYWRkQXVkaW9WYXJpYWJsZShldmVudFtpXSk7CiAgICAgIH0KICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnJlcGFyc2VNZWRpYSgpOwoKICAgICAgdGhpcy53cml0ZVRvU3RvcmFnZSgpOwoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5yZW5kZXJIaW50cy5tZWRpYVJlbmRlcktleSsrOwogICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKCiAgICAgIC8vLy8vCiAgICAgIGlmICh0aGlzLmlzTG9nZ2VkSW4pIHsKICAgICAgICB0aGlzLmF1ZGlvVmFyaWFibGVzLmZvckVhY2goCiAgICAgICAgICBmdW5jdGlvbih2YWx1ZSwga2V5KSB7CiAgICAgICAgICAgIHRoaXMuc3RhdHVzID0KICAgICAgICAgICAgICAiVXBsb2FkaW5nICIgKyB2YWx1ZS5maWxlTmFtZSArICIuLi4gcGxlYXNlIGJlIHBhdGllbnQgOikiOwogICAgICAgICAgICBjb25zb2xlLmxvZygiVXBsb2FkZWQ6IiArIHZhbHVlLnVwbG9hZGVkKTsKCiAgICAgICAgICAgIGlmICh2YWx1ZS51cGxvYWRlZCA9PSBmYWxzZSkgewogICAgICAgICAgICAgIHZhciBjdXJyQXVkUmVmID0gdGhpcy5zdG9yeVJlZi5jaGlsZCgKICAgICAgICAgICAgICAgIGtleS5yZXBsYWNlKCJAIiwgIiIpICsgIj0iICsgdmFsdWUuZmlsZU5hbWUKICAgICAgICAgICAgICApOwogICAgICAgICAgICAgIHZhciBmaWxlID0gdmFsdWUuZmlsZTsKICAgICAgICAgICAgICB0aGlzLnRvdGFsRmlsZVNpemUgKz0gZmlsZS5zaXplIC8gMTAyNCAvIDEwMjQ7CiAgICAgICAgICAgICAgaWYgKHRoaXMudG90YWxGaWxlU2l6ZSA+IHRoaXMubWF4U3RvcmFnZVNpemUpIHsKICAgICAgICAgICAgICAgIHRoaXMudG90YWxGaWxlU2l6ZSAtPSBmaWxlLnNpemUgLyAxMDI0IC8gMTAyNDsKICAgICAgICAgICAgICAgIHRoaXMuc3RhdHVzID0KICAgICAgICAgICAgICAgICAgIlNvcnJ5ISBJdCBsb29rcyBsaWtlIHlvdSd2ZSBydW4gb3V0IG9mIHN0b3JhZ2Ugc3BhY2UuIFRyeSB1cGxvYWRpbmcgc21hbGxlciBmaWxlcyEiOwogICAgICAgICAgICAgICAgLy90aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuZGVsZXRlQXVkaW9WYXJpYWJsZShrZXkpOwogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVBdWRpb1ZhcmlhYmxlKHsKICAgICAgICAgICAgICAgICAgbmFtZToga2V5LAogICAgICAgICAgICAgICAgICBmaWxlTmFtZTogdmFsdWUuZmlsZU5hbWUsCiAgICAgICAgICAgICAgICAgIGZpbGU6IHZhbHVlLmZpbGUKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjdXJyQXVkUmVmLnB1dChmaWxlKS50aGVuKAogICAgICAgICAgICAgICAgICBmdW5jdGlvbigpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnN0YXR1cyA9CiAgICAgICAgICAgICAgICAgICAgICAiVXBsb2FkIGZvciAiICsKICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLmZpbGVOYW1lICsKICAgICAgICAgICAgICAgICAgICAgICIgc3VjY2Vzc2Z1bC4uLiB0aGFua3MgZm9yIHdhaXRpbmchIjsKCiAgICAgICAgICAgICAgICAgICAgaWYgKHZhbHVlLnBhdGguaS5pbmNsdWRlcygiYmxvYiIpKSB7CiAgICAgICAgICAgICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKHZhbHVlLnBhdGguaSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICB2YXIgb2JqID0gewogICAgICAgICAgICAgICAgICAgICAgZmlsZTogdmFsdWUuZmlsZSwKICAgICAgICAgICAgICAgICAgICAgIGZpbGVOYW1lOiB2YWx1ZS5maWxlTmFtZSwKICAgICAgICAgICAgICAgICAgICAgIHBhdGg6IGN1cnJBdWRSZWYuZ2V0RG93bmxvYWRVUkwoKSwKICAgICAgICAgICAgICAgICAgICAgIGNvbG9yOiB2YWx1ZS5jb2xvciwKICAgICAgICAgICAgICAgICAgICAgIGlkOiB2YWx1ZS5pZCwKICAgICAgICAgICAgICAgICAgICAgIHVwbG9hZGVkOiB0cnVlCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3Iuc2V0QXVkaW9WYXJpYWJsZShrZXksIG9iaik7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy5hdWRpb1ZhcmlhYmxlcyk7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy50b3RhbEZpbGVTaXplKTsKCiAgICAgICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgICAgICAgICAgICAgICB0aGlzLnJlbmRlckhpbnRzLm1lZGlhUmVuZGVyS2V5Kys7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CiAgICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgIH0uYmluZCh0aGlzKQogICAgICAgICk7CiAgICAgIH0KICAgICAgLy8vLy8KICAgIH0sCgogICAgcmVtb3ZlSW1hZ2VWYXJpYWJsZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmRlbGV0ZUltYWdlVmFyaWFibGUoZXZlbnQpOwoKICAgICAgdGhpcy53cml0ZVRvU3RvcmFnZSgpOwoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5yZW5kZXJIaW50cy5tZWRpYVJlbmRlcktleSsrOwogICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKCiAgICAgIC8vLy8vCiAgICAgIGlmICh0aGlzLmlzTG9nZ2VkSW4pIHsKICAgICAgICB2YXIgcmVtb3ZlUmVmID0gdGhpcy5zdG9yeVJlZi5jaGlsZCgKICAgICAgICAgIGV2ZW50Lm5hbWUucmVwbGFjZSgiQCIsICIiKSArICI9IiArIGV2ZW50LmZpbGVOYW1lCiAgICAgICAgKTsKICAgICAgICByZW1vdmVSZWYuZGVsZXRlKCkudGhlbihmdW5jdGlvbigpIHsKICAgICAgICAgIGNvbnNvbGUubG9nKCJERUxFVEVEIik7CiAgICAgICAgfSk7CiAgICAgICAgdGhpcy53cml0ZVRvU3RvcmFnZSgpOwogICAgICAgIHRoaXMudG90YWxGaWxlU2l6ZSAtPSBldmVudC5maWxlLnNpemUgLyAxMDI0IC8gMTAyNDsKICAgICAgfQogICAgICAvLy8vLwogICAgfSwKCiAgICByZW1vdmVBdWRpb1ZhcmlhYmxlOiBmdW5jdGlvbihldmVudCkgewogICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuZGVsZXRlQXVkaW9WYXJpYWJsZShldmVudCk7CgogICAgICB0aGlzLndyaXRlVG9TdG9yYWdlKCk7CgogICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICB0aGlzLnJlbmRlckhpbnRzLm1lZGlhUmVuZGVyS2V5Kys7CiAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwoKICAgICAgLy8vLy8KICAgICAgaWYgKHRoaXMuaXNMb2dnZWRJbikgewogICAgICAgIHZhciByZW1vdmVSZWYgPSB0aGlzLnN0b3J5UmVmLmNoaWxkKAogICAgICAgICAgZXZlbnQubmFtZS5yZXBsYWNlKCJAIiwgIiIpICsgIj0iICsgZXZlbnQuZmlsZU5hbWUKICAgICAgICApOwogICAgICAgIHJlbW92ZVJlZi5kZWxldGUoKS50aGVuKGZ1bmN0aW9uKCkgewogICAgICAgICAgY29uc29sZS5sb2coIkRFTEVURUQiKTsKICAgICAgICB9KTsKICAgICAgICB0aGlzLndyaXRlVG9TdG9yYWdlKCk7CiAgICAgICAgdGhpcy50b3RhbEZpbGVTaXplIC09IGV2ZW50LmZpbGUuc2l6ZSAvIDEwMjQgLyAxMDI0OwogICAgICB9CiAgICAgIC8vLy8vCiAgICB9LAoKICAgIGFkZEltYWdlVG9QYWdlKGV2ZW50KSB7CiAgICAgIHZhciBkYXRhID0gewogICAgICAgIG5hbWU6IGV2ZW50Lm5hbWUsCiAgICAgICAgcGFnZU5hbWU6IHRoaXMuc3RvcnlQYWdlc1t0aGlzLmN1cnJlbnRQYWdlIC0gMV0ucGFnZU5hbWUKICAgICAgfTsKICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmFkZEltYWdlVG9QYWdlKGRhdGEpOwoKICAgICAgdGhpcy53cml0ZVRvU3RvcmFnZSgpOwoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CiAgICB9LAoKICAgIGFkZEF1ZGlvVG9QYWdlKGV2ZW50KSB7CiAgICAgIHZhciBkYXRhID0gewogICAgICAgIG5hbWU6IGV2ZW50Lm5hbWUsCiAgICAgICAgcGFnZU5hbWU6IHRoaXMuc3RvcnlQYWdlc1t0aGlzLmN1cnJlbnRQYWdlIC0gMV0ucGFnZU5hbWUKICAgICAgfTsKICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmFkZEF1ZGlvVG9QYWdlKGRhdGEpOwoKICAgICAgdGhpcy53cml0ZVRvU3RvcmFnZSgpOwoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CiAgICB9LAoKICAgIHJlbW92ZUltYWdlRnJvbVBhZ2UoZXZlbnQpIHsKICAgICAgdmFyIGRhdGEgPSB7CiAgICAgICAgbmFtZTogZXZlbnQubmFtZSwKICAgICAgICBwYWdlTmFtZTogdGhpcy5zdG9yeVBhZ2VzW3RoaXMuY3VycmVudFBhZ2UgLSAxXS5wYWdlTmFtZQogICAgICB9OwogICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IucmVtb3ZlSW1hZ2VGcm9tUGFnZShkYXRhKTsKCiAgICAgIHRoaXMud3JpdGVUb1N0b3JhZ2UoKTsKCiAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5Kys7CiAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwogICAgfSwKCiAgICByZW1vdmVBdWRpb0Zyb21QYWdlKGV2ZW50KSB7CiAgICAgIHZhciBkYXRhID0gewogICAgICAgIG5hbWU6IGV2ZW50Lm5hbWUsCiAgICAgICAgcGFnZU5hbWU6IHRoaXMuc3RvcnlQYWdlc1t0aGlzLmN1cnJlbnRQYWdlIC0gMV0ucGFnZU5hbWUKICAgICAgfTsKICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnJlbW92ZUF1ZGlvRnJvbVBhZ2UoZGF0YSk7CgogICAgICB0aGlzLndyaXRlVG9TdG9yYWdlKCk7CgogICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKICAgIH0sCgogICAgbmV4dFBhZ2U6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHRoaXMucGFnZXNWaXNpdGVkLnB1c2godGhpcy5jdXJyZW50UGFnZSk7CgogICAgICBpZiAoZXZlbnQubG9jYXRpb24gPCB0aGlzLnN0b3J5UGFnZXMubGVuZ3RoKSB7CiAgICAgICAgdGhpcy5jdXJyZW50UGFnZSA9IGV2ZW50LmxvY2F0aW9uICsgMTsKICAgICAgfQogICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICB0aGlzLnJlbmRlckhpbnRzLnRoZW1lc1JlbmRlcktleSsrOwogICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKICAgIH0sCgogICAgZ29Ub1N0YXJ0OiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5wYWdlc1Zpc2l0ZWQgPSBbXTsKCiAgICAgIGZvciAodmFyIGkgPSAwOyB0aGlzLnN0b3J5UGFnZXMubGVuZ3RoOyBpKyspIHsKICAgICAgICBpZiAodGhpcy5zdG9yeVBhZ2VzW2ldLmxpbmtQYXNzYWdlLnRhZ3MuaW5jbHVkZXMoInN0YXJ0IikpIHsKICAgICAgICAgIHRoaXMuY3VycmVudFBhZ2UgPSBpICsgMTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5yZW5kZXJIaW50cy50aGVtZXNSZW5kZXJLZXkrKzsKICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CiAgICB9LAoKICAgIHNldFN0YXJ0UGFnZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnNldFN0YXJ0UGFnZShldmVudCk7CgogICAgICB0aGlzLndyaXRlVG9TdG9yYWdlKCk7CgogICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICB0aGlzLnJlbmRlckhpbnRzLnRoZW1lc1JlbmRlcktleSsrOwogICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKICAgIH0sCgogICAgcHJldlBhZ2U6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5wYWdlc1Zpc2l0ZWQubGVuZ3RoID4gMCkgewogICAgICAgIHRoaXMuY3VycmVudFBhZ2UgPSB0aGlzLnBhZ2VzVmlzaXRlZFt0aGlzLnBhZ2VzVmlzaXRlZC5sZW5ndGggLSAxXTsKICAgICAgICB0aGlzLnBhZ2VzVmlzaXRlZC5wb3AoKTsKICAgICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgIH0KCiAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5Kys7CiAgICAgIHRoaXMucmVuZGVySGludHMudGhlbWVzUmVuZGVyS2V5Kys7CiAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwoKICAgICAgcmV0dXJuIHRydWU7CiAgICB9LAoKICAgIGFkZFBhZ2U6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHRoaXMuc3RvcnlQYWdlc1t0aGlzLmN1cnJlbnRQYWdlIC0gMV0ubGlua1Bhc3NhZ2UudGV4dCArPQogICAgICAgICJcbltbIiArIGV2ZW50Lm5hbWUgKyAiXV0iOwogICAgICB2YXIgdmFyaWFibGVzUGFzc2FnZSA9IHRoaXMuc3RvcnlQYWdlc1sKICAgICAgICB0aGlzLmN1cnJlbnRQYWdlIC0gMQogICAgICBdLmxpbmtQYXNzYWdlLnRhZ3MuaW5jbHVkZXMoInZhcmlhYmxlcyIpOwogICAgICB0aGlzLnVwZGF0ZVBhc3NhZ2UoewogICAgICAgIG5hbWU6IHRoaXMuc3RvcnlQYWdlc1t0aGlzLmN1cnJlbnRQYWdlIC0gMV0ubGlua1Bhc3NhZ2UubmFtZSwKICAgICAgICB0ZXh0OiB0aGlzLnN0b3J5UGFnZXNbdGhpcy5jdXJyZW50UGFnZSAtIDFdLmxpbmtQYXNzYWdlLnRleHQsCiAgICAgICAgaXNWYXJpYWJsZXM6IHZhcmlhYmxlc1Bhc3NhZ2UKICAgICAgfSk7CgogICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuYWRkUGFnZSh7CiAgICAgICAgbmFtZTogZXZlbnQubmFtZSwKICAgICAgICBwcmV2TGluazogdGhpcy5zdG9yeVBhZ2VzW3RoaXMuY3VycmVudFBhZ2UgLSAxXS5saW5rUGFzc2FnZS5uYW1lCiAgICAgIH0pOwoKICAgICAgdGhpcy53cml0ZVRvU3RvcmFnZSgpOwoKICAgICAgdGhpcy5nb1RvUGFnZShldmVudCk7CiAgICB9LAoKICAgIGdvVG9QYWdlOiBmdW5jdGlvbihldmVudCkgewogICAgICBmb3IgKHZhciBpID0gMDsgdGhpcy5zdG9yeVBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgaWYgKHRoaXMuc3RvcnlQYWdlc1tpXS5saW5rUGFzc2FnZS5uYW1lID09IGV2ZW50Lm5hbWUpIHsKICAgICAgICAgIHRoaXMuY3VycmVudFBhZ2UgPSBpICsgMTsKICAgICAgICAgIGJyZWFrOwogICAgICAgIH0KICAgICAgfQoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CiAgICB9LAoKICAgIHNob3dUaGVtZXM6IGZ1bmN0aW9uKCkgewogICAgICB0aGlzLnRoZW1lVmlldyA9IHRydWU7CgogICAgICB0aGlzLnJlZ2VuZXJhdGVTdG9yeVRleHQoeyBkaXNwOiB0aGlzLnJlbmRlckhpbnRzLmhpZGRlbiB9KTsKCiAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5Kys7CiAgICAgIHRoaXMucmVuZGVySGludHMudGhlbWVzUmVuZGVyS2V5Kys7CiAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwogICAgfSwKCiAgICBoaWRlVGhlbWVzOiBmdW5jdGlvbigpIHsKICAgICAgdGhpcy50aGVtZVZpZXcgPSBmYWxzZTsKCiAgICAgIHRoaXMucmVnZW5lcmF0ZVN0b3J5VGV4dCh7IGRpc3A6IHRoaXMucmVuZGVySGludHMuaGlkZGVuIH0pOwoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5yZW5kZXJIaW50cy50aGVtZXNSZW5kZXJLZXkrKzsKICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CiAgICB9LAoKICAgIHNldFRoZW1lOiBmdW5jdGlvbihldmVudCkgewogICAgICB0aGlzLnN0b3J5UGFnZXNbdGhpcy5jdXJyZW50UGFnZSAtIDFdLnRoZW1lID0KICAgICAgICAiY29sb3I6IiArIGV2ZW50LnRleHRDb2xvciArICI7YmFja2dyb3VuZC1jb2xvcjoiICsgZXZlbnQuYmdDb2xvcjsKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5yZW5kZXJIaW50cy50aGVtZXNSZW5kZXJLZXkrKzsKICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CiAgICB9LAoKICAgIHNldFRoZW1lQWxsOiBmdW5jdGlvbihldmVudCkgewogICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMuc3RvcnlQYWdlcy5sZW5ndGg7IGkrKykgewogICAgICAgIHRoaXMuc3RvcnlQYWdlc1tpXS50aGVtZSA9CiAgICAgICAgICAiY29sb3I6IiArIGV2ZW50LnRleHRDb2xvciArICI7YmFja2dyb3VuZC1jb2xvcjoiICsgZXZlbnQuYmdDb2xvcjsKICAgICAgfQoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5yZW5kZXJIaW50cy50aGVtZXNSZW5kZXJLZXkrKzsKICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CiAgICB9LAoKICAgIHNldFZhcmlhYmxlOiBmdW5jdGlvbihldmVudCkgewogICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3Iuc2V0VGV4dFZhcmlhYmxlKGV2ZW50Lm5hbWUsIGV2ZW50LnZhbHVlKTsKCiAgICAgIHRoaXMud3JpdGVUb1N0b3JhZ2UoKTsKCiAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5Kys7CiAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwogICAgfSwKCiAgICBzZXRWYXJpYWJsZU5hbWU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5jaGFuZ2VUZXh0VmFyaWFibGVOYW1lKGV2ZW50KTsKCiAgICAgIHRoaXMud3JpdGVUb1N0b3JhZ2UoKTsKICAgICAgdGhpcy5yZW5kZXJIaW50cy52YXJpYWJsZVJlbmRlcktleSsrOwogICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKICAgIH0sCgogICAgZGVsZXRlVmFyaWFibGU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5kZWxldGVUZXh0VmFyaWFibGUoZXZlbnQpOwoKICAgICAgdGhpcy53cml0ZVRvU3RvcmFnZSgpOwogICAgICB0aGlzLnJlbmRlckhpbnRzLnZhcmlhYmxlUmVuZGVyS2V5Kys7CiAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5Kys7CiAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwogICAgfSwKCiAgICByZWdlbmVyYXRlU3RvcnlUZXh0OiBmdW5jdGlvbihldmVudCkgewogICAgICB0aGlzLnJlbmRlckhpbnRzLmhpZGRlbiA9IGV2ZW50LmRpc3A7CgogICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuZ2VuZXJhdGVTdG9yeVRleHQoCiAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5oaWRkZW4sCiAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5pblZhcmlhYmxlRWRpdG9yLAogICAgICAgIHRoaXMucmVuZGVySGludHMuaW5NZWRpYUVkaXRvcgogICAgICApOwogICAgICB0aGlzLnN0b3J5VmFyaWFibGVzID0gdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnZhcmlhYmxlczsKICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcyA9IHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5pbWFnZVZhcmlhYmxlczsKICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcyA9IHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5hdWRpb1ZhcmlhYmxlczsKICAgICAgdGhpcy5zdG9yeVBhZ2VzID0gdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmV4cG9ydGVkU3RvcnlQYWdlczsKICAgICAgdGhpcy5zdG9yeU5hbWUgPSB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuYmFzZVN0b3J5Lm5hbWU7CgogICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKICAgIH0sCgogICAgYWRkTmV3VmFyaWFibGU6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5hZGRUZXh0VmFyaWFibGUoZXZlbnQpOwogICAgICB0aGlzLndyaXRlVG9TdG9yYWdlKCk7CgogICAgICB0aGlzLnJlbmRlckhpbnRzLnJlbmRlcktleSsrOwogICAgICB0aGlzLnJlbmRlckhpbnRzLnZhcmlhYmxlUmVuZGVyS2V5Kys7CiAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwogICAgfSwKCiAgICBhZGRMaW5rOiBmdW5jdGlvbihldmVudCkgewogICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuYWRkTGluayh7CiAgICAgICAgcGFnZU5hbWU6IHRoaXMuc3RvcnlQYWdlc1t0aGlzLmN1cnJlbnRQYWdlIC0gMV0ucGFnZU5hbWUsCiAgICAgICAgbmFtZTogZXZlbnQubmFtZQogICAgICB9KTsKCiAgICAgIHRoaXMud3JpdGVUb1N0b3JhZ2UoKTsKCiAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5Kys7CiAgICAgIHRoaXMucmVuZGVySGludHMucGFzc2FnZVJlbmRlcktleSsrOwogICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKICAgIH0sCgogICAgcmVtb3ZlTGluazogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnJlbW92ZUxpbmsoZXZlbnQpOwoKICAgICAgdGhpcy53cml0ZVRvU3RvcmFnZSgpOwoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CiAgICB9LAoKICAgIHVwZGF0ZVBhc3NhZ2U6IGZ1bmN0aW9uKGV2ZW50KSB7CiAgICAgIHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5zZXRQYXNzYWdlKGV2ZW50Lm5hbWUsIGV2ZW50LnRleHQpOwoKICAgICAgdGhpcy53cml0ZVRvU3RvcmFnZSgpOwoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5yZW5kZXJIaW50cy5wYXNzYWdlUmVuZGVyS2V5Kys7CgogICAgICBpZiAoZXZlbnQuaXNWYXJpYWJsZXMpIHsKICAgICAgICB0aGlzLnJlbmRlckhpbnRzLnZhcmlhYmxlUmVuZGVyS2V5Kys7CiAgICAgIH0KCiAgICAgIHRoaXMuY2hlY2tSZW5kZXJIaW50cygpOwogICAgfSwKCiAgICB1cGRhdGVQYXNzYWdlTmFtZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmNoYW5nZVBhc3NhZ2VOYW1lKGV2ZW50KTsKCiAgICAgIHRoaXMud3JpdGVUb1N0b3JhZ2UoKTsKCiAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5Kys7CiAgICAgIHRoaXMucmVuZGVySGludHMucGFzc2FnZVJlbmRlcktleSsrOwogICAgICB0aGlzLmNoZWNrUmVuZGVySGludHMoKTsKICAgIH0sCgogICAgZGVsZXRlUGFzc2FnZTogZnVuY3Rpb24oZXZlbnQpIHsKICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmRlbGV0ZVBhc3NhZ2UoZXZlbnQpOwoKICAgICAgdGhpcy53cml0ZVRvU3RvcmFnZSgpOwoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5wYXNzYWdlUmVuZGVyS2V5Kys7CgogICAgICBpZiAoIXRoaXMucHJldlBhZ2UoKSkgewogICAgICAgIHRoaXMuZ29Ub1N0YXJ0KCk7CiAgICAgIH0KICAgIH0sCgogICAgY2hhbmdlU3RvcnlOYW1lKGV2ZW50KSB7CiAgICAgIHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5jaGFuZ2VTdG9yeU5hbWUoZXZlbnQpOwoKICAgICAgdGhpcy53cml0ZVRvU3RvcmFnZSgpOwoKICAgICAgdGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkrKzsKICAgICAgdGhpcy5jaGVja1JlbmRlckhpbnRzKCk7CiAgICB9LAoKICAgIGRvd25sb2FkU3RvcnlUd2VlOiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHN0b3J5VmlldyA9IHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5nZW5lcmF0ZVNhdmVTdG9yeSgpOwogICAgICB0aGlzLmhhbmRsZXMuZmlsZUNvbnZlcnRlci5zdG9yeSA9IHN0b3J5VmlldzsKCiAgICAgIHZhciB0d2VlQmxvYiA9IHRoaXMuaGFuZGxlcy5maWxlQ29udmVydGVyLnR3ZWUoKTsKCiAgICAgIHZhciBkbGJsb2IgPSBuZXcgQmxvYihbdHdlZUJsb2JdLCB7IHR5cGU6ICJ0ZXh0L3BsYWluIiB9KTsKCiAgICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJhIik7CiAgICAgIGxpbmsuaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoZGxibG9iKTsKICAgICAgbGluay50YXJnZXQgPSAiX2JsYW5rIjsKICAgICAgbGluay5zZXRBdHRyaWJ1dGUoCiAgICAgICAgImRvd25sb2FkIiwKICAgICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuYmFzZVN0b3J5Lm5hbWUgKyAiLnR3ZWUiCiAgICAgICk7CiAgICAgIGxpbmsuY2xpY2soKTsKICAgICAgVVJMLnJldm9rZU9iamVjdFVSTChsaW5rLmhyZWYpOwogICAgICAvL3RoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5yZW1vdmVWYXJpYWJsZUluamVjdCgpOwogICAgfSwKCiAgICBzYXZlU3RvcnlUb1Byb2ZpbGUoKSB7CiAgICAgIHZhciBjbG91ZFN0b3J5ID0gdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmdlbmVyYXRlU2F2ZVN0b3J5KCk7CiAgICAgIHRoaXMuaGFuZGxlcy5maWxlQ29udmVydGVyLnN0b3J5ID0gY2xvdWRTdG9yeTsKICAgICAgdmFyIHR3ZWVCbG9iID0gdGhpcy5oYW5kbGVzLmZpbGVDb252ZXJ0ZXIudHdlZSgpOwoKICAgICAgdmFyIGQgPSBuZXcgRGF0ZSgpOwogICAgICB2YXIgZHJhZnRPYmogPSB7CiAgICAgICAgdGV4dDogdHdlZUJsb2IsCiAgICAgICAgZGF0ZVVwZGF0ZWQ6CiAgICAgICAgICBkLmdldE1vbnRoKCkgKyAxICsgIi8iICsgZC5nZXREYXRlKCkgKyAiLyIgKyBkLmdldEZ1bGxZZWFyKCksCiAgICAgICAgT0dzdG9yeTogc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgiT0dzdG9yeVBhc3NhZ2VzIikKICAgICAgfTsKICAgICAgaWYgKAogICAgICAgIGRiLnJlZigKICAgICAgICAgICJhY2NvdW50cy8iICsKICAgICAgICAgICAgZmlyZWJhc2UuYXV0aCgpLmN1cnJlbnRVc2VyLnVpZCArCiAgICAgICAgICAgICIvZHJhZnRzLyIgKwogICAgICAgICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuYmFzZVN0b3J5Lm5hbWUKICAgICAgICApCiAgICAgICkgewogICAgICAgIGRiLnJlZigKICAgICAgICAgICJhY2NvdW50cy8iICsKICAgICAgICAgICAgZmlyZWJhc2UuYXV0aCgpLmN1cnJlbnRVc2VyLnVpZCArCiAgICAgICAgICAgICIvZHJhZnRzLyIgKwogICAgICAgICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuYmFzZVN0b3J5Lm5hbWUKICAgICAgICApLnVwZGF0ZShkcmFmdE9iaik7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgZGIucmVmKAogICAgICAgICAgImFjY291bnRzLyIgKwogICAgICAgICAgICBmaXJlYmFzZS5hdXRoKCkuY3VycmVudFVzZXIudWlkICsKICAgICAgICAgICAgIi9kcmFmdHMvIiArCiAgICAgICAgICAgIHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5iYXNlU3RvcnkubmFtZQogICAgICAgICkucHVzaChkcmFmdE9iaik7CiAgICAgIH0KICAgICAgYWxlcnQoIllvdXIgc3Rvcnkgd2FzIHNhdmVkIHN1Y2Nlc3NmdWxseSEiKTsKICAgIH0sCgogICAgZ2V0RXhwb3J0RmlsZSgpIHsKICAgICAgdmFyIGNsb3VkU3RvcnkgPSB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuZ2VuZXJhdGVQdWJsaXNoU3RvcnkoKTsKICAgICAgdGhpcy5oYW5kbGVzLmZpbGVDb252ZXJ0ZXIuc3RvcnkgPSBjbG91ZFN0b3J5OwogICAgICB2YXIgdHdlZUJsb2IgPSB0aGlzLmhhbmRsZXMuZmlsZUNvbnZlcnRlci50d2VlKCk7CiAgICAgIHRoaXMuJHN0b3JlLmNvbW1pdCgidXBkYXRlU3RvcnlQdWJsaXNoIiwgdHdlZUJsb2IpOwogICAgfSwKCiAgICBkb3dubG9hZFN0b3J5OiBmdW5jdGlvbigpIHsKICAgICAgdmFyIHN0b3J5VmlldyA9IHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5nZW5lcmF0ZVZpZXdTdG9yeSh0cnVlKTsKICAgICAgdGhpcy5oYW5kbGVzLmZpbGVDb252ZXJ0ZXIuc3RvcnkgPSBzdG9yeVZpZXc7CiAgICAgIHZhciBodG1sQmxvYiA9IHRoaXMuaGFuZGxlcy5maWxlQ29udmVydGVyLmh0bWwoCiAgICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmNzcywKICAgICAgICAiIgogICAgICApOwoKICAgICAgc3RvcnlWaWV3ID0gdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmdlbmVyYXRlU2F2ZVN0b3J5KCk7CiAgICAgIHRoaXMuaGFuZGxlcy5maWxlQ29udmVydGVyLnN0b3J5ID0gc3RvcnlWaWV3OwogICAgICB2YXIgdHdlZUJsb2IgPSB0aGlzLmhhbmRsZXMuZmlsZUNvbnZlcnRlci50d2VlKCk7CgogICAgICB2YXIgemlwID0gbmV3IEpTWmlwKCk7CiAgICAgIHppcC5maWxlKHRoaXMuc3RvcnlOYW1lICsgIi5odG1sIiwgaHRtbEJsb2IpOwogICAgICB6aXAuZmlsZSh0aGlzLnN0b3J5TmFtZSArICIudHdlZSIsIHR3ZWVCbG9iKTsKICAgICAgemlwLmZpbGUoCiAgICAgICAgInJlYWRNZS50eHQiLAogICAgICAgICJUbyB2aWV3IHRoZSBzdG9yeSwgZG91YmxlIGNsaWNrIG9uIHRoZSBodG1sIGZpbGUuXG5JZiB0aGUgdXNlciB3YW50cyB0byByZS1lZGl0IHRoZSBzdG9yeSwgdGhleSBtdXN0IHVwbG9hZCB0aGUgLnR3ZWUgZmlsZSB0byBvdXIgd2Vic2l0ZS5cbkNyZWF0ZSBhbiBhY2NvdW50IHRvIHNhdmUgc3RvcmllcywgZG93bmxvYWQgc3RvcmllcyBhbmQgbW9yZSEiCiAgICAgICk7CgogICAgICB2YXIgbmFtZSA9IHRoaXMuc3RvcnlOYW1lOwoKICAgICAgemlwLmdlbmVyYXRlQXN5bmMoeyB0eXBlOiAiYmxvYiIgfSkudGhlbihmdW5jdGlvbihjb250ZW50KSB7CiAgICAgICAgLy8gc2VlIEZpbGVTYXZlci5qcwogICAgICAgIEZpbGVTYXZlci5zYXZlQXMoY29udGVudCwgbmFtZSArICIuemlwIik7CiAgICAgIH0pOwogICAgICAvL3RoaXMuaGFuZGxlcy5maWxlQ29udmVydGVyLmh0bWwoZXZlbnQuY3NzLCBldmVudC5qcyk7CiAgICB9LAoKICAgIHZpZXdTdG9yeUhUTUw6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgc3RvcnlWaWV3ID0gdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmdlbmVyYXRlVmlld1N0b3J5KHRydWUpOwogICAgICB0aGlzLmhhbmRsZXMuZmlsZUNvbnZlcnRlci5zdG9yeSA9IHN0b3J5VmlldzsKCiAgICAgIC8vdGhpcy5oYW5kbGVzLmZpbGVDb252ZXJ0ZXIuaHRtbChldmVudC5jc3MsIGV2ZW50LmpzKTsKCiAgICAgIHZhciBodG1sQmxvYiA9IHRoaXMuaGFuZGxlcy5maWxlQ29udmVydGVyLmh0bWwoCiAgICAgICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmNzcywKICAgICAgICAiIgogICAgICApOwoKICAgICAgY29uc3QgbGluayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoImEiKTsKICAgICAgbGluay5ocmVmID0gVVJMLmNyZWF0ZU9iamVjdFVSTCgKICAgICAgICBuZXcgQmxvYihbaHRtbEJsb2JdLCB7IHR5cGU6ICJ0ZXh0L2h0bWwiIH0pCiAgICAgICk7CiAgICAgIGxpbmsudGFyZ2V0ID0gIl9ibGFuayI7CiAgICAgIC8vbGluay5zZXRBdHRyaWJ1dGUoJ2Rvd25sb2FkJywgIHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5iYXNlU3RvcnkubmFtZSArICcuaHRtbCcpOwogICAgICBsaW5rLmNsaWNrKCk7CiAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwobGluay5ocmVmKTsKICAgICAgLy90aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IucmVtb3ZlVmFyaWFibGVJbmplY3QoKTsKICAgIH0sCgogICAgLyp2aWV3SFRNTEJsb2I6IGZ1bmN0aW9uKGh0bWxDb250ZW50cyl7CiAgICAgICAgICAgIGNvbnN0IGxpbmsgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgIGxpbmsuaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoW2h0bWxDb250ZW50c10sIHt0eXBlOiAidGV4dC9odG1sIn0pKTsKICAgICAgICAgICAgbGluay50YXJnZXQgPSAiX2JsYW5rIgogICAgICAgICAgICAvL2xpbmsuc2V0QXR0cmlidXRlKCdkb3dubG9hZCcsICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuYmFzZVN0b3J5Lm5hbWUgKyAnLmh0bWwnKTsKICAgICAgICAgICAgbGluay5jbGljaygpOwogICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKGxpbmsuaHJlZik7CiAgICAgICAgfSwqLwoKICAgIHB1Ymxpc2hTdG9yeVR5cGU6IGZ1bmN0aW9uKCkgewogICAgICB2YXIgdGVtcGxhdGVDaGFuZ2VkID0gdGhpcy5jaGVja1VuaXF1ZVN0b3J5KCk7CiAgICAgIGlmICgKICAgICAgICBzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKCJjcmVhdGVUZW1wbGF0ZSIpID09PSAieWVzIiAmJgogICAgICAgIHRlbXBsYXRlQ2hhbmdlZCA9PT0gdHJ1ZQogICAgICApIHsKICAgICAgICB0aGlzLmNoZWNrVW5pcXVlVGVtcGxhdGUoKTsKICAgICAgfQogICAgfSwKCiAgICBjaGVja1VuaXF1ZVRlbXBsYXRlOiBmdW5jdGlvbigpIHsKICAgICAgbGV0IGNhblN1Ym1pdCA9IHRydWU7CiAgICAgIGNvbnN0IFR5cGVzZW5zZSA9IHJlcXVpcmUoInR5cGVzZW5zZSIpOwogICAgICBjb25zdCB0eXBlc2Vuc2UgPSBuZXcgVHlwZXNlbnNlLkNsaWVudCh7CiAgICAgICAgbm9kZXM6IFsKICAgICAgICAgIHsKICAgICAgICAgICAgLy9ob3N0OiAnbG9jYWxob3N0JywKICAgICAgICAgICAgLy8gaG9zdDogInZjbS0xNTQzMS52bS5kdWtlLmVkdSIsCiAgICAgICAgICAgIC8vIHBvcnQ6ICI4MTA4IiwKICAgICAgICAgICAgLy8gcHJvdG9jb2w6ICJodHRwcyIKICAgICAgICAgICAgaG9zdDogImF2Mnhya2k2eTU0aGwzd2JwLTEuYTEudHlwZXNlbnNlLm5ldCIsCiAgICAgICAgICAgIHBvcnQ6ICI0NDMiLAogICAgICAgICAgICBwcm90b2NvbDogImh0dHBzIgogICAgICAgICAgfQogICAgICAgIF0sCgogICAgICAgIC8vIGFwaUtleTogIllPWUNwRkxqOXU0MTJpaGlnc3RDZXI1WnMyU3R6cHRSIgogICAgICAgIGFwaUtleTogIkkxUkRucGZCeGRwbGxEY2h0ajdnc2x6c3F3cG1udm1pIgogICAgICB9KTsKCiAgICAgIHR5cGVzZW5zZQogICAgICAgIC5jb2xsZWN0aW9ucygic3RvcmllcyIpCiAgICAgICAgLnJldHJpZXZlKCkKICAgICAgICAudGhlbihkYXRhID0+IHsKICAgICAgICAgIHZhciBudW1Eb2NzID0gZGF0YS5udW1fZG9jdW1lbnRzOwogICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBudW1Eb2NzIC0gMTsgaSsrKSB7CiAgICAgICAgICAgIHR5cGVzZW5zZQogICAgICAgICAgICAgIC5jb2xsZWN0aW9ucygic3RvcmllcyIpCiAgICAgICAgICAgICAgLmRvY3VtZW50cyhpLnRvU3RyaW5nKCkpCiAgICAgICAgICAgICAgLnJldHJpZXZlKCkKICAgICAgICAgICAgICAudGhlbihkYXRhID0+IHsKICAgICAgICAgICAgICAgIGxldCBhRmlsZUNvbnZlcnRlciA9IG5ldyBGaWxlQ29udmVydGVyKGRhdGEudGV4dCwgZmFsc2UpOwogICAgICAgICAgICAgICAgbGV0IGFTdG9yeUVkaXRvciA9IG5ldyBTdG9yeUVkaXRvcihhRmlsZUNvbnZlcnRlci5zdG9yeSk7CiAgICAgICAgICAgICAgICB2YXIgczEgPSAiIjsKICAgICAgICAgICAgICAgIHZhciBzMiA9ICIiOwogICAgICAgICAgICAgICAgZm9yICgKICAgICAgICAgICAgICAgICAgbGV0IGkgPSAwOwogICAgICAgICAgICAgICAgICBpIDwgYVN0b3J5RWRpdG9yLmV4cG9ydGVkU3RvcnlQYWdlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgIGkrKwogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgIHMxICs9IGFTdG9yeUVkaXRvci5leHBvcnRlZFN0b3J5UGFnZXNbaV0ubGlua1Bhc3NhZ2UudGV4dDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zdG9yeVBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgICAgICAgICAgIHMyICs9IHRoaXMuc3RvcnlQYWdlc1tpXS5saW5rUGFzc2FnZS50ZXh0OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICBhU3RvcnlFZGl0b3IuZXhwb3J0ZWRTdG9yeVBhZ2VzLmxlbmd0aCA8CiAgICAgICAgICAgICAgICAgIHRoaXMuc3RvcnlQYWdlcy5sZW5ndGgKICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICBmb3IgKAogICAgICAgICAgICAgICAgICAgIGxldCBpID0gYVN0b3J5RWRpdG9yLmV4cG9ydGVkU3RvcnlQYWdlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgaSA8IHRoaXMuc3RvcnlQYWdlcy5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgaSsrCiAgICAgICAgICAgICAgICAgICkgewogICAgICAgICAgICAgICAgICAgIHZhciBpbmRleE9wZW5CcmFja2V0cyA9IHRoaXMuc3RvcnlQYWdlc1sKICAgICAgICAgICAgICAgICAgICAgIGkKICAgICAgICAgICAgICAgICAgICBdLmxpbmtQYXNzYWdlLnRleHQuaW5kZXhPZigiW1siKTsKICAgICAgICAgICAgICAgICAgICB2YXIgaW5kZXhDbG9zZUJyYWNrZXRzID0gdGhpcy5zdG9yeVBhZ2VzWwogICAgICAgICAgICAgICAgICAgICAgaQogICAgICAgICAgICAgICAgICAgIF0ubGlua1Bhc3NhZ2UudGV4dC5pbmRleE9mKCJdXSIpOwogICAgICAgICAgICAgICAgICAgIHZhciBjbGVhblN0ciA9IHRoaXMuc3RvcnlQYWdlc1tpXS5saW5rUGFzc2FnZS50ZXh0OwogICAgICAgICAgICAgICAgICAgIGlmIChpbmRleE9wZW5CcmFja2V0cyAhPSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgdmFyIGJyYWNrZXRTdHIgPSB0aGlzLnN0b3J5UGFnZXNbCiAgICAgICAgICAgICAgICAgICAgICAgIGkKICAgICAgICAgICAgICAgICAgICAgIF0ubGlua1Bhc3NhZ2UudGV4dC5zdWJzdHJpbmcoCiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4T3BlbkJyYWNrZXRzLAogICAgICAgICAgICAgICAgICAgICAgICBpbmRleENsb3NlQnJhY2tldHMgKyAyCiAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgY2xlYW5TdHIgPSB0aGlzLnN0b3J5UGFnZXNbaV0ubGlua1Bhc3NhZ2UudGV4dC5yZXBsYWNlKAogICAgICAgICAgICAgICAgICAgICAgICBicmFja2V0U3RyLAogICAgICAgICAgICAgICAgICAgICAgICAiIgogICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKAogICAgICAgICAgICAgICAgICAgICAgdGhpcy5zdG9yeVBhZ2VzW2ldLmxpbmtQYXNzYWdlLnRleHQuaW5jbHVkZXMoCiAgICAgICAgICAgICAgICAgICAgICAgICJUaGlzIGlzIGEgbmV3IHBhc3NhZ2UuIEVkaXQgaXQgdG8gY3JlYXRlIHlvdXIgb3duIHN0b3J5ISIKICAgICAgICAgICAgICAgICAgICAgICkgfHwKICAgICAgICAgICAgICAgICAgICAgIGNsZWFuU3RyLnJlcGxhY2UoL1xzL2csICIiKSA9PT0gIiIKICAgICAgICAgICAgICAgICAgICApIHsKICAgICAgICAgICAgICAgICAgICAgIGFsZXJ0KCJQbGVhc2UgZWRpdCBjb250ZW50IGluIG5ldyBwYXNzYWdlcy4iKTsKICAgICAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgczIgKz0gY2xlYW5TdHI7CiAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHZhciBzaW1pbGFyaXR5U2NvcmUgPSB0aGlzLnNpbWlsYXJpdHkoczEsIHMyKTsKICAgICAgICAgICAgICAgIC8vY29uc29sZS5sb2coc2ltaWxhcml0eVNjb3JlKTsKICAgICAgICAgICAgICAgIGlmIChzaW1pbGFyaXR5U2NvcmUgPiAwLjc1KSB7CiAgICAgICAgICAgICAgICAgIGNhblN1Ym1pdCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICBhbGVydCgKICAgICAgICAgICAgICAgICAgICAiU3RvcnkgdGVtcGxhdGUgaXMgdG9vIHNpbWlsYXIgdG8gZXhpc3RpbmcgdGVtcGxhdGUuIFBsZWFzZSBzdWJtaXQgYSB1bmlxdWUgc3RvcnkgdGVtcGxhdGUuIgogICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoCiAgICAgICAgICAgICAgICAgIHNpbWlsYXJpdHlTY29yZSA8PSAwLjc1ICYmCiAgICAgICAgICAgICAgICAgIGkgPT09IG51bURvY3MgLSAyICYmCiAgICAgICAgICAgICAgICAgIGNhblN1Ym1pdCA9PT0gdHJ1ZQogICAgICAgICAgICAgICAgKSB7CiAgICAgICAgICAgICAgICAgIGFsZXJ0KAogICAgICAgICAgICAgICAgICAgICJTdG9yeSB0ZW1wbGF0ZSBpcyB1bmlxdWUgYW5kIGlzIHJlYWR5IHRvIGJlIHB1Ymxpc2hlZCEiCiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9KTsKICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0sCgogICAgLy8gQWRkIHN1cHBvcnQgZm9yIGRyYWZ0cwogICAgY2hlY2tVbmlxdWVTdG9yeTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzMSA9ICIiOwogICAgICB2YXIgczIgPSAiIjsKICAgICAgZm9yICgKICAgICAgICBsZXQgaSA9IDA7CiAgICAgICAgaSA8IEpTT04ucGFyc2Uoc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgiT0dzdG9yeVBhc3NhZ2VzIikpLmxlbmd0aDsKICAgICAgICBpKysKICAgICAgKSB7CiAgICAgICAgczEgKz0gSlNPTi5wYXJzZShzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKCJPR3N0b3J5UGFzc2FnZXMiKSlbaV0KICAgICAgICAgIC5saW5rUGFzc2FnZS50ZXh0OwogICAgICB9CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5zdG9yeVBhZ2VzLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgczIgKz0gdGhpcy5zdG9yeVBhZ2VzW2ldLmxpbmtQYXNzYWdlLnRleHQ7CiAgICAgIH0KICAgICAgaWYgKAogICAgICAgIEpTT04ucGFyc2Uoc2Vzc2lvblN0b3JhZ2UuZ2V0SXRlbSgiT0dzdG9yeVBhc3NhZ2VzIikpLmxlbmd0aCA8CiAgICAgICAgdGhpcy5zdG9yeVBhZ2VzLmxlbmd0aAogICAgICApIHsKICAgICAgICBmb3IgKAogICAgICAgICAgbGV0IGkgPSBKU09OLnBhcnNlKHNlc3Npb25TdG9yYWdlLmdldEl0ZW0oIk9Hc3RvcnlQYXNzYWdlcyIpKS5sZW5ndGg7CiAgICAgICAgICBpIDwgdGhpcy5zdG9yeVBhZ2VzLmxlbmd0aDsKICAgICAgICAgIGkrKwogICAgICAgICkgewogICAgICAgICAgdmFyIGluZGV4T3BlbkJyYWNrZXRzID0gdGhpcy5zdG9yeVBhZ2VzW2ldLmxpbmtQYXNzYWdlLnRleHQuaW5kZXhPZigKICAgICAgICAgICAgIltbIgogICAgICAgICAgKTsKICAgICAgICAgIHZhciBpbmRleENsb3NlQnJhY2tldHMgPSB0aGlzLnN0b3J5UGFnZXNbaV0ubGlua1Bhc3NhZ2UudGV4dC5pbmRleE9mKAogICAgICAgICAgICAiXV0iCiAgICAgICAgICApOwogICAgICAgICAgdmFyIGNsZWFuU3RyID0gdGhpcy5zdG9yeVBhZ2VzW2ldLmxpbmtQYXNzYWdlLnRleHQ7CiAgICAgICAgICBpZiAoaW5kZXhPcGVuQnJhY2tldHMgIT0gLTEpIHsKICAgICAgICAgICAgdmFyIGJyYWNrZXRTdHIgPSB0aGlzLnN0b3J5UGFnZXNbaV0ubGlua1Bhc3NhZ2UudGV4dC5zdWJzdHJpbmcoCiAgICAgICAgICAgICAgaW5kZXhPcGVuQnJhY2tldHMsCiAgICAgICAgICAgICAgaW5kZXhDbG9zZUJyYWNrZXRzICsgMgogICAgICAgICAgICApOwogICAgICAgICAgICBjbGVhblN0ciA9IHRoaXMuc3RvcnlQYWdlc1tpXS5saW5rUGFzc2FnZS50ZXh0LnJlcGxhY2UoCiAgICAgICAgICAgICAgYnJhY2tldFN0ciwKICAgICAgICAgICAgICAiIgogICAgICAgICAgICApOwogICAgICAgICAgfQogICAgICAgICAgaWYgKAogICAgICAgICAgICB0aGlzLnN0b3J5UGFnZXNbaV0ubGlua1Bhc3NhZ2UudGV4dC5pbmNsdWRlcygKICAgICAgICAgICAgICAiVGhpcyBpcyBhIG5ldyBwYXNzYWdlLiBFZGl0IGl0IHRvIGNyZWF0ZSB5b3VyIG93biBzdG9yeSEiCiAgICAgICAgICAgICkgfHwKICAgICAgICAgICAgY2xlYW5TdHIucmVwbGFjZSgvXHMvZywgIiIpID09PSAiIgogICAgICAgICAgKSB7CiAgICAgICAgICAgIGFsZXJ0KCJQbGVhc2UgZWRpdCBjb250ZW50IGluIG5ldyBwYXNzYWdlcy4iKTsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgfQogICAgICAgICAgczIgKz0gY2xlYW5TdHI7CiAgICAgICAgfQogICAgICB9CiAgICAgIHZhciBzaW1pbGFyaXR5U2NvcmUgPSB0aGlzLnNpbWlsYXJpdHkoczEsIHMyKTsKICAgICAgY29uc29sZS5sb2coc2ltaWxhcml0eVNjb3JlKTsKICAgICAgaWYgKHNpbWlsYXJpdHlTY29yZSA+IDAuNzUpIHsKICAgICAgICBhbGVydCgKICAgICAgICAgICJTdG9yeSBpcyB0b28gc2ltaWxhciB0byB0aGUgb3JpZ2luYWwuIFBsZWFzZSBzdWJtaXQgYSB1bmlxdWUgc3RvcnkuIgogICAgICAgICk7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICB9CiAgICAgIGlmIChzZXNzaW9uU3RvcmFnZS5nZXRJdGVtKCJjcmVhdGVUZW1wbGF0ZSIpICE9ICJ5ZXMiKSB7CiAgICAgICAgYWxlcnQoIlN0b3J5IGlzIHVuaXF1ZSBhbmQgaXMgcmVhZHkgdG8gYmUgcHVibGlzaGVkISIpOwogICAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0cnVlOwogICAgICB9CiAgICB9LAoKICAgIC8vIFVzZXMgTGV2ZW5zaHRlaW4gZGlzdGFuY2UgYWxnb3JpdGhtCiAgICBzaW1pbGFyaXR5OiBmdW5jdGlvbihzMSwgczIpIHsKICAgICAgdmFyIGxvbmdlciA9IHMxLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXHMvZywgIiIpOwogICAgICB2YXIgc2hvcnRlciA9IHMyLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgvXHMvZywgIiIpOwogICAgICBpZiAoczEubGVuZ3RoIDwgczIubGVuZ3RoKSB7CiAgICAgICAgbG9uZ2VyID0gczI7CiAgICAgICAgc2hvcnRlciA9IHMxOwogICAgICB9CiAgICAgIHZhciBsb25nZXJMZW5ndGggPSBsb25nZXIubGVuZ3RoOwogICAgICBpZiAobG9uZ2VyTGVuZ3RoID09IDApIHsKICAgICAgICByZXR1cm4gMS4wOwogICAgICB9CiAgICAgIHJldHVybiAoCiAgICAgICAgKGxvbmdlckxlbmd0aCAtIHRoaXMuZWRpdERpc3RhbmNlKGxvbmdlciwgc2hvcnRlcikpIC8KICAgICAgICBwYXJzZUZsb2F0KGxvbmdlckxlbmd0aCkKICAgICAgKTsKICAgIH0sCgogICAgZWRpdERpc3RhbmNlOiBmdW5jdGlvbihzMSwgczIpIHsKICAgICAgdmFyIGNvc3RzID0gbmV3IEFycmF5KCk7CiAgICAgIGZvciAodmFyIGkgPSAwOyBpIDw9IHMxLmxlbmd0aDsgaSsrKSB7CiAgICAgICAgdmFyIGxhc3RWYWx1ZSA9IGk7CiAgICAgICAgZm9yICh2YXIgaiA9IDA7IGogPD0gczIubGVuZ3RoOyBqKyspIHsKICAgICAgICAgIGlmIChpID09IDApIHsKICAgICAgICAgICAgY29zdHNbal0gPSBqOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKGogPiAwKSB7CiAgICAgICAgICAgICAgdmFyIG5ld1ZhbHVlID0gY29zdHNbaiAtIDFdOwogICAgICAgICAgICAgIGlmIChzMS5jaGFyQXQoaSAtIDEpICE9IHMyLmNoYXJBdChqIC0gMSkpIHsKICAgICAgICAgICAgICAgIG5ld1ZhbHVlID0KICAgICAgICAgICAgICAgICAgTWF0aC5taW4oTWF0aC5taW4obmV3VmFsdWUsIGxhc3RWYWx1ZSksIGNvc3RzW2pdKSArIDE7CiAgICAgICAgICAgICAgfQogICAgICAgICAgICAgIGNvc3RzW2ogLSAxXSA9IGxhc3RWYWx1ZTsKICAgICAgICAgICAgICBsYXN0VmFsdWUgPSBuZXdWYWx1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoaSA+IDApIHsKICAgICAgICAgIGNvc3RzW3MyLmxlbmd0aF0gPSBsYXN0VmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICAgIHJldHVybiBjb3N0c1tzMi5sZW5ndGhdOwogICAgfSwKCiAgICB3cml0ZVRvU3RvcmFnZTogZnVuY3Rpb24oKSB7CiAgICAgIHZhciBzdG9yeVZpZXcgPSB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuZ2VuZXJhdGVTYXZlU3RvcnkoKTsKICAgICAgdGhpcy5oYW5kbGVzLmZpbGVDb252ZXJ0ZXIuc3RvcnkgPSBzdG9yeVZpZXc7CgogICAgICB2YXIgdHdlZUJsb2IgPSB0aGlzLmhhbmRsZXMuZmlsZUNvbnZlcnRlci50d2VlKCk7CiAgICAgIHNlc3Npb25TdG9yYWdlLnNldEl0ZW0oInN0b3J5Q29udGVudCIsIHR3ZWVCbG9iKTsKICAgICAgc2Vzc2lvblN0b3JhZ2Uuc2V0SXRlbSgic3RvcnlMb2NhdGlvbiIsICIiKTsKCiAgICAgIC8vdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnJlbW92ZVZhcmlhYmxlSW5qZWN0KCk7CgogICAgICB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuZ2VuZXJhdGVTdG9yeVRleHQoCiAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5oaWRkZW4sCiAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5pblZhcmlhYmxlRWRpdG9yLAogICAgICAgIHRoaXMucmVuZGVySGludHMuaW5NZWRpYUVkaXRvcgogICAgICApOwogICAgICB0aGlzLnN0b3J5VmFyaWFibGVzID0gdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLnZhcmlhYmxlczsKICAgICAgdGhpcy5pbWFnZVZhcmlhYmxlcyA9IHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5pbWFnZVZhcmlhYmxlczsKICAgICAgdGhpcy5hdWRpb1ZhcmlhYmxlcyA9IHRoaXMuaGFuZGxlcy5zdG9yeUVkaXRvci5hdWRpb1ZhcmlhYmxlczsKICAgICAgdGhpcy5zdG9yeVBhZ2VzID0gdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmV4cG9ydGVkU3RvcnlQYWdlczsKICAgICAgdGhpcy5zdG9yeU5hbWUgPSB0aGlzLmhhbmRsZXMuc3RvcnlFZGl0b3IuYmFzZVN0b3J5Lm5hbWU7CiAgICB9LAoKICAgIGNoZWNrUmVuZGVySGludHM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy5yZW5kZXJIaW50cy5yZW5kZXJLZXkgPiAxMCkgewogICAgICAgIHRoaXMucmVuZGVySGludHMucmVuZGVyS2V5ID0gMTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMucmVuZGVySGludHMudmFyaWFibGVSZW5kZXJLZXkgPiAxMCkgewogICAgICAgIHRoaXMucmVuZGVySGludHMudmFyaWFibGVSZW5kZXJLZXkgPSAxOwogICAgICB9CgogICAgICBpZiAodGhpcy5yZW5kZXJIaW50cy50aGVtZXNSZW5kZXJLZXkgPiAxMCkgewogICAgICAgIHRoaXMucmVuZGVySGludHMudGhlbWVzUmVuZGVyS2V5ID0gMTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMucmVuZGVySGludHMucGFzc2FnZVJlbmRlcktleSA+IDEwKSB7CiAgICAgICAgdGhpcy5yZW5kZXJIaW50cy5wYXNzYWdlUmVuZGVyS2V5ID0gMTsKICAgICAgfQoKICAgICAgaWYgKHRoaXMucmVuZGVySGludHMuZ3NvUmVuZGVyS2V5ID4gMTApIHsKICAgICAgICB0aGlzLnJlbmRlckhpbnRzLmdzb1JlbmRlcktleSA9IDE7CiAgICAgIH0KCiAgICAgIGlmICh0aGlzLnJlbmRlckhpbnRzLm1lZGlhUmVuZGVyS2V5ID4gMTApIHsKICAgICAgICB0aGlzLnJlbmRlckhpbnRzLm1lZGlhUmVuZGVyS2V5ID0gMTsKICAgICAgfQogICAgfSwKCiAgICBoaWRlVG9vbHM6IGZ1bmN0aW9uKCkgewogICAgICBpZiAodGhpcy50b29sQnV0dG9uID09ICJtZGktbWludXMiKSB7CiAgICAgICAgdGhpcy50b29sc1dpZHRoID0gIjEwJSI7CiAgICAgICAgdGhpcy5wYWdlV2lkdGggPSAiOTAlIjsKICAgICAgICB0aGlzLmhpZGVJdGVtID0gdHJ1ZTsKICAgICAgICB0aGlzLnRvb2xCdXR0b24gPSAibWRpLXBsdXMiOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMudG9vbHNXaWR0aCA9ICIzMCUiOwogICAgICAgIHRoaXMucGFnZVdpZHRoID0gIjcwJSI7CiAgICAgICAgdGhpcy5oaWRlSXRlbSA9IGZhbHNlOwogICAgICAgIHRoaXMudG9vbEJ1dHRvbiA9ICJtZGktbWludXMiOwogICAgICB9CiAgICB9LAoKICAgIGdvRnVsbFNjcmVlbjogZnVuY3Rpb24oKSB7CiAgICAgIC8qCiAgICAgICAgICAgIHZhciBzdG9yeVBhZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgic3RvcnlQYWdlIik7CiAgICAgICAgICAgIGlmICghZG9jdW1lbnQuZnVsbHNjcmVlbikgewogICAgICAgICAgICAgICAgc3RvcnlQYWdlLnJlcXVlc3RGdWxsc2NyZWVuKCk7CiAgICAgICAgICAgICAgICB0aGlzLmZ1bGxCdXR0b24gPSAiRXhpdCI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5leGl0RnVsbHNjcmVlbigpOwogICAgICAgICAgICAgICAgdGhpcy5mdWxsQnV0dG9uID0gIkZ1bGwgU2NyZWVuIjsKCiAgICAgICAgICAgIH0KICAgICAgICAgICAgKi8KICAgICAgaWYgKCF0aGlzLmluRnVsbE1vZGUpIHsKICAgICAgICB0aGlzLiRlbWl0KCJldnRHb0Z1bGwiKTsKICAgICAgICB0aGlzLmluRnVsbE1vZGUgPSB0cnVlOwogICAgICAgIHRoaXMuZnVsbEJ1dHRvbiA9ICJtZGktZnVsbHNjcmVlbi1leGl0IjsKICAgICAgICB0aGlzLmNvbnRlbnRIZWlnaHQgPSAiMTAwdmgiOwogICAgICB9IGVsc2UgewogICAgICAgIHRoaXMuJGVtaXQoImV2dEV4aXRGdWxsIik7CiAgICAgICAgdGhpcy5pbkZ1bGxNb2RlID0gZmFsc2U7CiAgICAgICAgdGhpcy5mdWxsQnV0dG9uID0gIm1kaS1mdWxsc2NyZWVuIjsKICAgICAgICB0aGlzLmNvbnRlbnRIZWlnaHQgPSAiNzR2aCI7CiAgICAgIH0KICAgIH0sCgogICAgc2V0TWluSGVpZ2h0OiBmdW5jdGlvbihldmVudCkgewogICAgICB0aGlzLm1pbkhlaWdodCA9IGV2ZW50OwogICAgfQogIH0sCgogIGJlZm9yZURlc3Ryb3k6IGZ1bmN0aW9uKCkgewogICAgY29uc29sZS5sb2coIkRlc3Ryb3llZCIpOwogICAgdGhpcy5oYW5kbGVzLnN0b3J5RWRpdG9yLmRlc3Ryb3koKTsKICB9LAoKICBtaXhpbnM6IFtzdG9yeU1peGluLCB0d2VlQ29udmVydGVyXQp9Owo="},{"version":3,"sources":["Editor.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAqLA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;;AAEA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;;AAEA;AACA","file":"Editor.vue","sourceRoot":"src/components/editor","sourcesContent":["<template>\n  <div class=\"editor\">\n    <v-card\n      fluid\n      outlined\n      class=\"column\"\n      id=\"toolBar\"\n      :width=\"this.toolsWidth\"\n      :height=\"this.contentHeight\"\n    >\n      <gso\n        v-bind:key=\"this.renderHints.gsoRenderKey\"\n        v-bind:isLoggedIn=\"this.isLoggedIn\"\n        v-bind:storyName=\"this.storyName\"\n        v-bind:minimized=\"this.hideItem\"\n        v-on:evtDownloadStory=\"downloadStory\"\n        v-on:evtViewHTML=\"viewStoryHTML\"\n        v-on:evtNewStoryName=\"changeStoryName\"\n        v-on:evtSave=\"saveStoryToProfile\"\n        v-on:evtPublish=\"getExportFile\"\n        v-on:evtNewStory=\"loadTwee\"\n        v-on:evtCreateNewStory=\"loadStoryTemplate\"\n      />\n\n      <v-toolbar color=\"orange darken-2\" flat dark>\n        <v-toolbar-title>\n          <h4>TOOLS</h4>\n        </v-toolbar-title>\n        <v-spacer />\n        <v-btn fab light x-small @click=\"hideTools\">\n          <v-icon>{{toolButton}}</v-icon>\n        </v-btn>\n      </v-toolbar>\n\n      <v-tabs vertical color=\"orange darken-2\">\n        <v-tab\n          v-on:click=\"renderHints.inVariableEditor = true; renderHints.inMediaEditor = false; hideThemes(); \"\n        >\n          <h5>Text</h5>\n        </v-tab>\n\n        <v-tab\n          v-on:click=\"renderHints.inVariableEditor = false; renderHints.inMediaEditor = true; hideThemes(); \"\n        >\n          <h5>Media</h5>\n        </v-tab>\n\n        <v-tab\n          v-on:click=\"renderHints.inVariableEditor = false; renderHints.inMediaEditor = false; showThemes(); \"\n        >\n          <h5>Themes</h5>\n        </v-tab>\n\n        <v-tab\n          v-on:click=\"renderHints.inVariableEditor = false; renderHints.inMediaEditor = false; hideThemes(); \"\n        >\n          <h5>Passages</h5>\n        </v-tab>\n\n        <v-tab-item :hidden=\"this.hideItem\">\n          <v-card flat>\n            <v-card-text>\n              <var-sidebar\n                id=\"var_sidebar\"\n                v-bind:key=\"this.renderHints.variableRenderKey\"\n                v-bind:storyVars=\"this.storyVariables\"\n                v-on:evtVarValueChange=\"setVariable\"\n                v-on:evtVarNameChange=\"setVariableName\"\n                v-on:evtDelete=\"deleteVariable\"\n                v-on:evtDispVars=\"regenerateStoryText\"\n                v-on:evtNewVar=\"addNewVariable\"\n              ></var-sidebar>\n            </v-card-text>\n          </v-card>\n        </v-tab-item>\n\n        <v-tab-item :hidden=\"this.hideItem\">\n          <v-card flat>\n            <v-card-text>\n              <media-sidebar\n                id=\"media_sidebar\"\n                v-bind:key=\"this.renderHints.mediaRenderKey\"\n                v-bind:imageVars=\"this.imageVariables\"\n                v-bind:audioVars=\"this.audioVariables\"\n                v-bind:status=\"this.status\"\n                v-on:evtDispVars=\"regenerateStoryText\"\n                v-on:evtReplaceImage=\"replaceImage\"\n                v-on:evtReplaceAudio=\"replaceAudio\"\n                v-on:evtAudioNameChange=\"replaceAudioName\"\n                v-on:evtImageNameChange=\"replaceImageName\"\n                v-on:evtNewImageVariable=\"addImageVariable\"\n                v-on:evtNewAudioVariable=\"addAudioVariable\"\n                v-on:evtAddImage=\"addImageToPage\"\n                v-on:evtAddAudio=\"addAudioToPage\"\n                v-on:evtRemoveImage=\"removeImageVariable\"\n                v-on:evtRemoveAudio=\"removeAudioVariable\"\n              ></media-sidebar>\n            </v-card-text>\n          </v-card>\n        </v-tab-item>\n\n        <v-tab-item :hidden=\"this.hideItem\">\n          <v-card flat>\n            <v-card-text>\n              <themes-sidebar\n                id=\"themes_sidebar\"\n                v-on:evtNewTheme=\"setTheme\"\n                v-on:evtNewThemeAll=\"setThemeAll\"\n                v-bind:backgroundColor=\"this.storyPages[this.currentPage - 1].extractCSSProperty('background-color')\"\n                v-bind:textColor=\"this.storyPages[this.currentPage - 1].extractCSSProperty('color')\"\n              ></themes-sidebar>\n            </v-card-text>\n          </v-card>\n        </v-tab-item>\n        <v-tab-item :hidden=\"this.hideItem\">\n          <v-card flat>\n            <v-card-text>\n              <passage-sidebar\n                id=\"passage_sidebar\"\n                v-bind:storyPages=\"this.storyPages\"\n                v-bind:currPassage=\"this.storyPages[this.currentPage - 1].pageName\"\n                v-bind:key=\"this.renderHints.passageRenderKey\"\n                v-on:evtNewPassageName=\"updatePassageName\"\n                v-on:evtRemoveLink=\"removeLink\"\n                v-on:evtAddLink=\"addLink\"\n                v-on:evtGoToPage=\"goToPage\"\n                v-on:evtCreateNew=\"addPage\"\n                v-on:evtDelete=\"deletePassage\"\n              ></passage-sidebar>\n            </v-card-text>\n          </v-card>\n        </v-tab-item>\n      </v-tabs>\n\n      <div style=\"border-top: solid 2px lightgray; padding: 10px;\">\n        <v-card-text>\n          Need help using the editor? Visit\n          <a href=\"MyTale Guide.html\" target=\"_blank\">Support</a>.\n        </v-card-text>\n      </div>\n    </v-card>\n\n    <v-card\n      outlined\n      class=\"column\"\n      id=\"storyPage\"\n      :width=\"this.pageWidth\"\n      :height=\"this.contentHeight\"\n    >\n      <page-layout\n        id=\"page_layout\"\n        v-bind:key=\"this.renderHints.renderKey\"\n        v-bind:page=\"this.storyPages[this.currentPage - 1]\"\n        v-bind:imageVars=\"this.imageVariables\"\n        v-bind:audioVars=\"this.audioVariables\"\n        v-bind:themeView=\"this.themeView\"\n        v-on:evtNext=\"nextPage\"\n        v-on:evtStart=\"goToStart\"\n        v-on:evtPrev=\"prevPage\"\n        v-on:evtPassageNameChange=\"updatePassageName\"\n        v-on:evtPassageChange=\"updatePassage\"\n        v-on:evtDelete=\"deletePassage\"\n        v-on:evtMinHeight=\"setMinHeight\"\n        v-on:evtStartPage=\"setStartPage\"\n        v-on:removeImageFromPage=\"removeImageFromPage\"\n        v-on:removeAudioFromPage=\"removeAudioFromPage\"\n      ></page-layout>\n\n      <v-tooltip bottom>\n        <template v-slot:activator=\"{ on, attrs }\">\n          <v-btn v-bind=\"attrs\" v-on=\"on\" top left absolute icon light @click=\"goFullScreen\">\n            <v-icon>{{fullButton}}</v-icon>\n          </v-btn>\n        </template>\n        <span>{{!inFullMode ? \"Full Screen\": \"Exit Full Screen\"}}</span>\n      </v-tooltip>\n    </v-card>\n  </div>\n</template>\n\n<script>\nimport Sidebar_Variables from \"./tools/variables/Sidebar_Variables.vue\";\nimport Sidebar_Media from \"./tools/media/Sidebar_Media.vue\";\nimport Sidebar_Themes from \"./tools/themes/Sidebar_Themes.vue\";\nimport Sidebar_Passage from \"./tools/passage/Sidebar_Passage.vue\";\nimport Global_Story_Options from \"./tools/options/Global_Story_Options.vue\";\nimport Page_Layout from \"./Page_Layout.vue\";\n\nimport FileConverter from \"@/js/extwee_utils/FileConverter.js\";\nimport StoryEditor from \"@/js/extwee_utils/StoryEditor.js\";\nimport firebase from \"firebase\";\nimport { db } from \"@/firebaseConfig\";\nimport storyMixin from \"../../mixins/storyMixin\";\nimport tweeConverter from \"../../mixins/tweeConverterMixin\";\nimport Axios from \"axios\";\nimport FileSaver from \"browser-filesaver\";\nimport debounce from \"debounce\";\n\nvar JSZip = require(\"jszip\");\n\nexport default {\n  name: \"editor\",\n\n  data() {\n    return {\n      isLoggedIn: false,\n\n      /////\n      userRef: null,\n      storyRef: null,\n      basePath: \"\",\n      totalFileSize: 0,\n      maxStorageSize: 15,\n      status: \"\",\n      /////\n\n      storyName: \"\",\n      storyPages: Array,\n      storyVariables: Map,\n      imageVariables: Map,\n      audioVariables: Map,\n\n      currentPage: 1,\n      pagesVisited: [],\n\n      toolsWidth: \"30%\",\n\n      pageWidth: \"70%\",\n      contentHeight: \"74vh\",\n      minHeight: \"500px\",\n      hideItem: false,\n      toolButton: \"mdi-minus\",\n      fullButton: \"mdi-fullscreen\",\n      inFullMode: false,\n\n      themeView: false,\n\n      handles: {\n        storyEditor: StoryEditor,\n        fileConverter: FileConverter\n      },\n\n      renderHints: {\n        renderKey: 1,\n        variableRenderKey: 1,\n        themesRenderKey: 1,\n        passageRenderKey: 1,\n        gsoRenderKey: 1,\n        mediaRenderKey: 1,\n        hidden: true,\n        inVariableEditor: true,\n        inMediaEditor: false\n      },\n\n      hi: \"Hello\",\n      exportFile: \"\"\n    };\n  },\n\n  created: function() {\n    /////\n    if (firebase.auth().currentUser) {\n      this.isLoggedIn = true;\n    }\n    if (this.isLoggedIn) {\n      var storageRef = firebase.storage().ref();\n      var userID = firebase.auth().currentUser.email;\n      this.userRef = storageRef.child(userID);\n    }\n    /////\n\n    if (this.$store.state.storyLocation != \"\") {\n      Axios.get(this.$store.state.storyLocation).then(response => {\n        if (response.data != null) {\n          this.loadContents(response.data);\n          if (\n            sessionStorage.getItem(\"OGstoryPassages\") === \"\" ||\n            sessionStorage.getItem(\"OGstoryPassages\") === null\n          ) {\n            sessionStorage.setItem(\n              \"OGstoryPassages\",\n              JSON.stringify(this.handles.storyEditor.exportedStoryPages)\n            );\n          }\n          sessionStorage.setItem(\"createTemplate\", \"yes\");\n          console.log(\"Read Success\");\n        } else {\n          console.log(\"Read Fail\");\n        }\n      });\n    } else if (this.$store.state.storyContent != \"\") {\n      console.log(sessionStorage.getItem(\"storyContent\"));\n      this.loadContents(this.$store.state.storyContent);\n      if (sessionStorage.getItem(\"OGstoryPassages\") === \"\") {\n        sessionStorage.setItem(\n          \"OGstoryPassages\",\n          JSON.stringify(this.handles.storyEditor.exportedStoryPages)\n        );\n      }\n      //this.handles.storyEditor.removeVariableInject();\n      this.regenerateStoryText({ disp: true });\n    }\n\n    if (this.isLoggedIn) {\n      if (this.storyName == \"\") {\n        this.storyName = \"Story Template\";\n      }\n      this.storyRef = this.userRef.child(this.storyName);\n      this.basePath = this.isLoggedIn.email + \"/\" + this.storyName + \"/\";\n    }\n\n    /////\n    if (this.isLoggedIn) {\n      this.storyRef.listAll().then(\n        function(result) {\n          result.items.forEach(\n            function(mediaRef) {\n              var key =\n                \"@\" + mediaRef.name.substring(0, mediaRef.name.indexOf(\"=\"));\n\n              if (this.imageVariables.has(key)) {\n                var currValue = this.imageVariables.get(key);\n                var value = {\n                  file: currValue.file,\n                  fileName: mediaRef.name.substring(\n                    mediaRef.name.indexOf(\"=\") + 1\n                  ),\n                  path: mediaRef.getDownloadURL(),\n                  id: currValue.id,\n                  color: currValue.color,\n                  uploaded: true\n                };\n                this.handles.storyEditor.setImageVariable(key, value);\n                this.totalFileSize += currValue.file.size / 1024 / 1024;\n              }\n              if (this.audioVariables.has(key)) {\n                currValue = this.audioVariables.get(key);\n                value = {\n                  file: currValue.file,\n                  fileName: mediaRef.name.substring(\n                    mediaRef.name.indexOf(\"=\") + 1\n                  ),\n                  path: mediaRef.getDownloadURL(),\n                  id: currValue.id,\n                  color: currValue.color,\n                  uploaded: true\n                };\n                this.handles.storyEditor.setAudioVariable(key, value);\n                this.totalFileSize += currValue.file.size / 1024 / 1024;\n              }\n              console.log(this.imageVariables);\n              console.log(this.audioVariables);\n            }.bind(this)\n          );\n        }.bind(this)\n      );\n    }\n    /////\n  },\n\n  components: {\n    \"var-sidebar\": Sidebar_Variables,\n    \"media-sidebar\": Sidebar_Media,\n    \"themes-sidebar\": Sidebar_Themes,\n    \"passage-sidebar\": Sidebar_Passage,\n    \"page-layout\": Page_Layout,\n    gso: Global_Story_Options\n  },\n\n  watch: {\n    status: debounce(function() {\n      if (this.status.includes(\"success\")) {\n        this.status = \"\";\n        this.renderHints.renderKey++;\n        this.checkRenderHints();\n      }\n    }, 3000)\n  },\n\n  methods: {\n    loadTwee: function(files) {\n      console.log(files);\n\n      const file = files[0];\n\n      var isHTML = file.name.includes(\".html\");\n\n      this.storyVariables = null;\n      this.storyLinkPassages = null;\n      this.storyDispPassages = null;\n\n      this.handles.storyEditor = null;\n      this.handles.fileConverter = null;\n\n      const tempFileReader = new FileReader();\n\n      tempFileReader.onload = () => {\n        // alert(tempFileReader.result);\n\n        this.handles.fileConverter = new FileConverter(\n          tempFileReader.result,\n          isHTML\n        );\n        this.handles.storyEditor = new StoryEditor(\n          this.handles.fileConverter.story\n        );\n        this.storyVariables = this.handles.storyEditor.variables;\n        this.imageVariables = this.handles.storyEditor.imageVariables;\n        this.audioVariables = this.handles.storyEditor.audioVariables;\n        this.storyPages = this.handles.storyEditor.exportedStoryPages;\n        this.storyName = this.handles.storyEditor.baseStory.name;\n\n        this.goToStart();\n\n        this.renderHints.renderKey++;\n        this.renderHints.variableRenderKey++;\n        this.renderHints.passageRenderKey++;\n        this.renderHints.gsoRenderKey++;\n\n        this.renderHints.hidden = true;\n        this.checkRenderHints();\n\n        sessionStorage.setItem(\"storyContent\", tempFileReader.result);\n        sessionStorage.setItem(\"storyLocation\", \"\");\n\n        this.regenerateStoryText({ disp: this.renderHints.hidden });\n      };\n      tempFileReader.readAsText(file);\n    },\n\n    loadContents: function(contents) {\n      this.storyVariables = null;\n      this.storyLinkPassages = null;\n      this.storyDispPassages = null;\n\n      this.handles.storyEditor = null;\n      this.handles.fileConverter = null;\n\n      this.handles.fileConverter = new FileConverter(contents, false);\n      this.handles.storyEditor = new StoryEditor(\n        this.handles.fileConverter.story\n      );\n      this.storyVariables = this.handles.storyEditor.variables;\n      this.imageVariables = this.handles.storyEditor.imageVariables;\n      this.audioVariables = this.handles.storyEditor.audioVariables;\n      this.storyPages = this.handles.storyEditor.exportedStoryPages;\n      this.storyName = this.handles.storyEditor.baseStory.name;\n\n      this.goToStart();\n\n      this.renderHints.renderKey++;\n      this.renderHints.variableRenderKey++;\n      this.renderHints.passageRenderKey++;\n      this.renderHints.gsoRenderKey++;\n\n      this.renderHints.hidden = true;\n      this.checkRenderHints();\n\n      this.regenerateStoryText({ disp: this.renderHints.hidden });\n    },\n\n    loadStoryTemplate: function() {\n      console.log(\"story template\");\n\n      Axios.get(\"/stories/Story Template.twee\").then(response => {\n        if (response.data != null) {\n          this.loadContents(response.data);\n          sessionStorage.setItem(\n            \"OGstoryPassages\",\n            JSON.stringify(this.handles.storyEditor.exportedStoryPages)\n          );\n          sessionStorage.setItem(\"createTemplate\", \"yes\");\n          console.log(\"Read Success\");\n        } else {\n          console.log(\"Read Fail\");\n        }\n      });\n\n      this.regenerateStoryText({ disp: this.renderHints.hidden });\n    },\n\n    replaceImage: function(event) {\n      this.handles.storyEditor.setImageVariable(event.name, event.data);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.mediaRenderKey++;\n      this.checkRenderHints();\n\n      /////\n      var imgData = this.imageVariables.get(event.name);\n      if (this.isLoggedIn) {\n        var removeRef = this.storyRef.child(\n          event.name.replace(\"@\", \"\") + \"=\" + event.oldData.fileName\n        );\n        removeRef.delete().then(function() {\n          this.status =\n            \"Uploading \" + event.data.fileName + \"... please be patient :)\";\n        });\n        this.totalFileSize -= event.oldData.file.size / 1024 / 1024;\n        this.totalFileSize += event.data.file.size / 1024 / 1024;\n\n        if (this.totalFileSize > this.maxStorageSize) {\n          this.totalFileSize -= event.data.file.size / 1024 / 1024;\n          this.totalFileSize += event.oldData.file.size / 1024 / 1024;\n          this.status =\n            \"Sorry! It looks like you've run out of storage space. Try uploading a smaller file!\";\n\n          this.handles.storyEditor.setImageVariable(event.name, event.oldData);\n          this.renderHints.renderKey++;\n          this.renderHints.mediaRenderKey++;\n          this.checkRenderHints();\n        } else {\n          var newRef = this.storyRef.child(\n            event.name.replace(\"@\", \"\") + \"=\" + event.data.fileName\n          );\n          newRef.put(event.data.file).then(\n            function() {\n              this.status =\n                \"Upload for \" + event.data.fileName + \" successful!\";\n              var obj = {\n                file: event.data.file,\n                fileName: event.data.fileName,\n                path: newRef.getDownloadURL(),\n                color: imgData.color,\n                id: imgData.id,\n                uploaded: true\n              };\n              this.handles.storyEditor.setImageVariable(event.name, obj);\n\n              this.renderHints.renderKey++;\n              this.renderHints.mediaRenderKey++;\n              this.checkRenderHints();\n\n              console.log(this.imageVariables);\n            }.bind(this)\n          );\n        }\n      }\n      /////\n    },\n\n    replaceAudio: function(event) {\n      this.handles.storyEditor.setAudioVariable(event.name, event.data);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.mediaRenderKey++;\n      this.checkRenderHints();\n\n      /////\n      var audData = this.audioVariables.get(event.name);\n      if (this.isLoggedIn) {\n        var removeRef = this.storyRef.child(\n          event.name.replace(\"@\", \"\") + \"=\" + event.oldData.fileName\n        );\n        removeRef.delete().then(function() {\n          this.status =\n            \"Uploading \" + event.data.fileName + \"... please be patient :)\";\n        });\n        this.totalFileSize -= event.oldData.file.size / 1024 / 1024;\n        this.totalFileSize += event.data.file.size / 1024 / 1024;\n\n        if (this.totalFileSize > this.maxStorageSize) {\n          this.totalFileSize -= event.data.file.size / 1024 / 1024;\n          this.totalFileSize += event.oldData.file.size / 1024 / 1024;\n          this.status =\n            \"Sorry! It looks like you've run out of storage space. Try uploading a smaller file!\";\n\n          this.handles.storyEditor.setAudioVariable(event.name, event.oldData);\n          this.renderHints.renderKey++;\n          this.renderHints.mediaRenderKey++;\n          this.checkRenderHints();\n        } else {\n          var newRef = this.storyRef.child(\n            event.name.replace(\"@\", \"\") + \"=\" + event.data.fileName\n          );\n          newRef.put(event.data.file).then(\n            function() {\n              this.status =\n                \"Upload for \" +\n                event.data.fileName +\n                \" successful... thanks for waiting!\";\n              var obj = {\n                file: event.data.file,\n                fileName: event.data.fileName,\n                path: newRef.getDownloadURL(),\n                color: audData.color,\n                id: audData.id,\n                uploaded: true\n              };\n              this.handles.storyEditor.setAudioVariable(event.name, obj);\n\n              this.renderHints.renderKey++;\n              this.renderHints.mediaRenderKey++;\n              this.checkRenderHints();\n\n              console.log(this.audioVariables);\n            }.bind(this)\n          );\n        }\n      }\n      /////\n    },\n\n    replaceImageName: function(event) {\n      var process = this.handles.storyEditor.changeImageVariableName(event);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.mediaRenderKey++;\n      this.checkRenderHints();\n\n      /////\n      var fileName = event.fileName;\n      if (this.isLoggedIn && process) {\n        var removeRef = this.storyRef.child(\n          event.prevName.replace(\"@\", \"\") + \"=\" + fileName\n        );\n        removeRef.delete();\n        var imgData = this.imageVariables.get(event.newName);\n        var newRef = this.storyRef.child(\n          event.newName.replace(\"@\", \"\") + \"=\" + fileName\n        );\n        newRef.put(imgData.file).then(\n          function() {\n            this.status = \"Your changes were saved successfully!\";\n\n            if (imgData.path.i.includes(\"blob\")) {\n              URL.revokeObjectURL(imgData.path.i);\n            }\n\n            var obj = {\n              file: imgData.file,\n              fileName: fileName,\n              path: newRef.getDownloadURL(),\n              color: imgData.color,\n              id: imgData.id,\n              uploaded: true\n            };\n            this.handles.storyEditor.setImageVariable(event.newName, obj);\n\n            this.renderHints.renderKey++;\n            this.renderHints.mediaRenderKey++;\n            this.checkRenderHints();\n\n            //console.log(this.imageVariables);\n          }.bind(this)\n        );\n      }\n      /////\n    },\n\n    replaceAudioName: function(event) {\n      var process = this.handles.storyEditor.changeAudioVariableName(event);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.mediaRenderKey++;\n      this.checkRenderHints();\n\n      /////\n      var fileName = event.fileName;\n      if (this.isLoggedIn && process) {\n        var removeRef = this.storyRef.child(\n          event.prevName.replace(\"@\", \"\") + \"=\" + fileName\n        );\n        removeRef.delete();\n        var audData = this.audioVariables.get(event.newName);\n        var newRef = this.storyRef.child(\n          event.newName.replace(\"@\", \"\") + \"=\" + fileName\n        );\n        newRef.put(audData.file).then(\n          function() {\n            this.status = \"Your changes were saved successfully!\";\n\n            if (audData.path.i.includes(\"blob\")) {\n              URL.revokeObjectURL(audData.path.i);\n            }\n\n            var obj = {\n              file: audData.file,\n              fileName: fileName,\n              path: newRef.getDownloadURL(),\n              color: audData.color,\n              id: audData.id,\n              uploaded: true\n            };\n            this.handles.storyEditor.setAudioVariable(event.newName, obj);\n\n            this.renderHints.renderKey++;\n            this.renderHints.mediaRenderKey++;\n            this.checkRenderHints();\n\n            console.log(this.audioVariables);\n          }.bind(this)\n        );\n      }\n      /////\n    },\n\n    addImageVariable: function(event) {\n      for (var i = 0; i < event.length; i++) {\n        this.handles.storyEditor.addImageVariable(event[i]);\n      }\n      this.handles.storyEditor.reparseMedia();\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.mediaRenderKey++;\n      this.checkRenderHints();\n\n      /////\n      if (this.isLoggedIn) {\n        this.imageVariables.forEach(\n          function(value, key) {\n            this.status =\n              \"Uploading \" + value.fileName + \"... please be patient :)\";\n            console.log(\"Uploaded:\" + value.uploaded);\n\n            if (value.uploaded == false) {\n              var currImageRef = this.storyRef.child(\n                key.replace(\"@\", \"\") + \"=\" + value.fileName\n              );\n              var file = value.file;\n              this.totalFileSize += file.size / 1024 / 1024;\n              if (this.totalFileSize > this.maxStorageSize) {\n                this.totalFileSize -= file.size / 1024 / 1024;\n                this.status =\n                  \"Sorry! It looks like you've run out of storage space. Try uploading smaller files!\";\n                //this.handles.storyEditor.deleteImageVariable(key);\n                this.removeImageVariable({\n                  name: key,\n                  fileName: value.fileName,\n                  file: value.file\n                });\n              } else {\n                currImageRef.put(file).then(\n                  function() {\n                    this.status =\n                      \"Upload for \" +\n                      value.fileName +\n                      \" successful... thanks for waiting!\";\n\n                    if (value.path.i.includes(\"blob\")) {\n                      URL.revokeObjectURL(value.path.i);\n                    }\n\n                    var obj = {\n                      file: value.file,\n                      fileName: value.fileName,\n                      path: currImageRef.getDownloadURL(),\n                      color: value.color,\n                      id: value.id,\n                      uploaded: true\n                    };\n                    this.handles.storyEditor.setImageVariable(key, obj);\n                    //console.log(this.imageVariables);\n                    //console.log(this.totalFileSize);\n\n                    this.renderHints.renderKey++;\n                    this.renderHints.mediaRenderKey++;\n                    this.checkRenderHints();\n                  }.bind(this)\n                );\n              }\n            }\n          }.bind(this)\n        );\n      }\n      /////\n    },\n\n    addAudioVariable: function(event) {\n      for (var i = 0; i < event.length; i++) {\n        this.handles.storyEditor.addAudioVariable(event[i]);\n      }\n      this.handles.storyEditor.reparseMedia();\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.mediaRenderKey++;\n      this.checkRenderHints();\n\n      /////\n      if (this.isLoggedIn) {\n        this.audioVariables.forEach(\n          function(value, key) {\n            this.status =\n              \"Uploading \" + value.fileName + \"... please be patient :)\";\n            console.log(\"Uploaded:\" + value.uploaded);\n\n            if (value.uploaded == false) {\n              var currAudRef = this.storyRef.child(\n                key.replace(\"@\", \"\") + \"=\" + value.fileName\n              );\n              var file = value.file;\n              this.totalFileSize += file.size / 1024 / 1024;\n              if (this.totalFileSize > this.maxStorageSize) {\n                this.totalFileSize -= file.size / 1024 / 1024;\n                this.status =\n                  \"Sorry! It looks like you've run out of storage space. Try uploading smaller files!\";\n                //this.handles.storyEditor.deleteAudioVariable(key);\n                this.removeAudioVariable({\n                  name: key,\n                  fileName: value.fileName,\n                  file: value.file\n                });\n              } else {\n                currAudRef.put(file).then(\n                  function() {\n                    this.status =\n                      \"Upload for \" +\n                      value.fileName +\n                      \" successful... thanks for waiting!\";\n\n                    if (value.path.i.includes(\"blob\")) {\n                      URL.revokeObjectURL(value.path.i);\n                    }\n\n                    var obj = {\n                      file: value.file,\n                      fileName: value.fileName,\n                      path: currAudRef.getDownloadURL(),\n                      color: value.color,\n                      id: value.id,\n                      uploaded: true\n                    };\n                    this.handles.storyEditor.setAudioVariable(key, obj);\n                    console.log(this.audioVariables);\n                    console.log(this.totalFileSize);\n\n                    this.renderHints.renderKey++;\n                    this.renderHints.mediaRenderKey++;\n                    this.checkRenderHints();\n                  }.bind(this)\n                );\n              }\n            }\n          }.bind(this)\n        );\n      }\n      /////\n    },\n\n    removeImageVariable: function(event) {\n      this.handles.storyEditor.deleteImageVariable(event);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.mediaRenderKey++;\n      this.checkRenderHints();\n\n      /////\n      if (this.isLoggedIn) {\n        var removeRef = this.storyRef.child(\n          event.name.replace(\"@\", \"\") + \"=\" + event.fileName\n        );\n        removeRef.delete().then(function() {\n          console.log(\"DELETED\");\n        });\n        this.writeToStorage();\n        this.totalFileSize -= event.file.size / 1024 / 1024;\n      }\n      /////\n    },\n\n    removeAudioVariable: function(event) {\n      this.handles.storyEditor.deleteAudioVariable(event);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.mediaRenderKey++;\n      this.checkRenderHints();\n\n      /////\n      if (this.isLoggedIn) {\n        var removeRef = this.storyRef.child(\n          event.name.replace(\"@\", \"\") + \"=\" + event.fileName\n        );\n        removeRef.delete().then(function() {\n          console.log(\"DELETED\");\n        });\n        this.writeToStorage();\n        this.totalFileSize -= event.file.size / 1024 / 1024;\n      }\n      /////\n    },\n\n    addImageToPage(event) {\n      var data = {\n        name: event.name,\n        pageName: this.storyPages[this.currentPage - 1].pageName\n      };\n      this.handles.storyEditor.addImageToPage(data);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.checkRenderHints();\n    },\n\n    addAudioToPage(event) {\n      var data = {\n        name: event.name,\n        pageName: this.storyPages[this.currentPage - 1].pageName\n      };\n      this.handles.storyEditor.addAudioToPage(data);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.checkRenderHints();\n    },\n\n    removeImageFromPage(event) {\n      var data = {\n        name: event.name,\n        pageName: this.storyPages[this.currentPage - 1].pageName\n      };\n      this.handles.storyEditor.removeImageFromPage(data);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.checkRenderHints();\n    },\n\n    removeAudioFromPage(event) {\n      var data = {\n        name: event.name,\n        pageName: this.storyPages[this.currentPage - 1].pageName\n      };\n      this.handles.storyEditor.removeAudioFromPage(data);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.checkRenderHints();\n    },\n\n    nextPage: function(event) {\n      this.pagesVisited.push(this.currentPage);\n\n      if (event.location < this.storyPages.length) {\n        this.currentPage = event.location + 1;\n      }\n      this.renderHints.renderKey++;\n      this.renderHints.themesRenderKey++;\n      this.checkRenderHints();\n    },\n\n    goToStart: function() {\n      this.pagesVisited = [];\n\n      for (var i = 0; this.storyPages.length; i++) {\n        if (this.storyPages[i].linkPassage.tags.includes(\"start\")) {\n          this.currentPage = i + 1;\n          break;\n        }\n      }\n\n      this.renderHints.renderKey++;\n      this.renderHints.themesRenderKey++;\n      this.checkRenderHints();\n    },\n\n    setStartPage: function(event) {\n      this.handles.storyEditor.setStartPage(event);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.themesRenderKey++;\n      this.checkRenderHints();\n    },\n\n    prevPage: function() {\n      if (this.pagesVisited.length > 0) {\n        this.currentPage = this.pagesVisited[this.pagesVisited.length - 1];\n        this.pagesVisited.pop();\n      } else {\n        return false;\n      }\n\n      this.renderHints.renderKey++;\n      this.renderHints.themesRenderKey++;\n      this.checkRenderHints();\n\n      return true;\n    },\n\n    addPage: function(event) {\n      this.storyPages[this.currentPage - 1].linkPassage.text +=\n        \"\\n[[\" + event.name + \"]]\";\n      var variablesPassage = this.storyPages[\n        this.currentPage - 1\n      ].linkPassage.tags.includes(\"variables\");\n      this.updatePassage({\n        name: this.storyPages[this.currentPage - 1].linkPassage.name,\n        text: this.storyPages[this.currentPage - 1].linkPassage.text,\n        isVariables: variablesPassage\n      });\n\n      this.handles.storyEditor.addPage({\n        name: event.name,\n        prevLink: this.storyPages[this.currentPage - 1].linkPassage.name\n      });\n\n      this.writeToStorage();\n\n      this.goToPage(event);\n    },\n\n    goToPage: function(event) {\n      for (var i = 0; this.storyPages.length; i++) {\n        if (this.storyPages[i].linkPassage.name == event.name) {\n          this.currentPage = i + 1;\n          break;\n        }\n      }\n\n      this.renderHints.renderKey++;\n      this.checkRenderHints();\n    },\n\n    showThemes: function() {\n      this.themeView = true;\n\n      this.regenerateStoryText({ disp: this.renderHints.hidden });\n\n      this.renderHints.renderKey++;\n      this.renderHints.themesRenderKey++;\n      this.checkRenderHints();\n    },\n\n    hideThemes: function() {\n      this.themeView = false;\n\n      this.regenerateStoryText({ disp: this.renderHints.hidden });\n\n      this.renderHints.renderKey++;\n      this.renderHints.themesRenderKey++;\n      this.checkRenderHints();\n    },\n\n    setTheme: function(event) {\n      this.storyPages[this.currentPage - 1].theme =\n        \"color:\" + event.textColor + \";background-color:\" + event.bgColor;\n      this.renderHints.renderKey++;\n      this.renderHints.themesRenderKey++;\n      this.checkRenderHints();\n    },\n\n    setThemeAll: function(event) {\n      for (var i = 0; i < this.storyPages.length; i++) {\n        this.storyPages[i].theme =\n          \"color:\" + event.textColor + \";background-color:\" + event.bgColor;\n      }\n\n      this.renderHints.renderKey++;\n      this.renderHints.themesRenderKey++;\n      this.checkRenderHints();\n    },\n\n    setVariable: function(event) {\n      this.handles.storyEditor.setTextVariable(event.name, event.value);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.checkRenderHints();\n    },\n\n    setVariableName: function(event) {\n      this.handles.storyEditor.changeTextVariableName(event);\n\n      this.writeToStorage();\n      this.renderHints.variableRenderKey++;\n      this.renderHints.renderKey++;\n      this.checkRenderHints();\n    },\n\n    deleteVariable: function(event) {\n      this.handles.storyEditor.deleteTextVariable(event);\n\n      this.writeToStorage();\n      this.renderHints.variableRenderKey++;\n      this.renderHints.renderKey++;\n      this.checkRenderHints();\n    },\n\n    regenerateStoryText: function(event) {\n      this.renderHints.hidden = event.disp;\n\n      this.handles.storyEditor.generateStoryText(\n        this.renderHints.hidden,\n        this.renderHints.inVariableEditor,\n        this.renderHints.inMediaEditor\n      );\n      this.storyVariables = this.handles.storyEditor.variables;\n      this.imageVariables = this.handles.storyEditor.imageVariables;\n      this.audioVariables = this.handles.storyEditor.audioVariables;\n      this.storyPages = this.handles.storyEditor.exportedStoryPages;\n      this.storyName = this.handles.storyEditor.baseStory.name;\n\n      this.renderHints.renderKey++;\n      this.checkRenderHints();\n    },\n\n    addNewVariable: function(event) {\n      this.handles.storyEditor.addTextVariable(event);\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.variableRenderKey++;\n      this.checkRenderHints();\n    },\n\n    addLink: function(event) {\n      this.handles.storyEditor.addLink({\n        pageName: this.storyPages[this.currentPage - 1].pageName,\n        name: event.name\n      });\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.passageRenderKey++;\n      this.checkRenderHints();\n    },\n\n    removeLink: function(event) {\n      this.handles.storyEditor.removeLink(event);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.checkRenderHints();\n    },\n\n    updatePassage: function(event) {\n      this.handles.storyEditor.setPassage(event.name, event.text);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.passageRenderKey++;\n\n      if (event.isVariables) {\n        this.renderHints.variableRenderKey++;\n      }\n\n      this.checkRenderHints();\n    },\n\n    updatePassageName: function(event) {\n      this.handles.storyEditor.changePassageName(event);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.renderHints.passageRenderKey++;\n      this.checkRenderHints();\n    },\n\n    deletePassage: function(event) {\n      this.handles.storyEditor.deletePassage(event);\n\n      this.writeToStorage();\n\n      this.renderHints.passageRenderKey++;\n\n      if (!this.prevPage()) {\n        this.goToStart();\n      }\n    },\n\n    changeStoryName(event) {\n      this.handles.storyEditor.changeStoryName(event);\n\n      this.writeToStorage();\n\n      this.renderHints.renderKey++;\n      this.checkRenderHints();\n    },\n\n    downloadStoryTwee: function() {\n      var storyView = this.handles.storyEditor.generateSaveStory();\n      this.handles.fileConverter.story = storyView;\n\n      var tweeBlob = this.handles.fileConverter.twee();\n\n      var dlblob = new Blob([tweeBlob], { type: \"text/plain\" });\n\n      const link = document.createElement(\"a\");\n      link.href = URL.createObjectURL(dlblob);\n      link.target = \"_blank\";\n      link.setAttribute(\n        \"download\",\n        this.handles.storyEditor.baseStory.name + \".twee\"\n      );\n      link.click();\n      URL.revokeObjectURL(link.href);\n      //this.handles.storyEditor.removeVariableInject();\n    },\n\n    saveStoryToProfile() {\n      var cloudStory = this.handles.storyEditor.generateSaveStory();\n      this.handles.fileConverter.story = cloudStory;\n      var tweeBlob = this.handles.fileConverter.twee();\n\n      var d = new Date();\n      var draftObj = {\n        text: tweeBlob,\n        dateUpdated:\n          d.getMonth() + 1 + \"/\" + d.getDate() + \"/\" + d.getFullYear(),\n        OGstory: sessionStorage.getItem(\"OGstoryPassages\")\n      };\n      if (\n        db.ref(\n          \"accounts/\" +\n            firebase.auth().currentUser.uid +\n            \"/drafts/\" +\n            this.handles.storyEditor.baseStory.name\n        )\n      ) {\n        db.ref(\n          \"accounts/\" +\n            firebase.auth().currentUser.uid +\n            \"/drafts/\" +\n            this.handles.storyEditor.baseStory.name\n        ).update(draftObj);\n      } else {\n        db.ref(\n          \"accounts/\" +\n            firebase.auth().currentUser.uid +\n            \"/drafts/\" +\n            this.handles.storyEditor.baseStory.name\n        ).push(draftObj);\n      }\n      alert(\"Your story was saved successfully!\");\n    },\n\n    getExportFile() {\n      var cloudStory = this.handles.storyEditor.generatePublishStory();\n      this.handles.fileConverter.story = cloudStory;\n      var tweeBlob = this.handles.fileConverter.twee();\n      this.$store.commit(\"updateStoryPublish\", tweeBlob);\n    },\n\n    downloadStory: function() {\n      var storyView = this.handles.storyEditor.generateViewStory(true);\n      this.handles.fileConverter.story = storyView;\n      var htmlBlob = this.handles.fileConverter.html(\n        this.handles.storyEditor.css,\n        \"\"\n      );\n\n      storyView = this.handles.storyEditor.generateSaveStory();\n      this.handles.fileConverter.story = storyView;\n      var tweeBlob = this.handles.fileConverter.twee();\n\n      var zip = new JSZip();\n      zip.file(this.storyName + \".html\", htmlBlob);\n      zip.file(this.storyName + \".twee\", tweeBlob);\n      zip.file(\n        \"readMe.txt\",\n        \"To view the story, double click on the html file.\\nIf the user wants to re-edit the story, they must upload the .twee file to our website.\\nCreate an account to save stories, download stories and more!\"\n      );\n\n      var name = this.storyName;\n\n      zip.generateAsync({ type: \"blob\" }).then(function(content) {\n        // see FileSaver.js\n        FileSaver.saveAs(content, name + \".zip\");\n      });\n      //this.handles.fileConverter.html(event.css, event.js);\n    },\n\n    viewStoryHTML: function() {\n      var storyView = this.handles.storyEditor.generateViewStory(true);\n      this.handles.fileConverter.story = storyView;\n\n      //this.handles.fileConverter.html(event.css, event.js);\n\n      var htmlBlob = this.handles.fileConverter.html(\n        this.handles.storyEditor.css,\n        \"\"\n      );\n\n      const link = document.createElement(\"a\");\n      link.href = URL.createObjectURL(\n        new Blob([htmlBlob], { type: \"text/html\" })\n      );\n      link.target = \"_blank\";\n      //link.setAttribute('download',  this.handles.storyEditor.baseStory.name + '.html');\n      link.click();\n      URL.revokeObjectURL(link.href);\n      //this.handles.storyEditor.removeVariableInject();\n    },\n\n    /*viewHTMLBlob: function(htmlContents){\n            const link = document.createElement('a');\n            link.href = URL.createObjectURL(new Blob([htmlContents], {type: \"text/html\"}));\n            link.target = \"_blank\"\n            //link.setAttribute('download',  this.handles.storyEditor.baseStory.name + '.html');\n            link.click();\n            URL.revokeObjectURL(link.href);\n        },*/\n\n    publishStoryType: function() {\n      var templateChanged = this.checkUniqueStory();\n      if (\n        sessionStorage.getItem(\"createTemplate\") === \"yes\" &&\n        templateChanged === true\n      ) {\n        this.checkUniqueTemplate();\n      }\n    },\n\n    checkUniqueTemplate: function() {\n      let canSubmit = true;\n      const Typesense = require(\"typesense\");\n      const typesense = new Typesense.Client({\n        nodes: [\n          {\n            //host: 'localhost',\n            // host: \"vcm-15431.vm.duke.edu\",\n            // port: \"8108\",\n            // protocol: \"https\"\n            host: \"av2xrki6y54hl3wbp-1.a1.typesense.net\",\n            port: \"443\",\n            protocol: \"https\"\n          }\n        ],\n\n        // apiKey: \"YOYCpFLj9u412ihigstCer5Zs2StzptR\"\n        apiKey: \"I1RDnpfBxdpllDchtj7gslzsqwpmnvmi\"\n      });\n\n      typesense\n        .collections(\"stories\")\n        .retrieve()\n        .then(data => {\n          var numDocs = data.num_documents;\n          for (let i = 0; i < numDocs - 1; i++) {\n            typesense\n              .collections(\"stories\")\n              .documents(i.toString())\n              .retrieve()\n              .then(data => {\n                let aFileConverter = new FileConverter(data.text, false);\n                let aStoryEditor = new StoryEditor(aFileConverter.story);\n                var s1 = \"\";\n                var s2 = \"\";\n                for (\n                  let i = 0;\n                  i < aStoryEditor.exportedStoryPages.length;\n                  i++\n                ) {\n                  s1 += aStoryEditor.exportedStoryPages[i].linkPassage.text;\n                }\n                for (let i = 0; i < this.storyPages.length; i++) {\n                  s2 += this.storyPages[i].linkPassage.text;\n                }\n                if (\n                  aStoryEditor.exportedStoryPages.length <\n                  this.storyPages.length\n                ) {\n                  for (\n                    let i = aStoryEditor.exportedStoryPages.length;\n                    i < this.storyPages.length;\n                    i++\n                  ) {\n                    var indexOpenBrackets = this.storyPages[\n                      i\n                    ].linkPassage.text.indexOf(\"[[\");\n                    var indexCloseBrackets = this.storyPages[\n                      i\n                    ].linkPassage.text.indexOf(\"]]\");\n                    var cleanStr = this.storyPages[i].linkPassage.text;\n                    if (indexOpenBrackets != -1) {\n                      var bracketStr = this.storyPages[\n                        i\n                      ].linkPassage.text.substring(\n                        indexOpenBrackets,\n                        indexCloseBrackets + 2\n                      );\n                      cleanStr = this.storyPages[i].linkPassage.text.replace(\n                        bracketStr,\n                        \"\"\n                      );\n                    }\n                    if (\n                      this.storyPages[i].linkPassage.text.includes(\n                        \"This is a new passage. Edit it to create your own story!\"\n                      ) ||\n                      cleanStr.replace(/\\s/g, \"\") === \"\"\n                    ) {\n                      alert(\"Please edit content in new passages.\");\n                      return;\n                    }\n                    s2 += cleanStr;\n                  }\n                }\n                var similarityScore = this.similarity(s1, s2);\n                //console.log(similarityScore);\n                if (similarityScore > 0.75) {\n                  canSubmit = false;\n                  alert(\n                    \"Story template is too similar to existing template. Please submit a unique story template.\"\n                  );\n                  return;\n                }\n                if (\n                  similarityScore <= 0.75 &&\n                  i === numDocs - 2 &&\n                  canSubmit === true\n                ) {\n                  alert(\n                    \"Story template is unique and is ready to be published!\"\n                  );\n                  return;\n                }\n              });\n          }\n        });\n    },\n\n    // Add support for drafts\n    checkUniqueStory: function() {\n      var s1 = \"\";\n      var s2 = \"\";\n      for (\n        let i = 0;\n        i < JSON.parse(sessionStorage.getItem(\"OGstoryPassages\")).length;\n        i++\n      ) {\n        s1 += JSON.parse(sessionStorage.getItem(\"OGstoryPassages\"))[i]\n          .linkPassage.text;\n      }\n      for (let i = 0; i < this.storyPages.length; i++) {\n        s2 += this.storyPages[i].linkPassage.text;\n      }\n      if (\n        JSON.parse(sessionStorage.getItem(\"OGstoryPassages\")).length <\n        this.storyPages.length\n      ) {\n        for (\n          let i = JSON.parse(sessionStorage.getItem(\"OGstoryPassages\")).length;\n          i < this.storyPages.length;\n          i++\n        ) {\n          var indexOpenBrackets = this.storyPages[i].linkPassage.text.indexOf(\n            \"[[\"\n          );\n          var indexCloseBrackets = this.storyPages[i].linkPassage.text.indexOf(\n            \"]]\"\n          );\n          var cleanStr = this.storyPages[i].linkPassage.text;\n          if (indexOpenBrackets != -1) {\n            var bracketStr = this.storyPages[i].linkPassage.text.substring(\n              indexOpenBrackets,\n              indexCloseBrackets + 2\n            );\n            cleanStr = this.storyPages[i].linkPassage.text.replace(\n              bracketStr,\n              \"\"\n            );\n          }\n          if (\n            this.storyPages[i].linkPassage.text.includes(\n              \"This is a new passage. Edit it to create your own story!\"\n            ) ||\n            cleanStr.replace(/\\s/g, \"\") === \"\"\n          ) {\n            alert(\"Please edit content in new passages.\");\n            return false;\n          }\n          s2 += cleanStr;\n        }\n      }\n      var similarityScore = this.similarity(s1, s2);\n      console.log(similarityScore);\n      if (similarityScore > 0.75) {\n        alert(\n          \"Story is too similar to the original. Please submit a unique story.\"\n        );\n        return false;\n      }\n      if (sessionStorage.getItem(\"createTemplate\") != \"yes\") {\n        alert(\"Story is unique and is ready to be published!\");\n      } else {\n        return true;\n      }\n    },\n\n    // Uses Levenshtein distance algorithm\n    similarity: function(s1, s2) {\n      var longer = s1.toLowerCase().replace(/\\s/g, \"\");\n      var shorter = s2.toLowerCase().replace(/\\s/g, \"\");\n      if (s1.length < s2.length) {\n        longer = s2;\n        shorter = s1;\n      }\n      var longerLength = longer.length;\n      if (longerLength == 0) {\n        return 1.0;\n      }\n      return (\n        (longerLength - this.editDistance(longer, shorter)) /\n        parseFloat(longerLength)\n      );\n    },\n\n    editDistance: function(s1, s2) {\n      var costs = new Array();\n      for (var i = 0; i <= s1.length; i++) {\n        var lastValue = i;\n        for (var j = 0; j <= s2.length; j++) {\n          if (i == 0) {\n            costs[j] = j;\n          } else {\n            if (j > 0) {\n              var newValue = costs[j - 1];\n              if (s1.charAt(i - 1) != s2.charAt(j - 1)) {\n                newValue =\n                  Math.min(Math.min(newValue, lastValue), costs[j]) + 1;\n              }\n              costs[j - 1] = lastValue;\n              lastValue = newValue;\n            }\n          }\n        }\n        if (i > 0) {\n          costs[s2.length] = lastValue;\n        }\n      }\n      return costs[s2.length];\n    },\n\n    writeToStorage: function() {\n      var storyView = this.handles.storyEditor.generateSaveStory();\n      this.handles.fileConverter.story = storyView;\n\n      var tweeBlob = this.handles.fileConverter.twee();\n      sessionStorage.setItem(\"storyContent\", tweeBlob);\n      sessionStorage.setItem(\"storyLocation\", \"\");\n\n      //this.handles.storyEditor.removeVariableInject();\n\n      this.handles.storyEditor.generateStoryText(\n        this.renderHints.hidden,\n        this.renderHints.inVariableEditor,\n        this.renderHints.inMediaEditor\n      );\n      this.storyVariables = this.handles.storyEditor.variables;\n      this.imageVariables = this.handles.storyEditor.imageVariables;\n      this.audioVariables = this.handles.storyEditor.audioVariables;\n      this.storyPages = this.handles.storyEditor.exportedStoryPages;\n      this.storyName = this.handles.storyEditor.baseStory.name;\n    },\n\n    checkRenderHints: function() {\n      if (this.renderHints.renderKey > 10) {\n        this.renderHints.renderKey = 1;\n      }\n\n      if (this.renderHints.variableRenderKey > 10) {\n        this.renderHints.variableRenderKey = 1;\n      }\n\n      if (this.renderHints.themesRenderKey > 10) {\n        this.renderHints.themesRenderKey = 1;\n      }\n\n      if (this.renderHints.passageRenderKey > 10) {\n        this.renderHints.passageRenderKey = 1;\n      }\n\n      if (this.renderHints.gsoRenderKey > 10) {\n        this.renderHints.gsoRenderKey = 1;\n      }\n\n      if (this.renderHints.mediaRenderKey > 10) {\n        this.renderHints.mediaRenderKey = 1;\n      }\n    },\n\n    hideTools: function() {\n      if (this.toolButton == \"mdi-minus\") {\n        this.toolsWidth = \"10%\";\n        this.pageWidth = \"90%\";\n        this.hideItem = true;\n        this.toolButton = \"mdi-plus\";\n      } else {\n        this.toolsWidth = \"30%\";\n        this.pageWidth = \"70%\";\n        this.hideItem = false;\n        this.toolButton = \"mdi-minus\";\n      }\n    },\n\n    goFullScreen: function() {\n      /*\n            var storyPage = document.getElementById(\"storyPage\");\n            if (!document.fullscreen) {\n                storyPage.requestFullscreen();\n                this.fullButton = \"Exit\";\n            }\n            else {\n                document.exitFullscreen();\n                this.fullButton = \"Full Screen\";\n\n            }\n            */\n      if (!this.inFullMode) {\n        this.$emit(\"evtGoFull\");\n        this.inFullMode = true;\n        this.fullButton = \"mdi-fullscreen-exit\";\n        this.contentHeight = \"100vh\";\n      } else {\n        this.$emit(\"evtExitFull\");\n        this.inFullMode = false;\n        this.fullButton = \"mdi-fullscreen\";\n        this.contentHeight = \"74vh\";\n      }\n    },\n\n    setMinHeight: function(event) {\n      this.minHeight = event;\n    }\n  },\n\n  beforeDestroy: function() {\n    console.log(\"Destroyed\");\n    this.handles.storyEditor.destroy();\n  },\n\n  mixins: [storyMixin, tweeConverter]\n};\n</script>\n\n<style scoped>\n@keyframes border_anim {\n  from {\n    border: solid gray;\n  }\n  to {\n    border: solid black;\n  }\n}\n\n.header {\n  text-align: center;\n}\n\n.uploads {\n  text-align: left;\n}\n\n/*\n    .editor{\n        margin-left: 50px;\n        margin-right: 50px;\n    }\n    */\n\n#storyPage,\n#toolBar {\n  overflow: auto;\n}\n\n#page_layout {\n  padding-top: 58px;\n  overflow: auto;\n}\n\n.column {\n  text-align: center;\n  float: left;\n  padding: 5px;\n}\n\n#download_btn {\n  display: flex;\n  flex-direction: row;\n  justify-content: space-around;\n}\n\n#downloadTButton {\n  grid-area: downloadT;\n  font-size: 20px;\n  width: 20%;\n}\n\n#downloadHButton {\n  grid-area: downloadH;\n  font-size: 20px;\n  width: 20%;\n}\n\n#viewHButton {\n  grid-area: viewH;\n  font-size: 20px;\n  width: 20%;\n}\n\n.layoutButton {\n  font-size: 50px;\n}\n\n.layoutButton:hover {\n  animation: border_anim;\n  animation-fill-mode: forwards;\n  animation-duration: 500ms;\n}\n</style>\n\n<style>\n* {\n  scrollbar-width: 20px;\n  scrollbar-color: lightgray transparent;\n}\n\n/* Works on Chrome/Edge/Safari */\n*::-webkit-scrollbar {\n  height: 5px;\n  width: 5px;\n}\n*::-webkit-scrollbar-track {\n  background: transparent;\n}\n*::-webkit-scrollbar-thumb {\n  background-color: lightgray;\n  border-radius: 20px;\n}\n\n*::-webkit-scrollbar-thumb:hover {\n  background-color: rgb(200, 200, 200);\n  border-radius: 20px;\n}\n</style>\n"]}]}